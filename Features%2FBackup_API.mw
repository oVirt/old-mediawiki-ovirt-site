= Backup API =
This document describes the design for the Backup API feature.

== Motivation ==
The motivation that stands behind this idea is to provide the user an API which can be used to backup different VM disks in the system.
The user will be able to use externalized backup applications which will provide the ability to backup the data of any image disk into a predefined container disk which will be used as part of a backup container (VM).

== Current status ==
* Target Release: 
* Status: Development Stage
* Last updated date: Tue Sep 12 2013

== Functionality ==
=== General Functionality ===
When attaching a disk to a vm only the active volume was used, if the user wanted to see the disk content at some snapshot he had to preview that snapshot.<BR>
As part of the backup API feature, a snapshot of a disk can be attached to another vm, regardless of the disk not being marked as shareable - when doing so, VDSM should create a temp snapshot allowing read/write access above the selected snapshot, the above should happend when hotplugging a disk/ running a vm.<BR>
In case of hot unplug of the disk snapshot vdsm should delete the temp snapshot.

=== Backup Disk Functionality ===
The new backup disk is not a regular disk and will be blocked from being exported/ use in a template/ or be part of the backup VM snapshot.<BR>
If the new backup disk will be a boot disk and will have an OS installed on it then there can be one of the other use cases:<BR>
1. If the backup VM will already contain a boot disk with OS installed on it, then the original boot disk will be remained.
2. If the backup VM will not contain a boot disk with OS installed on it, then the original boot disk will act as a boot disk which the VM will start the boot from.

== Example ==
1. Navigate to the wanted disk snapshot from REST by accessing:<BR>
SERVER:PORT:/api/vms/GUID/snapshots/GUID/disks

2. POST the copied disk with the disk id and the snapshot id:<BR>
   http://SERVER:PORT/api/vms/GUID/disks/

When creating a disk you will have to pass the the disk id and the snapshot id such as the following example:
  <disk id="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"><BR>
    <snapshot id="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"/><BR>
  </disk>

==The Backup Process ==
User can back up a virtual machine by an externalized application by the following steps:
* Choose the disk snapshot which you want to use for back up.
* Attach this disk snapshot to the target  virtual machine for back up
* Capture the virtual disk data and virtual machine configuration information (vim.vm.ConfigInfo).
* Open and read the virtual disk and snapshot files. Copy them to backup media, along with configuration information.
* Remove the disk

== Future Work ==
* UI  - would be handled in a following patch (the information is accessible through REST)
* possibly further inspection of permissions

== Future work / Limitations ==
* The created temp snapshots is stored on the host local storage (the host that the vm is running on) and not on the shared storage (domains) therefore the vm can't be migrated.
*  A disk snapshot can be attached to a different VM than the one of which the snapshot (VM snapshot) was taken of.
