== oVirt & Neutron GRE Integration ==

[[File:oVirt_Neutron_GRE.jpeg]]

===The oVirt Side===
[[Quick Start Guide|Install the engine on a host.]]
Setup a couple of RHEL 6.5 compatible hosts, run yum update. These will be used to host guests.
You can use oVirt's GUI to add the hosts now. If you do, you can select 'reinstall' later to install the Neutron agents.

===Install Neutron Controller===

On the RHEL 6.5 host that will be used as the Neutron server, L3 agent and DHCP agent - Install iproute 2 that supports namespaces (For example 2.6.32-130):
https://brewweb.devel.redhat.com/buildinfo?buildID=297968

This host will now be known as the controller.

On the controller:

<pre>yum install -y http://rdo.fedorapeople.org/openstack-havana/rdo-release-havana.rpm</pre>

No need for a yum update or reboot.

"Due to the quantum/neutron rename, SELinux policies are currently broken for Havana, so SELinux must be disabled/permissive on machines running neutron services, edit /etc/selinux/config to set SELINUX=permissive."

Install Neutron manually or use Packstack.

Via packstack:

<pre>sudo yum install -y openstack-packstack</pre>

Make packstack generate an answer file:

<pre>packstack --gen-answer-file=<file name></pre>

An answer file will be created in /root/<file name>

Edit it and change:

Only install required services (Neutron only would be ideal but as of 17.10.13 Packstack fails if you don't select Nova as well)

Make sure Neutron server IP is reachable from the host that will act as the oVirt engine

From:

<pre>CONFIG_NEUTRON_OVS_TENANT_NETWORK_TYPE=local</pre>

To:

<pre>CONFIG_NEUTRON_OVS_TENANT_NETWORK_TYPE=gre</pre>

Change the tunnel ranges to something similar to:

<pre>CONFIG_NEUTRON_OVS_TUNNEL_RANGES=1:1000</pre>

Finally change:

<pre>CONFIG_NEUTRON_OVS_TUNNEL_IF=<ethX></pre>

To the device which faces the compute nodes.

Now run:<br />
<pre>packstack --answer-file=<file name></pre>

When using GRE, set the MTU in the Guest to 1400, this will allow for the GRE header and no packet fragmentation. Also you should set TSO to off on the instance machine for outbound traffic to work. This can be done by this command : ethtool -K eth0 tso off . You can create a bash script for init.d to run it at startup.

===oVirt Configuration===

On the machine that runs the oVirt engine:

<pre>
engine-config --set KeystoneAuthUrl=http://<host.fqdn>:35357/v2.0
engine-config --set OnlyRequiredNetworksMandatoryForVdsSelection=true</pre>

From the GUI, add Neutron as an external provider

===Hosts Configuration===

The next step is to add hosts to oVirt. It requires a few yum repositories.

====Repositories====

For VDSM: ovirt-stable for Fedora:

<pre>sudo yum install -y http://resources.ovirt.org/releases/ovirt-release-fedora.noarch.rpm</pre>

Or for RHEL:

<pre>sudo yum install -y http://resources.ovirt.org/releases/ovirt-release-el.noarch.rpm</pre>

Additionally, for the Open vSwitch layer 2 agent: 

<pre>sudo yum install -y http://rdo.fedorapeople.org/openstack-havana/rdo-release-havana.rpm</pre>

====Configuration====

oVirt can install the layer 2 agent on the host if external provider is selected during host install. However, it is currently broken with OpenStack Havana until oVirt 3.3.3 is released. GRE/VXLAN integration is also not currently supported in 3.3. Until it is fixed, follow these manual steps on each host:

To install layer 2 ovs agent follow the instructions on (If not using using oVirt 3.3.3+):

http://www.ovirt.org/Features/Detailed_Quantum_Integration#OVS_Agent_installation_steps

After you complete that set of instructions, please make the following additional modifications:

Edit:

/etc/neutron/neutron.conf

Under [agent]

Change:

<pre>root_helper = sudo quantum-rootwrap /etc/quantum/rootwrap.conf</pre>

To:

<pre>root_helper = sudo neutron-rootwrap /etc/neutron/rootwrap.conf</pre>

Edit:

/etc/neutron/plugins/openvswitch/ovs_plugin.ini:

<pre>
[ovs]

tenant_network_type = gre

enable_tunneling = True

tunnel_type = gre

tunnel_id_ranges = 5000:10000

local_ip = <ip of nic that should bring up GRE tunnels>

[agent]

tunnel_types = gre
</pre>

Then restart the agent's service:

<pre>service neutron-openvswitch-agent restart</pre>

===VDSM Hook===

Finally install the oVirt VDSM hook that enables Neutron integration:

<pre>yum install vdsm-hook-openstacknet</pre>

===Enjoying the Results===

# Create the desired networks in Neutron
# From oVirt: Import those networks
# Connect VMs to those networks
# Start the VMs!

The VMs should be able to connect to both oVirt and Neutron networks.
