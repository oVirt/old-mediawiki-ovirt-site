<!-- {{autolang|base=yes}} -->

== Disk Permissions ==

=== Summary ===
The Disk Permissions feature is supplementary for Disk related features (Floating Disk, Shared Raw Disk, Direct LUN). It enables permissions management on a Disk.

=== Owner ===
* Name: Moti Asayag
* Email: masayag@redhat.com

=== Current status ===
* Status: Design Stage 
* Last updated date: Wed Mar 28 2012

=== Design ===
Disk inherits permissions from the VM it is attached to and from the storage domain it resides on (if there is one) <BR>
When granting a user 'Create VM' permission, the user will be able to create a VM without creating Disks.<BR>
Creating disks requires specific permissions for that, on the storage domain or the storage pool.<BR>
When disk is created, 'DISK_OPERATOR' role is given to the user which created the Disk.<BR>
Add permissions command will support adding permissions which are already existing in the system without failing the command in can-do-action as done today.<BR>
It will serve the client when the user decide not to use permissions nor quota for Disk creation.

==== Disk Permissions and Quota ====
When Quota is enabled, Disk consumption will be enforced by the Quota, regardless the user's permissions on the Storage entities.<BR>
When Quota is disabled for the Data Center, a dialog will propose to the user whether to use the permissions model or to disable it in <BR>
aspect of Disk consumption, meaning users can create disks/move disks without need for permissions on Storage.<BR>
 
<BR>
The following section describes permissions for Disk entities.

==== Disk Actions ====
Required permissions for Disk related actions:
* Create disk - requires permissions on the Storage Domain.
* Attach disk to VM - requires permissions on the Disk and on the VM (applies for shared disk as well).
* Detach disk from VM - requires permissions on the VM only. (Unlike attach disk that requires permissions on the VM and on the Disk).
* Activate/Deactivate disk on VM (also Hot Plug) - requires permission on the VM.
* Remove disk (from Disk tab)- permissions on the Disk.
* Update disk - permissions on the Disk.
* Move or copy disk - requires permissions on the Disk and on the target Storage Domain.
* Add disk to VM - requires both permissions on the VM and on the storage domain (same as adding disk and attaching to VM).
** Create - on storage domain
** Attach - on disk and VM
** Activate - on VM
* Remove VM - we'll extend the command to support either deleting disks from the system (the current behavior) or only detach the disks, permissions goes as follows:
** If disks are marked for deletion - requires permissions on the removed Disks and on the VM.
** If disks aren't marked for deletion - the disks are detached, therefore no permissions required for the Disk, only for removing VM.

==== Roles ====
===== New Action Groups for Disk Object Type =====
  CREATE_DISK - AddDisk, AddDiskToVm
  EDIT_DISK_PROPERTIES - UpdateDisk, UpdateVM, Activate/Deactivate
  ATTACH_DISK - AttachDiskToVm
  CONFIGURE_DISK_STORAGE - MoveOrCopyDisk
  DELETE_DISK - RemoveDisk, RemoveVm

===== New Roles =====
New predefined user role for disks '''DISK_OPERATOR''' will be given to user when creating a Disk (either from Disk tab or from VM's disk sub-tab).<BR>
DISK_OPERATOR will be associated with the following action groups: CREATE_DISK, EDIT_DISK_PROPERTIES, ATTACH_DISK, CONFIGURE_DISK_STORAGE and DELETE_DISK.
  Add new role to ''PredefinedRoles.java''
  Add new upgrade script for new roles and updating existing roles.

===== Updated Roles =====
SuperUser, ENGINEPowerUser, ClusterAdmin, DataCenterAdmin and VmOperator should be extended with action groups of Disks (CREATE_DISK, EDIT_DISK_PROPERTIES, ATTACH_DISK, DELETE_DISK).<BR>
Currently attach/detach is being executed as part of the UpdateVm action.
  Existing roles are Update by upgrade script.
  Extend ''VdcObjectType'' with Disk.

==== DB Changes ====
  Modify create_functions.sql:
  Add support for Disk to ''fn_get_entity_parents'' stored-procedure.
  Add support for Disk to ''fn_get_entity_name'' stored-procedure.

==== Upgrade DB ====
DB Upgrade should handle the following:
* Add Disk Operator permissions on the relevant Disks to:
** "VM Operator" users (applies to users with permissions on VM with Disks attached to).
** SuperUser, ENGINEPowerUser, ClusterAdmin and DataCenterAdmin
* Add all disk related operations to the system administrator.

* When creating VM from template, the user should get permissions for the VM and for its images 
* Permissions will be given on storage domains to users with VMs (having CREATE_VM role) for the storage domains where the VM disks reside on (DISK_CREATOR role).

==== UI Changes ====
Add Permissions sub-tab under Disks main tab<BR>
Add Disk Operator role to Roles Tree in:<BR>
  ''frontend/webadmin/modules/uicommonweb/src/main/java/org/ovirt/engine/ui/uicommonweb/models/configure/roles_ui/RoleTreeView.java''
  ''frontend/webadmin/modules/uicompat/src/main/java/org/ovirt/engine/ui/uicompat/Enums.java''
  ''frontend/webadmin/modules/uicompat/src/main/resources/org/ovirt/engine/ui/uicompat/Enums.properties''

=== Benefit to oVirt ===
Permission management for Disks enhances the Disk functionality, provides flexibility to users and protects it from misuse.<BR>
Granting permissions on Disk to user is done via the Administrator Portal or using RESTful API.

=== Dependencies / Related Features ===
The Disk Permissions is dependent on the following features:
* SharedRawDisk
* Floating Disk
* Direct LUN

Affected oVirt projects:
* Engine-core
* Admin Portal

=== Open issues ===
* Direct LUN - Add/Remove Direct LUN disk has its own commands or share the same Disk Add/Remove ? If share, need to distinguish the required permission by the Disk in the ''CommandBase.getPermissionCheckSubjects''

=== Documentation / External references ===

=== Comments and Discussion ===
* See [[Talk:Features/DiskPermissions]]  
[[Category: Feature]]
