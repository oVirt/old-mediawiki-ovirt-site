<!-- {{autolang|base=yes}} -->

<!-- The actual name of your feature page should look something like: "Your feature name". Use natural language to name the pages. -->

= NUMA aware KSM support <!-- The name of your feature --> =

{{Feature|name=NUMA aware KSM support|modules=engine, vdsm, MoM, GUI, REST|status=Design|version=3.6}}

== Summary ==
The KSM feature is optimizing shared memory pages across all NUMA nodes. The consequences is: a shared memory pages (controlled by KSM) to be read from many CPUs across NUMA nodes. Hence degrading (could totally eliminate) the NUMA performance gain.
The optimal behavior is for KSM feature to optimize memory usage per NUMA nodes. This feature is implemented in KSM since [https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Virtualization_Administration_Guide/chap-KSM.html RHEL 6.5].
We want to introduce a new feature to oVirt that will allow host administrator to control NUMA aware KSM policy.

== Owner ==
* Feature Owner: Dudi Maroshi <dmaroshi (at) redhat (dot) com>
* GUI Component Owner: Dudi Maroshi <dmaroshi (at) redhat (dot) com>
* Engine Component Owner: Dudi Maroshi <dmaroshi (at) redhat (dot) com>
* VDSM Component Owner: Dudi Maroshi <dmaroshi (at) redhat (dot) com>
* MoM Component Owner: Dudi Maroshi <dmaroshi (at) redhat (dot) com>
* REST Component Owner: Dudi Maroshi <dmaroshi (at) redhat (dot) com>

== General Description ==
The information flow is presented in the diagram bellow:

[[File:Ksm-merge_across-node-data-flow.png]]<br />
The implementation activities are the following:<br />
# Update Database and entities with new attribute.
# Update REST api and its translation system with new attribute
# Update GUI with new widget 
# Test GUI and REST api
# Update oVirt-engine business logic to transmit KSM changes to host
# Test oVirt-engine
# Update MoM subsystem with new attribute
# Test MoM subsystem to track new attribute, and update KSM policy
# Update VDSM agent to update new MoM policy with new attribute

== Detailed Description ==
We want to introduce a new feature to HREV-M that will allow host administrator to control NUMA aware KSM.<br />


=== Kernel level solution ===
Since RHEL 6.5 there is a kernel flag that controls KSM's NUMA awareness. The flag '''/sys/kernel/mm/ksm/merge_across_nodes''' has strict logic for enabling/disabling NUMA awareness in KSM. Especially this documented lifecycle constraint:<br />

“''merge_across_nodes setting can be changed only when there are no ksm shared pages in system: set run 2 to unmerge pages first, then to 1 after changing merge_across_nodes, to remerge according to the new setting. Default = 1 (merging across NUMA nodes as in earlier releases)''”<br />

The initial life-cycle of KSM service with NUMA awareness is  presented in the pic bellow:<br />
[[File:ksm-merge-nodes-statechart.png]]<br />
The skilled hypervisor/host administrator may control merge_across_nodes life-cycle using scripts. Outside oVirt control.<br />

== Benefit to oVirt ==
<!-- What is the benefit to the oVirt project?  If this is a major capability update, what has changed?  If this is a new feature, what capabilities does it bring? Why will oVirt become a better distribution or project because of this feature?-->
What is the benefit to the oVirt project?  If this is a major capability update, what has changed?  If this is a new feature, what capabilities does it bring? Why will oVirt become a better distribution or project because of this feature?


== Dependencies / Related Features ==
<!-- What other packages depend on this package?  Are there changes outside the developers' control on which completion of this feature depends?  In other words, completion of another feature owned by someone else and might cause you to not be able to finish on time or that you would need to coordinate? Other Features that might get affected by this feature? -->

What other packages depend on this package?  Are there changes outside the developers' control on which completion of this feature depends?  In other words, completion of another feature owned by someone else and might cause you to not be able to finish on time or that you would need to coordinate? Other Features that might get affected by this feature?


== Documentation / External references ==
<!-- Is there upstream documentation on this feature, or notes you have written yourself?  Link to that material here so other interested developers can get involved. Links to RFEs. -->
Is there upstream documentation on this feature, or notes you have written yourself?  Link to that material here so other interested developers can get involved. Links to RFEs.

== Testing ==

Explain how this feature may be tested by a user or a quality engineer. List relevant use cases and expected results.

== Contingency Plan ==

Explain what will be done in case the feature won't be ready on time

== Release Notes ==

 == Your feature heading ==
 A descriptive text of your feature to be included in release notes

== Comments and Discussion ==

This below adds a link to the "discussion" tab associated with your page.  This provides the ability to have ongoing comments or conversation without bogging down the main feature page

* Refer to [[Talk:Your feature name]]  <!-- This adds a link to the "discussion" tab associated with your page.  This provides the ability to have ongoing comments or conversation without bogging down the main feature page -->

[[Category:Feature]]
[[Category:Template]]
