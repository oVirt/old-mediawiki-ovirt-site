<!-- {{autolang|base=yes}} -->

== UI Plugins ==

=== Summary ===
This feature provides an infrastructure and API for implementing and deploying custom user interface (UI) plugins for oVirt web administration application.

=== Owner ===
* Name: [[User:Vszocs|Vojtech Szocs]]
* Email: <vszocs@redhat.com>
* IRC: vszocs at #ovirt (irc.oftc.net)

=== Current status ===
* Plugin infrastructure implementation complete and working
* Plugin API to be improved in near future
* Sample plugins showcasing supported API to be contributed in near future

=== Overview ===
oVirt web administration application (WebAdmin) is the main UI for managing all components of a virtual system infrastructure. In addition to existing WebAdmin functionality, there can be times when administrators want to expose additional features or to integrate with other systems through WebAdmin UI. This is where UI plugins come into play: each plugin represents a set of user interface extensions that can be packaged and distributed for use with oVirt Engine via WebAdmin.

=== Introduction  ===
UI plugins integrate with WebAdmin directly on the client (web browser) using [http://en.wikipedia.org/wiki/JavaScript JavaScript] programming language. Plugin invocation is driven by WebAdmin and happens right within the context of web browser's JavaScript runtime, using JavaScript language as the lowest common denominator between WebAdmin ([http://en.wikipedia.org/wiki/Google_Web_Toolkit GWT]) and individual plugins. UI plugins can take full advantage of JavaScript language and its rich ecosystem of libraries.

At key events during runtime, WebAdmin invokes individual plugins via '''event handler functions''' representing WebAdmin → plugin communication. Even though WebAdmin supports multiple event handler functions, a plugin only declares functions which are of interest to its implementation. Each plugin must register relevant event handler functions as part of [[#Plugin_bootstrap_sequence|plugin bootstrap sequence]], before the plugin is put to use by WebAdmin.

To facilitate plugin → WebAdmin communication, WebAdmin exposes global (top-level) <code>pluginApi</code> JavaScript object for individual plugins to consume. Each plugin obtains specific <code>pluginApi</code> instance, allowing WebAdmin to control plugin API function invocation per each plugin with regard to [[#Plugin_lifecycle|plugin lifecycle]].

=== Discovering plugins ===
Before a plugin can be [[#Loading_plugins|loaded]] and [[#Plugin_bootstrap_sequence|bootstrapped]] by WebAdmin, it has to be discovered by UI plugin infrastructure in the first place.

TODO image from presentation here

[[#Plugin_descriptor|Plugin descriptor]] is the entry point to [[#Discovering_plugins|plugin discovery process]], containing important plugin meta-data as well as (optional) default plugin-specific configuration. As part of handling WebAdmin HTML page request (1), UI plugin infrastructure attempts to discover and load plugin descriptors from local file system (2). For each plugin descriptor, the infrastructure also attempts to load corresponding [[#Plugin_user_configuration|plugin user configuration]] used to override default plugin-specific configuration (if any) and tweak plugin runtime behavior. Note that providing plugin user configuration is completely optional. After loading descriptors and corresponding user configuration, oVirt Engine aggregates UI plugin data and embeds it into WebAdmin HTML page for runtime evaluation (3).

By default, plugin descriptors are expected to reside in <code>$ENGINE_USR/ui-plugins</code> directory, with a default mapping <code>ENGINE_USR=/usr/share/ovirt-engine</code> as defined by oVirt Engine local configuration. Plugin descriptors are expected to comply with [http://en.wikipedia.org/wiki/JSON JSON] format specification, with the addition of allowing Java/C++ style comments (both <code>/</code>+<code>*</code> and <code>//</code> varieties).

By default, plugin user configuration files are expected to reside in <code>$ENGINE_ETC/ui-plugins</code> directory, with a default mapping <code>ENGINE_ETC=/etc/ovirt-engine</code> as defined by oVirt Engine local configuration. Plugin user configuration files are expected to comply with same content format rules as plugin descriptors. Note that plugin user configuration files follow <code>$descriptorFileName-config.json</code> naming convention.

=== Loading plugins ===
After a plugin has been [[#Discovering_plugins|discovered]] and its data embedded into WebAdmin HTML page, WebAdmin will attempt to load the given plugin as part of application startup (unless configured otherwise).

TODO image from presentation here

For each plugin, WebAdmin creates an HTML <code>iframe</code> element used to load [[#Plugin_host_page|plugin host page]] (1). Plugin host page is the entry point to [[#Plugin_bootstrap_sequence|plugin bootstrap process]], used to evaluate plugin code (JavaScript) within the context of the corresponding <code>iframe</code> element. UI plugin infrastructure supports serving plugin resource files, such as plugin host page, from local file system (2). Plugin host page gets loaded into the <code>iframe</code> element and the plugin code is evaluated (3). From this point forward, plugin communicates with WebAdmin via plugin API (4).

By default, plugin resource files are expected to reside in <code>$ENGINE_USR/ui-plugins/$resourcePath</code> directory, with <code>$resourcePath</code> value defined by the corresponding attribute in [[#Plugin_descriptor|plugin descriptor]].

=== Plugin descriptor ===
Plugin descriptor is the entry point to [[#Discovering_plugins|plugin discovery process]], containing important plugin meta-data as well as (optional) default plugin-specific configuration.

Following code snippet shows a sample plugin descriptor:
<pre>
{

    // A name that uniquely identifies the plugin (required).
    // Not related to descriptor file name, must not be empty.
    "name": "MyPlugin",

    // URL of plugin host page used to evaluate plugin code (required).
    // Using UI plugin infrastructure support to serve plugin resource files.
    // This URL maps to $ENGINE_USR/ui-plugins/$resourcePath/start.html
    "url": "/webadmin/webadmin/plugin/MyPlugin/start.html",

    // Default configuration object associated with the plugin (optional).
    "config": { "band": "ZZ Top", "score": 10 },

    // Path to plugin resource files, relative to plugin descriptor location (optional).
    // Required when using UI plugin infrastructure support to serve plugin resource files.
    // This path maps to $ENGINE_USR/ui-plugins/my-files
    "resourcePath": "my-files"

}
</pre>

=== Plugin user configuration ===
Plugin user configuration is used to override default plugin-specific configuration (if any) and tweak plugin runtime behavior.

Following code snippet shows a sample plugin user configuration:
<pre>
{

    // Custom configuration object associated with the plugin (optional).
    // This overrides the default (plugin descriptor) configuration, if any.
    "config": { "band": "AC/DC" },

    // Whether the plugin should be loaded on WebAdmin startup (optional).
    // Default value is 'true'.
    "enabled": true,

    // Relative order in which the plugin will be loaded (optional).
    // Default value is Integer.MAX_VALUE (lowest order).
    "order": 0

}
</pre>

As part of [[#Discovering_plugins|discovering plugins]], UI plugin infrastructure will merge custom configuration (if any) on top of default configuration (if any). For example:
* Plugin descriptor defines <code>config</code> attribute as <code>{ "band": "ZZ Top", "score": 10 }</code>
* Plugin user configuration defines <code>config</code> attribute as <code>{ "band": "AC/DC" }</code>
* Resulting plugin configuration, accessible to the given plugin at runtime, will be <code>{ "band": "AC/DC", "score": 10 }</code>

=== Plugin host page ===
Plugin host page is the entry point to [[#Plugin_bootstrap_sequence|plugin bootstrap process]], used to evaluate plugin code (JavaScript) within the context of the corresponding <code>iframe</code> element.

Following code snippet shows a sample plugin host page:
<pre>
<!DOCTYPE html>
<html>
<head>
<!--
        Can serve other plugin resource files just like the host page itself (1).
        <script type="text/javascript" src="/webadmin/webadmin/plugin/MyPlugin/libs/example1.js"></script>
        <script type="text/javascript" src="libs/example2.js"></script>
-->
<script>

        // Plugin bootstrap code (2).

</script>
</head>
<body>
<!--
        HTML body is intentionally empty (3).
-->
</body>
</html>
</pre>

Prior to evaluating actual plugin code, plugin host page can fetch and evaluate dependent scripts as necessary (1). Actual [[#Plugin_bootstrap_sequence|plugin bootstrap code]] is typically evaluated from within the <code>head</code> section (2). Since UI plugin infrastructure uses a hidden <code>iframe</code> element to load the plugin host page, any markup placed within the <code>body</code> section will have no effect in practice (3).

=== Plugin bootstrap sequence ===
A typical plugin bootstrap sequence consists of following steps:
* Obtain <code>pluginApi</code> instance for the given plugin
* Obtain runtime plugin configuration object (optional)
* Register relevant event handler functions
* Notify UI plugin infrastructure to proceed with plugin initialization

Following code snippet illustrates the above mentioned steps in practice:
<pre>
// Access plugin API using 'parent' due to this code being evaluated within the context of an iframe element.
// As 'parent.pluginApi' is subject to Same-Origin Policy, this will work only when WebAdmin HTML page and plugin host page are served from same origin.
var api = parent.pluginApi('MyPlugin');

// Runtime configuration object associated with the plugin (or an empty object).
var config = api.configObject();

// Register event handler functions for later invocation by the UI plugin infrastructure.
api.register({
        // UiInit event handler function.
        UiInit: function() {
                // Handle UiInit event.
                window.alert('Favorite music band is ' + config.band);
        }
});

// Notify UI plugin infrastructure to proceed with plugin initialization.
api.ready();
</pre>

=== Plugin lifecycle ===
TODO

=== Supported API functions ===
TODO part of Features/UIPluginsAPIReference
TODO don't forget screenshots

=== Supported application events ===
TODO part of Features/UIPluginsAPIReference

=== Sample UI plugins ===
TODO don't forget link to git repository

=== References ===
* [[Features/UIPluginsOriginalDesignNotes|Original design notes]]

=== Comments and discussion ===
* Refer to [[Talk:Features/UIPlugins|UI plugins discussion page]].

[[Category:Feature]]
