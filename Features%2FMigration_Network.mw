== Migration Network ==

=== Summary ===
Define a migration network role, and use such networks to carry migration data

=== Owner ===

* Name: [[User:Danken| Dan Kenigsberg]]

* Email: <danken@redhat.com>

=== Current status ===
* Not yet scheduled to a specific release
* Last updated: {{CURRENTMONTHNAME}} {{CURRENTDAY}}, {{CURRENTYEAR}}<!--This is markup for current date, do not change-->

=== Detailed Description ===
When Engine requests to migrate a VM from one node to another, the VM state (Bios, IO devices, RAM) is transferred over a TCP/IP connection that is opened from the source <tt>qemu</tt> process to the destination <tt>qemu</tt>. Currently, destination qemu listens for the incoming connection on the management IP address of the destination host. This has serious downsides: a "migration storm" may choke the destination's management interface; migration is plaintext and ovirtmgmt includes Engine which sits may sit the node cluster.

With this feature, a cluster administrator may grant the "migration" role to one of the cluster networks. Engine would use that network's IP address on the destination host when it requests a migration of a VM. With proper network setup, migration data would be separated to that network.

=== Benefit to oVirt ===
* Users would be able to define and dedicate a separate network for migration. Users that need quick migration would use nics with high bandwidth. Users who want to cap the bandwidth consumed by migration could define a migration network over nics with bandwidth limitation.
* Migration data can be limited to a separate network, that has no layer-2 access from Engine

=== Dependencies / Related Features ===
<!-- What other packages depend on this package?  Are there changes outside the developers' control on which completion of this feature depends?  In other words, completion of another feature owned by someone else and might cause you to not be able to finish on time or that you would need to coordinate? Other Features that might get affected by this feature? -->

==== Vdsm ====
The <tt>migrate</tt> verb should be extended with an additional parameter, specifying the address that the remote <tt>qemu</tt> process should listen on. A new argument is to be added to the currently-defined migration arguments:
* vmId: UUID
* dst: management address of destination host
* dstparams: hibernation volumes definition
* mode: migration/hibernation
* method: rotten legacy
* ''New'': migration uri, according to http://libvirt.org/html/libvirt-libvirt.html#virDomainMigrateToURI2 such as <tt>tcp://<ip of migration network on remote node></tt>

==== Engine ====
# Network definition.
#* A new network role - not unlike "display network" should be added.Only one migration network should be defined on a cluster.
#* If none is defined, the legacy "use ovirtmgmt for migration" behavior would apply.
#* A migration network is more likely to be a ''required'' network, but a user may opt for non-required. He may face unpleasant surprises if he wants to migrate his machine, but no candidate host has the network available.
#* The "migration" role can be granted or taken on-the-fly, when hosts are active, as long as there are no currently-migrating VMs.
# Scheduler:
#* When deciding which host should be used for automatic migration, take into account the existence and availability of the migration network on the destination host.
#* For manual migration, let user migrate a VM to a host with no migration network - if the admin wants to keep jamming the management network with migration traffic, let her.
#* Just like choosing the destination host, the user may choose a specific migration network. If host is not selected then allow to choose from cluster's networks. The default should be the cluster's migration network.
# migration verb.
#* For the a modern cluster level, with migration network defined on the destination host, an additional ''miguri'' parameter should be added to the <tt>migrate</tt> command

=== Development Phases ===
==== First phase ====
*  Add a new network role of migration network.
*  Each cluster has one, and it is the default migration network for VMs on the cluster.
*  Factory default is that ovirtmgmt is the cluster migration network.

''Target:'' oVirt -3.3

==== Second phase ====
*  Add a per-VM propery of migrationNetwork. If Null, the cluster  migrationNetwork would be used.
*  Let the user override the VM migration network in the migrate API and  in the GUI.

''Target:'' TBD

=== Documentation / External references ===

* Yuval M asking to choose a network form migration data: http://lists.ovirt.org/pipermail/users/2013-January/011301.html

=== Comments and Discussion ===

* Refer to [[Talk:Migration Network]]  <!-- This adds a link to the "discussion" tab associated with your page.  This provides the ability to have ongoing comments or conversation without bogging down the main feature page -->

[[Category:Feature]]
[[Category:Networking]]
