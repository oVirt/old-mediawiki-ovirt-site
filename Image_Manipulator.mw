The Image Manipulation is layered to allow flexibility and for maximum code reuse.
The first layer is the Repository Engine.
Repository Engines Abstract the creation, deletion and manipulation of Tags and Volumes.
The Image Manipulator uses the Repository Engines operations to compose high level Image centric operations.

=Terminology=

The algorithm uses two major object types: Tags and Volumes.
Tag is the only user facing object. They are just metadata.
Tags have the following metadata:
* ''Tag ID'' - Used to find the object.
* ''Size'' - The Logical size of the image pointed to by the tag.
* ''Mutable'' - Whether the underlying volume can be modified by an operation. This doesn't mean that the actual bits have to stay the same but rather that no operation can change the resulting disk image.
* ''Strategy'' - Help the image manipulator decide how to perform several high level operations.
* ''Options'' - Other low lever options that might affect how the image manipulator decides to perform higher level tasks.
* ''Tag Type'' - Can either be 'strong' or 'weak'. Only strong tags can be accessed by the user. Weak tags are only accessible internally.
* ''Tag State'' - Can be 'optimized', 'degraded', 'broken'. "Optimized" means that the undelying volume is operational and it's in an optimal state according to various factors. "Degraded" means that the volume is fully operational but might not perform optimally. "broken" means that the underlying volume is either incomplete or corrupted.
* ''Volume ID'' - The volID this tag is pointing to. This data is not exposed to the user.

Volumes are slabs of data and associated metadata. Volumes are accessed using a Volume ID which is unique in a repository.
Volumes are simpler objects and have the following metadata
* ''Parent'' - A Tag ID of a tag that I is a logical relative. Even though the volume might not actually need data from the parent. We keep that information for every volume.
* ''Format'' - The format with which the data is stored on the slab of data currently only "raw" and "qcow2" are supported.

=Image Repository=

Image Repositories need to supply the abilities to handle tags and volumes.
The basic interface every repository needs to implement is. All operations must be atomic!

createVolume(size, metadata) - returns an id to an already locked volume with the metadata attached.
deleteVolume(volId) - deletes the specified volume.

readVolumeMetadata(volId) - read the volume metadata.
writeVolumeMetadata(volId, metadata) - change the volume metadata.

lockVolume(volId) - try and acquire the cluster lock of the volume.
unlockVolume(volId) - release the cluster wide lock.

createTag(metadata) - creates a tag with the specified metadata.
deleteTag(tagId) - delete the specified tag.

readTag(tagId) - read the metadata stored in the specified tag.
changeTag(tagId, metadata) - Change the metadata in the tag. This replaces the entire metadata with the new object.

writeUserData(tagId, data) - attaches user data to the tag.
readUserData(tagId) - reads the userdata attached to the tag.

repos might have more specialized operations but this is the bare minimum.

=Low Lever Operations and Recovery=
All high level operations must be composed out of the following more basic operations. These operations are just basic templates and don't specify the actual content or format of the volume and assume only the most basic of functionality exists. This is a must in order to keep the higher level operations flexible.

All low level operations should be able to fail at any point and return to a consistent state without any information that is not on the domain itself.
==Basic Structure==
[[File:RepoLegend.png]]

These are operations that can be used

==Add New==
Adds a new Tag and volume that might depend on another existing Tag and Volume pair.
If the new volume has no parent assume the initial state is empty and the volume is not pointing to any tags.

# Initial state
# Create a volume using (createVolume) that points to the parent tag
# Create a weak tag pointing to the new volume
#* At this point you can start filling the volume with data, putting in the user data and other operations.
#.Change the tag from weak to strong. (Seals the deal)

[[File:im_op_add_child.png]]

==Switcheroo==
Creates a new volume and makes it the one pointed to by the existing tag and creates a new tag to point to the existing volume.
This is useful for qcow2 snapshots where the new created file is actually the new head and the old file is the new "snapshot" object.

# Initial state
# Lock base volume
# Create a weak tag pointing to base volume.
# Create a new volume pointing to the new tag.
# Change the volume ID in the original tag to point to the new volume
# Seal the deal
#* Change the new tag from weak to strong
#* Alternatively for cross domain operations, you will do an "Add New" on second domain and copy the data from the old volume between stage 3 and 4.
[[File:im_op_switch.png]]

==Delete Image==
This doesn't really delete the image but rather makes it in accessible from the outside. Whether VDSM will actually delete the bits is a while different story.

# Initial State
# Lock the volume
# Turn the tag to a weak tag

[[File:im_op_delete_image.png]]

==Delete Orphan volume==
If a volume is not reference by any tag weak of strong it can be safely deleted.

# Initial State
# Lock volume
# Delete volume

[[File:im_op_delete_oropan_volume.png]]

==Delete Weak Tip==
If a weak tah is not referenced by any volume it can be safely assume that no one will ever use it and it can be removed.

# Initial State
# Lock volume
# Delete tag

Note that you can't just roll to delete orphan without making sure the volume is actually and orphan now!

[[File:im_op_delete_weak_tip.png]]

==Delete Single Linked==
If a weak tag has only 1 dependent the two volumes can be merged and the tag removed.

# Initial State
# Lock the volume pointed to by the weak tag
# Lock the volume pointing to the tag
# Either merge up or down depending on what is best according to the data inside the volumes
# Reparent according to merge direction in previous phase

[[File:im_op_delete_single_linked.png]]

==Convert \ Replace==
This is used to either convert or replace a volume with new data.

# Initial state
# Lock original volume
# Create new volume
#* Push new data to the new volume
# Change the tag to point to the new volume. (Seals the deal)

[[File:im_op_convert_replace.png]]

==Reparent==
Sometimes the content of the volume doesn't really depend on it's immediate parent. This means that if the parent is weak we can just reparent to the grand parent so that the weak tag has as little of links as possible. This is preferable because the parent volume will only be deleted if no more then 1 volumes point to it's tag.

# Initial state
# Lock the volume you wish to reparent
# Change it's metadata (Seal the deal)

[[File:im_op_reparent.png]]
