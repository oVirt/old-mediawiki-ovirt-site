<!-- {{autolang|base=yes}} -->

== Live Merge ==

{{Feature|name=Live Merge|modules=engine,vdsm|status=Development|version=3.5.0}}

=== Summary ===
Live merge makes it possible to delete VM disk snapshots that are no longer needed while the VM continues to run.

=== Owners ===

* Name: [[User:AdamLitke| Adam Litke]] <alitke@redhat.com>
* Name: [[User:GregPadgett| Greg Padgett]] <gpadgett@redhat.com>

=== Current status ===
Design and Development underway

Patches:
* [http://gerrit.ovirt.org/#/c/25918/ LiveMerge: Add Image.getVolumeChain API]

* Last updated on {{REVISIONYEAR}}-{{REVISIONMONTH}}-{{REVISIONDAY2}} by [[User:{{urlencode:{{REVISIONUSER}} | WIKI}}]] <!--This is markup for the date on which the current page was last changed, do not change-->

=== Detailed Description ===
<!-- Expand on the summary, if appropriate.  A couple sentences suffices to explain the goal, but the more details you can provide the better. -->
Expand on the summary, if appropriate.  A couple sentences suffices to explain the goal, but the more details you can provide the better.


=== Benefit to oVirt ===
This feature hides the complexity of the Live Merge flows behind a simple clickable "Delete" button in the UI.  This results in a symmetric create/delete snapshot operations regardless of whether the VM is running or not.  This feature has been actively requested by users.

=== Dependencies / Related Features ===

==== Libvirt ====
* [https://bugzilla.redhat.com/show_bug.cgi?id=1062142 live snapshot merge (commit) of the active layer]

=== Documentation / External references ===
<!-- Is there upstream documentation on this feature, or notes you have written yourself?  Link to that material here so other interested developers can get involved. Links to RFEs. -->
Is there upstream documentation on this feature, or notes you have written yourself?  Link to that material here so other interested developers can get involved. Links to RFEs.

=== Testing ===

==== Positive flow (Create and remove a snapshot while a VM runs) ====
* In webadmin, start a VM and create a new snapshot
* Navigate to the VM's disks and for each disk, select the snapshot that was created and click the Remove button
* After a few seconds, the snapshots should be removed from the list

==== Negative flow (engine restart during live merge) ====
* Start in webadmin with a running VM that has one or more snapshots
* Remove a snapshot as in the positive flow but immediately terminate ovirt-engine
* Wait for the operation to complete by using 'vdsClient getVolumeChain' on the virt host and watching for the volume to disappear
* Restart engine
* In webadmin, confirm that the snapshot is removed
* Check that the volume associated with the snapshot has been removed from storage

==== Negative flow (vdsm restart during live merge) ====
* Start in webadmin with a running VM that has one or more snapshots
* Remove a snapshot as in the positive flow but immediately terminate vdsm
* Wait for the host to go unresponsive in the webadmin
* Restart vdsm and wait for the host to return to Up status
* In webadmin, confirm that the snapshot is removed
* Check that the volume associated with the snapshot has been removed from storage

==== Negative flow (VM crashes during live merge) ====
* Start in webadmin with a running VM that has one or more snapshots
* Remove a snapshot as in the positive flow but immediately terminate the VM
* A live merge failure event should appear in the audit log and the snapshot should remain in the list

=== Comments and Discussion ===
* Refer to [[Talk:LiveMerge]]

[[Category:Feature]]
[[Category:Template]]
