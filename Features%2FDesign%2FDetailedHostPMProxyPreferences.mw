{{autolang|base=yes}}

<!-- The actual name of your feature page should look something like: Features/YourFeatureName.  This keeps all features in the same namespace -->
= Host Power Management Proxy Preferences =

== Summary ==
<!-- A sentence or two summarizing what this feature is and what it will do.  This information is used for the overall feature summary page for each release. -->

When Power Management is defined on the Host and the host becomes non-responding , the engine will attempt to restart the Host after a graceful period is passed<br>
The Host non-responding treatment is doing the following actions <br>
   Send a Stop command 
   Wait for status 'off' 
     (controlled by FenceStopStatusDelayBetweenRetriesInSec,FenceStopStatusRetries configuration values)
   Send a Start command
   Wait for status 'on' 
     (controlled by FenceStartStatusDelayBetweenRetriesInSec,FenceStartStatusRetries configuration values)

The current implementation of PM proxy selection is based on selection of host from the data center with 'UP' status.<br>

This implementation is not robust enough, since fence action such as 'RestartVds' which is comprised of two fence actions (stop & start) might be able to complete the first action, but fails to detect a proxy for the second. In some cases the entire DC become non-responsive or even stopped. In that case no host on DC could act as a proxy.

This document describes an extension to the current proxy selection algorithm that enables each Host to define its proxy chain as a priority list.

Specifically, the local host may be chosen as a proxy for fencing operations <br>
This may be achieved by installing a full VDSM packages on the local machine of by using<br>
[http://wiki.ovirt.org/wiki/Features/Design/DetailedHostPMProxyPreferences#Local_VDSM Local VDSM]

An alternative to installing a lightweight local VDSM is writing a Fence Wrapper

== Owner ==
<!--This should link to your home wiki page so we know who you are-->
* Feature owner: [[User:emesika| Eli Mesika]]
:* GUI Component owner: [[User:emesika| Eli Mesika]]
:* REST Component owner: [[User:emesika| Eli Mesika]]
:* Engine Component owner: [[User:emesika| Eli Mesika]]
:* QA Owner: [[User:ykaul| Yaniv Kaul]] 

<!-- Include you email address that you can be reached should people want to contact you about helping with your feature, status is requested, or  technical issues need to be resolved-->
* Email: emesika@redhat.com

== Current status ==
* Target Release: 3.2
* Status: Design
* Last updated date: Nov 4 2012

== Detailed Description ==
<!-- Provide the details of the feature. What is it going to include. See the sections below. -->
<!-- New entities and changes in existing entities. -->


== CRUD ==
Adding a pm_proxy_preferences column to vds_static table.<br>
this column represents a comma separated proxy preferences lists per Host<br>
The default value for this column will be : 'engine,cluster,dc'<br>
So, if this value is for example the default value, a Host that is in non-responsive state and has Power Management configured will be fenced using first the engine then the first UP Host in Cluster then the first UP Host in the Data Center.

Modify views vds and vds_with_tags to include pm_proxy_preferences<br>
Update InsertVdsStatic and UpdateVdsStatic SPs to handle pm_proxy_preferences<br>

=== DAO ===
Adding handling of pm_proxy_preferences to <br>
VdsStaticDAODbFacadeImpl<br>
VdsDAODbFacadeImpl

=== Metadata ===
Adding test for the new pm_proxy_preferences field in VdsStaticDAOTest <br>
Adding test data in fixtures.xml

== Business Logic == 
Add pmProxyPreferences field to VdsStatic<br>
Add pmProxyPreferences field to VDS<br>

FencingExecutor::FindVdsToFence<br>
------------------------------------
Apply the logic of searching for the proxy according to the pmProxyPreferences value<br>



=== Flow ===

Start/Stop commands are passed to the Host fencing agent via a proxy machine, in this case <br>
The pm_proxy_preferences of the Host that is in non-responding state is examined<br>
for each entry in the  comma-separated values for this field we are trying to send the fencing command (Start/Stop) via the proxy<br>
In the case that the proxy is the local engine , a validation phase of checking existence of local running vdsm and installed fence-agents package is issued<br>
The first proxy on the pm_proxy_preferences chain that succeeded to execute the command takes <br>
If all proxies in the pm_proxy_preferences chain fails to execute the fencing operation , an ERROR is written to the log.

== API ==
<!-- describe changes in REST API and SDK -->

The REST API will be enhanced to include the new Proxy Preferences as follows<br>

   <host>
     <power_management>
        <proxies>
           <proxy>
             <address>1.1.1.1</address>
           </proxy>
           <proxy>
              <address>host.tlv.redhat.com</address>
           </proxy>
           <proxy>
              <predefined>engine</predefined>
           </proxy>
           <proxy>
              <predefined>cluster</predefined>
           </proxy>
          <proxy>
              <predefined>datacenter</predefined>
           </proxy>
        </proxies>
     </power_management>
  </host>

To achieve that we should do the following: <br>
in api.xsd (schema) define new elements:<br>
   ''proxy'' which contains two fields : address and predefined 
   ''proxies'' which contains a list of proxy
Add enum PreDefinedFenceType {ENGINE,CLUSTER,DATACENTER} in org.ovirt.engine.api.model package<br>
Add PreDefinedFenceType enum to capabilities (BackendCapabilitiesResource)<br>
Add enum validations<br>
Add custom mapping for these new power-management fields in HostMapper.java, for both REST-->Backend and Backend-->REST directions)<br>
Add metadata to rsdl_metadata_v-3.1.yaml

== User Experience ==
<!-- Describe user experience related issues. For example: We need a wizard for ...., the behaviour is different in the UI because ....., etc. -->

A new list will be added to the Power Management Tab when adding a new Host or modifying existing Host<br>
The list will have by default the entries : engine,cluster and DC<br>
The user may add other Host IPs or FQDNs by typing a value and pressing the ADD button<br>
The user may also use the UP and DOWN buttons to change items order inside the list(item order = priority)<br>

Assuming that engine,cluster and dc are part of each chain and only priority may changes<br>
See [http://wiki.ovirt.org/wiki/Features/Design/DetailedHostPMProxyPreferences#Open_Issues pre-defined values]  for details.

[[File:ProxyPreferences.png]]

== Installation/Upgrade ==
<!-- Describe how the feature will effect new installation or existing one. -->
Add the new pm_proxy_preferences column in the upgrade script.

=== User work-flows ===
<!-- Describe the high-level work-flows relevant to this feature. -->

== Enforcement ==


== Dependencies / Related Features and Projects ==
<!-- What other packages (RPMs) depend on this package?  Are there changes outside the developers' control on which completion of this feature depends?  -->
=== Affected oVirt projects ===

[http://wiki.ovirt.org/wiki/Features/HostPMMultipleAgents Host Power Management Multiple Agents]

== Documentation / External references ==
<!-- Is there upstream documentation on this feature, or notes you have written yourself?  Link to that material here so other interested developers can get involved. Links to RFEs. -->
[[Features/HostPMProxyPreferences]]

== Open Issues ==
<!-- Issues that we haven't decided how to take care of yet. These are issues that we need to resolve and change this document accordingly. -->

=== pre-defined values ===
Are pre-defined values applied implicitly?<br>
Meaning, if a user modified the PM Proxy Preferences to be for example only : IP1,IP2 <br>
Does this means that this is the actual chain and if both IP1 & IP2 fails to serve as proxies the Power Management operation fails?<br>
or, we should say that this actually implies IP1,IP2,engine,cluster,dc implicitly?<br>
In case of that, what should we apply if user set PM Proxy Preferences to be engine,IP1,IP2 ?<br>
Suggestion:<br>
engine,cluster,dc should be applied implicitly and missing definitions from the original default (engine,cluster.dc) will be applied using the same priority<br>
Examples:<br>
engine,IP1,IP2 => engine,IP1,IP2,cluster,dc
IP1,dc,IP2     => IP1,dc,IP2,engine,cluster


=== Local VDSM ===

In the case that engine is selected as a proxy, we may want a separate service (temporary name : local vdm) that will run on the local host and expose only the fencing functionality from VDSM<br>

This option has major affect on the effort/cost and time-line of this feature since we need to write a new service for that, package it , install it etc.

[[Category: Feature]]
