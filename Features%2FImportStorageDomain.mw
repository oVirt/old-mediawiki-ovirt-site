==Import Storage Domain ==

{{Feature|name=Import Storage Domain|modules=storage|version=|status=Design}}

=== Summary ===
Today we able to import Export Storage Domain and ISO Storage Domain, though there is no support for importing an existing Storage Domain.<BR/>
Each Storage Domain should contain the disks and the VM's OVFs<BR/>
The VM's OVF is an XML standard representing the VM configuration, including disks, VM memory, CPU and more.

=== Owner ===
* Maor Lipchuk mlipchuk@redhat.com 

=== Current status ===
* Design

====  Phase 1 - Detach Storage Domain ====
Today we can detach a Storage Domain from the DC, only if it does not contains any disks or VMs on it.<BR/>
As part of this feature, the user will be able to also detach Storage Domain which contains VMs and Disks, and re-attach it to other Data Center.<BR/><BR/>
If there will be VMs with disks on multiple Storage Domains or Template with disks on multiple Storage Domains as well the operation will fail and an event log will be presented, with the following message (see future work)  :<BR/>
 Cannot detach {Storage Domain Name}. The following VMs/Templates have disks related to the following storages {other Storage Domain Names}. Please move those disks to the {Storage Domain Name}.


==== Phase 2 - Import NFS Storage Domain ====
On import an existing Storage Domain, the engine will read the VM's OVFs from the file (Related to OVF on any domain), and the related disks of the Data Domain.<BR/>
If the file does not exists in the domain, the engine will only import the disks without the VMs and will print an appropriate event log.<BR/>
We might have a VM with disks on other Storage Domains, in that case we will add a new Storage Domain which will be named  {Data_Center_Name}_Unattached# to the Data Center.<BR/>
This dummy Storage Domain functionality will behave the same as a Storage Domain in maintenance mode.<BR/>
The disks related to this Storage Domain (Which are related to the VMs) will be shown as disabled in the GUI and will be inactive for the VM.<BR/>
The VMs could run but the inactive disks will not be part of the process.The user should confirm that the OS and the boot disk is on the active disks.<BR/>
Template Disk might be on multiple Storage Domains, in case some of the Storage Domains are unattached (isStorageExists is false), then the functionality of creating a VM from this Template will be the same as a maintenance Storage Domain.

===== ALERT of importing used Storage Domain =====
The main risk of Data Corruption that can be here, is when a user will import a Storage Domain which some other setup uses.<BR/>
To avoid this kind of Data Corruption, the engine will prompt a warning message before each import of Storage Domain with Meta Data that indicate it is already attached to a Storage Pool.


===== Importing Unattached Storage Domain =====
The user can also import an unattached Storage Domain to the Data Center, which has already disks related to it.<BR/>
Once that done we can correlate the storage GUID of the storage with the storage GUID in the Unattached Storage Domain in the DC,<BR/>
once we will found a match, the engine will run over the properties of the Storage Domain configuration (Name, path ext.) and will change the isStorageExists flag to true.


===== GUI Perspective =====
* The Import of an NFS Storage Domain, will be the similar from the GUI perspective of importing Export/ISO domain.<BR/>
The user will enter the path of the storage domain and will start the import process.<BR/>
* Unrelated disks will be disabled in the GUI


===== DB Changes =====
We will add a new column in the storage domains table which will be called isStorageExists.<BR/>
When this field is false then all the images related to it will be disabled in the GUI.

==== Phase 3 - Import block device Storage Domain ====
On import a Block Device Storage Domain,<BR/>
The user will need to input a Storage Server name or IP, the engine will then connect to all the LUNs in the Storage Server and will group by their VGs.<BR/>
Each VG represents a Storage Domain in the engine.<BR/>
Eventually the engine should have a map of maps.<BR/>
The first map will link between VG and targets. each target is also a map which link between the target and its LUNs.<BR/>

Open Question: What about external LUN disk, should it be considered as a new storage domain?<BR/>

===== GUI Perspective =====
* Once the user will decide to import a Block Device Domain, it will use a similar dialog as adding iSCSI/FC Storage Domain.<BR/>
The user will insert a Storage Server name or IP and press connect.<BR/>
Once the engine will finish connecting to all the LUNs,  the user will see a list of VG guids, when the user will mark one VG he should see at the bottom of the dialog a list of targets belongs to that VG.<BR/>
Each target will have a '+' neer it, so if the user will press it, he can see the LUNs related to it.<BR/>
* See: Future Work

Once the user finished to import the VG he chose, he should provide it a name, and the engine will read the VM's OVFs from the file (Related to OVF on any domain), and the related disks of the Data Domain.<BR/>
From that on, the same behaviour should be the same as importing from NFS as described in phase 2.

=== Permissions ===
There should not be changes is detach storage domain
Every user with permissions to create a Storage Domain on the Data Center, will be able to import a storage domain as well.

=== Future Work ===
* Detach Stroage Domain: Eventually if the user will choose all the storage domains at once then we will detach them all at once (Need to take into consideration this message could nag the user since we might always have VMs with disks on other storage domains)
* Import Storage Domain : supporting importing of iSCSI storage domain will be in later phase
* Import Storage Domain :  The user will be able to send a list of paths, and the engine will import them all at once
* Nice to have: A way to choose the VMs to import to the DC (instead automatically)
* Mock ups will be added.
* Phase 3 GUI Perspective : The user will be also able to see the LUNs as the main entity and get to know which VG it is related to.

=== Related Features ===
This feature is dependent on OVF on any domain

=== Comments and Discussion ===

* Refer to [[Talk: ImportStorageDomain ]]
