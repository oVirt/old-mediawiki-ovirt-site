=Import Storage Domain =

{{Feature|name=Import Storage Domain|modules=engine/vdsm|status=Released|version=3.5}}
This feature is part of http://www.ovirt.org/Features/ImportUnregisteredEntities

== Summary ==
Today, oVirt is able to import ISO and Export Storage Domains, however, there is no support for importing an existing Data Storage Domain.<BR/>
Each Data Storage Domain is an entity which contains disks and sometime VM's and Template's OVF.<BR/>
The OVF is an XML standard representing the VM/Template configuration, including disks, memory, CPU and more.<BR/>
Based on this information stored in the Storage Domain, we can relate the disks, VMs and Templates to any Data Center which we will relate the Storage Domain to.<BR/>
<BR/>
The usability of the feature might be useful for various use cases, the following are some of them: 
* Recover after the loss of the oVirt Engine's database.
* Transfer VMs between setups without the need to copy the data into and out of the export domain.
* Support migrating Storage Domains between DCs and between different oVirt installations.

== Owner ==
* Maor Lipchuk
* Email <mlipchuk@redhat.com>

== Current status ==
* Design

== General Functionality ==
* The feature should be fully supported from oVirt 3.5.
* The feature is dependent on both features:
 OVF_STORE disk - http://www.ovirt.org/Feature/OvfOnWantedDomains
 Detach/Attach Storage Domain - http://www.ovirt.org/Features/ImportUnregisteredEntities
* Imported Storage Domains can be attached directly to a specific Data Center or it can be imported as 'unattached', and later can be attached to a specific Data Center.
* When attaching a Storage Domain, all the entities from the OVF_STORE disk should be retrieved into the Data Base
* If there will be a Storage Domain with several OVF_STORE disks, the engine will retrieve all the unregistered entities from the newest and active OVF_STORE disk, and those entities will be presented to the user. (see [1])
* If an entity fetched from the OVF_STORE disk will be already in the unregistered_ovf_of_entities table (see http://www.ovirt.org/Features/ImportUnregisteredEntities#General_Functionality), the engine will replace the data in the unregistered_ovf_of_entities table with the VM fetched from the OVF_STORE disk.
* If a Storage Domain will not contain the OVF_STORE disk, the engine should attach the Storage Domain without any unregistered entities, and a message in the engine log should be presented.
* Once those VM/Template will be in the Data Base, the user should be able to register those entities using the import unregistered entities feature [see http://www.ovirt.org/Features/ImportUnregisteredEntities#Work_flow_for_detach_and_attach_Storage_Domain_with_entities_-_UI_flow]
* An import of a Storage Domain will not obtain a running status of a VM (Up, Powring Up, Shutting Down...) all the VMs will be registered as down.
* An import of a Storage Domain should be supported for block Storage Domain, and file Storage Domain.

=== Restrictions ===
* Attaching an imported Storage Domain can only be applied by an initialized Data Center.

=== Implementation gaps ===
[1] On the attach operation all those OVF_STORE disks should be scanned for OVF entities.<BR/> All the VMs/Templates in the OVF_STORE disks should be presented to the user as an unregistered entities which should be imported. (see [1])<BR/>
[2] The attach operation should notify the user, a warning, whether the Storage Domain is already attached to another Data Center.<BR/> The user can then choose whether to run over the meta data or neglect its operation.<BR/>
[3] On attach of a Storage Domain, the user risks a data corruption if the Storage Domain is being used by another oVirt setup, in order to avoid data corruption. Before every attach operation of a Storage Domain with a meta data indicating it is related to another Data Center, the system will prompt the user a warning message that indicates it is already attached to a Data Center.<BR/>
[4] Open Issue: We should have an indication of External LUN disk on the Lun<BR/>


===== GUI Perspective =====
===== Work flow for Import block Storage Domain - UI flow =====
On import a Block Device Storage Domain The user should do the following steps: <BR/>
1. The user should press the "import Storage Domain" button.<BR/>
2. The user should choose iSCSI or FCP type of Storage Domain.<BR/>
3. The user should provide a Storage Server name or IP, to be imported from.<BR/>
4. The engine should present the user a list of targets related to the Storage Server provided in step 3.<BR/>
5. The user should pick the targets which he knows are related to the Storage Domains he/she wants to import and press the connect button.<BR/>
6. After the engine will connect to those targets, the user should see in the bottom of the dialog a list of Storage Domains which are candidates to be imported.<BR/>
7. The user should then choose the Storage Domains which he/she wants to import and press the ok button.<BR/>
8. Once the Storage Domain has been imported, the user should attach the Storage Domain to an initialized Data Center and activate the Storage Domain.<BR/>
9. After the Storage Domain is activated, go to the Storage main tab and pick the Storage Domain which was activated a minute ago.<BR/>
10. In the same Storage main tab, the user should see two sub tabs, "Import VMs" and "Import Tempaltes", in the "Import VMs" sub tab, the user should see all the VMs which are candidates to be imported, and in the "Import Tempaltes" sub tab, there should be the same only for templates.<BR/>
11. The user can pick several VMs (or Templates), and press on the "import" button.<BR/>
12. When the "Import" button is pressed, a dialog should be opened, showing the list of all the entities the user chose to register.<BR/>
The user should choose a cluster for each entity which should be compatible for it.<BR/>
The user can also watch the entity properties (such as disks, networks) in the sub tab inside the dialog.

==== Work flow for Import File Storage Domain - UI flow ====
On import a File Device Storage Domain The user should do the following steps: <BR/>
1. The user should press the "import Storage Domain" button.<BR/>
2. The user should choose a file type domain (NFS, POSIX, etc.).<BR/>
3. The user should provide the path where this Storage exists and press on the import button.<BR/>
4. Once the Storage Domain has been imported, the user should attach the Storage Domain to an initialized Data Center and activate the Storage Domain.<BR/>
5. After the Storage Domain is activated, go to the Storage main tab and pick the Storage Domain which was activated a minute ago.<BR/>
6. In the same Storage main tab, the user should see two sub tabs, "Import VMs" and "Import Tempaltes", in the "Import VMs" sub tab, the user should see all the VMs which are candidates to be imported, and in the "Import Tempaltes" sub tab, there should be the same only for templates.<BR/>
7. The user can pick several VMs (or Templates), and press on the "import" button.<BR/>
8. When the "Import" button is pressed, a dialog should be opened, showing the list of all the entities the user chose to register.<BR/>
The user should choose a cluster for each entity which should be compatible for it.<BR/>
The user can also watch the entity properties (such as disks, networks) in the sub tab inside the dialog.

* The user flow for importing NFS Storage Domain, will be similar to importing Export/ISO domain.<BR/>
The user will enter the path of the storage domain and will start the import process.<BR/>

The following UI mockups contain guidelines for the different screens and wizards related for file Storage Domains:<BR/>
An import screen for NFS Storage Domain :<BR/>
<BR/>
[[File:ImportNFS.jpeg|600px]]
<BR/><BR/><BR/><BR/>
An import screen for POSIX Storage Domain :<BR/>
<BR/>
[[File:ImportPosix.jpeg|600px]]
<BR/><BR/><BR/><BR/>
An import screen for Gluster Storage Domain :<BR/>
<BR/>
[[File:ImportGluster.jpeg|600px]]


The following UI mockups contain guidelines for the different screens and wizards related to the block domain:<BR/>
An import screen for Fibre Channel Storage Domain :<BR/>
<BR/>
[[File:FibreChannel.png|600px]]
<BR/><BR/><BR/><BR/>
An import screen for iSCSI Storage Domain :<BR/>
<BR/>
[[File:Iscsi.jpeg|600px]]

=== Permissions ===
* No additional permissions will be added.
* The role for importing a Storage Domain should be CREATE_STORAGE_DOMAIN
Open issue: Could be also that CREATE_VM for creating VMs.

=== Future Work ===
* Detach Stroage Domain with VMs/Templates and disks: The user will be able to detach a list of Storage Domains all at once instead detaching each Storage Domain one by one.
* Import Storage Domain :  The user will be able to import a list of Storage domains all at once.
* Adding validation for checking image corruption after importing the Storage Domain. - Mainly  for sync issues with the OVF.
* Import an Export Domain as a regular Storage Domain

=== Related Bugs ===
* https://bugzilla.redhat.com/1069780
* https://bugzilla.redhat.com/1069173

=== Related Features ===
* OVF on any domain
* Quota - The user might import disks which will extend a defined Quota in DC.
This scenario is similar to when a user enforce a quota though it already been extended.
The default behaviour will treat that by letting the user still use the resources though he/she will not be able to create any more disks.
* Local Storage Domain - Should be the same behaviour as any other NFS Storage Domain.
* Gluster
* PosixFs

=== Comments and Discussion ===
* Refer to [[Talk: ImportStorageDomain ]]
