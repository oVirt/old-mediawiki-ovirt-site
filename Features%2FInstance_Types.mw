<!-- {{autolang|base=yes}} -->
 
= Instance Types =
 
== Summary ==
Enhancing oVirt template model to allow for more flexible options in creating virtual machines targeted at improving self service for the private cloud use cases.
 
* Allow administrators to define hardware profiles (“Instance Types” or “Flavours”) 
* Allow administrators to define and publish images (similar to amazon AMIs or OpenStack images)
* Allow administrators and users, based on permissions, to create virtual machines from pre-defined images and hardware profiles.
 
 
== Owner ==
 
* Name: [[User:ofrenkel|Omer Frenkel]]
* Email: [mailto:ofrenkel@redhat.com ofrenkel@redhat.com]
* Name: [[User:TJelinek|Tomas Jelinek]]
* Email: [mailto:TJelinek@redhat.com TJelinek@redhat.com]
* PM Requirements : [[User:ACathrow|Andrew Cathrow]]
* Email: [mailto:acathrow@redhat.com acathrow@redhat.com]
 
 
== Current status ==
* Target Release: 3.3
* Status: under design and discussion.
 
== Background ==
In oVirt 3.1 the template definition includes both the hardware configuration and the image
To support more cloud use cases we wish to separate the hardware configuration of the virtual machine from the actual image type.
 
In a ''cloud'' use case the typical flow involves a user selecting the hardware configuration (for example “Small”  and the image (eg. RHEL 6.3 Web server”).
 
The current model used by oVirt forces a user to select a template that includes both the hardware configuration and the image type.
 
In many cloud platforms the following concepts and terminology are used:
 
'''Instance Type (or flavor)'''<br>
Used to describe the hardware configuration of the virtual machines.<br>
For example “medium” including 1 virtual CPU and 4GB of memory.
 
'''Image'''<br>
Used to describe the virtual machine disk image. (Amazon uses the term AMI)
This is the base operating system image including applications.
The image is stateless, any changes made to the image are lost after stopping the virtual machine.<br>
For example “Windows 2008R2 with SQLServer”
 
'''Volume'''<br>
Used to describe a persistent disk that is attached to a virtual machine.
Volumes are optional - a virtual machine might run in a completely stateless fashion with no attached volumes.
 
In these environments when provisioning a virtual machine a user picks an instance type/flavor and an image, combining the two to create running instance.
 
Typically the image is stateless, when the virtual machine is stopped all changes are lost.
A user can add volumes to the virtual machines, which are persistent disks typically used as a data disk.
 
'''Template'''<br>
The old template used in the oVirt until now. 
Up to discussion: do we want to keep them or do we want to completely throw them away from the user interface?
 
== Design ==
The following table enumerates all the fields involved and also how they are related to the entities. 
 
The specific columns means:
* '''Present''': this field is present on the entity for user editing
* '''Comm''': comment for the entity
* '''Perms''': new permissions needed
* '''Adv Only''': the new VM dialog will contain a button "Advanced Options". If the field is marked as Adv Only: Y than it is visible only after clicking this button
* '''Basic User''': if the user is not an admin user, only the fields which are marked as Basic User: Y will be editable for him
* '''Marked''': if Y, it means the field is "special" and if the user changes it, the instance type will change to "custom"
* '''On Create''': default value when creating the VM
 
The specific values means:
* '''Y''': yes
* '''N''': no
* '''D''':  deprecated
* '''Not in GUI''': not directly editable from GUI. Either not editable at all or gets the value indirectly (e.g. from to selected OS)
* '''Values for On Create''': ''User'' = user is required to fill it, ''Instance'' = copied from instance, ''merge'' = merge of two or more entities (comment describes how), ''Image'' = copied from image, ''empty'' = empty
 
{| class="wikitable"
!Field name !! Description !! colspan="2"|Template !!colspan="3"|Image !!colspan="3"|Instance Type !!colspan="7"|VM
|-
! !! !! Present !! Comm !! Present !! Perms !! Comm !! Present !! Perms !! Comm !! Present !! Perms !! Adv Only !! Basic User !! Marked !! On Create !! Comm
|-
| vm_guid || Internal unique ID || N || || N || || || N || || || N || || || || || Generated || 
|-
| vm_name || name set by user for vm and template || Y || || Y || || || Y || create instance || we could autogenerate a default if not passed || Y || || N || Y || N || User || 
|-
| mem_size_mb || Memory Size || Y || || N || || || Y || create instance || || Y || || Y || Y || Y || Instance || 
|-
| vmt_guid || Internal link to template object || N || || N || || || N || || || Y || || Y || Y || N || User || If user picks custom template, than it appears on basic as well
|-
| OS || Operating System Type || Y || || Y || || || N || || || Y || || Y || Y || Y || Image || 
|-
| description || description set by user for vm and template || Y || || Y || || || Y || create instance ||  || Y || || N || Y || N || User || We could take from image if not passed
|-
| vds_group_id || vm cluster || Y || || N || || || Y || change cluster || || Y || || N || Y || N || User || 
|-
| domain || directory services domain || Y || || N || || || N || || || Y || || Y || Y || N || User || 
|-
| creation_date || internal. creation date || N || || N || || || N || || || N || || || || || ||
|-
| num_of_monitors || number of monitors || Y || || N || || || Y || || || Y || || Y || N || N || User || 
|-
| is_initialized || internal. mark if vm was syspreped || N || || N || || || N || || || N || || || || || false || 
|-
| is_auto_suspend || legacy from auto-suspend feature, not in use || D || || D || || || D || || || D || || || || || D || 
|-
| num_of_sockets || umber of sockets || Y || || N || || || Y || || || Y || || Y || Y || Y || Instance || 
|-
| cpu_per_socket || cpu per socket || Y || || N || || || Y || || || Y || || Y || Y || Y || Instance || 
|-
| usb_policy || usb policy || Y || || N || || || Y || || || Y || || Y || N || N || User || 
|-
| time_zone || time zone || Y || || N || || || N || || || Y || || Y || Y || N || User || 
|-
| is_stateless || stateless flag || Y || || N || || || N || || || Y || || N || Y || N || User || Needs to be set on per disk level as well
|-
| fail_back || legacy from fail-back feature, not in use || D || || D || || || D || || || D || || || || || D || 
|-
| dedicated_vm_for_vds || specific host for running vm || Y || || N || || || N || || || Y || || Y || Y || N || null || 
|-
| auto_startup || HA || Y || || N || || || Y || || || Y || || Y || Y || N || User || 
|-
| vm_type || vm type (server/desktop) || Y || || N || || || N || || || Y || || N || Y || N || User || 
|-
| nice_level || vm nice level || Y || || N || || || N || || || Y || || Y || N || N || User || Currently not on GUI (but present in REST). Do we want it there?
|-
| default_boot_sequence || boot sequence || Y || || N || || || Y || || || Y || || Y || Y || N || Instance || 
|-
| default_display_type || display type(SPICE, VNC)|| Y || || N || || || Y || || || Y || || Y || Y || N || Instance || 
|-
| priority || priority || Y || || N || || || Y || || || Y || || Y || Y || Y || Instance || 
|-
| iso_path || cd || Y || || Y || || || N || || || Y || || Y || Y || N || Image || 
|-
| origin || internal. where the vm was created || N || || N || || || N || || || N || || || || || Instance || 
|-
| initrd_url || boot params || Y || || Y || || || N || || || Y || || Y || Y || N || Image || 
|-
| kernel_url || boot params || Y || || Y || || || N || || || Y || || Y || Y || N || Image || 
|-
| kernel_params || boot params || Y || || Y || || || N || || || Y || || Y || Y || N || Image || Only visible when kernel url is specified in image. 
|-
| migration_support || migration support options || Y || || N || || || N || || || Y || || Y || Y || Y || true || 
|-
| userdefined_properties || custom properties || Y || || Y || || || Y || || || Y || || Y || N || N || merge || merge instance type and image by key with instance type taking priority
|-
| predefined_properties || custom properties || Y || || Y || || || Y || || || Y || || Y || N || N || merge || merge instance type and image by key with instance type taking priority
|-
| min_allocated_mem || memory guaranteed || Y || || N || || || Y || || || Y || || Y || N || Y || Instance || 
|-
| child_count || internal. for template, not in use? || N || || N || || || N || || || N || || || || || || 
|-
| quota_id || link to quota || Y || || Y || || || N || || || Y || || N || Y || N || User || Merge of template and image with image taking priority
|-
| allow_console_reconnect || allow reconnect to console || Y || || N || || || N || || || Y || console reconnect || Y || N || N || User || 
|-
| cpu_pinning || cpu pinning || N || || N || || || N || || || Y || || || || || empty || For future
|-
| is_smartcard_enabled || smartcard enabled || Y || || N || || || Y || || || Y || || Y || N || N || Instance || 
|-
| payload || payload (device, not in vm_static) || Y || || N || || || Y || || || Y || || || || || Instance || Not in GUI
|-
| thin/clone || || Y || || N || || || Y || || || Y || || Y || Y || Y || Instance || 
|-
| soundcard || payload (device, not in vm_static) || N || || N || || || Y || || || Y || || || || || Instance || Not in GUI. Setting should include soundcard type which is dependant on the OS.
|-
| Balloon || payload (device, not in vm_static) || N || || N || || || Y || || || Y || || || || || Instance || Not in GUI
|-
| network interface || binding of NIC to logical network || N || || N || || || Y || || can be empty || Y || || N || Y || N || Instance || 
|-
| instance_type_id || internal. link to vm's instance type || N || || N || || || N || || || Y || || N || Y || N || User || 
|-
| image_type_id || internal. link to vm's image type || N || || N || || || N || || || Y || || N || Y || N || User || 
|-
| host_cpu_flags || use host cpu flags || N || || N || || || N || || || N || || || || || empty || Not in GUI
|-
| db_generation || internal || N || || N || || || N || || || N || || || || ||  || Not in GUI
|-
| is_delete_protected || protection from accidental deletion || Y || || N || || || N || || || Y || || Y || Y || N || User ||
|-
| is_disabled || disabled-template (for templates only) || Y || || N || || || N || || || N || || || || || ||
|-
| vncKeyboardLayout || VNC specific keyboard layout || Y || || N || || || N || || || Y || || Y || Y || N || User ||
|-
| tunnelMigration || use libvirt-to-libvirt communication || N || || N || || || Y || || || || || || ||  || Instance || Not in GUI
|-
|}

== Entities' Details ==
=== VM ===
The "New Server" and "New Desktop" buttons in GUI will be replaced by a common '''New VM''' button with a combo box where you can choose from "Optimized for Server" and "Optimized for Desktop". 
The exact meaning this switch:
* '''Optimized for Server''': 
** does not have soundcard
** the disk image is cloned
** is not stateless
* '''Optimized for Desktop''': 
** has soundcard
** the image is used (thin allocation)
** is stateless
This are only the default values which will be present in the GUI - the user can change them.
 
The following picture shows the '''New VM''' dialog in the basic form. This are the only values required to select in order to create a new VM.
[[File:NewVmBasic.png]]
<br>
Please note the '''Assign Logical Networks''' part. It's meaning is, that the instance type defines the network interfaces. In this dialog the user is required to assign them to specific network (available on the selected cluster) or a special value called "No Network".  If "No Network" is selected, the network interface is created but is not connected to a network. The "No Network" is available only for cluser of version 3.2 or higher.
 
The following picture shows the New VM dialog after clicking the '''Show Advanced Options''' dialog.
[[File:NewVmAdvanced.png]]
<br>
After clicking the '''Show Advanced Options''' the user is prompted by the dialog above. Please note the marked fields - this are the '''Marked''' fields from the table above. If the user edits them, the instance type will change to '''custom'''.
 
After clicking OK, the user will be prompted with a screen containing the summary information about the VM the user is about to create. On this dialog he or she can either commit (click OK) and the VM will be created or decide to go back and adjust (clicking the cancel).
The summary information will contain the following:
* VM Name
* OS Type
* Memory
* Total Virtual CPUs
* Console (SPICE, VNC, RDP)
* Data Center
* Cluster

=== Image ===
Will be created from an existing VM using the '''Create Image''' - similar to the way how the templates are created today.
Opened question: Do we want them to be stateless in 3.3?
 
=== Volume ===
Opened question: Do we want this to 3.3?
 
=== Instance Types (Flavors) ===
A user should be able to create an instance type using a dialog similar to the '''New VM''' dialog. Here a user should be able to define their instance configuration.<br>
For the exact editable field please see the table above.
 
'''Predefined Instance Types'''<br><br>
A set of predefined instance types should be created. <br>
For consistency we should use the default OpenStack sizes.<br>
A user should be allowed to edit but not delete predefined instance types<br>
The administrator should be able to disable instance types.<br>
 
{| class="wikitable"
! Name !!Memory !! vCPUs
 
|-
| m1.tiny || 512 MB || 1
|-
| m1.small|| 2 GB || 1
|-
| m1.medium || 4 GB ||2
|-
| m1.large || 8 GB || 2
|-
| m1.xlarge || 16 GB || 4
|}
 
 
'''Extra Instance Metadata'''<br><br>
 
Within the design of the instance entity we should bear in mind that in the future we may need to incorporate elements from the SLA/QoS work. <br>
None of these are appropriate for the 3.3 release.<br>
 
For example adding quality of service parameters.<br>
As a point of reference OpenStack includes parameters such as “rxtx quota” that allows the administrator to cap the maximum amount of network I/O permitting (for example an ISP capping a customer to 5GB).<br>
Other use cases include specifying storage I/O priorty, network capping and throttling.<br>
 
=== Templates ===
The existing template mechanism can be used to handle ''Images''.
 
== Example User Workflow ==
This is an example of the user workflow, how the new Instance Types approach would be used.
 
1: Create a new '''Instance Type'''
: In the Templates main tab click the ''New Instance Type'' button, than fill and save the provided dialog
2: Create a new '''Image'''
: In the ''Virtual Machines'' main tab selct a VM, than click ''Create Image'' which will extract the image and the image specific configuration (similar to current ''make template'')
3: Create a new VM
: In ''Virtual Machines'' main tab click the "New VM" button. Select the data center, cluster, instance type, image and assigns the logical network to network interface, than click OK.
4: Run the created VM
5: Edit ''Instance Type'' (e.g. added more memory to it)
6: The change is reflected also on the VM after restarting it
 
== Runtime ==
 
When a virtual machine is run the complete configuration should be constructed in the following method:<br>
* The instance type is used to provide the hardware configuration for the VM.
** This setting should be applied at runtime not at configuration time
** If an instance type is updated (eg. added 2GB of memory) then the next time this VM is launched it should pickup the new instance configuration
<br>
* The operating system type and disks are taken from the Image
** If the VM is set to be stateless then the disks from the Image are set to be stateless
** Note: For stateless disks the image are applied at run time not at the time that the virtual machine was defined
** If a Image is updated then the next time a stateless VM is run from this Image then the image will be updated
 
* Extra disks that are defined at the VM level are added to the VM.
<br>
 
We should allow changing the instance type on a VM that is down<br>
* for example: changing vm from instance type 'medium' to 'large' or to 'custom' (which allow user editing all fields)<br>
* this sounds reasonable but there is a problem with some fields which are defined in instance-type,<br>
if we have defaults for server and desktops (clone disks vs. thin allocation),<br>
changing instance type will not take affect on this.
 
== Permissions ==
New permissions will be needed:
* '''Create Instance''': This permission will allow a user to create a new virtual machine from an existing instance type (but not edit the instance type itself)
* '''Instance Owner''': This permission will allow a user to:
** Add/Remove disks
** Add/Remove NICS
** Edit instance (VM) for a limited set of parameters (the "Basic User" from the table above)
 
== User Interface ==
* Templates:
** '''Templates''' main tab should remain as-is
** '''Templates''' main tab should be displayed only when selecting the '''Templates''' node below '''[DC-Name]''' in the left-pane-tree. 
Otherwise, it should be hidden (including for System).
 
* Instance Types:
** A new '''Instance Types''' main tab should be added
** A new '''Instance Types''' node should be added to the left-pane-tree under each '''[DC-Name]'''. 
** No items should exist under it (i.e. it is just a "link", just like the '''VMs''' tree-node). 
** When selected, only "Instance Types" main tab should be displayed, filtered according to the relevant DC.
** '''Instance Types''' main tab should be displayed only if the '''[DC-Name]''' tree-node is selected or if the '''Instance Types''' tree-node under '''[DC-Name]''' is selected. 
Otherwise, it should be hidden (including for System).
 
* Images:
** A new '''Images''' main tab should be added.
** A new '''Images''' node should be added to the left-pane tree under each "[DC-Name]". 
No items should exist under it (i.e. it is just a "link", just like the "VMs" tree-node). 
When selected, only "Images" main tab should be displayed, filtered according to the relevant DC.
 
* In the '''Disks''' main tab, there is an '''Images''' radio-button; this radio-button should be renamed, in order to avoid confusion.
* '''Images''' main tab should be displayed only if the '''[DC-Name]''' tree-node is selected or if the '''Images''' tree-node under '''[DC-Name]''' is selected. 
Otherwise, it should be hidden (including for System).
 
== REST API ==
TBD as soon as the specific requirements will be clarified
 
[[Category:Feature]]
[[Category:Template]]
