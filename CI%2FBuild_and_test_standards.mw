= Build and test standards =

This is the recommended setup to be able to build and test a project using the ovirt infrastructure.

== The automation directory ==

Each project in the root directory must have a subdirectory named <code>automation</code> containing the scripts and configuration files described here.

All the scripts will be run from the root directory, using a relative path, like:

<code>automation/build-artifacts.sh</code>

No parameters will be passed, and no assumptions on any preexisting environment variables should be made except for the default minimal ones (USER, PWD, ...).

== Builds ==

To build a project, you have to create a shell script (will be run with bash) named <code>build-artifacts.sh</code> inside the automation directory.

It should generate any artifacts to be archives (isos, rpms, debs, tarballs, ...) and leave them at <code>exported-artifacts/</code> directory, at the same level as the <code>automation</code> directory, in the root. The build system will collect anything left there. It must make sure that the exported-artifacts is empty if needed, or created if non-existing.

To declare package dependencies when building the artifacts, you shall create a plain text file named <code>build-artifacts.req</code> at the same level as the script, with a newline separated list of packages to install. If the packages are distribution specific, you must put them on their own requirements file, that should have the name <code>build-artifacts.req.${releasever}</code> is one of:

* fc19
* fc20
* fc21
* el6
* el7

This list will be updated with new values as new versions and distributions become available.

== Tests ==

There are two different tests/test sets that will be run on different events:
* pushing the patch to gerrit will trigger <code>check_patch.sh</code>
* merging the patch will trigger <code>check_merged.sh</code>

=== check_patch.sh ===

This script should:
* Usually only run static code analysis tools and unit tests
* no long-running tests
* focus is on giving quick feedback to the developer while working on a patchset

=== check_merged.sh ===

This script is meant to be the merge gate when merging changes to the main branch, so it should:
* run all the tests that you find required for any change to get merged, e.g. it could simply run all the tests in <code>check_patch.sh</code>
* have also some functional/other tests that require more time/resources
* It will be run less often than <code>check_patch.sh</code>

=== Dependencies ===

As with the <code>build-artifacts.sh</code> script, if you need any packages for the tests to run, you can create a generic file or releasever specific one with the packages needed listed.

=== Running parallel tests ===

In the future we might support having more than one of the above scripts, possibly in the form:

<code>check_patch.testN.sh</code>

To allow running them in parallel, for starters we only support a unique script, if you want/&amp;need any parallel execution you should handle it yourself for now.

== Extra note on dependencies ==

The tests will run on a minimal installation environment, so don't expect anything to be installed, if you are not sure if your dep is installed, declare it. Note that the distribution matrix to run the tests on is defined in the yaml  at the [[http://gerrit.ovirt.org/#/admin/projects/jenkins|| jenkins repo]].

For example, if your build scripts needs git to get the version string, add it as a dependency, if it needs autotools, maven, pep8, tox or similar, declare it too.

[[Category:CI]]
[[Category:Infrastructure]]
