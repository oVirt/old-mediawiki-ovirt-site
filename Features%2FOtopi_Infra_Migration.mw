<!-- {{autolang|base=yes}} -->

== Otopi Infra Migration ==

=== Summary ===
A complete re-write of engine-setup, engine-cleanup, engine-upgrade and AIO plugin using otopi.

=== Owner ===
* Name: [[User:Alonbl|Alon Bar-Lev]]
* Email: <alonbl@redhat.com>

* Name: [[User:Alourie| Alex Lourie]]
* Email: <alourie@redhat.com>

* Name: [[User:SandroBonazzola| Sandro Bonazzola]]
* Email: <sbonazzo@redhat.com>

=== Current status ===

* Last updated: {{CURRENTMONTHNAME}} {{CURRENTDAY}}, {{CURRENTYEAR}}<!--This is markup for current date, do not change-->

==== engine-setup ====
{| class="wikitable" border="1"
|-
! Feature
! Existing implementation
! Otopi implementation
! Owner
! Priority
! Target date
|-
| Verify that root is the user executing the script
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Allow unprivileged user ro run a development installation
|style="background-color: red;"| Not implemented
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Checking total memory
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done <ref name="memcheck" />
|[[User:SandroBonazzola| Sandro Bonazzola]]
|
|
|-
| Generate answer file
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done<ref name="generateanswer" />
|
|
|
|-
| Allow logging
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Support AIO plugin
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|Medium
|
|-
| Support FIREWALL_MANAGER option
|style="background-color: lightgreen;"| Done
|style="background-color: orange;"| In Progress
|[[User:SandroBonazzola| Sandro Bonazzola]]
|High
|
|-
| Support OVERRIDE_HTTPD_CONFIG option
|style="background-color: lightgreen;"| Done
|style="background-color: lightblue;"| Not required<ref name="noneed" />
|
|
|
|-
| Support HTTP_PORT option
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done<ref name="httpport" />
|
|
|
|-
| Support HTTPS_PORT option
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done<ref name="httpsport" />
|
|
|
|-
| Support RANDOM_PASSWORDS option
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|Medium
|
|-
| Overriding given passwords with random
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
| Medium
|
|-
| Support MAC_RANGE option
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|Medium
|
|-
| Support HOST_FQDN option
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done<ref name="fqdn" />
|
|
|
|-
| Support AUTH_PASS option
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done<ref name="authpass"/>
|
|
|
|-
| Support ORG_NAME option
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done<ref name="orgname" />
|
|
|
|-
| Support APPLICATION_MODE option
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done<ref name="appmode" />
|
|
|
|-
| Support DC_TYPE option
|style="background-color: lightgreen;"| Done
|style="background-color:red;"| Not implemented
|
|Low
|
|-
| Support DB_REMOTE_INSTALL option
|style="background-color: lightgreen;"| Done
|style="background-color: orange;"| In Progress
|
|Medium
|
|-
| Support DB_LOCAL_PASS option
|style="background-color: lightgreen;"| Done
|style="background-color: orange;"| In Progress
|
|Low
|
|-
| Support DB_HOST option
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done<ref name="dbhost" />
|
|
|
|-
| Support DB_PORT option
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done<ref name="dbport" />
|
|
|
|-
| Support DB_ADMIN option
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Support DB_REMOTE_PASS option
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Support DB_SECURE_CONNECTION option
|style="background-color: lightgreen;"| Done
|style="background-color: yellow;"| Feedback <ref name="dbsecure" />
|
|
|
|-
| Support NFS_MP option
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|[[User:SandroBonazzola| Sandro Bonazzola]]
|
|
|-
| Support ISO_DOMAIN_NAME option
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|[[User:SandroBonazzola| Sandro Bonazzola]]
|
|
|-
| Support CONFIG_NFS option
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done<ref name="confignfs" />
|[[User:SandroBonazzola| Sandro Bonazzola]]
|
|
|-
| Display summary in interactive mode
|style="background-color: lightgreen;"| Done
|style="background-color:red;"| Not implemented
|
|Low
|
|-
|Initialize MiniYum
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|Medium
|
|-
|Handle second execution warning
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|Medium
|
|-
| Handle loading and validating params from answer file
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done<ref name="answer" />
|
|
|
|-
| Mask input sets
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|Low
|
|-
| Log masked configuration
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|Low
|
|-
| Set Max Shared Memory
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Check for supported Java VM
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| CA Generation
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Extract CA fingerprint
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Extract non password key for log collector
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Extract non password key for Apache
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Extract SSH fingerprint
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Configure engine service - database
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Configure engine service - Java
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Configure engine service - Protocols
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Configure .pgpass file
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Encrypt DB Password
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Push the encrypted password into the local configuration file
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Start / Stop rhevm-etl / ovirt-engine-dwhd service when needed
|style="background-color: lightgreen;"| Done
| style="background-color: yellow;"| Feedback
|[[User:SandroBonazzola| Sandro Bonazzola]]
|
|
|-
| Start / Stop rhevm-notifierd / engine-notifierd service when needed
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|[[User:SandroBonazzola| Sandro Bonazzola]]
|
|
|-
| Upgrade engine database if already exist
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Install engine database if doesn't exist
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Set Application Mode (Both, Virt, Gluster)
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Update VDC Options
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Update default data center storage type
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|Medium
|
|-
| Configure engine-log-collector
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|[[User:SandroBonazzola| Sandro Bonazzola]]
|
|
|-
| Configure engine-iso-uploader
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|[[User:SandroBonazzola| Sandro Bonazzola]]
|
|
|-
| Configure engine-image-uploader
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|[[User:SandroBonazzola| Sandro Bonazzola]]
|
|
|-
| Configure PostgreSQL max_connections if using local DB
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|Low
|
|-
| Configure NFS exports for ISO Domain if requested
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|Medium
|
|-
| Allow importing existing NFS ISO Domain
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|[[User:SandroBonazzola| Sandro Bonazzola]]
|
|
|-
| Create new NFS ISO Domain
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done 
|[[User:SandroBonazzola| Sandro Bonazzola]]
|
|
|-
| Migrate existing NFS ISO exports from /etc/exports to /etc/exports.d/
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|[[User:SandroBonazzola| Sandro Bonazzola]]
|Low
|
|-
| Set selinux context for NFS ISO mount points
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|Medium
|
|-
| set NFS/portmap ports by overriding /etc/sysconfig/nfs
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|[[User:SandroBonazzola| Sandro Bonazzola]]
|
|
|-
| Enable the rpcbind and nfs services
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|[[User:SandroBonazzola| Sandro Bonazzola]]
|
|
|-
| Load files (iso,vfd) from existing rpms to ISO domain
|style="background-color: lightgreen;"| Done
|style="background-color: yellow;"| Feedback 
|[[User:SandroBonazzola| Sandro Bonazzola]]
|
|
|-
| Check firewall managers installed in the system
|style="background-color: lightgreen;"| Done
|style="background-color: orange;"| In Progress
|[[User:SandroBonazzola| Sandro Bonazzola]]
|High
|
|-
| Configure and enable iptables if requested
|style="background-color: lightgreen;"| Done
|style="background-color: orange;"| In Progress
|[[User:SandroBonazzola| Sandro Bonazzola]]
|High
|
|-
| Configure and enable FirewallD if requested
|style="background-color: lightgreen;"| Done
|style="background-color: orange;"| In Progress
|[[User:SandroBonazzola| Sandro Bonazzola]]
|High
|
|-
| Start / Stop Engine service when needed
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|
|
|
|-
| Enable httpd_can_network_connect selinux flag
|style="background-color: lightgreen;"| Done
|style="background-color: yellow;"| Feedback 
|[[User:Alourie| Alex Lourie]]
|
|
|-
| Backup old Apache httpd config when needed
|style="background-color: lightgreen;"| Done
|style="background-color: yellow;"| Feedback
|[[User:Alourie| Alex Lourie]]
|
|
|-
| Configure Apache mod_ssl for using  engine apache keys
|style="background-color: lightgreen;"| Done
|style="background-color: yellow;"| Feedback
|[[User:Alourie| Alex Lourie]]
|
|
|-
| Configure Apache for listening on requested HTTP port
|style="background-color: lightgreen;"| Done
|style="background-color: yellow;"| Feedback
|[[User:Alourie| Alex Lourie]]
|
|
|-
| Configure Apache for listening on requested HTTPS port
|style="background-color: lightgreen;"| Done
|style="background-color: yellow;"| Feedback
|[[User:Alourie| Alex Lourie]]
|
|
|-
| Configure Apache as proxy for the requests to the jboss service
|style="background-color: lightgreen;"| Done
|style="background-color: yellow;"| Feedback
|[[User:Alourie| Alex Lourie]]
|
|
|-
| Enable the httpd service
|style="background-color: lightgreen;"| Done
|style="background-color: yellow;"| Feedback
|[[User:Alourie| Alex Lourie]]
|
|
|-
| Enter rpm versions into yum version-lock
|style="background-color: lightgreen;"| Done
|style="background-color: lightgreen;"| Done
|[[User:Alourie| Alex Lourie]]
|
|
|-
| Add info message to the user finalizing the  successful install
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|Low
|
|-
| Print additional message to the user finalizing the  successful install
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|Low
|
|-
| Log a summary of the parameters
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|Low
|
|}
<references>
<ref name="memcheck"> The option <code>--no-mem-check</code> is now <code>--otopi-environment="OVESETUP_SYSTEM/memCheck=bool:False"</code> </ref>
<ref name="generateanswer">The option <code>--gen-answer-file</code> is now <code>--generate-answer</code> </ref>
<ref name="answer">The option <code>--answer-file</code> is now <code>--config-append</code> </ref>
<ref name="confignfs">The option <code>CONFIG_NFS=yes</code> is now <code>OVESETUP_SYSTEM/nfsConfigEnabled=bool:True</code> </ref>
<ref name="fqdn">The option <code>HOST_FQDN=host</code> is now <code>OVESETUP_CONFIG/fqdn=str:host</code> </ref>
<ref name="httpport">The option <code>HTTP_PORT=80</code> is now <code>OVESETUP_CONFIG/httpPort=int:80</code> </ref>
<ref name="httpsport">The option <code>HTTPS_PORT=443</code> is now <code>OVESETUP_CONFIG/httpsPort=int:443</code> </ref>
<ref name="appmode">The option <code>APPLICATION_MODE=both</code> is now <code>OVESETUP_CONFIG/applicationMode=str:both</code> </ref>
<ref name="orgname">The option <code>ORG_NAME=organization</code> is now <code>OVESETUP_PKI/organization=str:organization</code> </ref>
<ref name="dbhost">The option <code>DB_HOST=localhost</code> is now <code>OVESETUP_DB/host=str:localhost</code> </ref>
<ref name="dbport">The option <code>DB_PORT=5432</code> is now <code>OVESETUP_DB/port=int:5432</code> </ref>
<ref name="dbsecure">The option <code>DB_SECURE_CONNECTION=no</code> is now <code>OVESETUP_DB/secured=bool:False</code> </ref>
<ref name="authpass">The option <code>AUTH_PASS=...</code> is now <code>osetupcons.ConfigEnv.ADMIN_PASSWORD</code></ref>
<ref name="noneed">This means that the function is not required in the new code design</ref>
</references>

==== engine-cleanup ====
{| class="wikitable" border="1"
|-
! Feature
! Existing implementation
! Otopi implementation
! Owner
|-
| Verify that root is the user executing the script
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|-
| Allow unprivileged user ro run a development cleanup
|style="background-color: red;"| Not implemented
|style="background-color: red;"| Not implemented
|
|-
| Support unattended-clean option
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|-
| Support dont-drop-db option
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|-
| Support dont-remove-ca option
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|-
| Support remove-nfs-exports option
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|-
| Support remove-exported-content option
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|-
| Change working dir to the root directory
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|-
| Allow logging
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|-
| Ask user to proceed with cleanup in interactive mode
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|-
| Stop Engine service when needed
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|-
| Backup engine database if drop requested
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|-
| Drop engine database if requested
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|-
| Clean pgpass  if drop requested
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|-
| Clean sysctl configuration
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|-
| Backup CA if remove requested
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|-
| Remove CA  if requested
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|-
| Stop engine-notifierd when needed
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|-
| Clean ISO domain NFS exports if requested
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|-
| Clean ISO domain exported directories if requested
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|-
| Add info message to the user finalizing the  successful cleanup
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|-
| Add info message on where the logs are located
|style="background-color: lightgreen;"| Done
|style="background-color: red;"| Not implemented
|
|}

=== Detailed Description ===
TBD


=== Benefit to oVirt ===
*  Modular implementation, lower cost of maintenance. 
* Use of otopi API.
* Be able to port engine to other distributions.
* Be able to install engine at development mode.
* Be able to customize installation.
* Share installation of components (reports, dwh).
* Code reuse of installer code for multiple purposes (host-deploy, enigne-setup).

=== Dependencies / Related Features ===
<!-- What other packages depend on this package?  Are there changes outside the developers' control on which completion of this feature depends?  In other words, completion of another feature owned by someone else and might cause you to not be able to finish on time or that you would need to coordinate? Other Features that might get affected by this feature? -->
TBD

=== Documentation / External references ===
* [[:File:ovirt-host-deploy 3.2.pdf|Ovirt Host Deploy Presentation]]
* [https://bugzilla.redhat.com/show_bug.cgi?id=911191 Bug 911191 - Migrate ovirt-engine-setup and AIO plugin to otopi]

=== Comments and Discussion ===
* Refer to [[Talk:Features/Otopi_Infra_Migration]] 

[[Category:Feature]]
