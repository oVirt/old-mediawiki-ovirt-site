{{Feature|name=Fencing refactoring|modules=engine|status=Design|version=3.6.0}}

== Summary ==
The goal of this fencing refactoring is to clean up the code and provide those features:
* Make SSH Soft Fencing part of Non Responding Treatment
* Provide ability to enable/disable SSH Soft Fencing, Kdump detection and Power Management Restart per host

== Owner ==
* Name: Martin Pe≈ôina
* Email: mperina@redhat.com

== Detailed Description ==
* Non Responding Treatment will be executed for any host when host status is changed to '''NonResponsive''' (in oVirt <= 3.5 SSH Soft Fencing  execution is enabled for all hosts and Non Responding Treatment execution is enabled only for hosts with '''Virt''' capabilities, in oVirt 3.6 only SSH Soft Fencing step will be executed for '''Gluster''' only hosts).
* The delay between host status '''Up''' is changed to '''NonResponsive''' is defined on page [[Automatic_Fencing#Automatic_Fencing|Automatic Fencing]].
* Non Responding Treatment will contain by default 3 steps (they can be enabled/disabled per host):
*# '''SSH Soft Fencing'''
*# '''Kdump Detection'''
*# '''Power Management Restart'''

=== Database structure ===
To hold information about Non Responding Treatment steps table <tt>fence_sequence_steps</tt> will be created:
{| class="wikitable"
! style="text-align:left;"| Name
! style="text-align:left;"|Type
! style="text-align:left;"|NULL
! style="text-align:left;"|PK
! style="text-align:left;"|Description
|-
| step_name
| VARCHAR(25)
| N
| Y
| One of <tt>SSH</tt>, <tt>KDUMP</tt>, <tt>PM</tt>
|-
| vds_id
| UUID
| N
| Y
| Existing host ID
|-
| step_order
| SMALLINT
| N
| N
| Order of the step
|-
| step_enabled
| BOOLEAN
| N
| N
| 
|}
Each host will own one record in this table, which will be created during 1st host deploy or during oVirt upgrade. Also during oVirt upgrade value of existing column <tt>vds_static.pm_detect_kdump</tt> will converted into <tt>KDUMP</tt> step in <tt>fence_sequence_steps</tt> table.

=== Webadmin UI ===
New '''Fence Sequence''' tab will be added into '''Host detail''' dialog. This tab will contain check boxes for all steps to enabled/disable each step for the specific host.

=== REST API ===
<ul>
<li>Existing Fence Sequence Steps for a host can be listed using URL <tt>/api/hosts/{id}/fence-sequence-steps</tt>:
<pre>
<fence-sequence-steps>
  <fence-sequence-step>
    <name>Name</name>
    <host>Host ID</host>
    <step-order>1</step-order>
    <step-enabled>1</step-enabled>
  <fence-sequence-step>
...
</fence-sequence-steps>
</pre>
</li>
<li>To enable or disable Fence Sequence Step <tt>PUT</tt> operation using URL <tt>/api/hosts/{id}/fence-sequence-steps/{name}</tt> with parameter <tt>step-enabled</tt> can be executed.</li>
<li>Other operation like creating and removing step is not currently supported.</li>
</ul>

== Testing ==
TBD

[[Category:Feature]]
[[Category:oVirt 3.6 Proposed Feature]]
