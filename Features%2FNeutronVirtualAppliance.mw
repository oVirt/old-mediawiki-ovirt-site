<!-- {{autolang|base=yes}} -->

== Neutron Virtual Appliance ==
{{Feature|name=Neutron Virtual Appliance|modules=network|status=Development|version=3.5.0}}

=== Summary ===
oVirt engine has integrated the OpenStack Neutron service as a [[Features/OSN_Integration|network provider]]. The OpenStack network provider enables ovirt-engine to consume Neutron services.<br>
However, in order to provision Neutron services, one needs to manually deploy Neutron and Keystone services.<br>
The Neutron Virtual Appliance designed to provide an easy and simple deployment of those services.

=== Owner ===
* Name: [[User:Moti Asayag| Moti Asayag]]
* Email: <masayag@redhat.com>
* Gitweb: http://gerrit.ovirt.org/gitweb?p=ovirt-appliance.git
** Pre-release development playground: https://github.com/masayag/ovirt-appliance/

=== Detailed Description ===
The feature designed to ease the neutron services provisioning from within ovirt by reducing the overhead of installing and configuring OpenStack.<br>
For that purpose an image was created for a rapid provisioning, where the image contains all of the relevant services installed and configured with basic configuration that allows the ovirt-engine administrator with few (or more) steps to use the neutron services from ovirt.<br>
The neutron appliance for ovirt-engine 3.5 is based on the Havana-RDO which uses [https://wiki.openstack.org/wiki/Packstack Packstack] for installing OpenStack.<br> The neutron node contains the following services:
# Neutron server
# Neutron L3 Agent
# Neutron DHCP Agent
# Open vSwitch Agent
# Open vSwitch
# QPID (messaging)

=== Add OpenStack network external provider using the Neutron appliance ===
==== Create a vm based on neutron-appliance image ====
# Add new vm network (e.g. named 'neutron') named in the relevant data-center.
# Edit the 'neutron' vnic profile of the 'neutron' network to include custom properties "mac-spoof=true"
## Instructions for adding the 'mac-spoof' property can be found [https://github.com/oVirt/vdsm/tree/master/vdsm_hooks/macspoof here].
# Import the neutron-appliance image as a template (e.g. named 'neutron-appliance') from the glance.ovirt.org repository.
# Add a new VM (i.e. named 'neutron-provider') with 4GB RAM based on 'neutron-appliance' template and with 2 vnics:
## eth0 - connected to 'ovirtmgmt' (needs to communicate with ovirt-engine and with the compute nodes/hypervisors)
## eth1 - connected to 'neutron' network

==== Run the neutron server vm ====
# Install the no-macspoof hook on the host the vm is scheduled to be run on:
## yum -y install vdsm-hook-macspoof
# Run the vm with cloud-init:
## Set a root password.
## Configure a static IP address (will be referred later as NEUTRON_SERVER_IP_ADDRESS) for eth0 (which is connected to 'ovirtmgmt')
# Connect to the vm (ssh/console) and run the following to verify OpenStack services are active:
  # . /root/keystonerc_admin
  # openstack-status 

==== Configure Neutron network provider on ovirt-engine ====
# engine-config -s KeystoneAuthUrl=http://NEUTRON_SERVER_IP_ADDRESS:35357/v2.0/
# Restart the ovirt-engine
# Add external network provider with the following properties:
:* On the general left tab:
:# Type: OpenStack Network
:# Networking Plugin: Open vSwitch
:# Provider URL: http://NEUTRON_SERVER_IP_ADDRESS:9696
:# User name: neutron
:# Password: should be found by: 'grep CONFIG_NEUTRON_KS_PW /root/packstack-answers*.txt' on the neutron server vm.
:# Tenant name: services
Verify 'connectivity test' passes (by clicking the 'Test' button)
:* On the Agent Configuration left tab:
:# Bridge Mappings: vmnet:br-neutron
g:# Host: NEUTRON_SERVER_IP_ADDRESS
:# Port: 5672
:# Username: guest
:# Password: guest

==== Install a Host with the network provider ====
# Configure OpenStack repository on the host, i.e.: sudo yum install -y http://rdo.fedorapeople.org/rdo-release.rpm
# Install the host with external network provider by clicking the 'Network Provider' left tab
# Select the newly configured 'neutron' network provider and set:
## bridge_mappings = vmnet:br-neutron
# Click 'OK' to engage the installation
# After installation is successfully completed, install the no-macspoof hook:
## yum -y install vdsm-hook-macspoof
# Configure 'neutron' network on the host using the 'Setup Networks' dialog
# Run the following on the host, to connect neutron integration bridge to neutron network:
## ovs-vsctl add-port br-neutron neutron

=== Creating the image ===
Steps for creating the image and sealing it are described [https://github.com/masayag/ovirt-appliance#creating-the-image here].
Once the image is created, follow the next steps:

# Import into [https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux_OpenStack_Platform/2/html/Getting_Started_Guide/ch09s02.html glance]:
 glance image-create --name "neutron-appliance" --is-public true --disk-format qcow2 --file 93b372dc-022e-4c49-a0aa-988cb1876c18 --container-format bare
# Add 'glance' as external provider into ovirt
# Import "neutron-appliance" as a template
# Create a vm based on the "neutron-appliance" template with cloud-init (root password, nic as eth0)

=== Benefit to oVirt ===
There are two major benefits for having this feature:
# Enhance oVirt networking capabilities by Neutron services.
# Provide 'soft landing' for ovirt users in the OpenStack field.

=== Dependencies / Related Features ===
The neutron virtual appliance is provided as an image which contains:
# CentOS 6.5 (based on public CentOS-6.5 image at glance.ovirt.org)
# Havana RDO
# Cloud-init 0.7.2-2

=== Documentation / External references ===
[http://openstack.redhat.com/Docs RDO documentation]

=== Testing ===
# Create a vm based on neutron-appliance image
# Connect to the vm (ssh/console)
  # . /root/keystonerc_admin
  # neutron net-list
A list of existing networks should appear.

# Add the neutron server vm into ovirt-engine and run it.
# Add an external network provider with the vm address.
# Discover the networks of the external provider.
# Create a network 'testnet' on the provider.
# Add a subnet for that network
# Install a host with the external network provider
# Add a vm 'test1' which has a vnic connected to 'testnet'
# run vm 'test1' with cloud-init and configure its vnic for DHCP
# Verify an IP address was obtained by the vm.

==== Test neutron services ====
More scenarios can be taken from [[Features/OSN_Integration#Testing|Testing ovirt-neutron integration]]

=== Open Issues ===
* Should the default quotas as configured on the neutron server should be increased ?
 [root@localhost ~(keystone_admin)]# neutron quota-show 
 +---------------------+-------+
 | Field               | Value |
 +---------------------+-------+
 | floatingip          | 50    |
 | network             | 10    |
 | port                | 50    |
 | router              | 10    |
 | security_group      | 10    |
 | security_group_rule | 100   |
 | subnet              | 10    |
 +---------------------+-------+

* Currently, the only supported plugin is Open vSwitch plugin. Is there any need for other plugin types ?

[[Category:Feature]]
[[Category:Template]]
