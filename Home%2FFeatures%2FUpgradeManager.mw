<!-- {{autolang|base=yes}} -->

= Upgrade Manager =
{{Feature|name=Upgrade Manager|modules=engine,infra|status=To be Released|version=3.6.0}}

== Summary ==
The process of upgrading cluster/hosts to a higher version is a manual process. When working with a small cluster of hosts that suffice. However, on large clusters it is very time-consuming to upgrade all the hosts manually. The purpose of this feature is to give administrators a set of tools to know when an upgrade is available (engine/hosts), upgrade separate hosts, and upgrade cluster as a whole, using rolling upgrade process.

== Owner ==
* Name: [[User:masayag|Moti Asayag]]
* Email: <masayag@redhat.com>
* IRC: masayag at #ovirt (irc.oftc.net)

== Benefit to oVirt ==
Upgrade is a big pain point on large oVirt deployments. The existence of tools to ease the upgrade process will make it easier to adopt oVirt.

== Requirements ==
The set of tools that are in the scope of this feature are:
# Notify the user that an update for the engine is available
# Make it easier to know whether a host has an available update, and what cluster levels this update supports
# Allow the user to upgrade a specific host automatically
# Allow the user to do a rolling cluster upgrade, either to a higher cluster level, or to a new version that supports the current one

== User Experience ==
=== Notify the user that an update for the engine is available ===
After the administrator logs in to the Administrator Portal, he will get a dialog notifying on a new available update. <br/>He can choose whether to "dismiss" this notification or not.
If he chooses to dismiss it, the only other way of knowing that an update is available is by going to the "About" dialog, and looking for the information there.
<br/> 
If an update is available it will appear there. Whether there is an update or not will be checked periodically every X days.
<br/>
An event log notifying an engine upgrade is available will be logged. The admin could subscribe and be notified via one of the notification methods for this event.
<br/>

=== Make it easier to know whether a host has an available update, and what cluster levels this update supports ===
Currently, for oVirt-node, it already shows you that there is an upgrade available, by an alert on the bottom of the general sub-tab.<br/>
We can add a similar alert also for regular hosts, showing more details on the cluster level as well.<br/>
Once the host is moved to maintenance, the option to "upgrade" will be shown and enabled in the host context menu.<br/>

=== Allow the user to upgrade a specific host automatically ===
If an update is available, and the host is moved to maintenance, the option to "upgrade" will be shown and enabled in the host context menu.

=== Allow the user to do a rolling cluster upgrade, either to a higher cluster level, or to a new version that supports the current one ===
For a cluster we should add the option to "check for available upgrade". This should go on all the operational hosts, and check whether there is a new version available, and what cluster levels it supports. If there is one, the minimal and maximal supported cluster level will be shown as well.
Now, the user can upgrade to a higher cluster level, or to a higher version in the current one.<br/><br/>
Two flows here behind the scenes:<br/>
1. Same cluster level - host by host is moved to maintenance, upgraded, activated. At the end of the day the cluster itself as a whole was upgraded. There should be an easy way to see the status of this upgrade, and information for all the hosts, whether they were upgraded or not (Task list?).<br/>
2. Higher cluster level - same as #1, but upgrading the cluster levels once all hosts were upgraded.<br/>

== Implementation ==
=== Upgrade using Satellite/Katello ===
[https://access.redhat.com/products/red-hat-satellite Satellite]/[http://www.katello.org/ Katello] are content and life-cycle host managers.<br>
oVirt can leverage Satellite/Katello capabilities to monitor and update the hosts.<br> 
Satellite/Katello should be registered and configured to the relevant repositories.
Host should be registered to satellite/katello and properly configured (including katello-agent installed, subscribed to the relevant content view/environment).<br>
See the following figure for the topology:
[[File:OVirt-Katello_integration.jpg|700px]]

The satellite/katello should be registered as Foreman/Host provider in the system, as an external provider.<br>
==== Update Host Flow ====
# Add host
# Associate the host with its Content Provider (satellite/katello)
# Identify the host within the provider as content host and store its uuid (the id serves as the consumer identifier within pulp) OR resolve host within satellite/katello by its hostname using content host search api.
# Verify via the provider that ‘katello-agent’ is installed on host (to enable packages/errata installation). Without proper katello-agent, the host will not be able to report its errata, nor packages and the Satellite/katello won't be able to issue package/errata installation.
# Select the host which is registered to satellite/katello 
# Move host to maintenance
# Select ‘errata’/'content' tab of the host → show list of available errata and their description by querying errata information for the specific host from the content provider.
# Select specific or several errata to install on the host
# Send request to satellite/katello and store the task-id for monitoring the installation progress.
# Poll satellite/katello foreman-tasks until task ends.
# Activate the host

== Open Issues/Questions ==
* Support a cluster upgrade when cluster contains both RHEL and RHEV-H hosts.
** How cluster version should be determined ?
* Upgrade procedure of RHEV-H (done by selecting a specific image to upgrade)
* Upgrade path: should hosts be upgraded to the recent packages or to a specific version of them ?
** Restrict upgrade to z-stream / security-bugs ?
