{{DISPLAYTITLE:oVirt Administration Guide}}

= Introduction =

== oVirt Architecture ==

An oVirt environment consists of:

* Virtual machine '''hosts''' using the Kernel-based Virtual Machine (KVM).
* '''Agents and tools''' running on hosts including VDSM, QEMU, and libvirt. These tools provide local management for virtual machines, networks and storage.
* '''oVirt'''; a centralized management platform for the oVirt environment. It provides a graphical interface where you can view, provision and manage resources.
* '''Storage domains''' to hold virtual resources like virtual machines, templates, ISOs.
* A '''database''' to track the state of and changes to the environment.
* Access to an external '''Directory Server''' to provide users and authentication.
* '''Networking''' to link the environment together. This includes physical network links, and logical networks.

[[File:Ovirt-1024x698.png|border|600px]]

'''Figure 1.1. oVirt Platform Overview'''

== oVirt System Components ==

The oVirt version 3.4 environment consists of one or more hosts (either Red Hat Enterprise Linux 6.5 or later hosts (or similar), Fedora 19, or oVirt Node 6.5 or later hosts) and at least one instance of oVirt.

Hosts run virtual machines using KVM (Kernel-based Virtual Machine) virtualization technology.

oVirt runs on a Red Hat Enterprise Linux (or similar) server, as well as Fedora 19, and provides interfaces for controlling the oVirt environment. It manages virtual machine and storage provisioning, connection protocols, user sessions, virtual machine images, and high-availability virtual machines.

oVirt is accessed through the Administration Portal using a web browser.

== oVirt Resources ==

The components of the oVirt environment fall into two categories: physical resources, and logical resources. Physical resources are physical objects, such as host and storage servers. Logical resources are nonphysical groupings and processes, such as logical networks and virtual machine templates.

* '''Data Center''' - A data center is the highest-level container for all physical and logical resources within a managed virtual environment. It is a collection of clusters, virtual machines, storage, and networks.
* '''Clusters''' - A cluster is a set of physical hosts that are treated as a resource pool for virtual machines. Hosts in a cluster share the same network infrastructure and storage. They form a migration domain within which virtual machines can be moved from host to host.
* '''Logical Networks''' - A logical network is a logical representation of a physical network. Logical networks group network traffic and communication between oVirt, hosts, storage, and virtual machines.
* '''Hosts''' - A host is a physical server that runs one or more virtual machines. Hosts are grouped into clusters. Virtual machines can be migrated from one host to another within a cluster.
* '''Storage Pool''' - The storage pool is a logical entity that contains a standalone image repository of a certain type, either iSCSI, Fibre Channel, NFS, or POSIX. Each storage pool can contain several domains, for storing virtual machine disk images, ISO images, and for the import and export of virtual machine images.
* '''Virtual Machines''' - A virtual machine is a virtual desktop or virtual server containing an operating system and a set of applications. Multiple identical virtual machines can be created in a '''Pool'''. Virtual machines are created, managed, or deleted by power users and accessed by users.
* '''Template''' - A template is a model virtual machine with predefined settings. A virtual machine that is based on a particular template acquires the settings of the template. Using templates is the quickest way of creating a large number of virtual machines in a single step.
* '''Virtual Machine Pool''' - A virtual machine pool is a group of identical virtual machines that are available on demand by each group member. Virtual machine pools can be set up for different purposes. For example, one pool can be for the Marketing department, another for Research and Development, and so on.
* '''Snapshot''' - A snapshot is a view of a virtual machine's operating system and all its applications at a point in time. It can be used to save the settings of a virtual machine before an upgrade or installing new applications. In case of problems, a snapshot can be used to restore the virtual machine to its original state.
* '''User Types''' - oVirt supports multiple levels of administrators and users with distinct levels of permissions. System administrators can manage objects of the physical infrastructure, such as data centers, hosts, and storage. Users access virtual machines available from a virtual machine pool or standalone virtual machines made accessible by an administrator.
* '''Events and Monitors''' - Alerts, warnings, and other notices about activities help the administrator to monitor the performance and status of resources.
* '''Reports''' - A range of reports either from the reports module based on JasperReports, or from the data warehouse. Preconfigured or ad hoc reports can be generated from the reports module. Users can also generate reports using any query tool that supports SQL from a data warehouse that collects monitoring data for hosts, virtual machines, and storage.

== oVirt API Support Statement ==

oVirt exposes a number of interfaces for interacting with the components of the virtualization environment. These interfaces are in addition to the user interfaces provided by oVirt Administration, User, and Reports Portals. Many of these interfaces are fully supported. Some, however, are supported only for read access.

'''Supported Interfaces for Read and Write Access'''

Direct interaction with these interfaces is supported and encouraged for both read and write access:

; Representational State Transfer (REST) API
: The REST API exposed by oVirt is a fully supported interface for interacting with oVirt.
; Software Development Kit (SDK)
: The SDK provided by the python-sdk and java-sdk packages is a fully supported interface for interacting with oVirt.
; Command Line Shell
: The command line shell provided by the ovirt-shell package is a fully supported interface for interacting with oVirt.
; VDSM Hooks
: The creation and use of VDSM hooks to trigger modification of virtual machines based on custom properties specified in the Administration Portal is supported on oVirt hosts. The use of VDSM Hooks on virtualization hosts running oVirt Node is not currently supported.

'''Supported Interfaces for Read Access'''

Direct interaction with these interfaces is supported and encouraged only for read access. Use of these interfaces for write access is not supported:

; oVirt History Database
: Read access to oVirt history database using the database views specified in the Administration Guide is supported. Write access is ''not'' supported.
; Libvirt on Virtualization Hosts
: Read access to <code>libvirt</code> using the <code>virsh -r</code> command is a supported method of interacting with virtualization hosts. Write access is ''not'' supported.

'''Unsupported Interfaces'''

Direct interaction with these interfaces is ''not'' supported:

; The vdsClient Command
: Use of the <code>vdsClient</code> command to interact with virtualization hosts is ''not'' supported.
; oVirt Node Console
: Console access to oVirt Node outside of the provided text user interface for configuration is ''not'' supported.
; oVirt Database
: Direct access to and manipulation of oVirt database is ''not'' supported.

== Administering and Maintaining the oVirt Environment ==

The oVirt environment requires an administrator to keep it running. As an administrator, your tasks include:

* Managing physical and virtual resources such as hosts and virtual machines. This includes upgrading and adding hosts, importing domains, converting virtual machines created on foreign hypervisors, and managing virtual machine pools.
* Monitoring the overall system resources for potential problems such as extreme load on one of the hosts, insufficient memory or disk space, and taking any necessary actions (such as migrating virtual machines to other hosts to lessen the load or freeing resources by shutting down machines).
* Responding to the new requirements of virtual machines (for example, upgrading the operating system or allocating more memory).
* Managing customized object properties using tags.
* Managing searches saved as public bookmarks.
* Managing user setup and setting permission levels.
* Troubleshooting for specific users or virtual machines for overall system functionality.
* Generating general and specific reports.

= Using the Administration Portal =

== Graphical User Interface Elements ==

The oVirt Administration Portal consists of contextual panes and menus and can be used in two modes - tree mode, and flat mode. Tree mode allows you to browse the object hierarchy of a data center while flat mode allows you to view all resources across data centers in a single list. The elements of the graphical user interface are shown in the diagram below.

⁠

[[Image:Admin-portal-label.png|Key Graphical User Interface Elements]]

'''Figure 2.1. Key Graphical User Interface Elements'''

'''Key Graphical User Interface Elements'''

<ul>
<li>[[Image:Bullet1.png]]<br>'''Header'''<br>
The header bar contains the name of the currently logged in user, the '''Sign Out''' button, the '''About''' button, the '''Configure''' button, and the '''Guide''' button. The '''About''' shows information on the version of oVirt, the '''Configure''' button allows you to configure user roles, and the '''Guide''' button provides a shortcut to the book you are reading now.<br>
'''Search Bar'''<br>
The search bar allows you to build queries for finding resources such as hosts and clusters in the oVirt environment. Queries can be as simple as a list of all the hosts in the system, or more complex, such as a list of resources that match certain conditions. As you type each part of the search query, you are offered choices to assist you in building the search. The star icon can be used to save the search as a bookmark.</li>
<li>[[Image:Bullet2.png]]<br>'''System/Bookmarks/Tags Pane'''<br>
The system pane displays a navigable hierarchy of the resources in the virtualized environment. Bookmarks are used to save frequently used or complicated searches for repeated use. Bookmarks can be added, edited, or removed. Tags are applied to groups of resources and are used to search for all resources associated with that tag. The System/Bookmarks/Tags Pane can be minimized using the arrow in the upper right corner of the panel.</li>
<li>[[Image:Bullet3.png]]<br>'''Resource Tabs'''<br>
All resources can be managed using their associated tab. Moreover, the '''Events''' tab allows you to view events for each resource. The Administration Portal provides the following tabs: '''Data Centers''', '''Clusters''', '''Hosts''', '''Networks''', '''Storage''', '''Disks''', '''Virtual Machines''', '''Pools''', '''Templates''', '''Volumes''', '''Users''', and '''Events''', and a '''Dashboard''' tab if you have installed the data warehouse and reports.</li>
<li>[[Image:Bullet4.png]]<br>'''Results List'''<br>
You can perform a task on an individual item, multiple items, or all the items in the results list by selecting the items and clicking the relevant action button. Information on a selected item is displayed in the details pane.<br>
 '''Refresh Rate'''<br>
The refresh rate drop-down menu at the top of the Results List allows you to set the time, in seconds, between Administration Portal refreshes. To avoid the delay between a user performing an action and the result appearing the portal, the portal will automatically refresh upon an action or event regardless of the chosen refresh interval. You can set this interval by clicking the refresh symbol in top right of the portal.</li>
<li>[[Image:Bullet5.png]]<br>'''Details Pane'''<br>
The details pane shows detailed information about a selected item in the results list. If no items are selected, this pane is hidden. If multiple items are selected, the details pane displays information on the first selected item only.
<br> '''Alerts/Events Pane'''<br>
Below the Details pane, the '''Alerts''' tab lists all high severity events such as errors or warnings. The '''Events''' tab shows a list of events for all resources. The '''Tasks''' tab lists the currently running tasks. You can view this panel by clicking the maximize/minimize button.</li>
</ul>

<div class="alert alert-info">'''Important:''' The minimum supported resolution viewing the Administration Portal in a web browser is 1024x768. The Administration Portal will not render correctly when viewed at a lower resolution.</div>

<div class="alert alert-info">'''Note:''' In oVirt 3.4, the web user interface display has been improved to allow the Administration Portal to render correctly at low resolutions or on non-maximized windows. When resolution is too low or window space insufficient to hold all menu tabs, you are able to scroll the tabs left or right, and access a drop down menu that lists all tabs. The '''System/Bookmarks/Tags Pane''' can also be minimized to allow additional space.</div>

== Tree Mode and Flat Mode ==

The Administration Portal provides two different modes for managing your resources: tree mode and flat mode. Tree mode displays resources in a hierarchical view per data center, from the highest level of the data center down to the individual virtual machine. Working in tree mode is highly recommended for most operations.

⁠

[[Image:Tree_mode.png|Tree Mode|250px]]

'''Figure 2.2. Tree Mode'''

Flat mode allows you to search across data centers, or storage domains. It does not limit you to viewing the resources of a single hierarchy. For example, you may need to find all virtual machines that are using more than 80% CPU across clusters and data centers, or locate all hosts that have the highest utilization. Flat mode makes this possible. In addition, certain objects, such as '''Pools''' and '''Users''' are not in the data center hierarchy and can be accessed only in flat mode.

To access flat mode, click on the '''System''' item in the '''Tree''' pane on the left side of the screen. You are in flat mode if the '''Pools''' and '''Users''' resource tabs appear.

⁠

[[Image:Flat_mode.png|Flat Mode|250px]]

'''Figure 2.3. Flat Mode'''

== Using the Guide Me Facility ==

When setting up resources such as data centers and clusters, a number of tasks must be completed in sequence. The context-sensitive '''Guide Me''' window prompts for actions that are appropriate to the resource being configured. The '''Guide Me''' window can be accessed at any time by clicking the '''Guide Me''' button on the resource toolbar.

⁠

[[Image:Guide_me.png|New Data Center Guide Me Window|300px]]

'''Figure 2.4. New Data Center Guide Me Window'''

== Performing Searches in oVirt ==

The Administration Portal enables the management of thousands of resources, such as virtual machines, hosts, users, and more. To perform a search, enter the search query (free-text or syntax-based) in the search bar. Search queries can be saved as bookmarks for future reuse, so you do not have to reenter a search query each time the specific search results are needed.

<div class="alert alert-info">'''Note:''' In versions prior to oVirt 3.4, searches in the Administration Portal were case sensitive. Now, the search bar supports case insensitive searches.</div>

== Saving a Query String as a Bookmark ==

'''Summary'''

A bookmark can be used to remember a search query, and shared with other users.

⁠

'''Procedure 2.1. Saving a Query String as a Bookmark'''

<ol>
<li>Enter the desired search query in the search bar and perform the search.</li>
<li><p>Click the star-shaped '''Bookmark''' button to the right of the search bar to open the '''New Bookmark''' window.</p>
<p>⁠</p>
<p>[[Image:Bookmark.png|Bookmark Icon]]</p>
<p>'''Figure 2.5. Bookmark Icon'''</p></li>
<li>Enter the '''Name''' of the bookmark.</li>
<li>Edit the '''Search string''' field (if applicable).</li>
<li>Click '''OK''' to save the query as a bookmark and close the window.</li>
<li>The search query is saved and displays in the '''Bookmarks''' pane.</li></ol>

'''Result'''

You have saved a search query as a bookmark for future reuse. Use the '''Bookmark''' pane to find and select the bookmark.

= ⁠Data Centers =

== Introduction to Data Centers ==

A data center is a logical entity that defines the set of resources used in a specific environment. A data center is considered a container resource, in that it is comprised of logical resources, in the form of clusters and hosts; network resources, in the form of logical networks and physical NICs; and storage resources, in the form of storage domains.

A data center can contain multiple clusters, which can contain multiple hosts; it can have multiple storage domains associated to it; and it can support multiple virtual machines on each of its hosts. An oVirt environment can contain multiple data centers; the data center infrastructure allows you to keep these centers separate.

All data centers are managed from the single Administration Portal.

oVirt creates a default data center during installation. It is recommended that you do not remove the default data center; instead, set up new appropriately named data centers.

== The Storage Pool Manager ==

The Storage Pool Manager (SPM) is a role given to one of the hosts in the data center enabling it to manage the storage domains of the data center. The SPM entity can be run on any host in the data center; oVirt grants the role to one of the hosts. The SPM does not preclude the host from its standard operation; a host running as SPM can still host virtual resources.

The SPM entity controls access to storage by coordinating the metadata across the storage domains. This includes creating, deleting, and manipulating virtual disks (images), snapshots, and templates, and allocating storage for sparse block devices (on SAN). This is an exclusive responsibility: only one host can be the SPM in the data center at one time to ensure metadata integrity.

oVirt ensures that the SPM is always available. oVirt moves the SPM role to a different host if the SPM host encounters problems accessing the storage. When the SPM starts, it ensures that it is the only host granted the role; therefore it will acquire a storage-centric lease. This process can take some time.

== SPM Priority ==

The SPM role uses some of a host's available resources. The SPM priority setting of a host alters the likelihood of the host being assigned the SPM role: a host with high SPM priority will be assigned the SPM role before a host with low SPM priority. Critical virtual machines on hosts with low SPM priority will not have to contend with SPM operations for host resources.

You can change a host's SPM priority by editing the host.

== Using the Events Tab to Identify Problem Objects in Data Centers ==

The '''Events''' tab for a data center displays all events associated with that data center; events include audits, warnings, and errors. The information displayed in the results list will enable you to identify problem objects in your oVirt environment.

The '''Events''' results list has two views: Basic and Advanced. Basic view displays the event icon, the time of the event, and the description of the events. Advanced view displays these also and includes, where applicable, the event ID; the associated user, host, virtual machine, template, data center, storage, and cluster; the Gluster volume, and the correlation ID.

== Data Center Tasks ==

=== Creating a New Data Center ===

'''Summary'''

This procedure creates a data center in your virtualization environment. The data center requires a functioning cluster, host, and storage domain to operate.

<div class="alert alert-info">'''Note:''' The storage '''Type''' can be edited until the first storage domain is added to the data center. Once a storage domain has been added, the storage '''Type''' cannot be changed.

If you set the '''Compatibility Version''' as '''3.1''', it cannot be changed to '''3.0''' at a later time; version regression is not allowed.</div>

⁠

'''Procedure 3.1. Creating a New Data Center'''

# Select the '''Data Centers''' resource tab to list all data centers in the results list.
# Click '''New''' to open the '''New Data Center''' window.
# Enter the '''Name''' and '''Description''' of the data center.
# Select the storage '''Type''', '''Compatibility Version''', and '''Quota Mode''' of the data center from the drop-down menus.
# Click '''OK''' to create the data center and open the '''New Data Center - Guide Me''' window.
# The '''Guide Me''' window lists the entities that need to be configured for the data center. Configure these entities or postpone configuration by clicking the '''Configure Later''' button; configuration can be resumed by selecting the data center and clicking the '''Guide Me''' button.

'''Result'''

The new data center is added to the virtualization environment. It will remain '''Uninitialized''' until a cluster, host, and storage domain are configured for it; use '''Guide Me''' to configure these entities.

=== Explanation of Settings in the New Data Center and Edit Data Center Windows ===

The table below describes the settings of a data center as displayed in the '''New Data Center''' and '''Edit Data Center''' windows. Invalid entries are outlined in orange when you click '''OK''', prohibiting the changes being accepted. In addition, field prompts indicate the expected values or range of values.

⁠

'''Table 3.1. Data Center Properties'''

{| class="wikitable"
!width="15%"|Field
!width="85%"|Description/Action
|- style="vertical-align:top;"
|'''Name'''
|The name of the data center. This text field has a 40-character limit and must be a unique name with any combination of uppercase and lowercase letters, numbers, hyphens, and underscores.
|- style="vertical-align:top;"
|'''Description'''
|The description of the data center. This field is recommended but not mandatory.
|- style="vertical-align:top;"
|'''Type'''
|The storage type. Choose one of the following:
* '''Shared'''
* '''Local'''

The type of data domain dictates the type of the data center and cannot be changed after creation without significant disruption. Multiple types of storage domains (iSCSI, NFS, FC, POSIX, and Gluster) can be added to the same data center, though local and shared domains cannot be mixed.
|- style="vertical-align:top;"
|'''Compatibility Version'''
|The version of oVirt. Choose one of the following:
* '''3.0'''
* '''3.1'''
* '''3.2'''
* '''3.3'''
* '''3.4'''

After upgrading oVirt, the hosts, clusters and data centers may still be in the earlier version. Ensure that you have upgraded all the hosts, then the clusters, before you upgrade the Compatibility Level of the data center.
|- style="vertical-align:top;"
|'''Quota Mode'''
|Quota is a resource limitation tool provided with oVirt. Choose one of:
* '''Disabled''': Select if you do not want to implement Quota
* '''Audit''': Select if you want to edit the Quota settings
* '''Enforced''': Select to implement Quota
|}

=== Editing a Resource ===

'''Summary'''

Edit the properties of a resource.

'''Procedure 3.2. Editing a Resource'''

# Use the resource tabs, tree mode, or the search function to find and select the resource in the results list.
# Click '''Edit''' to open the '''Edit''' window.
# Change the necessary properties and click '''OK'''.

'''Result'''

The new properties are saved to the resource. The '''Edit''' window will not close if a property field is invalid.

=== Creating a New Logical Network in a Data Center or Cluster ===

'''Summary'''

Create a logical network and define its use in a data center, or in clusters in a data center.

'''Procedure 3.3. Creating a New Logical Network in a Data Center or Cluster'''

<ol>
<li>Use the '''Data Centers''' or '''Clusters''' resource tabs, tree mode, or the search function to find and select a data center or cluster in the results list.</li>
<li>Click the '''Logical Networks''' tab of the details pane to list the existing logical networks.</li>
<li>From the '''Data Centers''' details pane, click '''New''' to open the '''New Logical Network''' window.
From the '''Clusters''' details pane, click '''Add Network''' to open the '''New Logical Network''' window.</li>
<li>Enter a '''Name''', '''Description''' and '''Comment''' for the logical network.</li>
<li>In the '''Export''' section, select the '''Create on external provider''' check box to create the logical network on an external provider. Select the external provider from the '''External Provider''' drop-down menu.</li>
<li>In the '''Network Parameters''' section, select the '''Enable VLAN tagging''', '''VM network''' and '''Override MTU''' to enable these options.</li>
<li>Enter a new label or select an existing label for the logical network in the '''Network Label''' text field.</li>
<li>From the '''Cluster''' tab, select the clusters to which the network will be assigned. You can also specify whether the logical network will be a required network.</li>
<li>If the '''Create on external provider''' check box is selected, the '''Subnet''' tab will be visible. From the '''Subnet''' tab enter a '''Name''', '''CIDR''' and select an '''IP Version''' for the subnet that the logical network will provide.</li>
<li>From the '''Profiles''' tab, add vNIC profiles to the logical network as required.</li>
<li>Click '''OK'''.</li></ol>

'''Result'''

You have defined a logical network as a resource required by a cluster or clusters in the data center. If you entered a label for the logical network, it will be automatically added to all host network interfaces with that label.

<div class="alert alert-info">'''Note:''' When creating a new logical network or making changes to an existing logical network that is used as a display network, any running virtual machines that use that network must be rebooted before the network becomes available or the changes are applied.</div>

=== Removing a Logical Network ===

'''Summary'''

Remove a logical network from oVirt.

⁠'''Procedure 3.4. Removing Logical Networks'''

# Use the '''Data Centers''' resource tab, tree mode, or the search function to find and select the data center of the logical network in the results list.
# Click the '''Logical Networks''' tab in the details pane to list the logical networks in the data center.
# Select a logical network and click '''Remove''' to open the '''Remove Logical Network(s)''' window.
# Optionally, select the '''Remove external network(s) from the provider(s) as well''' check box to remove the logical network both from oVirt and from the external provider if the network is provided by an external provider.
# Click '''OK'''.

'''Result'''

The logical network is removed from oVirt and is no longer available. If the logical network was provided by an external provider and you elected to remove the logical network from that external provider, it is removed from the external provider and is no longer available on that external provider as well.

=== Re-Initializing a Data Center: Recovery Procedure ===

'''Summary'''

This recovery procedure replaces the master data domain of your data center with a new master data domain; necessary in the event of data corruption of your master data domain. Re-initializing a data center allows you to restore all other resources associated with the data center, including clusters, hosts, and non-problematic storage domains.

You can import any backup or exported virtual machines or templates into your new master data domain.

⁠

'''Procedure 3.5. Re-Initializing a Data Center'''

# Click the '''Data Centers''' resource tab and select the data center to re-initialize.
# Ensure that any storage domains attached to the data center are in maintenance mode.
# Right-click the data center and select '''Re-Initialize Data Center''' from the drop-down menu to open the '''Data Center Re-Initialize''' window.
# The '''Data Center Re-Initialize''' window lists all available (detached; in maintenance mode) storage domains. Click the radio button for the storage domain you are adding to the data center.
# Select the '''Approve operation''' check box.
# Click '''OK''' to close the window and re-initialize the data center.

'''Result'''

The storage domain is attached to the data center as the master data domain and activated. You can now import any backup or exported virtual machines or templates into your new master data domain.

=== Removing a Data Center ===

'''Summary'''

An active host is required to remove a data center. Removing a data center will not remove the associated resources.

⁠

'''Procedure 3.6. Removing a Data Center'''

# Ensure the storage domains attached to the data center is in maintenance mode.
# Click the '''Data Centers''' resource tab and select the data center to remove.
# Click '''Remove''' to open the '''Remove Data Center(s)''' confirmation window.
# Click '''OK'''.

'''Result'''

The data center has been removed.

=== Force Removing a Data Center ===

'''Summary'''

A data center becomes <code>Non Responsive</code> if the attached storage domain is corrupt or if the host becomes <code>Non Responsive</code>. You cannot '''Remove''' the data center under either circumstance.

'''Force Remove''' does not require an active host. It also permanently removes the attached storage domain.

It may be necessary to '''Destroy''' a corrupted storage domain before you can '''Force Remove''' the data center.

⁠

'''Procedure 3.7. Force Removing a Data Center'''

# Click the '''Data Centers''' resource tab and select the data center to remove.
# Click '''Force Remove''' to open the '''Force Remove Data Center''' confirmation window.
# Select the '''Approve operation''' check box.
# Click '''OK'''

'''Result'''

The data center and attached storage domain are permanently removed from the oVirt environment.

=== Changing the Data Center Compatibility Version ===

'''Summary'''

oVirt data centers have a compatibility version. The compatibility version indicates the version of oVirt that the data center is intended to be compatible with. All clusters in the data center must support the desired compatibility level.

<div class="alert alert-info">'''Note:''' To change the data center compatibility version, you must have first updated all the clusters in your data center to a level that supports your desired compatibility level.</div>

⁠

'''Procedure 3.8. Changing the Data Center Compatibility Version'''

# Click the '''Data Centers''' resource tab and select the data center to remove.
# Select the data center to change from the list displayed. If the list of data centers is too long to filter visually, then perform a search to locate the desired data center.
# Click the '''Edit''' button.
# Change the '''Compatibility Version''' to the desired value.
# Click '''OK'''.

'''Result'''

You have updated the compatibility version of the data center.

<div class="alert alert-info">'''Warning:''' Upgrading the compatibility will also upgrade all of the storage domains belonging to the data center. If you are upgrading the compatibility version from below 3.1 to a higher version, these storage domains will become unusable with versions older than 3.1.</div>

== Data Centers and Storage Domains ==

=== Attaching an Existing Data Domain to a Data Center ===

'''Summary'''

Data domains that are '''Unattached''' can be attached to a data center. The data domain must be of the same '''Storage Type''' as the data center.

⁠

'''Procedure 3.9. Attaching an Existing Data Domain to a Data Center'''

# Click the '''Data Centers''' resource tab and select the appropriate data center.
# Select the '''Storage''' tab in the details pane to list the storage domains already attached to the data center.
# Click '''Attach Data''' to open the '''Attach Storage''' window.
# Select the check box for the data domain to attach to the data center. You can select multiple check boxes to attach multiple data domains.
# Click '''OK'''.

'''Result'''

The data domain is attached to the data center and is automatically activated.

<div class="alert alert-info">'''Note:''' In oVirt 3.4, shared storage domains of multiple types (iSCSI, NFS, FC, POSIX, and Gluster) can be added to the same data center.</div>

=== Attaching an Existing ISO domain to a Data Center ===

'''Summary'''

An ISO domain that is '''Unattached''' can be attached to a data center. The ISO domain must be of the same '''Storage Type''' as the data center. Only one ISO domain can be attached to a data center.


'''Procedure 3.10. Attaching an Existing ISO Domain to a Data Center'''

# Click the '''Data Centers''' resource tab and select the appropriate data center.
# Select the '''Storage''' tab in the details pane to list the storage domains already attached to the data center.
# Click '''Attach ISO''' to open the '''Attach ISO Library''' window.
# Click the radio button for the appropriate ISO domain.
# Click '''OK'''.

'''Result'''

The ISO domain is attached to the data center and is automatically activated.

=== Attaching an Existing Export Domain to a Data Center ===

'''Summary'''

An export domain that is '''Unattached''' can be attached to a data center.

Only one export domain can be attached to a data center.

⁠

'''Procedure 3.11. Attaching an Existing Export Domain to a Data Center'''

# Click the '''Data Centers''' resource tab and select the appropriate data center.
# Select the '''Storage''' tab in the details pane to list the storage domains already attached to the data center.
# Click '''Attach Export''' to open the '''Attach Export Domain''' window.
# Click the radio button for the appropriate Export domain.
# Click '''OK'''.

'''Result'''

The Export domain is attached to the data center and is automatically activated.

=== Detaching a Storage Domain from a Data Center ===

'''Summary'''

Detaching a storage domain from a data center will stop the data center from associating with that storage domain. The storage domain is not removed from the oVirt environment; it can be attached to another data center.

Data, such as virtual machines and templates, remains attached to the storage domain.

<div class="alert alert-info">'''Note:''' The master storage, if it is the last available storage domain, cannot be removed.</div>

⁠

'''Procedure 3.12. Detaching a Storage Domain from a Data Center'''

# Click the '''Data Centers''' resource tab and select the appropriate data center.
# Select the '''Storage''' tab in the details pane to list the storage domains attached to the data center.
# Select the storage domain to detach. If the storage domain is <code>Active</code>, click '''Maintenance''' to open the '''Maintenance Storage Domain(s)''' confirmation window.
# Click '''OK''' to initiate maintenance mode.
# Click '''Detach''' to open the '''Detach Storage''' confirmation window.
# Click '''OK'''.

'''Result'''

You have detached the storage domain from the data center. It can take up to several minutes for the storage domain to disappear from the details pane.

=== Activating a Storage Domain from Maintenance Mode ===

'''Summary'''

Storage domains in maintenance mode must be activated to be used.

⁠

'''Procedure 3.13. Activating a Data Domain from Maintenance Mode'''

# Click the '''Data Centers''' resource tab and select the appropriate data center.
# Select the '''Storage''' tab in the details pane to list the storage domains attached to the data center.
# Select the appropriate storage domain and click '''Activate'''.

'''Result'''

The storage domain is activated and can be used in the data center.

= ⁠Clusters =

== Introduction to Clusters ==

A cluster is a logical grouping of hosts that share the same storage domains and have the same type of CPU (either Intel or AMD). If the hosts have different generations of CPU models, they use only the features present in all models.

Each cluster in the system must belong to a data center, and each host in the system must belong to a cluster. Virtual machines are dynamically allocated to any host in a cluster and can be migrated between them, according to policies defined on the '''Clusters''' tab and in the Configuration tool during runtime. The cluster is the highest level at which power and load-sharing policies can be defined.

Clusters run virtual machines or Red Hat Storage Servers. These two purposes are mutually exclusive: A single cluster cannot support virtualization and storage hosts together.

The oVirt platform installs a default cluster in the default data center by default during the installation process.

== Cluster Tasks ==

=== Creating a New Cluster ===

'''Summary'''

A data center can contain multiple clusters, and a cluster can contain multiple hosts. All hosts in a cluster must be of the same CPU type (Intel or AMD). It is recommended that you create your hosts before you create your cluster to ensure CPU type optimization. However, you can configure the hosts at a later time using the '''Guide Me''' button.

⁠

'''Procedure 4.1. Creating a New Cluster'''

# Select the '''Clusters''' resource tab.
# Click '''New''' to open the '''New Cluster''' window.
# Select the '''Data Center''' the cluster will belong to from the drop-down list.
# Enter the '''Name''' and '''Description''' of the cluster.
# Select the '''CPU Name''' and '''Compatibility Version''' from the drop-down lists. It is important to match the CPU processor family with the minimum CPU processor type of the hosts you intend to attach to the cluster, otherwise the host will be non-operational.
# Click the '''Optimization''' tab to select the memory page sharing threshold for the cluster, and optionally enable CPU thread handling, memory ballooning, and KSM control on the hosts in the cluster.
# Click the '''Cluster Policy''' tab to optionally configure a cluster policy, scheduler optimization settings, enable trusted service for hosts in the cluster, and enable HA Reservation.
# Click the '''Resilience Policy''' tab to select the virtual machine migration policy.
# Click the '''Console''' tab to optionally override the global SPICE proxy, if any, and specify the address of a SPICE proxy for hosts in the cluster.
# Click '''OK''' to create the cluster and open the '''New Cluster - Guide Me''' window.
# The '''Guide Me''' window lists the entities that need to be configured for the cluster. Configure these entities or postpone configuration by clicking the '''Configure Later''' button; configuration can be resumed by selecting the cluster and clicking the '''Guide Me''' button.

'''Result'''

The new cluster is added to the virtualization environment.

=== Explanation of Settings and Controls in the New Cluster and Edit Cluster Windows ===

==== General Cluster Settings Explained ====


[[Image:New_Cluster_Window.png|New Cluster window|400px]]

'''Figure 4.1. New Cluster window'''

The table below describes the settings for the '''General''' tab in the '''New Cluster''' and '''Edit Cluster''' windows. Invalid entries are outlined in orange when you click '''OK''', prohibiting the changes being accepted. In addition, field prompts indicate the expected values or range of values.

⁠

'''Table 4.1. General Cluster Settings'''

{| class="wikitable"
!width="50%"|Field
!width="50%"|Description/Action
|- style="vertical-align:top;"
|'''Data Center'''
|The data center that will contain the cluster.
|- style="vertical-align:top;"
|'''Name'''
|The name of the cluster. This text field has a 40-character limit and must be a unique name with any combination of uppercase and lowercase letters, numbers, hyphens, and underscores.
|- style="vertical-align:top;"
|'''Description'''
|The description of the cluster. This field is recommended but not mandatory.
|- style="vertical-align:top;"
|'''CPU Name'''
|The CPU type of the cluster. Choose one of:
* Intel Conroe Family
* Intel Penryn Family
* Intel Nehalem Family
* Intel Westmere Family
* Intel SandyBridge Family
* Intel Haswell Family
* AMD Opteron G1
* AMD Opteron G2
* AMD Opteron G3
* AMD Opteron G4
* AMD Opteron G5
* IBM POWER 7 v2.0
* IBM POWER 7 v2.1
* IBM POWER 7 v2.3
* IBM POWER 7+ v2.1
* IBM POWER 8 v1.0

All hosts in a cluster must run the same CPU type (Intel or AMD); this cannot be changed after creation without significant disruption. The CPU type should be set for the least powerful host. For example: an '''Intel SandyBridge''' host can attach to an '''Intel Penryn''' cluster; an '''Intel Conroe''' host cannot. Hosts with different CPU models will only use features present in all models.
|- style="vertical-align:top;"
|'''Compatibility Version'''
|The version of oVirt. Choose one of:
* 3.0
* 3.1
* 3.2
* 3.3
* 3.4

You will not be able to select a version older than the version specified for the data center.
|- style="vertical-align:top;"
|'''CPU Architecture'''
|The architecture of the cluster. Choose either:
* x86_64
*ppc64
|}

==== Optimization Settings Explained ====

Memory page sharing allows virtual machines to use up to 200% of their allocated memory by utilizing unused memory in other virtual machines. This process is based on the assumption that the virtual machines in your oVirt environment will not all be running at full capacity at the same time, allowing unused memory to be temporarily allocated to a particular virtual machine.

CPU Thread Handling allows hosts to run virtual machines with a total number of processor cores greater than number of cores in the host. This is useful for non-CPU-intensive workloads, where allowing a greater number of virtual machines to run can reduce hardware requirements. It also allows virtual machines to run with CPU topologies that would otherwise not be possible, specifically if the number of guest cores is between the number of host cores and number of host threads.

The table below describes the settings for the '''Optimization''' tab in the '''New Cluster''' and '''Edit Cluster''' windows.

⁠

'''Table 4.2. Optimization Settings'''

{| class="wikitable"
!width="50%"|Field
!width="50%"|Description/Action
|- style="vertical-align:top;"
|'''Memory Optimization'''
|* '''None - Disable memory page sharing''': Disables memory page sharing.
* '''For Server Load - Enable memory page sharing to 150%''': Sets the memory page sharing threshold to 150% of the system memory on each host.
* '''For Desktop Load - Enable memory page sharing to 200%''': Sets the memory page sharing threshold to 200% of the system memory on each host.
|- style="vertical-align:top;"
|'''CPU Threads'''
|Selecting the '''Count Threads As Cores''' check box allows hosts to run virtual machines with a total number of processor cores greater than the number of cores in the host.
The exposed host threads would be treated as cores which can be utilized by virtual machines. For example, a 24-core system with 2 threads per core (48 threads total) can run virtual machines with up to 48 cores each, and the algorithms to calculate host CPU load would compare load against twice as many potential utilized cores.
|- style="vertical-align:top;"
|'''Memory Balloon'''
|Selecting the '''Enable Memory Balloon Optimization''' check box enables memory overcommitment on virtual machines running on the hosts in this cluster. When this option is set, the Memory Overcommit Manager (MoM) will start ballooning where and when possible, with a limitation of the guaranteed memory size of every virtual machine.
To have a balloon running, the virtual machine needs to have a balloon device with relevant drivers. Each virtual machine in cluster level 3.2 and higher includes a balloon device, unless specifically removed. Each host in this cluster receives a balloon policy update when its status changes to <code>Up</code>.
It is important to understand that in some scenarios ballooning may collide with KSM. In such cases MoM will try to adjust the balloon size to minimize collisions. Additionally, in some scenarios ballooning may cause sub-optimal performance for a virtual machine. Administrators are advised to use ballooning optimization with caution.
|- style="vertical-align:top;"
|'''KSM control'''
|Selecting the '''Enable KSM''' check box enables MoM to run Kernel Same-page Merging (KSM) when necessary and when it can yield a memory saving benefit that outweighs its CPU cost.
|}

==== Resilience Policy Settings Explained ====

The resilience policy sets the virtual machine migration policy in the event of host failure. Virtual machines running on a host that unexpectedly shuts down or is put into maintenance mode are migrated to other hosts in the cluster; this migration is dependent upon your cluster policy.

<div class="alert alert-info">'''Note:''' Virtual machine migration is a network-intensive operation. For instance, on a setup where a host is running ten or more virtual machines, migrating all of them can be a long and resource-consuming process. Therefore, select the policy action to best suit your setup. If you prefer a conservative approach, disable all migration of virtual machines. Alternatively, if you have many virtual machines, but only several which are running critical workloads, select the option to migrate only highly available virtual machines.</div>

The table below describes the settings for the '''Resilience Policy''' tab in the '''New Cluster''' and '''Edit Cluster''' windows.

⁠
'''Table 4.3. Resilience Policy Settings'''

{| class="wikitable"
!width="50%"|Field
!width="50%"|Description/Action
|- style="vertical-align:top;"
|'''Migrate Virtual Machines'''
|Migrates all virtual machines in order of their defined priority.
|- style="vertical-align:top;"
|'''Migrate only Highly Available Virtual Machines'''
|Migrates only highly available virtual machines to prevent overloading other hosts.
|- style="vertical-align:top;"
|'''Do Not Migrate Virtual Machines'''
|Prevents virtual machines from being migrated.
|}

==== Cluster Policy Settings Explained ====

Cluster policies allow you to specify the usage and distribution of virtual machines between available hosts. Define the cluster policy to enable automatic load balancing across the hosts in a cluster.

⁠

[[Image:Cluster_Window_Policy.png|400px|Editing a cluster's load balancing policy.]]

'''Figure 4.2. Cluster Policy Settings: Power_Saving'''

⁠

[[Image:Cluster_Window_Policy_VM_evenly.png|400px|Editing a cluster's load balancing policy.]]

'''Figure 4.3. Cluster Policy Settings: VM_Evenly_Distributed'''

The table below describes the settings for the '''Edit Policy''' window.

⁠

'''Table 4.4. Cluster Policy Tab Properties'''

{| class="wikitable"
!width="50%"|Field/Tab
!width="50%"|Description/Action
|- style="vertical-align:top;"
|'''None'''
|Set the policy value to '''None''' to have no load or power sharing between hosts. This is the default mode.
|- style="vertical-align:top;"
|'''Evenly_Distributed'''
|Distributes the CPU processing load evenly across all hosts in the cluster. Additional virtual machines attached to a host will not start if that host has reached the defined Maximum Service Level.
|- style="vertical-align:top;"
|'''Power_Saving'''
|Distributes the CPU processing load across a subset of available hosts to reduce power consumption on underutilized hosts. Hosts with a CPU load below the low utilization value for longer than the defined time interval will migrate all virtual machines to other hosts so that it can be powered down. Additional virtual machines attached to a host will not start if that host has reached the defined high utilization value.
|- style="vertical-align:top;"
|'''VM_Evenly_Distributed'''
|Distributes virtual machines evenly between hosts based on a count of the virtual machines.
* '''HighVmCount''': Sets the maximum number of virtual machines that can run on each host. Exceeding this limit qualifies the host as overloaded.
* '''MigrationThreshold''': Defines a buffer before virtual machines are migrated from the host. It is the maximum inclusive difference in virtual machine count between the most highly-utilized host and the least-utilized host. The cluster is balanced when every host in the cluster has a virtual machine count that falls inside the migration threshold.
* '''SpmVmGrace''': Defines the number of slots for virtual machines to be reserved on SPM hosts. The SPM host will have a lower load than other hosts, so this variable defines how many fewer virtual machines than other hosts it can run.

The cluster is considered unbalanced if any host is running more virtual machines than the '''HighVmCount''' and there is at least one host with a virtual machine count that falls outside of the '''MigrationThreshold'''.
|- style="vertical-align:top;"
|'''CpuOverCommitDurationMinutes'''
|Sets the time (in minutes) that a host can run a CPU load outside of the defined utilization values before the cluster policy takes action. The defined time interval protects against temporary spikes in CPU load activating cluster policies and instigating unnecessary virtual machine migration. Maximum two characters.
|- style="vertical-align:top;"
|'''HighUtilization'''
|Expressed as a percentage. If the host runs with CPU usage at or above the high utilization value for the defined time interval, oVirt migrates virtual machines to other hosts in the cluster until the host's CPU load is below the maximum service threshold.
|- style="vertical-align:top;"
|'''LowUtilization'''
|Expressed as a percentage. If the host runs below the low utilization value for the defined time interval, oVirt will migrate virtual machines to other hosts in the cluster. oVirt will power down the original host machine, and restart it again when load balancing requires or there are not enough free hosts in the cluster.
|- style="vertical-align:top;"
|'''Scheduler Optimization'''
|Optimize scheduling for host weighing/ordering.
* '''Optimize for Utilization''': Includes weight modules in scheduling to allow best selection.
* '''Optimize for Speed''': Skips host weighting in cases where there are more than ten pending requests.
|- style="vertical-align:top;"
|'''Enable Trusted Service'''
|Enable integration with an OpenAttestation server. Before this can be enabled, use the <code>engine-config</code> tool to enter the OpenAttestation server's details.
|- style="vertical-align:top;"
|'''Enable HA Reservation'''
|Enable oVirt to monitor cluster capacity for highly available virtual machines. oVirt ensures that appropriate capacity exists within a cluster for virtual machines designated as highly available to migrate in the event that their existing host fails unexpectedly.
|}

When a host's free memory drops below 20%, ballooning commands like <code>mom.Controllers.Balloon - INFO Ballooning guest:half1 from 1096400 to 1991580</code> are logged to <code>/var/log/vdsm/mom.log</code>. <code>/var/log/vdsm/mom.log</code> is the Memory Overcommit Manager log file.

==== Cluster Console Settings Explained ====

The following table details the information required on the '''Console''' tab of the '''New Cluster''' or '''Edit Cluster''' window.

⁠

'''Table 4.5. Console settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''Define SPICE Proxy for Cluster'''
|Select this check box to enable overriding the SPICE proxy defined in global configuration. This feature is useful in a case where the user (who is, for example, connecting via the User Portal) is outside of the network where the hypervisors reside.
|- style="vertical-align:top;"
|'''Overridden SPICE proxy address'''
|The proxy by which the SPICE client will connect to virtual machines. The address must be in the following format:
<pre class="screen">protocol://[host]:[port]</pre>
|}

=== Editing a Resource ===

'''Summary'''

Edit the properties of a resource.

⁠

'''Procedure 4.2. Editing a Resource'''

# Use the resource tabs, tree mode, or the search function to find and select the resource in the results list.
# Click '''Edit''' to open the '''Edit''' window.
# Change the necessary properties and click '''OK'''.

'''Result'''

The new properties are saved to the resource. The '''Edit''' window will not close if a property field is invalid.

=== Setting Load and Power Management Policies for Hosts in a Cluster ===

'''Summary'''

Cluster policies allow you to specify acceptable CPU usage values, both high and low, and what happens when those levels are reached. Define the cluster policy to enable automatic load balancing across the hosts in a cluster.

A host with CPU usage that exceeds the '''HighUtilization''' value will reduce its CPU processor load by migrating virtual machines to other hosts.

A host with CPU usage below its '''LowUtilization''' value will migrate all of its virtual machines to other hosts so it can be powered down until such time as it is required again.

⁠

'''Procedure 4.3. Setting Load and Power Management Policies for Hosts'''

<ol>
<li>Use the resource tabs, tree mode, or the search function to find and select the cluster in the results list.</li>
<li><p>Click the '''Edit''' button to open the '''Edit Cluster''' window.</p>
<p>⁠</p>
<p>[[Image:Edit_Cluster_Window_Policy.png|400px|Edit Cluster Policy]]</p>
<p>'''Figure 4.4. Edit Cluster Policy'''</p></li>
<li>Select one of the following policies:
<ul>
<li>'''None'''</li>
<li>'''VM_Evenly_Distributed''' - Enter the maximum number of virtual machines that can run on each host in '''HighVmCount''' field.</li>
<li>'''Evenly_Distributed''' - Enter CPU utilization percentage at which virtual machines start migrating to other hosts in the '''HighUtilization''' text field.</li>
<li>'''Power Saving''' - Enter the CPU utilization percentage below which the host will be considered under-utilized in the '''LowUtilization''' text field. Enter the CPU utilization percentage at which virtual machines start migrating to other hosts in the '''HighUtilization''' text field</li></ul>
</li>
<li>Specify the time interval in minutes at which the selected policy will be triggered in the '''CpuOverCommitDurationMinutes''' text field.</li>
<li>If you are using an OpenAttestation server to verify your hosts, and have set up the server's details using the <code>engine-config</code> tool, select the '''Enable Trusted Service''' check box.</li>
<li>Click '''OK'''.</li></ol>

'''Result'''

You have updated the cluster policy for the cluster.

=== Creating a New Logical Network in a Data Center or Cluster ===

'''Summary'''

Create a logical network and define its use in a data center, or in clusters in a data center.

⁠

'''Procedure 4.4. Creating a New Logical Network in a Data Center or Cluster'''

<ol>
<li>Use the '''Data Centers''' or '''Clusters''' resource tabs, tree mode, or the search function to find and select a data center or cluster in the results list.</li>
<li>Click the '''Logical Networks''' tab of the details pane to list the existing logical networks.</li>
<li>From the '''Data Centers''' details pane, click '''New''' to open the '''New Logical Network''' window.
From the '''Clusters''' details pane, click '''Add Network''' to open the '''New Logical Network''' window.</li>
<li>Enter a '''Name''', '''Description''' and '''Comment''' for the logical network.</li>
<li>In the '''Export''' section, select the '''Create on external provider''' check box to create the logical network on an external provider. Select the external provider from the '''External Provider''' drop-down menu.</li>
<li>In the '''Network Parameters''' section, select the '''Enable VLAN tagging''', '''VM network''' and '''Override MTU''' to enable these options.</li>
<li>Enter a new label or select an existing label for the logical network in the '''Network Label''' text field.</li>
<li>From the '''Cluster''' tab, select the clusters to which the network will be assigned. You can also specify whether the logical network will be a required network.</li>
<li>If the '''Create on external provider''' check box is selected, the '''Subnet''' tab will be visible. From the '''Subnet''' tab enter a '''Name''', '''CIDR''' and select an '''IP Version''' for the subnet that the logical network will provide.</li>
<li>From the '''Profiles''' tab, add vNIC profiles to the logical network as required.</li>
<li>Click '''OK'''.</li></ol>

'''Result'''

You have defined a logical network as a resource required by a cluster or clusters in the data center. If you entered a label for the logical network, it will be automatically added to all host network interfaces with that label.

<div class="alert alert-info">'''Note:''' When creating a new logical network or making changes to an existing logical network that is used as a display network, any running virtual machines that use that network must be rebooted before the network becomes available or the changes are applied.</div>

=== Removing a Cluster ===

'''Summary'''

Move all hosts out of a cluster before removing it.

<div class="alert alert-info">'''Note:''' You cannot remove the '''Default''' cluster, as it holds the '''Blank''' template. You can however rename the '''Default''' cluster and add it to a new data center.</div>

⁠

'''Procedure 4.5. Removing a Cluster'''

# Use the resource tabs, tree mode, or the search function to find and select the cluster to be removed in the results list.
# Ensure there are no hosts in the cluster.
# Click '''Remove''' to open the '''Remove Cluster(s)''' confirmation window.
# Click '''OK'''

'''Result'''

The cluster is removed.

=== Designate a Specific Traffic Type for a Logical Network with the Manage Networks Window ===

'''Summary'''

Specify the traffic type for the logical network to optimize the network traffic flow.

⁠

'''Procedure 4.6. Assigning or Unassigning a Logical Network to a Cluster'''

<ol>
<li>Use the '''Clusters''' resource tab, tree mode, or the search function to find and select the cluster in the results list.</li>
<li>Select the '''Logical Networks''' tab in the details pane to list the logical networks assigned to the cluster.</li>
<li><p>Click '''Manage Networks''' to open the '''Manage Networks''' window.</p>
<p>⁠</p>
<p>[[Image:Manage_Networks.png|400px|The Manage Networks window]]</p>
<p>'''Figure 4.5. Manage Networks'''</p></li>
<li>Select appropriate check boxes.</li>
<li>Click '''OK''' to save the changes and close the window.</li></ol>

'''Result'''

You have optimized the network traffic flow by assigning a specific type of traffic to be carried on a specific logical network.

<div class="alert alert-info">'''Note:''' Networks offered by external providers cannot be used as display networks.</div>

=== Explanation of Settings in the Manage Networks Window ===

The table below describes the settings for the '''Manage Networks''' window.

⁠

'''Table 4.6. Manage Networks Settings'''

{| class="wikitable"
!width="50%"|Field
!width="50%"|Description/Action
|- style="vertical-align:top;"
|'''Assign'''
|Assigns the logical network to all hosts in the cluster.
|- style="vertical-align:top;"
|'''Required'''
|A Network marked &quot;required&quot; must remain operational in order for the hosts associated with it to function properly. If a required network ceases to function, any hosts associated with it become non-operational.
|- style="vertical-align:top;"
|'''VM Network'''
|A logical network marked &quot;VM Network&quot; carries network traffic relevant to the virtual machine network.
|- style="vertical-align:top;"
|'''Display Network'''
|A logical network marked &quot;Display Network&quot; carries network traffic relevant to SPICE and to the virtual network controller.
|- style="vertical-align:top;"
|'''Migration Network'''
|A logical network marked &quot;Migration Network&quot; carries virtual machine and storage migration traffic.
|}

=== Changing the Cluster Compatibility Version ===

'''Summary'''

oVirt clusters have a compatibility version. The cluster compatibility version indicates the features of oVirt supported by all of the hosts in the cluster. The cluster compatibility is set according to the version of the least capable host operating system in the cluster.

<div class="alert alert-info">'''Note:''' To change the cluster compatibility version, you must have first updated all the hosts in your cluster to a level that supports your desired compatibility level.</div>

⁠

'''Procedure 4.7. Changing the Cluster Compatibility Version'''

# Use the '''Clusters''' resource tab, tree mode, or the search function to find and select the cluster in the results list.
# Click the '''Edit''' link. The Edit Cluster window will open.
# Change the '''Compatibility Version''' to the desired value.
# Click '''OK''' to open the '''Change Cluster Compatibility Version''' confirmation window.
# Click '''OK''' to confirm.

'''Result'''

You have updated the compatibility version of the cluster. Once you have updated the compatibility version of all clusters in a data center, then you are also able to change the compatibility version of the data center itself.

<div class="alert alert-info">'''Warning:''' Upgrading the compatibility will also upgrade all of the storage domains belonging to the data center. If you are upgrading the compatibility version from below 3.1 to a higher version, these storage domains will become unusable with versions older than 3.1.</div>

= Logical Networks =

== Introduction to Logical Networks ==

A logical network is a named set of global network connectivity properties in your data center. When a logical network is added to a host, it may be further configured with host-specific network parameters. Logical networks optimize network flow by grouping network traffic by usage, type, and requirements.

Logical networks allow both connectivity and segregation. You can create a logical network for storage communication to optimize network traffic between hosts and storage domains, a logical network specifically for all virtual machine traffic, or multiple logical networks to carry the traffic of groups of virtual machines.

The default logical network in all data centers is the management network called <code>ovirtmgmt</code>. The <code>ovirtmgmt</code> network carries all traffic, until another logical network is created. It is meant especially for management communication between oVirt and hosts.

A logical network is a data center level resource; creating one in a data center makes it available to the clusters in a data center. A logical network that has been designated a '''Required''' must be configured in all of a cluster's hosts before it is operational. '''Optional networks''' can be used by any host they have been added to.

<div class="alert alert-info">'''Warning:''' Do not change networking in a data center or a cluster if any hosts are running as this risks making the host unreachable.</div>

<div class="alert alert-info">'''Important:''' If you plan to use oVirt nodes to provide any services, remember that the services will stop if the oVirt environment stops operating.

This applies to all services, but you should be especially aware of the hazards of running the following on oVirt:

* Directory Services
* DNS
* Storage</div>

== Port Mirroring ==

Port mirroring copies layer 3 network traffic on a given logical network and host to a virtual interface on a virtual machine. This virtual machine can be used for network debugging and tuning, intrusion detection, and monitoring the behavior of other virtual machines on the same host and logical network.

The only traffic copied is internal to one logical network on one host. There is no increase on traffic on the network external to the host; however a virtual machine with port mirroring enabled uses more host CPU and RAM than other virtual machines.

Enable and disable port mirroring by editing network interfaces on virtual machines.

Port mirroring requires an IPv4 IP address.

Hotplugging profiles with port mirroring is not supported.

As of oVirt 3.4, port mirroring has been included in vNIC profiles. Port mirroring cannot be altered when the vNIC profile associated with port mirroring is attached to a virtual machine. To use port mirroring, create a dedicated vNIC profile that has port mirroring enabled.

<div class="alert alert-info">'''Important:''' Enabling port mirroring reduces the privacy of other network users.</div>

== Required Networks, Optional Networks, and Virtual Machine Networks ==

oVirt 3.1 and higher distinguishes between required networks and optional networks.

'''Required''' networks must be applied to all hosts in a cluster for the cluster and network to be '''Operational'''. Logical networks are added to clusters as '''Required''' networks by default.

When a required network becomes non-operational, the virtual machines running on the network are fenced and migrated to another host. This is beneficial if you have machines running mission critical workloads.

When a non-required network becomes non-operational, the virtual machines running on the network are not migrated to another host. This prevents unnecessary I/O overload caused by mass migrations.

Optional networks are those logical networks that have not been explicitly declared '''Required''' networks. Optional networks can be implemented on only the hosts that use them. The presence or absence of these networks does not affect the '''Operational''' status of a host.

Use the '''Manage Networks''' button to change a network's '''Required''' designation.

Virtual machine networks (called a '''VM network''' in the user interface) are logical networks designated to carry only virtual machine network traffic. Virtual machine networks can be required or optional.

<div class="alert alert-info">'''Note:''' A virtual machine with a network interface on an optional virtual machine network will not start on a host without the network.</div>

== vNIC Profiles and QoS ==

=== vNIC Profile Overview ===

A Virtual Network Interface Card (vNIC) profile is a collection of settings that can be applied to individual virtual network interface cards in oVirt. vNIC profiles allow you to apply Network QoS profiles to a vNIC, enable or disable port mirroring, and add or remove custom properties. vNIC profiles offer an added layer of administrative flexibility in that permission to use (consume) these profiles can be granted to specific users. In this way, you can control the quality of service that different users receive from a given network.

<div class="alert alert-info">'''Note:''' Starting with oVirt 3.3, virtual machines now access logical networks only through vNIC profiles and cannot access a logical network if no vNIC profiles exist for that logical network. When you create a new logical network in oVirt, a vNIC profile of the same name as the logical network is automatically created under that logical network.</div>

=== Creating a vNIC Profile ===

'''Summary'''

Create a Virtual Network Interface Controller (vNIC) profile to regulate network bandwidth for users and groups.


'''Procedure 5.1. Creating a vNIC Profile'''

<ol>
<li>Use the '''Networks''' resource tab, tree mode, or the search function to select a logical network in the results pane.</li>
<li>Select the '''Profiles''' tab in the details pane to display available vNIC profiles. If you selected the logical network in tree mode, you can select the '''vNIC Profiles''' tab in the results list.</li>
<li><p>Click '''New''' to open the '''VM Interface Profile''' window.</p>
<p>⁠</p>
<p>[[Image:VM_Interface_Profile.png|The VM Interface Profile window|350px]]</p>
<p>'''Figure 5.1. The VM Interface Profile window'''</p></li>
<li>Enter the '''Name''' and '''Description''' of the profile.</li>
<li>Use the '''QoS''' drop-down menu to select the relevant Quality of Service policy to apply to the vNIC profile.</li>
<li>Use the '''Port Mirroring''' and '''Allow all users to use this Profile''' check boxes to toggle these options.</li>
<li>Use the custom properties drop-down menu, which displays '''Please select a key...''' by default, to select a custom property and use the '''+''' and '''-''' buttons to add additional custom properties or remove existing custom properties.</li>
<li>Click '''OK''' to save the profile and close the window.</li></ol>

'''Result'''

You have created a vNIC profile. Apply this profile to users and groups to regulate their network bandwidth.

=== Assigning Security Groups to vNIC Profiles ===

'''Summary'''

You can assign security groups to the vNIC profile of networks that have been imported from an OpenStack Networking instance and that use the Linux Bridge or Open vSwitch plug-ins. A security group is a collection of strictly enforced rules that allow you to filter inbound and outbound traffic over a network interface. The following procedure outlines how to attach a security group to a vNIC profile.

⁠

'''Procedure 5.2. Assigning Security Groups to vNIC Profiles'''

# Click the '''Networks''' tab and select a logical network in the results list.
# Click the '''vNIC Profiles''' tab in the details pane.
# Click '''New''' or select an existing vNIC profile and click '''Edit''' to open the '''VM Interface Profile''' window.
# From the custom properties drop-down menu, select '''SecurityGroups'''.
# In the text field to the right of the custom properties drop-down menu, enter the ID of the security group to attach to the vNIC profile.
# Click '''OK'''.

<div class="alert alert-info">'''Note:''' A security group is identified using the ID of that security group as registered in the OpenStack Networking instance. You can find the IDs of security groups for a given tenant by running the following command on the system on which OpenStack Networking is installed:

<pre class="screen"># neutron security-group-list</pre></div>
'''Result'''

You have attached a security group to the vNIC profile and all traffic through the logical network to which that profile is attached will be filtered in accordance with the rules defined for that security group.

=== Explanation of Settings in the VM Interface Profile Window ===


'''Table 5.1. VM Interface Profile Window'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''Network'''
|A drop-down menu of the available networks to apply the vNIC profile.
|- style="vertical-align:top;"
|'''Name'''
|The name of the vNIC profile. This must be a unique name with any combination of uppercase and lowercase letters, numbers, hyphens, and underscores between 1 and 50 characters.
|- style="vertical-align:top;"
|'''Description'''
|The description of the vNIC profile. This field is recommended but not mandatory.
|- style="vertical-align:top;"
|'''QoS'''
|A drop-down menu of the available Network Quality of Service policies to apply to the vNIC profile. QoS policies regulate inbound and outbound network traffic of the vNIC.
|- style="vertical-align:top;"
|'''Port Mirroring'''
|A check box to toggle port mirroring. Port mirroring copies layer 3 network traffic on the logical network to a virtual interface on a virtual machine. It it not selected by default.
|- style="vertical-align:top;"
|'''Device Custom Properties'''
|A drop-down menu to select available custom properties to apply to the VNIC profile. Use the '''+''' and '''-''' buttons to add and remove properties respectively.
|- style="vertical-align:top;"
|'''Allow all users to use this Profile'''
|A check box to toggle the availability of the profile to all users in the environment. It is selected by default.
|}

=== Removing a vNIC Profile ===

'''Summary'''

Remove a vNIC profile to delete it from your virtualized environment.

'''Procedure 5.3. Removing a vNIC Profile'''

# Use the '''Networks''' resource tab, tree mode, or the search function to select a logical network in the results pane.
# Select the '''Profiles''' tab in the details pane to display available vNIC profiles. If you selected the logical network in tree mode, you can select the '''vNIC Profiles''' tab in the results list.
# Select one or more profiles and click '''Remove''' to open the '''Remove VM Interface Profile(s)''' window.
# Click '''OK''' to remove the profile and close the window.

'''Result'''

You have removed the vNIC profile.

=== User Permissions for vNIC Profiles ===

'''Summary'''

Configure user permissions to assign users to certain vNIC profiles. Assign the '''VnicProfileUser''' role to a user to enable them to use the profile. Restrict users from certain profiles by removing their permission for that profile.

'''Procedure 5.4. User Permissions for vNIC Profiles'''

# Use tree mode to select a logical network.
# Select the '''vNIC Profiles''' resource tab to display the VNIC profiles.
# Select the '''Permissions''' tab in the details pane to show the current user permissions for the profile.
# Use the '''Add''' button to open the '''Add Permission to User''' window, and the '''Remove''' button to open the '''Remove Permission''' window, to affect user permissions for the vNIC profile.

'''Result'''

You have configured user permissions for a VNIC profile.

=== QoS Overview ===

Network QoS is a feature that allows you to create profiles for limiting both the inbound and outbound traffic of individual virtual NIC. With this feature, you can limit bandwidth in a number of layers, controlling the consumption of network resources.

<div class="alert alert-info">'''Important:''' Network QoS is only supported on cluster compatibility version 3.3 and higher.</div>

=== Adding QoS ===

'''Summary'''

Create a QoS profile to regulate network traffic when applied to a vNIC profile, also known as VM Interface profile.

'''Procedure 5.5. Creating a QoS profile'''

# Use the '''Data Centers''' resource tab, tree mode, or the search function to display and select a data center in the results list.
# Select the '''Network QoS''' tab in the details pane to display the available QoS profiles.
# Click '''New''' to open the '''New Network QoS''' window.
# Enter the '''Name''' of the profile.
# Enter the limits for the '''Inbound''' and '''Outbound''' network traffic.
# Click '''OK''' to save the changes and close the window.

'''Summary'''

You have created a QoS Profile that can be used in a vNIC profile, also known as VM Interface profile.

=== Settings in the New Network QoS and Edit Network QoS Windows Explained ===

Network QoS settings allow you to configure bandwidth limits for both inbound and outbound traffic on three distinct levels.

'''Table 5.2. Network QoS Settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''Data Center'''
|The data center to which the Network QoS policy is to be added. This field is configured automatically according to the selected data center.
|- style="vertical-align:top;"
|'''Name'''
|A name to represent the network QoS policy within oVirt.
|- style="vertical-align:top;"
|'''Inbound'''
|The settings to be applied to inbound traffic. Select or clear the '''Inbound''' check box to enable or disable these settings.
* '''Average''': The average speed of inbound traffic.
* '''Peak''': The speed of inbound traffic during peak times.
* '''Burst''': The speed of inbound traffic during bursts.
|- style="vertical-align:top;"
|'''Outbound'''
|The settings to be applied to outbound traffic. Select or clear the '''Outbound''' check box to enable or disable these settings.
* '''Average''': The average speed of outbound traffic.
* '''Peak''': The speed of outbound traffic during peak times.
* '''Burst''': The speed of outbound traffic during bursts.
|}

=== Removing QoS ===

'''Summary'''

Remove a QoS profile from your virtualized environment.

'''Procedure 5.6. Removing a QoS profile'''

# Use the '''Data Centers''' resource tab, tree mode, or the search function to display and select a data center in the results list.
# Select the '''Network QoS''' tab in the details pane to display the available QoS profiles.
# Select the QoS profile to remove and click '''Remove''' to open the '''Remove Network QoS''' window. This window will list what, if any, vNIC profiles are using the selected QoS profile.
# Click '''OK''' to save the changes and close the window.

'''Result'''

You have removed the QoS profile.

== Logical Network Tasks ==

=== Creating a New Logical Network in a Data Center or Cluster ===

'''Summary'''

Create a logical network and define its use in a data center, or in clusters in a data center.

⁠

'''Procedure 5.7. Creating a New Logical Network in a Data Center or Cluster'''

<ol>
<li>Use the '''Data Centers''' or '''Clusters''' resource tabs, tree mode, or the search function to find and select a data center or cluster in the results list.</li>
<li>Click the '''Logical Networks''' tab of the details pane to list the existing logical networks.</li>
<li>From the '''Data Centers''' details pane, click '''New''' to open the '''New Logical Network''' window.
From the '''Clusters''' details pane, click '''Add Network''' to open the '''New Logical Network''' window.</li>
<li>Enter a '''Name''', '''Description''' and '''Comment''' for the logical network.</li>
<li>In the '''Export''' section, select the '''Create on external provider''' check box to create the logical network on an external provider. Select the external provider from the '''External Provider''' drop-down menu.</li>
<li>In the '''Network Parameters''' section, select the '''Enable VLAN tagging''', '''VM network''' and '''Override MTU''' to enable these options.</li>
<li>Enter a new label or select an existing label for the logical network in the '''Network Label''' text field.</li>
<li>From the '''Cluster''' tab, select the clusters to which the network will be assigned. You can also specify whether the logical network will be a required network.</li>
<li>If the '''Create on external provider''' check box is selected, the '''Subnet''' tab will be visible. From the '''Subnet''' tab enter a '''Name''', '''CIDR''' and select an '''IP Version''' for the subnet that the logical network will provide.</li>
<li>From the '''Profiles''' tab, add vNIC profiles to the logical network as required.</li>
<li>Click '''OK'''.</li></ol>

'''Result'''

You have defined a logical network as a resource required by a cluster or clusters in the data center. If you entered a label for the logical network, it will be automatically added to all host network interfaces with that label.

<div class="alert alert-info">'''Note:''' When creating a new logical network or making changes to an existing logical network that is used as a display network, any running virtual machines that use that network must be rebooted before the network becomes available or the changes are applied.</div>

=== Explanation of Settings and Controls in the New Cluster and Edit Cluster Windows ===

==== Logical Network General Settings Explained ====

The table below describes the settings for the '''General''' tab of the '''New Logical Network''' and '''Edit Logical Network''' window.

⁠

'''Table 5.3. New Logical Network and Edit Logical Network Settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''Name'''
|The name of the logical network. This text field has a 15-character limit and must be a unique name with any combination of uppercase and lowercase letters, numbers, hyphens, and underscores.
|- style="vertical-align:top;"
|'''Description'''
|The description of the logical network. This text field has a 40-character limit.
|- style="vertical-align:top;"
|'''Comment'''
|A field for adding plain text, human-readable comments regarding the logical network.
|- style="vertical-align:top;"
|'''Create on external provider'''
|Allows you to create the logical network to an OpenStack Networking instance that has been added to oVirt as an external provider.
'''External Provider''' - Allows you to select the external provider on which the logical network will be created.
|- style="vertical-align:top;"
|'''Enable VLAN tagging'''
|VLAN tagging is a security feature that gives all network traffic carried on the logical network a special characteristic. VLAN-tagged traffic cannot be read by interfaces that do not also have that characteristic. Use of VLANs on logical networks also allows a single network interface to be associated with multiple, differently VLAN-tagged logical networks. Enter a numeric value in the text entry field if VLAN tagging is enabled.
|- style="vertical-align:top;"
|'''VM Network'''
|Select this option if only virtual machines use this network. If the network is used for traffic that does not involve virtual machines, such as storage communications, do not select this check box.
|- style="vertical-align:top;"
|'''Override MTU'''
|Set a custom maximum transmission unit for the logical network. You can use this to match the maximum transmission unit supported by your new logical network to the maximum transmission unit supported by the hardware it interfaces with. Enter a numeric value in the text entry field if '''Override MTU''' is selected.
|- style="vertical-align:top;"
|'''Network Label'''
|Allows you to specify a new label for the network or select from a existing labels already attached to host network interfaces. If you select an existing label, the logical network will be automatically assigned to all host network interfaces with that label.
|}

==== Logical Network Cluster Settings Explained ====

The table below describes the settings for the '''Cluster''' tab of the '''New Logical Network''' and '''Edit Logical Network''' window.

'''Table 5.4. New Logical Network and Edit Logical Network Settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''Attach/Detach Network to/from Cluster(s)'''
|Allows you to attach or detach the logical network from clusters in the data center and specify whether the logical network will be a required network for individual clusters.

'''Name''' - the name of the cluster to which the settings will apply. This value cannot be edited.

'''Attach All''' - Allows you to attach or detach the logical network to or from all clusters in the data center. Alternatively, select or clear the '''Attach''' check box next to the name of each cluster to attach or detach the logical network to or from a given cluster.

'''Required All''' - Allows you to specify whether the logical network is a required network on all clusters. Alternatively, select or clear the '''Required''' check box next to the name of each cluster to specify whether the logical network is a required network for a given cluster.
|}

==== Logical Network vNIC Profiles Settings Explained ====

The table below describes the settings for the '''vNIC Profiles''' tab of the '''New Logical Network''' and '''Edit Logical Network''' window.

'''Table 5.5. New Logical Network and Edit Logical Network Settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''vNIC Profiles'''
|Allows you to specify one or more vNIC profiles for the logical network. You can add or remove a vNIC profile to or from the logical network by clicking the plus or minus button next to the vNIC profile. The first field is for entering a name for the vNIC profile.

'''Public''' - Allows you to specify whether the profile is available to all users.

'''QoS''' - Allows you to specify a network quality of service (QoS) profile to the vNIC profile.
|}

=== Editing a Logical Network ===

'''Summary'''

Edit the settings of a logical network.

⁠

'''Procedure 5.8. Editing a Logical Network'''

# Use the '''Data Centers''' resource tab, tree mode, or the search function to find and select the data center of the logical network in the results list.
# Click the '''Logical Networks''' tab in the details pane to list the logical networks in the data center.
# Select a logical network and click '''Edit''' to open the '''Edit Logical Network''' window.
# Edit the necessary settings.
# Click '''OK''' to save the changes.

'''Result'''

You have updated the settings of your logical network.

<div class="alert alert-info">'''Note:''' Multi-host network configuration is available on data centers with 3.1-or-higher compatibility, and automatically applies updated network settings to all of the hosts within the data center to which the network is assigned. Changes can only be applied when virtual machines using the network are down. You cannot rename a logical network that is already configured on a host. You cannot disable the '''VM Network''' option while virtual machines or templates using that network are running.</div>

=== Designate a Specific Traffic Type for a Logical Network with the Manage Networks Window ===

'''Summary'''

Specify the traffic type for the logical network to optimize the network traffic flow.

'''Procedure 5.9. Assigning or Unassigning a Logical Network to a Cluster'''

<ol>
<li>Use the '''Clusters''' resource tab, tree mode, or the search function to find and select the cluster in the results list.</li>
<li>Select the '''Logical Networks''' tab in the details pane to list the logical networks assigned to the cluster.</li>
<li><p>Click '''Manage Networks''' to open the '''Manage Networks''' window.</p>
<p>⁠</p>
<p>[[Image:Manage_Networks.png|The Manage Networks window|300px]]</p>
<p>'''Figure 5.2. Manage Networks'''</p></li>
<li>Select appropriate check boxes.</li>
<li>Click '''OK''' to save the changes and close the window.</li></ol>

'''Result'''

You have optimized the network traffic flow by assigning a specific type of traffic to be carried on a specific logical network.

<div class="alert alert-info">'''Note:''' Networks offered by external providers cannot be used as display networks.</div>

=== Explanation of Settings in the Manage Networks Window ===

The table below describes the settings for the '''Manage Networks''' window.

'''Table 5.6. Manage Networks Settings'''

{| class="wikitable"
!width="50%"|Field
!width="50%"|Description/Action
|- style="vertical-align:top;"
|'''Assign'''
|Assigns the logical network to all hosts in the cluster.
|- style="vertical-align:top;"
|'''Required'''
|A Network marked &quot;required&quot; must remain operational in order for the hosts associated with it to function properly. If a required network ceases to function, any hosts associated with it become non-operational.
|- style="vertical-align:top;"
|'''VM Network'''
|A logical network marked &quot;VM Network&quot; carries network traffic relevant to the virtual machine network.
|- style="vertical-align:top;"
|'''Display Network'''
|A logical network marked &quot;Display Network&quot; carries network traffic relevant to SPICE and to the virtual network controller.
|- style="vertical-align:top;"
|'''Migration Network'''
|A logical network marked &quot;Migration Network&quot; carries virtual machine and storage migration traffic.
|}

=== Adding Multiple VLANs to a Single Network Interface Using Logical Networks ===

'''Summary'''

Multiple VLANs can be added to a single network interface to separate traffic on the one host.

<div class="alert alert-info">'''Important:''' You must have created more than one logical network, all with the '''Enable VLAN tagging''' check box selected in the '''New Logical Network''' or '''Edit Logical Network''' windows.</div>

'''Procedure 5.10. Adding Multiple VLANs to a Network Interface using Logical Networks'''

<ol>
<li>Use the '''Hosts''' resource tab, tree mode, or the search function to find and select in the results list a host associated with the cluster to which your VLAN-tagged logical networks are assigned.</li>
<li>Click the '''Network Interfaces''' tab in the details pane to list the physical network interfaces attached to the data center.</li>
<li>Click '''Setup Host Networks''' to open the '''Setup Host Networks''' window.</li>
<li><p>Drag your VLAN-tagged logical networks into the '''Assigned Logical Networks''' area next to the physical network interface. The physical network interface can have multiple logical networks assigned due to the VLAN tagging.</p>
<p>⁠</p>
<p>[[Image:Setup_Host_Networks.png|Setup Host Networks|400px]]</p>
<p>'''Figure 5.3. Setup Host Networks'''</p></li>
<li>Edit the logical networks by hovering your cursor over an assigned logical network and clicking the pencil icon to open the '''Edit Network''' window.
If your logical network definition is not synchronized with the network configuration on the host, select the '''Sync network''' check box.
Select a '''Boot Protocol''' from:
<ul>
<li>'''None''',</li>
<li>'''DHCP''', or</li>
<li>'''Static''',
Provide the '''IP''' and '''Subnet Mask'''.</li></ul>

Click '''OK'''.</li>
<li>Select the '''Verify connectivity between Host and Engine''' check box to run a network check; this will only work if the host is in maintenance mode.</li>
<li>Select the '''Save network configuration''' check box</li>
<li>Click '''OK'''.</li></ol>

Add the logical network to each host in the cluster by editing a NIC on each host in the cluster. After this is done, the network will become operational

'''Result'''

You have added multiple VLAN-tagged logical networks to a single interface. This process can be repeated multiple times, selecting and editing the same network interface each time on each host to add logical networks with different VLAN tags to a single network interface.

=== Network Labels ===

Network labels can be used to greatly simplify several administrative tasks associated with creating and administering logical networks and associating those logical networks with physical host network interfaces and bonds.

A network label is a plain text, human readable label that can be attached to a logical network or a physical host network interface. There is no strict limit on the length of label, but you must use a combination of lowercase and uppercase letters, underscores and hyphens; no spaces or special characters are allowed.

Attaching a label to a logical network or physical host network interface creates an association with other logical networks or physical host network interfaces to which the same label has been attached, as follows:

'''Network Label Associations'''

* When you attach a label to a logical network, that logical network will be automatically associated with any physical host network interfaces with the given label.
* When you attach a label to a physical host network interface, any logical networks with the given label will be automatically associated with that physical host network interface.
* Changing the label attached to a logical network or physical host network interface acts in the same way as removing a label and adding a new label. The association between related logical networks or physical host network interfaces is updated.

'''Network Labels and Clusters'''

* When a labeled logical network is added to a cluster and there is a physical host network interface in that cluster with the same label, the logical network is automatically added to that physical host network interface.
* When a labeled logical network is detached from a cluster and there is a physical host network interface in that cluster with the same label, the logical network is automatically detached from that physical host network interface.

'''Network Labels and Logical Networks With Roles'''

* When a labeled logical network is assigned to act as a display network or migration network, that logical network is then configured on the physical host network interface using DHCP so that the logical network can be assigned an IP address.

==== Adding Network Labels to Host Network Interfaces ====

'''Summary'''

Using network labels allows you to greatly simplify the administrative workload associated with assigning logical networks to host network interfaces.

'''Procedure 5.11. Adding Network Labels to Host Network Interfaces'''

<ol>
<li>Use the '''Hosts''' resource tab, tree mode, or the search function to find and select in the results list a host associated with the cluster to which your VLAN-tagged logical networks are assigned.</li>
<li>Click the '''Network Interfaces''' tab in the details pane to list the physical network interfaces attached to the data center.</li>
<li>Click '''Setup Host Networks''' to open the '''Setup Host Networks''' window.</li>
<li><p>Edit a physical network interface by hovering your cursor over a physical network interface and clicking the pencil icon to open the '''Edit Interface''' window.</p>
<p>⁠</p>
<p>[[Image:Edit_Management_Network.png|The Edit Interface Window|200px]]</p>
<p>'''Figure 5.4. The Edit Interface Window'''</p></li>
<li>Enter a name for the network label in the '''Label''' text field and use the '''+''' and '''-''' buttons to add or remove additional network labels.</li>
<li>Click '''OK'''.</li></ol>

'''Result'''

You have added a network label to a host network interface. Any newly created logical networks with the same label will be automatically assigned to all host network interfaces with that label. Also, removing a label from a logical network will automatically remove that logical network from all host network interfaces with that label.

=== Using the Networks Tab ===

The '''Networks''' resource tab provides a central location for users to perform network-related operations and search for networks based on each network's property or association with other resources.

All networks in the oVirt environment display in the results list of the '''Networks''' tab. The '''New''', '''Edit''' and '''Remove''' buttons allow you to create, change the properties of, and delete logical networks within data centers.

Click on each network name and use the '''Clusters''', '''Hosts''', '''Virtual Machines''', '''Templates''', and '''Permissions''' tabs in the details pane to perform functions including:

* Attaching or detaching the networks to clusters and hosts
* Removing network interfaces from virtual machines and templates
* Adding and removing permissions for users to access and manage networks

These functions are also accessible through each individual resource tab.

== External Provider Networks ==

=== Importing Networks From External Providers ===

'''Summary'''

If an external provider offering networking services has been registered in oVirt, the networks provided by that provider can be imported into oVirt and used by virtual machines.

'''Procedure 5.12. Importing a Network From an External Provider'''

<ol>
<li>Click the '''Networks''' tab.</li>
<li><p>Click the '''Import''' button to open the '''Import Networks''' window.</p>
<p>⁠</p>
<p>[[Image:Import_Networks.png|The Import Networks Window|300px]]</p>
<p>'''Figure 5.5. The Import Networks Window'''</p></li>
<li>From the '''Network Provider''' drop-down list, select an external provider. The networks offered by that provider are automatically discovered and listed in the '''Provider Networks''' list.</li>
<li>Using the check boxes, select the networks to import in the '''Provider Networks''' list and click the down arrow to move those networks into the '''Networks to Import''' list.</li>
<li>From the '''Data Center''' drop-down list, select the data center into which the networks will be imported.</li>
<li>Optionally, clear the '''Allow All''' check box for a network in the '''Networks to Import''' list to prevent that network from being available to all users.</li>
<li>Click the '''Import''' button.</li></ol>

'''Result'''

The selected networks are imported into the target data center and can now be used in oVirt.

=== Limitations to Using External Provider Networks ===

The following limitations apply to using logical networks imported from an external provider in an oVirt environment.

* Logical networks offered by external providers must be used as virtual machine networks, and cannot be used as display networks.
* The same logical network can be imported more than once, but only to different data centers.
* You cannot edit logical networks offered by external providers in oVirt. To edit the details of a logical network offered by an external provider, you must edit the logical network directly from the OpenStack Networking instance that provides that logical network.
* Port mirroring is not available for virtual network interface cards connected to logical networks offered by external providers.
* If a virtual machine uses a logical network offered by an external provider, that provider cannot be deleted from oVirt while the logical network is still in use by the virtual machine.
* Networks offered by external providers are non-required. As such, scheduling for clusters in which such logical networks have been imported will not take those logical networks into account during host selection. Moreover, it is the responsibility of the user to ensure the availability of the logical network on hosts in clusters in which such logical networks have been imported.

<div class="alert alert-info">'''Important:''' Logical networks imported from external providers are only compatible with Red Hat Enterprise Linux hosts and cannot be assigned to virtual machines running on oVirt Node hosts.</div>

<div class="alert alert-info">'''Important:''' External provider discovery and importing are Technology Preview features. Technology Preview features are not fully supported under Red Hat Subscription Service Level Agreements (SLAs), may not be functionally complete, and are not intended for production use. However, these features provide early access to upcoming product innovations, enabling customers to test functionality and provide feedback during the development process.</div>

=== Subnets on External Provider Logical Networks ===

==== Configuring Subnets on External Provider Logical Networks ====

A logical network provided by an external provider can only assign IP addresses to virtual machines if one or more subnets have been defined on that logical network. If no subnets are defined, virtual machines will not be assigned IP addresses. If there is one subnet, virtual machines will be assigned an IP address from that subnet, and if there are multiple subnets, virtual machines will be assigned an IP address from any of the available subnets. The DHCP service provided by the Neutron instance on which the logical network is hosted is responsible for assigning these IP addresses.

While oVirt automatically discovers predefined subnets on imported logical networks, you can also add or remove subnets to or from logical networks from within oVirt.

==== Adding Subnets to External Provider Logical Networks ====

'''Summary'''

Create a subnet on a logical network provided by an external provider

⁠

'''Procedure 5.13. Adding Subnets to External Provider Logical Networks'''

<ol>
<li>Click the '''Networks''' tab.</li>
<li>Click the logical network provided by an external provider to which the subnet will be added.</li>
<li>Click the '''Subnets''' tab in the details pane.</li>
<li>Click the '''New''' button to open the '''New External Subnet''' window.</li>
<li>Enter a '''Name''' and '''CIDR''' for the new subnet.</li>
<li>From the '''IP Version''' drop-down menu, select either '''IPv4''' or '''IPv6'''.</li>
<li>Click '''OK'''.</li></ol>

'''Result'''

A new subnet is created on the logical network.

==== Removing Subnets from External Provider Logical Networks ====

'''Summary'''

Remove a subnet from a logical network provided by an external provider

⁠

'''Procedure 5.14. Removing Subnets from External Provider Logical Networks'''

# Click the '''Networks''' tab.
# Click the logical network provided by an external provider from which the subnet will be removed.
# Click the '''Subnets''' tab in the details pane.
# Click the subnet to remove.
# Click the '''Remove''' button and click '''OK''' when prompted.

'''Result'''

The subnet is removed from the logical network.

= ⁠Hosts =

== Introduction to oVirt Hosts ==

Hosts, also known as hypervisors, are the physical servers on which virtual machines run. Full virtualization is provided by using a loadable Linux kernel module called Kernel-based Virtual Machine (KVM).

KVM can concurrently host multiple virtual machines running either Windows or Linux operating systems. Virtual machines run as individual Linux processes and threads on the host machine and are managed remotely by oVirt. An oVirt environment has one or more hosts attached to it.

oVirt supports two methods of installing hosts. You can use the oVirt Node installation media, or install hypervisor packages on a standard Red Hat Enterprise Linux, CentOS, or Fedora installation.

oVirt hosts take advantage of '''tuned''' profiles, which provide virtualization optimizations. For more information on '''tuned''' for Red Hat Enterprise Linux, please refer to the ''[//access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html-single/Performance_Tuning_Guide/index.html Red Hat Enterprise Linux 6.0 Performance Tuning Guide]''.

The oVirt Node has security features enabled. Security Enhanced Linux (SELinux) and the iptables firewall are fully configured and on by default. oVirt can open required ports on Red Hat Enterprise Linux, CentOS, and Fedora hosts when it adds them to the environment. For a full list of ports, see [[#Virtualization_Host_Firewall_Requirements1|Section A.2, “Virtualization Host Firewall Requirements”]].

A host is a physical 64-bit server with the Intel VT or AMD-V extensions running Red Hat Enterprise Linux 6.1 or later, as well as CentOS 6.1 or later, in either the AMD64/Intel 64 version.

<div class="alert alert-info">'''Important:''' Red Hat Enterprise Linux 5.4 and Red Hat Enterprise Linux 5.5 machines that belong to existing clusters are supported. oVirt Guest Agent is now included in the <code>virtio serial</code> channel. Any Guest Agents installed on Windows guests on Red Hat Enterprise Linux hosts will lose their connection to oVirt when the Red Hat Enterprise Linux hosts are upgraded from version 5 to version 6.</div>

A physical host on the oVirt platform:

* Must belong to only one cluster in the system.
* Must have CPUs that support the AMD-V or Intel VT hardware virtualization extensions.
* Must have CPUs that support all functionality exposed by the virtual CPU type selected upon cluster creation.
* Has a minimum of 2 GB RAM.
* Can have an assigned system administrator with system permissions.

== oVirt Node Hosts ==

oVirt Node hosts are installed using a special build of Fedora, with only the packages required to host virtual machines. They run stateless, not writing any changes to disk unless explicitly required to.

oVirt Node hosts can be added directly to, and configured by, oVirt. Alternatively a host can be configured locally to connect to oVirt; oVirt then is only used to approve the host to be used in the environment.

Unlike Red Hat Enterprise Linux, Fedora, or CentOS hosts, oVirt Node hosts cannot be added to clusters that have been enabled for Gluster service for use as Red Hat Storage nodes.

<div class="alert alert-info">'''Important:''' The oVirt Node is a closed system. Use a Red Hat Enterprise Linux, CentOS, or Fedora host if additional rpm packages are required for your environment.</div>

== Foreman Host Provider Hosts ==

Hosts provided by a Foreman host provider can also be used as virtualization hosts by oVirt. After a Foreman host provider has been added to oVirt as an external provider, any hosts that it provides can be added to and used in oVirt in the same way as oVirt Node hosts and Red Hat Enterprise Linux/CentOS hosts.

<div class="alert alert-info">'''Important:''' Foreman host provider hosts are a Technology Preview feature. Technology Preview features are not fully supported, may not be functionally complete, and are not intended for production use. However, these features provide early access to upcoming product innovations, enabling customers to test functionality and provide feedback during the development process.</div>

== Enterprise Linux Hosts ==

You can use a standard Red Hat Enterprise Linux 6  or CentOS 6 installation on capable hardware as a host. oVirt supports hosts running Red Hat Enterprise Linux 6 or CentOS server AMD64/Intel 64 version.

Adding a host can take some time, as the following steps are completed by the platform: virtualization checks, installation of packages, creation of bridge and a reboot of the host. Use the Details pane to monitor the hand-shake process as the host and management system establish a connection.

== Host Tasks ==

=== Adding an Enterprise Linux Host ===

'''Summary'''

An Enterprise Linux host is based on a standard &quot;basic&quot; installation of Red Hat Enterprise Linux or CentOS. The physical host must be set up before you can add it to the oVirt environment.

oVirt logs into the host to perform virtualization capability checks, install packages, create a network bridge, and reboot the host. The process of adding a new host can take up to 10 minutes.

'''Procedure 6.1. Adding an Enterprise Linux Host'''

# Click the '''Hosts''' resource tab to list the hosts in the results list.
# Click '''New''' to open the '''New Host''' window.
# Use the drop-down menus to select the '''Data Center''' and '''Host Cluster''' for the new host.
# Enter the '''Name''', '''Address''', and '''SSH Port''' of the new host.
# Select an authentication method to use with the host.
#* Enter the root user's password to use password authentication.
#* Copy the key displayed in the '''SSH PublicKey''' field to <code>/root/.ssh/authorized_keys</code> on the host to use public key authentication.
# You have now completed the mandatory steps to add a Red Hat Enterprise Linux or CentOS host. Click the '''Advanced Parameters''' button to expand the advanced host settings.
## Optionally disable automatic firewall configuration.
## Optionally add a host SSH fingerprint to increase security. You can add it manually, or fetch it automatically.
# You can configure the '''Power Management''' and '''SPM''' using the applicable tabs now; however, as these are not fundamental to adding a Red Hat Enterprise Linux host, they are not covered in this procedure.
# Click '''OK''' to add the host and close the window.

'''Result'''

The new host displays in the list of hosts with a status of <code>Installing</code>. When installation is complete, the status updates to <code>Reboot</code>. The host must be activated for the status to change to <code>Up</code>.

<div class="alert alert-info">'''Note:''' You can view the progress of the installation in the details pane.</div>

=== Approving a Hypervisor ===

'''Summary'''

It is not possible to run virtual machines on a Hypervisor until the addition of it to the environment has been approved in oVirt.

'''Procedure 6.2. Approving a Hypervisor'''

# Log in to oVirt Administration Portal.
# From the '''Hosts''' tab, click on the host to be approved. The host should currently be listed with the status of '''Pending Approval'''.
# Click the '''Approve''' button. The '''Edit and Approve Hosts''' dialog displays. You can use the dialog to set a name for the host, fetch its SSH fingerprint before approving it, and configure power management, where the host has a supported power management card. For information on power management configuration, refer to [[#Host_Power_Management_Settings_Explained|“Host Power Management Settings Explained”]].
# Click '''OK'''. If you have not configured power management you will be prompted to confirm that you wish to proceed without doing so, click '''OK'''.

'''Result'''

The status in the '''Hosts''' tab changes to '''Installing''', after a brief delay the host status changes to '''Up'''.

=== Explanation of Settings and Controls in the New Host and Edit Host Windows ===

==== Host General Settings Explained ====

These settings apply when editing the details of a host or adding new Red Hat Enterprise Linux hosts and Foreman host provider hosts.

The '''General''' settings table contains the information required on the '''General''' tab of the '''New Host''' or '''Edit Host''' window.

⁠

'''Table 6.1. General Settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''Data Center'''
|The data center to which the host belongs. oVirt Node hosts cannot be added to Gluster-enabled clusters.
|-
|'''Host Cluster'''
|The cluster to which the host belongs.
|-
|'''Use External Providers'''
|Select or clear this check box to view or hide options for adding hosts provided by external providers. Upon selection, a drop-down list of external providers that have been added to oVirt displays. The following options are also available:
* '''Provider search filter''' - A text field that allows you to search for hosts provided by the selected external provider. This option is provider-specific; see provider documentation for details on forming search queries for specific providers. Leave this field blank to view all available hosts.
* '''External Hosts''' - A drop-down list that is populated with the name of hosts provided by the selected external provider. The entries in this list are filtered in accordance with any search queries that have been input in the '''Provider search filter'''.
|-
|'''Name'''
|The name of the cluster. This text field has a 40-character limit and must be a unique name with any combination of uppercase and lowercase letters, numbers, hyphens, and underscores.
|-
|'''Comment'''
|A field for adding plain text, human-readable comments regarding the host.
|-
|'''Address'''
|The IP address, or resolvable hostname of the host.
|-
|'''Password'''
|The password of the host's root user. This can only be given when you add the host; it cannot be edited afterwards.
|-
|'''SSH PublicKey'''
|Copy the contents in the text box to the <code>/root/.known_hosts</code> file on the host to use oVirt's ssh key instead of using a password to authenticate with the host.
|-
|'''Automatically configure host firewall'''
|When adding a new host, oVirt can open the required ports on the host's firewall. This is enabled by default. This is an '''Advanced Parameter'''.
|-
|'''SSH Fingerprint'''
|You can '''fetch''' the host's SSH fingerprint, and compare it with the fingerprint you expect the host to return, ensuring that they match. This is an '''Advanced Parameter'''.
|}

==== Host Power Management Settings Explained ====

The '''Power Management''' settings table contains the information required on the '''Power Management''' tab of the '''New Host''' or '''Edit Host''' windows.

⁠

'''Table 6.2. Power Management Settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|-
|'''Primary/ Secondary'''
|Prior to oVirt 3.2, a host with power management configured only recognized one fencing agent. Fencing agents configured on version 3.1 and earlier, and single agents, are treated as primary agents. The secondary option is valid when a second agent is defined.
|-
|'''Concurrent'''
|Valid when there are two fencing agents, for example for dual power hosts in which each power switch has two agents connected to the same power switch.
* If this check box is selected, both fencing agents are used concurrently when a host is fenced. This means that both fencing agents have to respond to the Stop command for the host to be stopped; if one agent responds to the Start command, the host will go up.
* If this check box is not selected, the fencing agents are used sequentially. This means that to stop or start a host, the primary agent is used first, and if it fails, the secondary agent is used.
|-
|'''Address'''
|The address to access your host's power management device. Either a resolvable hostname or an IP address.
|-
|'''User Name'''
|User account with which to access the power management device. You can set up a user on the device, or use the default user.
|-
|'''Password'''
|Password for the user accessing the power management device.
|-
|'''Type'''
|The type of power management device in your host.
Choose one of the following:
* '''apc''' - APC MasterSwitch network power switch. Not for use with APC 5.x power switch devices.
* '''apc_snmp''' - Use with APC 5.x power switch devices.
* '''bladecenter''' - IBM Bladecentre Remote Supervisor Adapter.
* '''cisco_ucs''' - Cisco Unified Computing System.
* '''drac5''' - Dell Remote Access Controller for Dell computers.
* '''drac7''' - Dell Remote Access Controller for Dell computers.
* '''eps''' - ePowerSwitch 8M+ network power switch.
* '''hpblade''' - HP BladeSystem.
* '''ilo''', '''ilo2''', '''ilo3''', '''ilo4''' - HP Integrated Lights-Out.
* '''ipmilan''' - Intelligent Platform Management Interface and Sun Integrated Lights Out Management devices.
* '''rsa''' - IBM Remote Supervisor Adaptor.
* '''rsb''' - Fujitsu-Siemens RSB management interface.
* '''wti''' - WTI Network PowerSwitch.
|-
|'''Port'''
|The port number used by the power management device to communicate with the host.
|-
|'''Options'''
|Power management device specific options. Enter these as 'key=value' or 'key'. See the documentation of your host's power management device for the options available.
|-
|'''Secure'''
|Tick this check box to allow the power management device to connect securely to the host. This can be done via ssh, ssl, or other authentication protocols depending on and supported by the power management agent.
|-
|'''Source'''
|Specifies whether the host will search within its '''cluster''' or '''data center''' for a fencing proxy. Use the '''Up''' and '''Down''' buttons to change the sequence in which the resources are used.
|-
|'''Disable policy control of power management'''
|Power management is controlled by the '''Cluster Policy''' of the host's '''cluster'''. If power management is enabled and the defined low utilization value is reached, oVirt will power down the host machine, and restart it again when load balancing requires or there are not enough free hosts in the cluster. Tick this check box to disable policy control.
|}

==== SPM Priority Settings Explained ====

The '''SPM''' settings table details the information required on the '''SPM''' tab of the '''New Host''' or '''Edit Host''' window.

⁠

'''Table 6.3. SPM settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|-
|'''SPM Priority'''
|Defines the likelihood that the host will be given the role of Storage Pool Manager(SPM). The options are '''Low''', '''Normal''', and '''High''' priority. Low priority means that there is a reduced likelihood of the host being assigned the role of SPM, and High priority means there is an increased likelihood. The default setting is Normal.
|}

==== Host Console Settings Explained ====

The '''Console''' settings table details the information required on the '''Console''' tab of the '''New Host''' or '''Edit Host''' window.

⁠

'''Table 6.4. Console settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|-
|'''Override display address'''
|Select this check box to override the display addresses of the host. This feature is useful in a case where the hosts are defined by internal IP and are behind a NAT firewall. When a user connects to a virtual machine from outside of the internal network, instead of returning the private address of the host on which the virtual machine is running, the machine returns a public IP or FQDN (which is resolved in the external network to the public IP).
|-
|'''Display address'''
|The display address specified here will be used for all virtual machines running on this host. The address must be in the format of a fully qualified domain name or IP.
|}

=== Configuring Host Power Management Settings ===

'''Summary'''

Configure your host power management device settings to perform host life-cycle operations (stop, start, restart) from the Administration Portal.

It is necessary to configure host power management in order to utilize host high availability and virtual machine high availability.

<div class="alert alert-info">'''Important:''' Ensure that your host is in <code>maintenance mode</code> before configuring power management settings. Otherwise, all running virtual machines on that host will be stopped ungracefully upon restarting the host, which can cause disruptions in production environments. A warning dialog will appear if you have not correctly set your host to <code>maintenance mode.</code></div>

⁠

'''Procedure 6.3. Configuring Power Management Settings'''

# Use the '''Hosts''' resource tab, tree mode, or the search function to find and select the host in the results list.
# Click '''Edit''' to open the '''Edit Host''' window.
# Click the '''Power Management''' tab to display the Power Management settings.
# Select the '''Enable Power Management''' check box to enable the fields.
# The '''Primary''' option is selected by default if you are configuring a new power management device. If you are adding a new device, set it to '''Secondary'''.
# Select the '''Concurrent''' check box to enable multiple fence agents to be used concurrently.
# Enter the '''Address''', '''User Name''', and '''Password''' of the power management device into the appropriate fields.
# Use the drop-down menu to select the '''Type''' of power management device.
# Enter the '''Port''' number used by the power management device to communicate with the host.
# Enter the '''Options''' for the power management device. Use a comma-separated list of '''key=value''' or '''key'''.
# Select the '''Secure''' check box to enable the power management device to connect securely to the host.
# Click '''Test''' to ensure the settings are correct.
# Click '''OK''' to save your settings and close the window.

'''Result'''

You have configured the power management settings for the host. The '''Power Management''' drop-down menu is now enabled in the Administration Portal.

<div class="alert alert-info">'''Note:''' Power management is controlled by the '''Cluster Policy''' of the host's '''cluster'''. If power management is enabled and the defined low utilization value is reached, oVirt will power down the host machine, and restart it again when load balancing requires or there are not enough free hosts in the cluster. Tick the '''Disable policy control of power management''' check box if you do not wish for your host to automatically perform these functions.</div>

=== Configuring Host Storage Pool Manager Settings ===

'''Summary'''

The Storage Pool Manager (SPM) is a management role given to one of the hosts in a data center to maintain access control over the storage domains. The SPM must always be available, and the SPM role will be assigned to another host if the SPM host becomes unavailable. As the SPM role uses some of the host's available resources, it is important to prioritize hosts that can afford the resources.

The Storage Pool Manager (SPM) priority setting of a host alters the likelihood of the host being assigned the SPM role: a host with high SPM priority will be assigned the SPM role before a host with low SPM priority.

⁠

'''Procedure 6.4. Configuring SPM settings'''

# Use the '''Hosts''' resource tab, tree mode, or the search function to find and select the host in the results list.
# Click '''Edit''' to open the '''Edit Host''' window.
# Click the '''SPM''' tab to display the '''SPM Priority''' settings.
# Use the radio buttons to select the appropriate SPM priority for the host.
# Click '''OK''' to save the settings and close the window.

'''Result'''

You have configured the SPM priority of the host.

=== Editing a Resource ===

'''Summary'''

Edit the properties of a resource.

⁠

'''Procedure 6.5. Editing a Resource'''

# Use the resource tabs, tree mode, or the search function to find and select the resource in the results list.
# Click '''Edit''' to open the '''Edit''' window.
# Change the necessary properties and click '''OK'''.

'''Result'''

The new properties are saved to the resource. The '''Edit''' window will not close if a property field is invalid.

=== Approving Newly Added oVirt Node Hosts ===

'''Summary'''

You have to install your oVirt Node hosts before you can approve them in oVirt. Read about installing oVirt Nodes in the ''oVirt Installation Guide''.

Once installed, the oVirt Node host is visible in the Administration Portal but not active. Approve it so that it can host virtual machines.

'''Procedure 6.6. Approving newly added oVirt Node hosts'''

# In the '''Hosts''' tab, select the host you recently installed using the oVirt Node host installation media. This host shows a status of <code>Pending Approval</code>.
# Click the '''Approve''' button.

'''Result'''

The host's status changes to <code>Up</code> and it can be used to run virtual machines.

<div class="alert alert-info">'''Note:''' You can also add this host using the procedure in [[#Adding_an_Enterprise_Linux_Host|“Adding an Enterprise Linux Host”]], which utilizes the oVirt Node host's IP address and the password that was set on the '''oVirt Engine''' screen.</div>

=== Moving a Host to Maintenance Mode ===

'''Summary'''

Many common maintenance tasks, including network configuration and deployment of software updates, require that hosts be placed into maintenance mode. When a host is placed into maintenance mode oVirt attempts to migrate all running virtual machines to alternative hosts.

The normal prerequisites for live migration apply, in particular there must be at least one active host in the cluster with capacity to run the migrated virtual machines.

⁠

'''Procedure 6.7. Moving a Host to Maintenance Mode'''

# Use the '''Hosts''' resource tab, tree mode, or the search function to find and select the host in the results list.
# Click '''Maintenance''' to open the '''Maintenance Host(s)''' confirmation window.
# Click '''OK''' to initiate maintenance mode.

Result:

All running virtual machines are migrated to alternative hosts. The '''Status''' field of the host changes to <code>Preparing for Maintenance</code>, and finally <code>Maintenance</code> when the operation completes successfully.

=== Activating a Host from Maintenance Mode ===

'''Summary'''

A host that has been placed into maintenance mode, or recently added to the environment, must be activated before it can be used.

⁠

'''Procedure 6.8. Activating a Host from Maintenance Mode'''

# Use the '''Hosts''' resource tab, tree mode, or the search function to find and select the host in the results list.
# Click '''Activate'''.

'''Result'''

The host status changes to <code>Unassigned</code>, and finally <code>Up</code> when the operation is complete. Virtual machines can now run on the host.

=== Removing a Host ===

'''Summary'''

Remove a host from your virtualized environment.

'''Procedure 6.9. Removing a host'''

# Use the '''Hosts''' resource tab, tree mode, or the search function to find and select the host in the results list.
# Place the host into maintenance mode.
# Click '''Remove''' to open the '''Remove Host(s)''' confirmation window.
# Select the '''Force Remove''' check box if the host is part of a Red Hat Storage cluster and has volume bricks on it, or if the host is non-responsive.
# Click '''OK'''.

'''Result'''

Your host has been removed from the environment and is no longer visible in the '''Hosts''' tab.

=== Customizing Hosts with Tags ===

'''Summary'''

You can use tags to store information about your hosts. You can then search for hosts based on tags.

⁠

'''Procedure 6.10. Customizing hosts with tags'''

<ol>
<li>Use the '''Hosts''' resource tab, tree mode, or the search function to find and select the host in the results list.</li>
<li><p>Click '''Assign Tags''' to open the '''Assign Tags''' window.</p>
<p>⁠</p>
<p>[[Image:Assign Tags.png|200px|Assign Tags Window]]</p>
<p>'''Figure 6.1. Assign Tags Window'''</p></li>
<li>The '''Assign Tags''' window lists all available tags. Select the check boxes of applicable tags.</li>
<li>Click '''OK''' to assign the tags and close the window.</li></ol>

'''Result'''

You have added extra, searchable information about your host as tags.

== Hosts and Networking ==

=== Refreshing Host Capabilities ===

'''Summary'''

When a network interface card is added to a host, the capabilities of the host must be refreshed to display that network interface card in oVirt.

⁠

'''Procedure 6.11. To Refresh Host Capabilities'''

# Use the resource tabs, tree mode, or the search function to find and select a host in the results list.
# Click the '''Refresh Capabilities''' button.

'''Result'''

The list of network interface cards in the '''Network Interfaces''' tab of the details pane for the selected host is updated. Any new network interface cards can now be used in oVirt.

=== Editing Host Network Interfaces and Assigning Logical Networks to Hosts ===

'''Summary'''

You can change the settings of physical host network interfaces, move the management network from one physical host network interface to another, and assign logical networks to physical host network interfaces.

<div class="alert alert-info">'''Important:''' You cannot assign logical networks offered by external providers to physical host network interfaces; such networks are dynamically assigned to hosts as they are required by virtual machines.</div>

⁠

'''Procedure 6.12. Editing Host Network Interfaces and Assigning Logical Networks to Hosts'''

<ol>
<li>Use the '''Hosts''' resource tab, tree mode, or the search function to find and select the host in the results.</li>
<li>Click the '''Network Interfaces''' tab in the details pane.</li>
<li><p>Click the '''Setup Host Networks''' button to open the '''Setup Host Networks''' window.</p>
<p>⁠</p>
<p>[[Image:Setup_Host_Networks.png|400px|The Setup Host Networks window]]</p>
<p>'''Figure 6.2. The Setup Host Networks window'''</p></li>
<li>Attach a logical network to a physical host network interface by selecting and dragging the logical network into the '''Assigned Logical Networks''' area next to the physical host network interface.
Alternatively, right-click the logical network and select a network interface from the drop-down menu.</li>
<li>Configure the logical network:
<ol>
<li>Hover your cursor over an assigned logical network and click the pencil icon to open the '''Edit Management Network''' window.</li>
<li>Select a '''Boot Protocol''' from:
<ul>
<li>'''None''',</li>
<li>'''DHCP''', or</li>
<li>'''Static'''.
If you selected '''Static''', enter the '''IP''', '''Subnet Mask''', and the '''Gateway'''.</li></ul>
</li>
<li>Click '''OK'''.</li>
<li>If your logical network definition is not synchronized with the network configuration on the host, select the '''Sync network''' check box.</li></ol>
</li>
<li>Select the '''Verify connectivity between Host and Engine''' check box to check network connectivity; this action will only work if the host is in maintenance mode.</li>
<li>Select the '''Save network configuration''' check box to make the changes persistent when the environment is rebooted.</li>
<li>Click '''OK'''.</li></ol>

'''Result'''

You have assigned logical networks to and configured a physical host network interface.

<div class="alert alert-info">'''Note:''' If not all network interface cards for the host are displayed, click the '''Refresh Capabilities''' button to update the list of network interface cards available for that host.</div>

=== Bonds ===

==== Bonding Logic in oVirt ====

oVirt Administration Portal allows you to create bond devices using a graphical interface. There are several distinct bond creation scenarios, each with its own logic.

Two factors that affect bonding logic are:

* Are either of the devices already carrying logical networks?
* Are the devices carrying compatible logical networks? A single device cannot carry both VLAN tagged and non-VLAN tagged logical networks.

⁠

'''Table 6.5. Bonding Scenarios and Their Results'''

{| class="wikitable"
!width="50%"|Bonding Scenario
!width="50%"|'''Result'''
|- style="vertical-align:top;"
|NIC + NIC
|The '''Create New Bond''' window is displayed, and you can configure a new bond device.
If the network interfaces carry incompatible logical networks, the bonding operation fails until you detach incompatible logical networks from the devices forming your new bond.
|-
|NIC + Bond
|The NIC is added to the bond device. Logical networks carried by the NIC and the bond are all added to the resultant bond device if they are compatible.
If the bond devices carry incompatible logical networks, the bonding operation fails until you detach incompatible logical networks from the devices forming your new bond.
|-
|Bond + Bond
|If the bond devices are not attached to logical networks, or are attached to compatible logical networks, a new bond device is created. It contains all of the network interfaces, and carries all logical networks, of the component bond devices. The '''Create New Bond''' window is displayed, allowing you to configure your new bond.
If the bond devices carry incompatible logical networks, the bonding operation fails until you detach incompatible logical networks from the devices forming your new bond.
|}

==== Bonding Modes ====

oVirt supports the following common bonding modes:

* Mode 1 (active-backup policy) sets all interfaces to the backup state while one remains active. Upon failure on the active interface, a backup interface replaces it as the only active interface in the bond. The MAC address of the bond in mode 1 is visible on only one port (the network adapter), to prevent confusion for the switch. Mode 1 provides fault tolerance and is supported in oVirt.
* Mode 2 (XOR policy) selects an interface to transmit packages to based on the result of an XOR operation on the source and destination MAC addresses modulo NIC slave count. This calculation ensures that the same interface is selected for each destination MAC address used. Mode 2 provides fault tolerance and load balancing and is supported in oVirt.
* Mode 4 (IEEE 802.3ad policy) creates aggregation groups for which included interfaces share the speed and duplex settings. Mode 4 uses all interfaces in the active aggregation group in accordance with the IEEE 802.3ad specification and is supported in oVirt.
* Mode 5 (adaptive transmit load balancing policy) ensures the outgoing traffic distribution is according to the load on each interface and that the current interface receives all incoming traffic. If the interface assigned to receive traffic fails, another interface is assigned the receiving role instead. Mode 5 is supported in oVirt.

==== Creating a Bond Device Using the Administration Portal ====

'''Summary'''

You can bond compatible network devices together. This type of configuration can increase available bandwidth and reliability. You can bond multiple network interfaces, pre-existing bond devices, and combinations of the two.

A bond cannot carry both vlan tagged and non-vlan traffic.

⁠

'''Procedure 6.13. Creating a Bond Device using the Administration Portal'''

<ol>
<li>Use the '''Hosts''' resource tab, tree mode, or the search function to find and select the host in the results list.</li>
<li>Click the '''Network Interfaces''' tab in the details pane to list the physical network interfaces attached to the host.</li>
<li>Click '''Setup Host Networks''' to open the '''Setup Host Networks''' window.</li>
<li><p>Select and drag one of the devices over the top of another device and drop it to open the '''Create New Bond''' window. Alternatively, right-click the device and select another device from the drop-down menu.</p>
<p>If the devices are incompatible, for example one is vlan tagged and the other is not, the bond operation fails with a suggestion on how to correct the compatibility issue.</p>
<p>⁠</p>
<p>[[Image:Create_New_Bond.png|200px|Bond Devices Window]]</p>
<p>'''Figure 6.3. Bond Devices Window'''</p></li>
<li>Select the '''Bond Name''' and '''Bonding Mode''' from the drop-down menus.
Bonding modes 1, 2, 4, and 5 can be selected. Any other mode can be configured using the '''Custom''' option.</li>
<li>Click '''OK''' to create the bond and close the '''Create New Bond''' window.</li>
<li>Assign a logical network to the newly created bond device.</li>
<li>Optionally choose to '''Verify connectivity between Host and Engine''' and '''Save network configuration'''.</li>
<li>Click '''OK''' accept the changes and close the '''Setup Host Networks''' window.</li></ol>

'''Result'''

Your network devices are linked into a bond device and can be edited as a single interface. The bond device is listed in the '''Network Interfaces''' tab of the details pane for the selected host.

Bonding must be enabled for the ports of the switch used by the host. The process by which bonding is enabled is slightly different for each switch; consult the manual provided by your switch vendor for detailed information on how to enable bonding.

==== Example Uses of Custom Bonding Options with Host Interfaces ====

You can create customized bond devices by selecting '''Custom''' from the '''Bonding Mode''' of the '''Create New Bond''' window. The following examples should be adapted for your needs. For a comprehensive list of bonding options and their descriptions, see the [https://www.kernel.org/doc/Documentation/networking/bonding.txt ''Linux Ethernet Bonding Driver HOWTO''] on Kernel.org.

⁠

'''Example 6.1. xmit_hash_policy'''

This option defines the transmit load balancing policy for bonding modes 2 and 4. For example, if the majority of your traffic is between many different IP addresses, you may want to set a policy to balance by IP address. You can set this load-balancing policy by selecting a '''Custom''' bonding mode, and entering the following into the text field:

<pre class="screen">mode=4 xmit_hash_policy=layer2+3</pre>
⁠

'''Example 6.2. ARP Monitoring'''

ARP monitor is useful for systems which can't or don't report link-state properly via ethtool. Set an ''<code>arp_interval</code>'' on the bond device of the host by selecting a '''Custom''' bonding mode, and entering the following into the text field:

<pre class="screen">mode=1 arp_interval=1 arp_ip_target=192.168.0.2</pre>
⁠

'''Example 6.3. Primary'''

You may want to designate a NIC with higher throughput as the primary interface in a bond device. Designate which NIC is primary by selecting a '''Custom''' bonding mode, and entering the following into the text field:

<pre class="screen">mode=1 primary=eth0</pre>

=== Saving a Host Network Configuration ===

'''Summary'''

One of the options when configuring a host network is to save the configuration as you apply it, making the changes persistent.

Any changes made to the host network configuration will be temporary if you did not select the '''Save network configuration''' check box in the '''Setup Host Networks''' window.

Save the host network configuration to make it persistent.

⁠

'''Procedure 6.14. Saving a host network configuration'''

# Use the '''Hosts''' resource tab, tree mode, or the search function to find and select the host in the results list.
# Click the '''Network Interfaces''' tab on the Details pane to list the NICs on the host, their address, and other specifications.
# Click the '''Save Network Configuration''' button.
# The host network configuration is saved and the following message is displayed on the task bar: &quot;Network changes were saved on host ''[Hostname]''.&quot;

'''Result'''

The host's network configuration is saved persistently and will survive reboots.

<div class="alert alert-info">'''Note:''' Saving the host network configuration also updates the list of available network interfaces for the host. This behavior is similar to that of the '''Refresh Capabilities''' button.</div>

== Host Resilience ==

=== Host High Availability ===

oVirt uses fencing to keep the hosts in a cluster responsive. A '''Non Responsive''' host is different from a '''Non Operational''' host. '''Non Operational''' hosts can be communicated with by oVirt, but have an incorrect configuration, for example a missing logical network. '''Non Responsive''' hosts cannot be communicated with by oVirt.

If a host with a power management device loses communication with oVirt, it can be fenced (rebooted) from the Administration Portal. All the virtual machines running on that host are stopped, and highly available virtual machines are started on a different host.

All power management operations are done using a proxy host, as opposed to directly by oVirt. At least two hosts are required for power management operations.

Fencing allows a cluster to react to unexpected host failures as well as enforce power saving, load balancing, and virtual machine availability policies. You should configure the fencing parameters for your host's power management device and test their correctness from time to time.

Hosts can be fenced automatically using the power management parameters, or manually by right-clicking on a host and using the options on the menu. In a fencing operation, an unresponsive host is rebooted, and if the host does not return to an active status within a prescribed time, it remains unresponsive pending manual intervention and troubleshooting.

If the host is required to run virtual machines that are highly available, power management must be enabled and configured.

=== Power Management by Proxy in oVirt ===

oVirt does not communicate directly with fence agents. Instead, oVirt uses a proxy to send power management commands to a host power management device. oVirt uses VDSM to execute power management device actions, so another host in the environment is used as a fencing proxy.

You can select between:

* Any host in the same cluster as the host requiring fencing.
* Any host in the same data center as the host requiring fencing.

A viable fencing proxy host has a status of either ''UP'' or ''Maintenance''.

=== Setting Fencing Parameters on a Host ===

The parameters for host fencing are set using the '''Power Management''' fields on the '''New Host''' or '''Edit Host''' windows. Power management enables the system to fence a troublesome host using an additional interface such as a Remote Access Card (RAC).

All power management operations are done using a proxy host, as opposed to directly by oVirt. At least two hosts are required for power management operations.

⁠

'''Procedure 6.15. Setting fencing parameters on a host'''

<ol>
<li>Use the '''Hosts''' resource tab, tree mode, or the search function to find and select the host in the results list.</li>
<li>Click '''Edit''' to open the '''Edit Host''' window.</li>
<li><p>Click the '''Power Management''' tab.</p>
<p>⁠</p>
<p>[[Image:Edit Host Power Management.png|400px|Power Management Settings]]</p>
<p>'''Figure 6.4. Power Management Settings'''</p></li>
<li>Select the '''Enable Power Management''' check box to enable the fields.</li>
<li>The '''Primary''' option is selected by default if you are configuring a new power management device. If you are adding a new device, set it to '''Secondary'''.</li>
<li>Select the '''Concurrent''' check box to enable multiple fence agents to be used concurrently.</li>
<li>Enter the '''Address''', '''User Name''', and '''Password''' of the power management device.</li>
<li>Select the power management device '''Type''' from the drop-down menu.</li>
<li>Enter the '''Port''' number used by the power management device to communicate with the host.</li>
<li>Enter the specific '''Options''' of the power management device. Use a comma-separated list of 'key=value' or 'key' entries.</li>
<li><p>Click the '''Test''' button to test the power management device. ''Test Succeeded, Host Status is: on'' will display upon successful verification.</p>
<div class="alert alert-info">'''Warning:''' Power management parameters (userid, password, options, etc) are tested by oVirt only during setup and manually after that. If you choose to ignore alerts about incorrect parameters, or if the parameters are changed on the power management hardware without the corresponding change in oVirt, fencing is likely to fail when most needed.</div></li>
<li>Click '''OK''' to save the changes and close the window.</li></ol>

'''Result'''

You are returned to the list of hosts. Note that the exclamation mark next to the host's name has now disappeared, signifying that power management has been successfully configured.

=== Soft-Fencing Hosts ===

Sometimes a host becomes non-responsive due to an unexpected problem, and though VDSM is unable to respond to requests, the virtual machines that depend upon VDSM remain alive and accessible. In these situations, restarting VDSM returns VDSM to a responsive state and resolves this issue.

oVirt 3.3 introduces &quot;soft-fencing over SSH&quot;. Prior to oVirt 3.3, non-responsive hosts were fenced only by external fencing devices. In oVirt 3.3, the fencing process has been expanded to include &quot;SSH Soft Fencing&quot;, a process whereby oVirt attempts to restart VDSM via SSH on non-responsive hosts. If oVirt fails to restart VDSM via SSH, the responsibility for fencing falls to the external fencing agent if an external fencing agent has been configured.

Soft-fencing over SSH works as follows. Fencing must be configured and enabled on the host, and a valid proxy host (a second host, in an UP state, in the data center) must exist. When the connection between oVirt and the host times out, the following happens:

# On the first network failure, the status of the host changes to &quot;connecting&quot;.
# oVirt then makes three attempts to ask VDSM for its status, or it waits for an interval determined by the load on the host. The formula for determining the length of the interval is configured by the configuration values TimeoutToResetVdsInSeconds (the default is 60 seconds) + [DelayResetPerVmInSeconds (the default is 0.5 seconds)]*(the count of running vms on host) + [DelayResetForSpmInSeconds (the default is 20 seconds)] * 1 (if host runs as SPM) or 0 (if the host does not run as SPM). To give VDSM the maximum amount of time to respond, oVirt chooses the longer of the two options mentioned above (three attempts to retrieve the status of VDSM or the interval determined by the above formula).
# If the host does not respond when that interval has elapsed, <code>vdsm restart</code> is executed via SSH.
# If <code>vdsm restart</code> does not succeed in re-establishing the connection between the host and oVirt, the status of the host changes to <code>Non Responsive</code> and, if power management is configured, fencing is handed off to the external fencing agent.

<div class="alert alert-info">'''Note:''' Soft-fencing over SSH can be executed on hosts that have no power management configured. This is distinct from &quot;fencing&quot;: fencing can be executed only on hosts that have power management configured.</div>

=== Using Host Power Management Functions ===

'''Summary'''

When power management has been configured for a host, you can access a number of options from the Administration Portal interface. While each power management device has its own customizable options, they all support the basic options to start, stop, and restart a host.

⁠

'''Procedure 6.16. Using Host Power Management Functions'''

<ol>
<li>Use the '''Hosts''' resource tab, tree mode, or the search function to find and select the host in the results list.</li>
<li>Click the '''Power Management''' drop-down menu.</li>
<li>Select one of the following options:</li>
<ul>
<li>'''Restart''': This option stops the host and waits until the host's status changes to <code>Down</code>. When the agent has verified that the host is down, the highly available virtual machines are restarted on another host in the cluster. The agent then restarts this host. When the host is ready for use its status displays as <code>Up</code>.</li>
<li>'''Start''': This option starts the host and lets it join a cluster. When it is ready for use its status displays as <code>Up</code>.</li>
<li>'''Stop''': This option powers off the host. Before using this option, ensure that the virtual machines running on the host have been migrated to other hosts in the cluster. Otherwise the virtual machines will crash and only the highly available virtual machines will be restarted on another host. When the host has been stopped its status displays as <code>Non-Operational</code>.</li></ul>

<div class="alert alert-info">'''Important:''' When two fencing agents are defined on a host, they can be used concurrently or sequentially. For concurrent agents, both agents have to respond to the Stop command for the host to be stopped; and when one agent responds to the Start command, the host will go up. For sequential agents, to start or stop a host, the primary agent is used first; if it fails, the secondary agent is used.</div></li>
<li>Selecting one of the above options opens a confirmation window. Click '''OK''' to confirm and proceed.</li></ol>

'''Result'''

The selected action is performed.

=== Manually Fencing or Isolating a Non Responsive Host ===

'''Summary'''

If a host unpredictably goes into a non-responsive state, for example, due to a hardware failure; it can significantly affect the performance of the environment. If you do not have a power management device, or it is incorrectly configured, you can reboot the host manually.

<div class="alert alert-info">'''Warning:''' Do not use the '''Confirm host has been rebooted''' option unless you have manually rebooted the host. Using this option while the host is still running can lead to a virtual machine image corruption.</div>

⁠

'''Procedure 6.17. Manually fencing or isolating a non-responsive host'''

<ol>
<li>On the '''Hosts''' tab, select the host. The status must display as <code>non-responsive</code>.</li>
<li>Manually reboot the host. This could mean physically entering the lab and rebooting the host.</li>
<li>On the Administration Portal, right-click the host entry and select the '''Confirm Host has been rebooted''' button.</li>
<li>A message displays prompting you to ensure that the host has been shut down or rebooted. Select the '''Approve Operation''' check box and click '''OK'''.</li></ol>

'''Result'''

You have manually rebooted your host, allowing highly available virtual machines to be started on active hosts. You confirmed your manual fencing action in the Administrator Portal, and the host is back online.

= ⁠Storage =

oVirt uses a centralized storage system for virtual machine disk images, ISO files and snapshots. Storage networking can be implemented using:

* Network File System (NFS)
* GlusterFS exports
* Other POSIX compliant file systems
* Internet Small Computer System Interface (iSCSI)
* Local storage attached directly to the virtualization hosts
* Fibre Channel Protocol (FCP)
* Parallel NFS (pNFS)

Setting up storage is a prerequisite for a new data center because a data center cannot be initialized unless storage domains are attached and activated.

As an oVirt system administrator, you need to create, configure, attach and maintain storage for the virtualized enterprise. You should be familiar with the storage types and their use. Read your storage array vendor's guides, and refer to the ''Red Hat Enterprise Linux Storage Administration Guide'' for more information on the concepts, protocols, requirements or general usage of storage.

The oVirt platform enables you to assign and manage storage using the Administration Portal's '''Storage''' tab. The '''Storage''' results list displays all the storage domains, and the details pane shows general information about the domain.

oVirt platform has three types of storage domains:

<ul>
<li>'''Data Domain:''' A data domain holds the virtual hard disks and OVF files of all the virtual machines and templates in a data center. In addition, snapshots of the virtual machines are also stored in the data domain.
The data domain cannot be shared across data centers. Storage domains of multiple types (iSCSI, NFS, FC, POSIX, and Gluster) can be added to the same data center, provided they are all shared, rather than local, domains.
You must attach a data domain to a data center before you can attach domains of other types to it.</li>
<li>'''ISO Domain:''' ISO domains store ISO files (or logical CDs) used to install and boot operating systems and applications for the virtual machines. An ISO domain removes the data center's need for physical media. An ISO domain can be shared across different data centers.</li>
<li><p>'''Export Domain:''' Export domains are temporary storage repositories that are used to copy and move images between data centers and oVirt environments. Export domains can be used to backup virtual machines. An export domain can be moved between data centers, however, it can only be active in one data center at a time.</p>
<p>'''Important'''</p>
<p>Support for export storage domains backed by storage on anything other than NFS is being deprecated. While existing export storage domains imported from oVirt 2.2 environments remain supported new export storage domains must be created on NFS storage.</p></li></ul>

Only commence configuring and attaching storage for your oVirt environment once you have determined the storage needs of your data center(s).

<div class="alert alert-info">'''Important:''' To add storage domains you must be able to successfully access the Administration Portal, and there must be at least one host connected with a status of '''Up'''.</div>

== Understanding Storage Domains ==

A storage domain is a collection of images that have a common storage interface. A storage domain contains complete images of templates and virtual machines (including snapshots), or ISO files. A storage domain can be made of either block devices (SAN - iSCSI or FCP) or a file system (NAS - NFS, GlusterFS, or other POSIX compliant file systems).

On NFS, all virtual disks, templates, and snapshots are files.

On SAN (iSCSI/FCP), each virtual disk, template or snapshot is a logical volume. Block devices are aggregated into a logical entity called a volume group, and then divided by LVM (Logical Volume Manager) into logical volumes for use as virtual hard disks.

Virtual disks can have one of two formats, either Qcow2 or RAW. The type of storage can be either Sparse or Preallocated. Snapshots are always sparse but can be taken for disks created either as RAW or sparse.

Virtual machines that share the same storage domain can be migrated between hosts that belong to the same cluster.

== Storage Metadata Versions in oVirt ==

oVirt stores information about storage domains as metadata on the storage domains themselves. Each major release of oVirt has seen improved implementations of storage metadata.

<ul>
<li>''V1 metadata (oVirt 2.x series)''
Each storage domain contains metadata describing its own structure, and all of the names of physical volumes that are used to back virtual machine disk images.
Master domains additionally contain metadata for all the domains and physical volume names in the storage pool. The total size of this metadata is limited to 2 kb, limiting the number of storage domains that can be in a pool.
Template and virtual machine base images are read only.
V1 metadata is applicable to NFS, iSCSI, and FC storage domains.</li>
<li>''V2 metadata (oVirt 3.0)''
All storage domain and pool metadata is stored as logical volume tags rather than written to a logical volume. Metadata about virtual machine disk volumes is still stored in a logical volume on the domains.
Physical volume names are no longer included in the metadata.
Template and virtual machine base images are read only.
V2 metadata is applicable to iSCSI, and FC storage domains.</li>
<li>''V3 metadata (oVirt 3.1+)''
All storage domain and pool metadata is stored as logical volume tags rather than written to a logical volume. Metadata about virtual machine disk volumes is still stored in a logical volume on the domains.
Virtual machine and template base images are no longer read only. This change enables live snapshots, live storage migration, and clone from snapshot.
Support for unicode metadata is added, for non-English volume names.
V3 metadata is applicable to NFS, GlusterFS, POSIX, iSCSI, and FC storage domains.</li></ul>

== Preparing and Adding File-Based Storage ==

=== Preparing NFS Storage ===

'''Summary'''

These steps must be taken to prepare an NFS file share on a server running Red Hat Enterprise Linux 6 for use with oVirt.

⁠

'''Procedure 7.1. Preparing NFS Storage'''

<ol>
<li><p>'''Install nfs-utils'''</p>
<p>NFS functionality is provided by the nfs-utils package. Before file shares can be created, check that the package is installed by querying the RPM database for the system:</p>
<pre class="screen">$ rpm -qi nfs-utils</pre>
<p>If the nfs-utils package is installed then the package information will be displayed. If no output is displayed then the package is not currently installed. Install it using <code>yum</code> while logged in as the <code>root</code> user:</p>
<pre class="screen"># yum install nfs-utils</pre></li>
<li><p>'''Configure Boot Scripts'''</p>
<p>To ensure that NFS shares are always available when the system is operational both the <code>nfs</code> and <code>rpcbind</code> services must start at boot time. Use the <code>chkconfig</code> command while logged in as <code>root</code> to modify the boot scripts.</p>
<pre class="screen"># chkconfig --add rpcbind
# chkconfig --add nfs
# chkconfig rpcbind on
# chkconfig nfs on</pre>
<p>Once the boot script configuration has been done, start the services for the first time.</p>
<pre class="screen"># service rpcbind start
# service nfs start</pre></li>
<li><p>'''Create Directory'''</p>
<p>Create the directory you wish to share using NFS.</p>
<pre class="screen"># mkdir /exports/iso</pre>
<p>Replace ''/exports/iso'' with the name, and path of the directory you wish to use.</p></li>
<li><p>'''Export Directory'''</p>
<p>To be accessible over the network using NFS the directory must be exported. NFS exports are controlled using the <code>/etc/exports</code> configuration file. Each export path appears on a separate line followed by a tab character and any additional NFS options. Exports to be attached to oVirt must have the read, and write, options set.</p>
<p>To grant read, and write access to <code>/exports/iso</code> using NFS for example you add the following line to the <code>/etc/exports</code> file.</p>
<pre class="screen">/exports/iso       *(rw)</pre>
<p>Again, replace ''/exports/iso'' with the name, and path of the directory you wish to use.</p></li>
<li><p>'''Reload NFS Configuration'''</p>
<p>For the changes to the <code>/etc/exports</code> file to take effect the service must be told to reload the configuration. To force the service to reload the configuration run the following command as <code>root</code>:</p>
<pre class="screen"># service nfs reload</pre></li>
<li><p>'''Set Permissions'''</p>
<p>The NFS export directory must be configured for read write access and must be owned by vdsm:kvm. If these users do not exist on your external NFS server use the following command, assuming that <code>/exports/iso</code> is the directory to be used as an NFS share.</p>
<pre class="screen"># chown -R 36:36 /exports/iso</pre>
<p>The permissions on the directory must be set to allow read and write access to the owner, and read and execute access to the group and other users. The owner will also have execute access to the directory. The permissions are set using the <code>chmod</code> command. The following command arguments set the required permissions on the <code>/exports/iso</code> directory.</p>
<pre class="screen"># chmod 0755 /exports/iso</pre></li></ol>

'''Result'''

The NFS file share has been created, and is ready to be attached by oVirt.

=== Attaching NFS Storage ===

'''Summary'''

An NFS type '''Storage Domain''' is a mounted NFS share that is attached to a data center. It is used to provide storage for virtualized guest images and ISO boot media. Once NFS storage has been exported it must be attached to oVirt using the Administration Portal.

NFS data domains can be added to NFS data centers. You can add NFS, ISO, and export storage domains to data centers of any type.

'''Procedure 7.2. Attaching NFS Storage'''

<ol>
<li>Click the '''Storage''' resource tab to list the existing storage domains.</li>
<li><p>Click '''New Domain''' to open the '''New Domain''' window.</p>
<p>⁠</p>
<p>[[Image:New Domain.png|400px|NFS Storage]]</p>
<p>'''Figure 7.1. NFS Storage'''</p></li>
<li>Enter the '''Name''' of the storage domain.</li>
<li>Select the '''Data Center''', '''Domain Function / Storage Type''', and '''Use Host''' from the drop-down menus.
If applicable, select the '''Format''' from the drop-down menu.</li>
<li>Enter the '''Export Path''' to be used for the storage domain.
The export path should be in the format of <code>192.168.0.10:/data or domain.example.com:/data</code></li>
<li><p>Click '''Advanced Parameters''' to enable further configurable settings. It is recommended that the values of these parameters not be modified.</p>
<div class="alert alert-info">'''Important:''' All communication to the storage domain is from the selected host and not directly from oVirt. At least one active host must be attached to the chosen Data Center before the storage is configured.</div></li>
<li>Click '''OK''' to create the storage domain and close the window.</li></ol>

'''Result'''

The new NFS data domain is displayed on the '''Storage''' tab with a status of <code>Locked</code> while the disk prepares. It is automatically attached to the data center upon completion.

=== Preparing Local Storage ===

'''Summary'''

A local storage domain can be set up on a host. When you set up host to use local storage, the host automatically gets added to a new data center and cluster that no other hosts can be added to. Multiple host clusters require that all hosts have access to all storage domains, which is not possible with local storage. Virtual machines created in a single host cluster cannot be migrated, fenced or scheduled.

<div class="alert alert-info">'''Important:''' On oVirt Nodes the only path permitted for use as local storage is <code>/data/images</code>. This directory already exists with the correct permissions on Hypervisor installations. The steps in this procedure are only required when preparing local storage on Red Hat Enterprise Linux virtualization hosts.</div>

⁠

'''Procedure 7.3. Preparing Local Storage'''

<ol>
<li><p>On the virtualization host, create the directory to be used for the local storage.</p>
<pre class="screen"># mkdir -p /data/images</pre></li>
<li><p>Ensure that the directory has permissions allowing read/write access to the <code>vdsm</code> user (UID 36) and <code>kvm</code> group (GID 36).</p>
<pre class="screen"># chown 36:36 /data /data/images</pre>
<pre class="screen"># chmod 0755 /data /data/images</pre></li></ol>

'''Result'''

Your local storage is ready to be added to the oVirt environment.

=== Adding Local Storage ===

'''Summary'''

Storage local to your host has been prepared. Now use oVirt to add it to the host.

Adding local storage to a host in this manner causes the host to be put in a new data center and cluster. The local storage configuration window combines the creation of a data center, a cluster, and storage into a single process.

⁠

'''Procedure 7.4. Adding Local Storage'''

<ol>
<li>Use the '''Hosts''' resource tab, tree mode, or the search function to find and select the host in the results list.</li>
<li>Click '''Maintenance''' to open the '''Maintenance Host(s)''' confirmation window.</li>
<li>Click '''OK''' to initiate maintenance mode.</li>
<li><p>Click '''Configure Local Storage''' to open the '''Configure Local Storage''' window.</p>
<p>⁠</p>
<p>[[Image:Configure Local Storage.png|400px|Configure Local Storage Window]]</p>
<p>'''Figure 7.2. Configure Local Storage Window'''</p></li>
<li>Click the '''Edit''' buttons next to the '''Data Center''', '''Cluster''', and '''Storage''' fields to configure and name the local storage domain.</li>
<li>Set the path to your local storage in the text entry field.</li>
<li>If applicable, select the '''Optimization''' tab to configure the memory optimization policy for the new local storage cluster.</li>
<li>Click '''OK''' to save the settings and close the window.</li></ol>

'''Result'''

Your host comes online in a data center of its own.

== Adding POSIX Compliant File System Storage ==

oVirt 3.1 and higher supports the use of POSIX (native) file systems for storage. POSIX file system support allows you to mount file systems using the same mount options that you would normally use when mounting them manually from the command line. This functionality is intended to allow access to storage not exposed using NFS, iSCSI, or FCP.

Any POSIX compliant filesystem used as a storage domain in oVirt '''MUST''' support sparse files and direct I/O. The Common Internet File System (CIFS), for example, does not support direct I/O, making it incompatible with oVirt.

<div class="alert alert-info">'''Important:''' Do ''not'' mount NFS storage by creating a POSIX compliant file system Storage Domain. Always create an NFS Storage Domain instead.</div>

=== Attaching POSIX Compliant File System Storage ===

'''Summary'''

You want to use a POSIX compliant file system that is not exposed using NFS, iSCSI, or FCP as a storage domain.

⁠

'''Procedure 7.5. Attaching POSIX Compliant File System Storage'''

<ol>
<li>Click the '''Storage''' resource tab to list the existing storage domains in the results list.</li>
<li><p>Click '''New Domain''' to open the '''New Domain''' window.</p>
<p>⁠</p>
<p>[[Image:New Domain Posix.png|400px|POSIX Storage]]</p>
<p>'''Figure 7.3. POSIX Storage'''</p></li>
<li>Enter the '''Name''' for the storage domain.</li>
<li>Select the '''Data Center''' to be associated with the storage domain. The Data Center selected must be of type '''POSIX (POSIX compliant FS)'''. Alternatively, select <code>(none)</code>.</li>
<li>Select <code>Data / POSIX compliant FS</code> from the '''Domain Function / Storage Type''' drop-down menu.
If applicable, select the '''Format''' from the drop-down menu.</li>
<li>Select a host from the '''Use Host''' drop-down menu. Only hosts within the selected data center will be listed. The host that you select will be used to connect the storage domain.</li>
<li>Enter the '''Path''' to the POSIX file system, as you would normally provide it to the <code>mount</code> command.</li>
<li>Enter the '''VFS Type''', as you would normally provide it to the <code>mount</code> command using the ''<code>-t</code>'' argument. See <code>man mount</code> for a list of valid VFS types.</li>
<li>Enter additional '''Mount Options''', as you would normally provide them to the <code>mount</code> command using the ''<code>-o</code>'' argument. The mount options should be provided in a comma-separated list. See <code>man mount</code> for a list of valid mount options.</li>
<li>Click '''OK''' to attach the new Storage Domain and close the window.</li></ol>

'''Result'''

You have used a supported mechanism to attach an unsupported file system as a storage domain.

== Preparing and Adding Block Storage ==

=== Preparing iSCSI Storage ===

'''Summary'''

These steps must be taken to export iSCSI storage device from a server running Red Hat Enterprise Linux 6 to use as a storage domain with oVirt.

⁠

'''Procedure 7.6. Preparing iSCSI Storage'''

<ol>
<li><p>Install the '''scsi-target-utils''' package using the <code>yum</code> command as root on your storage server.</p>
<pre class="screen"># yum install -y scsi-target-utils</pre></li>
<li><p>Add the devices or files you want to export to the <code>/etc/tgt/targets.conf</code> file. Here is a generic example of a basic addition to the <code>targets.conf</code> file:</p>
<pre class="screen">&lt;target iqn.YEAR-MONTH.com.EXAMPLE:SERVER.targetX&gt;
          backing-store /PATH/TO/DEVICE1 # Becomes LUN 1
          backing-store /PATH/TO/DEVICE2 # Becomes LUN 2
          backing-store /PATH/TO/DEVICE3 # Becomes LUN 3
&lt;/target&gt;</pre>
<p>Targets are conventionally defined using the year and month they are created, the reversed fully qualified domain that the server is in, the server name, and a target number.</p></li>
<li><p>Start the '''tgtd''' service.</p>
<pre class="screen"># service tgtd start</pre></li>
<li><p>Make the '''tgtd''' start persistently across reboots.</p>
<pre class="screen"># chkconfig tgtd on</pre></li>
<li><p>Open an iptables firewall port to allow clients to access your iSCSI export. By default, iSCSI uses port 3260. This example inserts a firewall rule at position 6 in the INPUT table.</p>
<pre class="screen"># iptables -I INPUT 6 -p tcp --dport 3260 -j ACCEPT</pre></li>
<li><p>Save the iptables rule you just created.</p>
<pre class="screen"># service iptables save</pre></li></ol>

'''Result'''

You have created a basic iSCSI export. You can use it as an iSCSI data domain.

=== Adding iSCSI Storage ===

'''Summary'''

oVirt platform supports iSCSI storage by creating a storage domain from a volume group made of pre-existing LUNs. Neither volume groups nor LUNs can be attached to more than one storage domain at a time.

For information regarding the setup and configuration of iSCSI on Red Hat Enterprise Linux, see the ''Red Hat Enterprise Linux Storage Administration Guide''.

<div class="alert alert-info">'''Note:''' You can only add an iSCSI storage domain to a data center that is set up for iSCSI storage type.</div>

⁠

'''Procedure 7.7. Adding iSCSI Storage'''

<ol>
<li>Click the '''Storage''' resource tab to list the existing storage domains in the results list.</li>
<li>Click the '''New Domain''' button to open the '''New Domain''' window.</li>
<li><p>Enter the '''Name''' of the new storage domain.</p>
<p>⁠</p>
<p>[[Image:New Domain iscsi.png|400px|New iSCSI Domain]]</p>
<p>'''Figure 7.4. New iSCSI Domain'''</p></li>
<li>Use the '''Data Center''' drop-down menu to select an iSCSI data center.
If you do not yet have an appropriate iSCSI data center, select <code>(none)</code>.</li>
<li>Use the drop-down menus to select the '''Domain Function / Storage Type''' and the '''Format'''. The storage domain types that are not compatible with the chosen data center are not available.</li>
<li><p>Select an active host in the '''Use Host''' field. If this is not the first data domain in a data center, you must select the data center's SPM host.</p>
<div class="alert alert-info">'''Important:''' All communication to the storage domain is via the selected host and not directly from oVirt. At least one active host must exist in the system, and be attached to the chosen data center, before the storage is configured.</div></li>
<li><p>oVirt is able to map either iSCSI targets to LUNs, or LUNs to iSCSI targets. The '''New Domain''' window automatically displays known targets with unused LUNs when iSCSI is selected as the storage type. If the target that you are adding storage from is not listed then you can use target discovery to find it, otherwise proceed to the next step.</p>
<p>'''iSCSI Target Discovery'''</p>
<ol>
<li><p>Click '''Discover Targets''' to enable target discovery options. When targets have been discovered and logged in to, the '''New Domain''' window automatically displays targets with LUNs unused by the environment.</p>
<div class="alert alert-info">'''Note:''' LUNs used externally to the environment are also displayed.</div>
<p>You can use the '''Discover Targets''' options to add LUNs on many targets, or multiple paths to the same LUNs.</p></li>
<li>Enter the fully qualified domain name or IP address of the iSCSI host in the '''Address''' field.</li>
<li>Enter the port to connect to the host on when browsing for targets in the '''Port''' field. The default is <code>3260</code>.</li>
<li>If the Challenge Handshake Authentication Protocol (CHAP) is being used to secure the storage, select the '''User Authentication''' check box. Enter the '''CHAP user name''' and '''CHAP password'''.</li>
<li>Click the '''Discover''' button.</li>
<li>Select the target to use from the discovery results and click the '''Login''' button.
Alternatively, click the '''Login All''' to log in to all of the discovered targets.</li></ol>
</li>
<li>Click the '''+''' button next to the desired target. This will expand the entry and display all unused LUNs attached to the target.</li>
<li>Select the check box for each LUN that you are using to create the storage domain.</li>
<li>Click '''OK''' to create the storage domain and close the window.</li></ol>

'''Result'''

The new iSCSI storage domain displays on the storage tab. This can take up to 5 minutes.

=== Adding FCP Storage ===

'''Summary'''

oVirt platform supports SAN storage by creating a storage domain from a volume group made of pre-existing LUNs. Neither volume groups nor LUNs can be attached to more than one storage domain at a time.

oVirt system administrators need a working knowledge of Storage Area Networks (SAN) concepts. SAN usually uses Fibre Channel Protocol (FCP) for traffic between hosts and shared external storage. For this reason, SAN may occasionally be referred to as FCP storage.

For information regarding the setup and configuration of FCP or multipathing on Red Hat Enterprise Linux, please refer to the ''Storage Administration Guide'' and ''DM Multipath Guide''.

<div class="alert alert-info">'''Note:''' You can only add an FCP storage domain to a data center that is set up for FCP storage type.</div>

'''Procedure 7.8. Adding FCP Storage'''

<ol>
<li>Click the '''Storage''' resource tab to list all storage domains in the virtualized environment.</li>
<li>Click '''New Domain''' to open the '''New Domain''' window.</li>
<li><p>Enter the '''Name''' of the storage domain</p>
<p>⁠</p>
<p>[[Image:New Domain FCP.png|400px|Adding FCP Storage]]</p>
<p>'''Figure 7.5. Adding FCP Storage'''</p></li>
<li>Use the '''Data Center''' drop-down menu to select an FCP data center.
If you do not yet have an appropriate FCP data center, select <code>(none)</code>.</li>
<li>Use the drop-down menus to select the '''Domain Function / Storage Type''' and the '''Format'''. The storage domain types that are not compatible with the chosen data center are not available.</li>
<li><p>Select an active host in the '''Use Host''' field. If this is not the first data domain in a data center, you must select the data center's SPM host.</p>
<p>'''Important'''</p>
<p>All communication to the storage domain is via the selected host and not directly from oVirt. At least one active host must exist in the system, and be attached to the chosen data center, before the storage is configured.</p></li>
<li>The '''New Domain''' window automatically displays known targets with unused LUNs when '''Data / Fibre Channel''' is selected as the storage type. Select the '''LUN ID''' check box to select all of the available LUNs.</li>
<li>Click '''OK''' to create the storage domain and close the window.</li></ol>

'''Result'''

The new FCP data domain displays on the '''Storage''' tab. It will remain with a <code>Locked</code> status while it is being prepared for use. When ready, it is automatically attached to the data center.

=== Unusable LUNs in oVirt ===

In certain circumstances, oVirt will not allow you to use a LUN to create a storage domain or virtual machine hard disk.

<ul>
<li>LUNs that are already part of the current oVirt environment are automatically prevented from being used.</li>
<li>LUNs that are already being used by the SPM host will also display as in use. You can choose to forcefully over ride the contents of these LUNs, but the operation is not guaranteed to succeed.</li></ul>

== Storage Tasks ==

=== Importing Existing ISO or Export Storage Domains ===

'''Summary'''

You have an ISO or export domain that you have been using with a different data center. You want to attach it to the data center you are using, and import virtual machines or use ISOs.

⁠

'''Procedure 7.9. Importing an Existing ISO or Export Storage Domain'''

<ol>
<li>Click the '''Storage''' resource tab to list all the available storage domains in the results list.</li>
<li><p>Click '''Import Domain''' to open the '''Import Pre-Configured Domain''' window.</p>
<p>⁠</p>
<p>[[Image:Import Domain.png|400px|Import Domain]]</p>
<p>'''Figure 7.6. Import Pre-Configured Domain'''</p></li>
<li>Select the appropriate '''Domain Function / Storage Type''' from the following:
<ul>
<li>ISO</li>
<li>Export</li></ul>

The '''Domain Function / Storage Type''' determines the availability of the '''Format''' field.</li>
<li><p>Select the SPM host from the '''Use host''' drop-down menu.</p>
<div class="alert alert-info">'''Important:'''All communication to the storage domain is via the selected host and not from oVirt. At least one host must be active and have access to the storage before the storage can be configured.</div></li>
<li>Enter the '''Export path''' of the storage. The export path can be either a static '''IP address''' or a resolvable hostname. For example, <code>192.168.0.10:/Images/ISO</code> or <code>storage.demo.redhat.com:/exports/iso</code>.</li>
<li>Click '''OK''' to import the domain and close the window.</li>
<li>The storage domain is imported and displays on the '''Storage''' tab. The next step is to attach it to a data center. This is described later in this chapter, .</li></ol>

'''Result'''

You have imported your export or ISO domain to you data center. Attach it to a data center to use it.

=== Populating the ISO Storage Domain ===

'''Summary'''

An ISO storage domain is attached to a data center, ISO images must be uploaded to it. oVirt provides an ISO uploader tool that ensures that the images are uploaded into the correct directory path, with the correct user permissions.

The creation of ISO images from physical media is not described in this document. It is assumed that you have access to the images required for your environment.

⁠

'''Procedure 7.10. Populating the ISO Storage Domain'''

<ol>
<li>Copy the required ISO image to a temporary directory on the system running oVirt.</li>
<li>Log in to the system running oVirt as the <code>root</code> user.</li>
<li><p>Use the <code>engine-iso-uploader</code> command to upload the ISO image. This action will take some time, the amount of time varies depending on the size of the image being uploaded and available network bandwidth.</p>
<p>⁠</p>
<p>'''Example 7.1. ISO Uploader Usage'''</p>
<p>In this example the ISO image <code>RHEL6.iso</code> is uploaded to the ISO domain called <code>ISODomain</code> using NFS. The command will prompt for an administrative user name and password. The user name must be provided in the form ''user name''@''domain''.</p>
<pre class="screen"># engine-iso-uploader --iso-domain=ISODomain upload RHEL6.iso</pre></li></ol>

'''Result'''

The ISO image is uploaded and appears in the ISO storage domain specified. It is also available in the list of available boot media when creating virtual machines in the data center which the storage domain is attached to.

=== Moving Storage Domains to Maintenance Mode ===

'''Summary'''

Detaching and removing storage domains requires that they be in maintenance mode. This is required to redesignate another data domain as the master data domain.

Editing domains and expanding iSCSI domains by adding more LUNs can only be done when the domain is active.

<div class="alert alert-info">'''Important:''' Put any active ISO and export domains in maintenance mode using this procedure.</div>

⁠

'''Procedure 7.11. Moving storage domains to maintenance mode'''

# Use the '''Storage''' resource tab, tree mode, or the search function to find and select the storage domain in the results list.
# Shut down and move all the virtual machines running on the storage domain.
# Click the '''Data Centers''' tab in the details pane.
# Click '''Maintenance''' to open the '''Maintenance Storage Domain(s)''' confirmation window.
# Click '''OK''' to initiate maintenance mode. The storage domain is deactivated and has an <code>Inactive</code> status in the results list.

'''Result'''

You can now edit, detach, remove, or reactivate the inactive storage domains from the data center.

<div class="alert alert-info">'''Note:''' You can also activate, detach and place domains into maintenance mode using the Storage tab on the details pane of the data center it is associated with.</div>

=== Editing a Resource ===

'''Summary'''

Edit the properties of a resource.

⁠

'''Procedure 7.12. Editing a Resource'''

# Use the resource tabs, tree mode, or the search function to find and select the resource in the results list.
# Click '''Edit''' to open the '''Edit''' window.
# Change the necessary properties and click '''OK'''.

'''Result'''

The new properties are saved to the resource. The '''Edit''' window will not close if a property field is invalid.

=== Activating Storage Domains ===

'''Summary'''

If you have been making changes to a data center's storage, you have to put storage domains into maintenance mode. Activate a storage domain to resume using it.

<ol>
<li>Use the '''Storage''' resource tab, tree mode, or the search function to find and select the inactive storage domain in the results list.</li>
<li>Click the '''Data Centers''' tab in the details pane.</li>
<li><p>Select the appropriate data center and click '''Activate'''.</p>
<div class="alert alert-info">'''Important:''' If you attempt to activate the ISO domain before activating the data domain, an error message displays and the domain is not activated.</div></li></ol>

'''Result'''

Your storage domain is active and ready for use.

=== Removing a Storage Domain ===

'''Summary'''

You have a storage domain in your data center that you want to remove from the virtualized environment.

⁠

'''Procedure 7.13. Removing a Storage Domain'''

# Use the '''Storage''' resource tab, tree mode, or the search function to find and select the appropriate storage domain in the results list.
# Move the domain into maintenance mode to deactivate it.
# Detach the domain from the data center.
# Click '''Remove''' to open the '''Remove Storage''' confirmation window.
# Select a host from the list.
# Click '''OK''' to remove the storage domain and close the window.

'''Summary'''

The storage domain is permanently removed from the environment.

=== Destroying a Storage Domain ===

'''Summary'''

A storage domain encountering errors may not be able to be removed through the normal procedure. Destroying a storage domain will forcibly remove the storage domain from the virtualized environment without reference to the export directory.

When the storage domain is destroyed, you are required to manually fix the export directory of the storage domain before it can be used again.

⁠

'''Procedure 7.14. Destroying a Storage Domain'''

# Use the '''Storage''' resource tab, tree mode, or the search function to find and select the appropriate storage domain in the results list.
# Right-click the storage domain and select '''Destroy''' to open the '''Destroy Storage Domain''' confirmation window.
# Select the '''Approve operation''' check box and click '''OK''' to destroy the storage domain and close the window.

'''Result'''

The storage domain has been destroyed. Manually clean the export directory for the storage domain to recycle it.

=== Detaching the Export Domain ===

'''Summary'''

Detach the export domain from the data center to import the templates to another data center.

⁠

'''Procedure 7.15. Detaching an Export Domain from the Data Center'''

# Use the '''Storage''' resource tab, tree mode, or the search function to find and select the export domain in the results list.
# Click the '''Data Centers''' tab in the details pane and select the export domain.
# Click '''Maintenance''' to open the '''Maintenance Storage Domain(s)''' confirmation window.
# Click '''OK''' to initiate maintenance mode.
# Click '''Detach''' to open the '''Detach Storage''' confirmation window.
# Click '''OK''' to detach the export domain.

'''Result'''

The export domain has been detached from the data center, ready to be attached to another data center.

=== Attaching an Export Domain to a Data Center ===

'''Summary'''

Attach the export domain to a data center.

⁠

'''Procedure 7.16. Attaching an Export Domain to a Data Center'''

# Use the '''Storage''' resource tab, tree mode, or the search function to find and select the export domain in the results list.
# Click the '''Data Centers''' tab in the details pane.
# Click '''Attach''' to open the '''Attach to Data Center''' window.
# Select the radio button of the appropriate data center.
# Click '''OK''' to attach the export domain.

'''Result'''

The export domain is attached to the data center and is automatically activated.

= Virtual Machines =

== Introduction to Virtual Machines ==

A virtual machine is a software implementation of a computer. The oVirt environment enables you to create virtual desktops and virtual servers.

Virtual machines consolidate computing tasks and workloads. In traditional computing environments, workloads usually run on individually administered and upgraded servers. Virtual machines reduce the amount of hardware and administration required to run the same computing tasks and workloads.

== Supported Virtual Machine Operating Systems ==

The operating systems that can be virtualized as guest operating systems in oVirt are as follows:

⁠

'''Table 8.1. Operating systems that can be used as guest operating systems'''

{| class="wikitable"
!width="60%"|Operating System
!width="20%"|Architecture
!width="20%"|SPICE support
|- style="vertical-align:top;"
|Red Hat Enterprise Linux 3
|32-bit, 64-bit
|Yes
|-
|Red Hat Enterprise Linux 4
|32-bit, 64-bit
|Yes
|-
|Red Hat Enterprise Linux 5
|32-bit, 64-bit
|Yes
|-
|Red Hat Enterprise Linux 6
|32-bit, 64-bit
|Yes
|-
|Red Hat Enterprise Linux 7
|32-bit, 64-bit
|Yes
|-
|SUSE Linux Enterprise Server 10 (select '''Other Linux''' for the guest type in the user interface)
|32-bit, 64-bit
|No
|-
|SUSE Linux Enterprise Server 11 (SPICE drivers (QXL) are not supplied by Red Hat. However, the distribution's vendor may provide SPICE drivers as part of their distribution.)
|32-bit, 64-bit
|No
|-
|Ubuntu 12.04 (Precise Pangolin LTS)
|32-bit, 64-bit
|Yes
|-
|Ubuntu 12.10 (Quantal Quetzal)
|32-bit, 64-bit
|Yes
|-
|Ubuntu 13.04 (Raring Ringtail)
|32-bit, 64-bit
|No
|-
|Ubuntu 13.10 (Saucy Salamander)
|32-bit, 64-bit
|Yes
|-
|Windows XP Service Pack 3 and newer
|32-bit
|Yes
|-
|Windows 7
|32-bit, 64-bit
|Yes
|-
|Windows 8
|32-bit, 64-bit
|No
|-
|Windows Server 2003 Service Pack 2 and newer
|32-bit, 64-bit
|Yes
|-
|Windows Server 2003 R2
|32-bit, 64-bit
|Yes
|-
|Windows Server 2008
|32-bit, 64-bit
|Yes
|-
|Windows Server 2008 R2
|64-bit
|Yes
|-
|Windows Server 2012
|64-bit
|No
|-
|Windows Server 2012 R2
|64-bit
|No
|}

Remote Desktop Protocol (RDP) is the default connection protocol for accessing Windows 8 and Windows 2012 guests from the user portal as Microsoft introduced changes to the Windows Display Driver Model that prevent SPICE from performing optimally.

<div class="alert alert-info">'''Note:''' While Red Hat Enterprise Linux 3 and Red Hat Enterprise Linux 4 are supported, virtual machines running the 32-bit version of these operating systems cannot be shut down gracefully from the administration portal because there is no ACPI support in the 32-bit x86 kernel. To terminate virtual machines running the 32-bit version of Red Hat Enterprise Linux 3 or Red Hat Enterprise Linux 4, right-click the virtual machine and select the '''Power Off''' option.</div>

== Virtual Machine Performance Parameters ==

oVirt virtual machines can support the following parameters:

'''Table 8.2. Supported virtual machine parameters'''

{| class="wikitable"
!width="33%"|Parameter
!width="33%"|Number
!width="33%"|Note
|- style="vertical-align:top;"
|Virtualized CPUs
|160
|per virtual machine
|-
|Virtualized RAM
|2TB
|For a 64 bit virtual machine
|-
|Virtualized RAM
|4GB
|per 32 bit virtual machine. Note, the virtual machine may not register the entire 4GB. The amount of RAM that the virtual machine recognizes is limited by its operating system.
|-
|Virtualized storage devices
|8
|per virtual machine
|-
|Virtualized network interface controllers
|8
|per virtual machine
|-
|Virtualized PCI devices
|32
|per virtual machine
|}

== Creating Virtual Machines ==

=== Creating a Virtual Machine ===

'''Summary'''

You can create a virtual machine using a blank template and configure all of its settings.

'''Procedure 8.1. Creating a Virtual Machine'''

<ol>
<li>Click the '''Virtual Machines''' tab.</li>
<li><p>Click the '''New VM''' button to open the '''New Virtual Machine''' window.</p>
<p>⁠</p>
<p>[[Image:New Virtual Machine.png|400px|The New Virtual Machine Window]]</p>
<p>'''Figure 8.1. The New Virtual Machine Window'''</p></li>
<li>On the '''General''' tab, fill in the '''Name''' and '''Operating System''' fields. You can accept the default settings for other fields, or change them if required.</li>
<li>Alternatively, click the '''Initial Run''', '''Console''', '''Host''', '''Resource Allocation''', '''Boot Options''', and '''Custom Properties''' tabs in turn to define options for your virtual machine.</li>
<li>Click '''OK''' to create the virtual machine and close the window.
The '''New Virtual Machine - Guide Me''' window opens.</li>
<li>Use the Guide Me buttons to complete configuration or click '''Configure Later''' to close the window.</li></ol>

'''Result'''

The new virtual machine is created and displays in the list of virtual machines with a status of <code>Down</code>. Before you can use this virtual machine, add at least one network interface and one virtual disk, and install an operating system.

=== Creating a Virtual Machine Based on a Template ===

'''Summary'''

You can create virtual machines based on templates. This allows you to create virtual machines that are pre-configured with an operating system, network interfaces, applications and other resources.

<div class="alert alert-info">'''Note:''' Virtual machines created based on a template depend on that template. This means that you cannot remove that template from oVirt if there is a virtual machine that was created based on that template. However, you can clone a virtual machine from a template to remove the dependency on that template.</div>

⁠

'''Procedure 8.2. Creating a Virtual Machine Based on a Template'''

<ol>
<li>Click the '''Virtual Machines''' tab.</li>
<li>Click the '''New VM''' button to open the '''New Virtual Machine''' window.</li>
<li>Select the '''Cluster''' on which the virtual machine will run.</li>
<li>Select a template from the '''Based on Template''' drop-down menu.</li>
<li>Select a template sub version from the '''Template Sub Version''' drop-down menu.</li>
<li>Enter a '''Name''', '''Description''' and any '''Comments''', and accept the default values inherited from the template in the rest of the fields. You can change them if needed.</li>
<li>Click the '''Show Advanced Options''' button.
<li><p>Click the '''Resource Allocation''' tab.</p>

<p>[[Image:New Virtual Machine Resource Allocation.png|400px|Provisioning - Thin]]</p>
<p>'''Figure 8.2. Provisioning - Thin'''</p></li>
<li>Select the '''Thin''' radio button in the '''Storage Allocation''' area.</li>
<li>Select the disk provisioning policy from the '''Allocation Policy''' drop-down menu. This policy affects the speed of the clone operation and the amount of disk space the new virtual machine initially requires.
<ul>
<li>Selecting '''Thin Provision''' results in a faster clone operation and provides optimized usage of storage capacity. Disk space is allocated only as it is required. This is the default selection.</li>
<li>Selecting '''Preallocated''' results in a slower clone operation and provides optimized virtual machine read and write operations. All disk space requested in the template is allocated at the time of the clone operation.</li></ul>
</li>
<li>Use the '''Target''' drop-down menu to select the storage domain on which the virtual machine's virtual disk will be stored.</li>
<li>Click '''OK'''.</li></ol>

'''Result'''

The virtual machine is created and displayed in the list in the '''Virtual Machines''' tab. You can now log on to the virtual machine and begin using it, or assign users to it.

=== Creating a Cloned Virtual Machine Based on a Template ===

'''Summary'''

Cloned virtual machines are similar to virtual machines based on templates. However, while a cloned virtual machine inherits settings in the same way as a virtual machine based on a template, a cloned virtual machine does not depend on the template on which it was based after it has been created.

<div class="alert alert-info">'''Note:''' If you clone a virtual machine from a template, the name of the template on which that virtual machine was based is displayed in the '''General''' tab of the '''Edit Virtual Machine''' window for that virtual machine. If you change the name of that template, the name of the template in the '''General''' tab will also be updated. However, if you delete the template from oVirt, the original name of that template will be displayed instead.</div>

⁠

'''Procedure 8.3. Cloning a Virtual Machine Based on a Template'''

<ol>
<li>Click the '''Virtual Machines''' tab.</li>
<li>Click the '''New VM''' button to open the '''New Virtual Machine''' window.</li>
<li>Select the '''Cluster''' on which the virtual machine will run.</li>
<li>Select a template from the '''Based on Template''' drop-down menu.</li>
<li>Select a template sub version from the '''Template Sub Version''' drop-down menu.</li>
<li>Enter a '''Name''', '''Description''' and any '''Comments'''. You can accept the default values inherited from the template in the rest of the fields, or change them if required.</li>
<li>Click the '''Show Advanced Options''' button.
<li><p>Click the '''Resource Allocation''' tab.</p>

<p>[[Image:New Virtual Machine Clone Allocation.png|400px|Provisioning - Clone]]</p>
<p>'''Figure 8.3. Provisioning - Clone'''</p></li>
<li>Select the '''Clone''' radio button in the '''Storage Allocation''' area.</li>
<li>Select the disk provisioning policy from the '''Allocation Policy''' drop-down menu. This policy affects the speed of the clone operation and the amount of disk space the new virtual machine initially requires.
<ul>
<li>Selecting '''Thin Provision''' results in a faster clone operation and provides optimized usage of storage capacity. Disk space is allocated only as it is required. This is the default selection.</li>
<li>Selecting '''Preallocated''' results in a slower clone operation and provides optimized virtual machine read and write operations. All disk space requested in the template is allocated at the time of the clone operation.</li></ul>
</li>
<li>Use the '''Target''' drop-down menu to select the storage domain on which the virtual machine's virtual disk will be stored.</li>
<li>Click '''OK'''.</li></ol>

<div class="alert alert-info">'''Note:''' Cloning a virtual machine may take some time. A new copy of the template's disk must be created. During this time, the virtual machine's status is first '''Image Locked''', then '''Down'''.</div>

'''Result'''

The virtual machine is created and displayed in the list in the '''Virtual Machines''' tab. You can now assign users to it, and can begin using it when the clone operation is complete.

== Explanation of Settings and Controls in the New Virtual Machine and Edit Virtual Machine Windows ==

=== Virtual Machine General Settings Explained ===

The following table details the options available on the '''General''' tab of the '''New Virtual Machine''' and '''Edit Virtual Machine''' windows.

⁠

'''Table 8.3. Virtual Machine: General Settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''Cluster'''
|The name of the host cluster to which the virtual machine is attached. Virtual machines are hosted on any physical machine in that cluster in accordance with policy rules.
|-
|'''Based on Template'''
|The template on which the virtual machine can be based. This field is set to <code>Blank</code> by default, which allows you to create a virtual machine on which an operating system has not yet been installed.
|-
|'''Template Sub Version'''
|The version of the template on which the virtual machine can be based. This field is set to the most recent version for the given template by default. If no versions other than the base template are available, this field is set to <code>base template</code> by default. Each version is marked by a number in brackets that indicates the relative order of the versions, with higher numbers indicating more recent versions.
|-
|'''Operating System'''
|The operating system. Valid values include a range of Red Hat Enterprise Linux and Windows variants.
|-
|'''Optimized for'''
|The type of system for which the virtual machine is to be optimized. There are two options: '''Server''', and '''Desktop'''; by default, the field is set to '''Server'''. Virtual machines optimized to act as servers have no sound card, use a cloned disk image, and are not stateless. In contrast, virtual machines optimized to act as desktop machines do have a sound card, use an image (thin allocation), and are stateless.
|-
|'''Name'''
|The name of the virtual machine. Names must not contain any spaces, and must contain at least one character from A-Z or 0-9. The maximum length of a virtual machine name is 64 characters.
|-
|'''Description'''
|A meaningful description of the new virtual machine.
|-
|'''Comment'''
|A field for adding plain text human-readable comments regarding the virtual machine.
|-
|'''Stateless'''
|Select this check box to run the virtual machine in stateless mode. This mode is used primarily for desktop VMs. Running a stateless desktop or server creates a new COW layer on the VM hard disk image where new and changed data is stored. Shutting down the stateless VM deletes the new COW layer, which returns the VM to its original state. Stateless VMs are useful when creating machines that need to be used for a short time, or by temporary staff.
|-
|'''Start in Pause Mode'''
|Select this check box to always start the virtual machine in pause mode. This option is suitable for VMs which require a long time to establish a SPICE connection; for example, VMs in remote locations.
|-
|'''Delete Protection'''
|Select this check box to make it impossible to delete the virtual machine. It is only possible to delete the virtual machine if this check box is not selected.
|}

At the bottom of the '''General''' tab is a drop-down box that allows you to assign network interfaces to the new virtual machine. Use the plus and minus buttons to add or remove additional network interfaces.

=== Virtual Machine System Settings Explained ===

The following table details the options available on the '''System''' tab of the '''New Virtual Machine''' and '''Edit Virtual Machine''' windows.

⁠

'''Table 8.4. Virtual Machine: System Settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''Memory Size'''
|The amount of memory assigned to the virtual machine. When allocating memory, consider the processing and storage needs of the applications that are intended to run on the virtual machine.
Maximum guest memory is constrained by the selected guest architecture and the cluster compatibility level.
|-
|'''Total Virtual CPUs'''
|The processing power allocated to the virtual machine as CPU Cores. Do not assign more cores to a virtual machine than are present on the physical host.
|-
|'''Cores per Virtual Socket'''
|The number of cores assigned to each virtual socket.
|-
|'''Virtual Sockets'''
|The number of CPU sockets for the virtual machine. Do not assign more sockets to a virtual machine than are present on the physical host.
|}

=== Virtual Machine Initial Run Settings Explained ===

The following table details the options available on the '''Initial Run''' tab of the '''New Virtual Machine''' and '''Edit Virtual Machine''' windows. The settings in this table are only visible if the '''Use Cloud-Init/Sysprep''' check box is selected.

⁠

'''Table 8.5. Virtual Machine: Initial Run Settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''Use Cloud-Init/Sysprep'''
|This check box toggles whether Cloud-Init or Sysprep will be used to initialize the virtual machine.
|-
|'''VM Hostname'''
|Allows you to specify a host name for the virtual machine.
|-
|'''Configure Time Zone'''
|Allows you to apply a specific time zone for the virtual machine. Select this check box and select a time zone from the '''Time Zone''' drop-down menu.
|-
|'''Authentication'''
|Allows you to configure authentication details for the virtual machine. Click the disclosure arrow to display the settings for this option.
* '''Use already configured password''': Allows you to specify that any passwords that have been configured for the virtual machine will be used.
* '''Root Password''': Allows you to specify a root password for the virtual machine. Enter the password in this text field and the '''Verify Root Password''' text field to verify the password.
* '''SSH Authorized Keys''': Allows you to specify SSH keys to be added to the authorized keys file of the virtual machine.
* '''Regenerate SSH Keys''': Allows you to regenerate SSH keys for the virtual machine.
|-
|'''Networks'''
|Allows you to specify network-related settings for the virtual machine. Click the disclosure arrow to display the settings for this option.
* '''DNS Servers''': Allows you to specify the DNS servers to be used by the virtual machine.
* '''DNS Search Domains''': Allows you to specify the DNS search domains to be used by the virtual machine.
* '''Network''': Allows you to configure network interfaces for the virtual machine. Select this check box and use the '''+''' and '''-''' buttons to add or remove network interfaces to or from the virtual machine. When you click the '''+''' button, a set of fields becomes visible that allow you to specify whether to use DHCP, and configure an IP address, netmask, and gateway, and also specify whether the network interface will start on boot.
|-
|'''Custom Script'''
|Allows you to enter custom scripts that will be run on the virtual machine when it starts. The scripts entered in this field are custom YAML sections that are added to those produced by oVirt, and allow you to automate tasks such as creating users and files, configuring '''yum''' repositories and running commands. For more information on the format of scripts that can be entered in this field, see the [http://www.ovirt.org/Features/vm-init-persistent#Custom_Script Custom Script] documentation.
|}

=== Virtual Machine Console Settings Explained ===

The following table details the options available on the '''Console''' tab of the '''New Virtual Machine''' and '''Edit Virtual Machine''' windows.

⁠

'''Table 8.6. Virtual Machine: Console Settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''Protocol'''
|Defines which display protocol to use. '''SPICE''' is the recommended protocol for Linux and Windows virtual machines, excepting Windows 8 and Windows Server 2012. Optionally, select '''VNC''' for Linux virtual machines. A VNC client is required to connect to a virtual machine using the VNC protocol.
|-
|'''VNC Keyboard Layout'''
|Defines the keyboard layout for the virtual machine. This option is only available when using the VNC protocol.
|-
|'''USB Support'''
|Defines whether USB devices can be used on the virtual machine. This option is only available for virtual machines using the SPICE protocol. Select either:
* '''Disabled''' - Does not allow USB redirection from the client machine to the virtual machine.
* '''Legacy''' - Enables the SPICE USB redirection policy used in oVirt 3.0. This option can only be used on Windows virtual machines, and will not be supported in future versions of oVirt.
* '''Native''' - Enables native KVM/SPICE USB redirection for Linux and Windows virtual machines. Virtual machines do not require any in-guest agents or drivers for native USB. This option can only be used if the virtual machine's cluster compatibility version is set to 3.1 or higher.
|-
|'''Monitors'''
|The number of monitors for the virtual machine. This option is only available for virtual desktops using the SPICE display protocol. You can choose '''1''', '''2''' or '''4'''. Since Windows 8 and Windows Server 2012 virtual machines do not support the SPICE protocol, they do not support multiple monitors.
|-
|'''Smartcard Enabled'''
|Smart cards are an external hardware security feature, most commonly seen in credit cards, but also used by many businesses as authentication tokens. Smart cards can be used to protect oVirt virtual machines. Tick or untick the check box to activate and deactivate Smart card authentication for individual virtual machines.
|-
|'''Disable strict user checking'''
|Click the '''Advanced Parameters''' arrow and select the check box to use this option. With this option selected, the virtual machine does not need to be rebooted when a different user connects to it.
By default, strict checking is enabled so that only one user can connect to the console of a virtual machine. No other user is able to open a console to the same virtual machine until it has been rebooted. The exception is that a <code>SuperUser</code> can connect at any time and replace a existing connection. When a <code>SuperUser</code> has connected, no normal user can connect again until the virtual machine is rebooted.
Disable strict checking with caution, because you can expose the previous user's session to the new user.
|-
|'''Soundcard Enabled'''
|A sound card device is not necessary for all virtual machine use cases. If it is for yours, enable a sound card here.
|-
|'''VirtIO Console Device Enabled'''
|The VirtIO console device is a console over VirtIO transport for communication between the host user space and guest user space. It has two parts: device emulation in QEMU that presents a virtio-pci device to the guest, and a guest driver that presents a character device interface to user space applications. Tick the check box to attach a VirtIO console device to your virtual machine.
|}

=== Virtual Machine Host Settings Explained ===

The following table details the options available on the '''Host''' tab of the '''New Virtual Machine''' and '''Edit Virtual Machine''' windows.

⁠

'''Table 8.7. Virtual Machine: Host Settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''Start Running On'''
|Defines the preferred host on which the virtual machine is to run. Select either:
* '''Any Host in Cluster''' - The virtual machine can start and run on any available host in the cluster.
* '''Specific''' - The virtual machine will start running on a particular host in the cluster. However, oVirt or an administrator can migrate the virtual machine to a different host in the cluster depending on the migration and high-availability settings of the virtual machine. Select the specific host from the drop-down list of available hosts.
|-
|'''Migration Options'''
|Defines options to run and migrate the virtual machine. If the options here are not used, the virtual machine will run or migrate according to its cluster's policy.
* '''Allow manual and automatic migration''' - The virtual machine can be automatically migrated from one host to another in accordance with the status of the environment, or manually by an administrator.
* '''Allow manual migration only''' - The virtual machine can only be migrated from one host to another manually by an administrator.
* '''Do not allow migration''' - The virtual machine cannot be migrated, either automatically or manually.

The '''Use Host CPU''' check box allows virtual machines to take advantage of the features of the physical CPU of the host on which they are situated. This option can only be enabled when '''Allow manual migration only''' or '''Do not allow migration''' are selected.
The '''Use custom migration downtime''' check box allows you to specify the maximum number of milliseconds the virtual machine can be down during live migration. Configure different maximum downtimes for each virtual machine according to its workload and SLA requirements. The VDSM default value is 0.
|}

=== Virtual Machine High Availability Settings Explained ===

The following table details the options available on the '''High Availability''' tab of the '''New Virtual Machine''' and '''Edit Virtual Machine''' windows.

⁠

'''Table 8.8. Virtual Machine: High Availability Settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''Highly Available'''
|Select this check box if the virtual machine is to be highly available. For example, in cases of host maintenance or failure, the virtual machine is automatically moved to or re-launched on another host. If the host is manually shut down by the system administrator, the virtual machine is not automatically moved to another host.
Note that this option is unavailable if the '''Migration Options''' setting in the '''Hosts''' tab is set to either '''Allow manual migration only''' or '''No migration'''. For a virtual machine to be highly available, it must be possible for oVirt to migrate the virtual machine to other available hosts as necessary.
|-
|'''Priority for Run/Migration queue'''
|Sets the priority level for the virtual machine to be migrated or restarted on another host.
|-
|'''Watchdog'''
|Allows users to attach a watchdog card to a virtual machine. A watchdog is a timer that is used to automatically detect and recover from failures. Once set, a watchdog timer continually counts down to zero while the system is in operation, and is periodically restarted by the system to prevent it from reaching zero. If the timer reaches zero, it signifies that the system has been unable to reset the timer and is therefore experiencing a failure. Corrective actions are then taken to address the failure. This functionality is especially useful for servers that demand high availability.
'''Watchdog Model''': The model of watchdog card to assign to the virtual machine. At current, the only supported model is '''i6300esb'''.
'''Watchdog Action''': The action to take if the watchdog timer reaches zero. The following actions are available:
* '''none''' - No action is taken. However, the watchdog event is recorded in the audit log.
* '''reset''' - The virtual machine is reset and oVirt is notified of the reset action.
* '''poweroff''' - The virtual machine is immediately shut down.
* '''dump''' - A dump is performed and the virtual machine is paused.
* '''pause''' - The virtual machine is paused, and can be resumed by users.
|}

=== Virtual Machine Resource Allocation Settings Explained ===

The following table details the options available on the '''Resource Allocation''' tab of the '''New Virtual Machine''' and '''Edit Virtual Machine''' windows.

⁠

'''Table 8.9. Virtual Machine: Resource Allocation Settings'''
{| class="wikitable"
!width="33%"|Field Name
!width="33%"|Sub-element
!width="33%"|Description
|- style="vertical-align:top;"
|'''CPU Allocation'''
|'''CPU Shares'''
|Allows users the set the level of CPU resources a virtual machine can demand relative to other virtual machines.
* '''Low''' - 512
* '''Medium''' - 1024
* '''High''' - 2048
* '''Custom''' - A custom level of CPU shares defined by the user.
|- style="vertical-align:top;"
|
|'''CPU Pinning topology'''
|Enables the virtual machine's virtual CPU (vCPU) to run on a specific physical CPU (pCPU) in a specific host. This option is not supported if the virtual machine's cluster compatibility version is set to 3.0. The syntax of CPU pinning is <code>v#p[_v#p]</code>, for example:
* <code>0#0</code> - Pins vCPU 0 to pCPU 0.
* <code>0#0_1#3</code> - Pins vCPU 0 to pCPU 0, and pins vCPU 1 to pCPU 3.
* <code>1#1-4,^2</code> - Pins vCPU 1 to one of the pCPUs in the range of 1 to 4, excluding pCPU 2.

In order to pin a virtual machine to a host, you must select '''Do not allow migration''' under '''Migration Options''', and select the <code>Use Host CPU</code> check box.
|- style="vertical-align:top;"
|'''Memory Allocation'''
|
|The amount of physical memory guaranteed for this virtual machine.
|- style="vertical-align:top;"
|'''Storage Allocation'''
|
|The '''Template Provisioning''' option is only available when the virtual machine is created from a template.
|- style="vertical-align:top;"
|
|'''Thin'''
|Provides optimized usage of storage capacity. Disk space is allocated only as it is required.
|- style="vertical-align:top;"
|
|'''Clone'''
|Optimized for the speed of guest read and write operations. All disk space requested in the template is allocated at the time of the clone operation.
|- style="vertical-align:top;"
|
|'''VirtIO-SCSI Enabled'''
|Allows users to enable or disable the use of VirtIO-SCSI on the virtual machines.
|}

=== Virtual Machine Boot Options Settings Explained ===

The following table details the options available on the '''Boot Options''' tab of the '''New Virtual Machine''' and '''Edit Virtual Machine''' windows

⁠

'''Table 8.10. Virtual Machine: Boot Options Settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''First Device'''
|After installing a new virtual machine, the new virtual machine must go into Boot mode before powering up. Select the first device that the virtual machine must try to boot:
* '''Hard Disk'''
* '''CD-ROM'''
* '''Network (PXE)'''
|- style="vertical-align:top;"
|'''Second Device'''
|Select the second device for the virtual machine to use to boot if the first device is not available. The first device selected in the previous option does not appear in the options.
|- style="vertical-align:top;"
|'''Attach CD'''
|If you have selected '''CD-ROM''' as a boot device, tick this check box and select a CD-ROM image from the drop-down menu. The images must be available in the ISO domain.
|}

=== Virtual Machine Custom Properties Settings Explained ===

The following table details the options available on the '''Custom Properties''' tab of the '''New Virtual Machine''' and '''Edit Virtual Machine''' windows.

⁠

'''Table 8.11. Virtual Machine: Custom Properties Settings'''

{| class="wikitable"
!width="33%"|Field Name
!width="33%"|Description
!width="33%"|Recommendations and Limitations
|- style="vertical-align:top;"
|'''sap_agent'''
|Enables SAP monitoring on the virtual machine. Set to '''true''' or '''false'''.
|-
|- style="vertical-align:top;"
|'''sndbuf'''
|Enter the size of the buffer for sending the virtual machine's outgoing data over the socket. Default value is 0.
|-
|- style="vertical-align:top;"
|'''vhost'''
|Disables vhost-net, which is the kernel-based virtio network driver on virtual network interface cards attached to the virtual machine. To disable vhost, the format for this property is:
<pre class="programlisting">LogicalNetworkName: false</pre>
This will explicitly start the virtual machine without the vhost-net setting on the virtual NIC attached to ''LogicalNetworkName''.
|vhost-net provides better performance than virtio-net, and if it is present, it is enabled on all virtual machine NICs by default. Disabling this property makes it easier to isolate and diagnose performance issues, or to debug vhost-net errors; for example, if migration fails for virtual machines on which vhost does not exist.
|- style="vertical-align:top;"
|'''viodiskcache'''
|Caching mode for the virtio disk. '''writethrough''' writes data to the cache and the disk in parallel, '''writeback''' does not copy modifications from the cache to the disk, and '''none''' disables caching.
|For oVirt 3.1, if viodiskcache is enabled, the virtual machine cannot be live migrated.
|}

<div class="alert alert-info">'''Warning:''' Increasing the value of the sndbuf custom property results in increased occurrences of communication failure between hosts and unresponsive virtual machines.</div>

== Configuring Virtual Machines ==

=== Completing the Configuration of a Virtual Machine by Defining Network Interfaces and Hard Disks ===

'''Summary'''

Before you can use your newly created virtual machine, the '''Guide Me''' window prompts you to configure at least one network interface and one virtual disk for the virtual machine.

'''Procedure 8.4. Completing the Configuration of a Virtual Machine by Defining Network Interfaces and Hard Disks'''

<ol>
<li>On the '''New Virtual Machine - Guide Me''' window, click the '''Configure Network Interfaces''' button to open the '''New Network Interface''' window. You can accept the default values or change them as necessary.</li>
<li>Enter the '''Name''' of the network interface.</li>
<li><p>Use the drop-down menus to select the '''Network''' and the '''Type''' of network interface for the new virtual machine. The '''Link State''' is set to '''Up''' by default when the NIC is defined on the virtual machine and connected to the network.</p>
<div class="alert alert-info">'''Note:''' The options on the '''Network''' and '''Type''' fields are populated by the networks available to the cluster, and the NICs available to the virtual machine.</div></li>
<li>If applicable, select the '''Specify custom MAC address''' check box and enter the network interface's MAC address.</li>
<li>Click the arrow next to '''Advanced Parameters''' to configure the '''Port Mirroring''' and '''Card Status''' fields, if necessary.</li>
<li>Click '''OK''' to close the '''New Network Interface''' window and open the '''New Virtual Machine - Guide Me''' window.</li>
<li>Click the '''Configure Virtual Disk''' button to open the '''New Virtual Disk''' window.</li>
<li><p>Add either an '''Internal''' virtual disk or an '''External''' LUN to the virtual machine.</p>
<p>⁠</p>
<p>[[Image:Add Virtual Disk.png|400px|Add Virtual Disk Window]]</p>
<p>'''Figure 8.4. Add Virtual Disk Window'''</p></li>
<li>Click '''OK''' to close the '''New Virtual Disk''' window. The '''New Virtual Machine - Guide Me''' window opens with changed context. There is no further mandatory configuration.</li>
<li>Click '''Configure Later''' to close the window.</li></ol>

'''Result'''

You have added a network interface and a virtual disk to your virtual machine.

=== Installing Windows on VirtIO-Optimized Hardware ===

'''Summary'''

The <code>virtio-win.vfd</code> diskette image contains Windows drivers for VirtIO-optimized disk and network devices. These drivers provide a performance improvement over emulated device drivers.

The <code>virtio-win.vfd</code> is placed automatically on ISO storage domains that are hosted on oVirt server. It must be manually uploaded using the '''engine-iso-uploader''' tool to other ISO storage domains.

You can install the VirtIO-optimized device drivers during your Windows installation by attaching a diskette to your virtual machine.

This procedure presumes that you added a <code>Red Hat VirtIO</code> network interface and a disk that uses the <code>VirtIO</code> interface to your virtual machine.

⁠

'''Procedure 8.5. Installing VirtIO Drivers during Windows Installation'''

# Click the '''Virtual Machines''' tab and select a virtual machine.
# Click the '''Run Once''' button, and the '''Run Once''' window displays.
# Click '''Boot Options''' to expand the '''Boot Options''' configuration options.
# Click the '''Attach Floppy''' check box, and select <code>virtio-win.vfd</code> from the drop down selection box.
# Click the '''Attach CD''' check box, and select from the drop down selection box the ISO containing the version of Windows you want to install.
# Move '''CD-ROM''' '''UP''' in the '''Boot Sequence''' field.
# Configure the rest of your '''Run Once''' options as required, and click '''OK''' to start your virtual machine, and then click the '''Console''' button to open a graphical console to your virtual machine.

'''Result'''

Windows installations include an option to load additional drivers early in the installation process. Use this option to load drivers from the <code>virtio-win.vfd</code> diskette that was attached to your virtual machine as <code>A:</code>.

For each supported virtual machine architecture and Windows version, there is a folder on the disk containing optimized hardware device drivers.

=== Virtual Machine Run Once Settings Explained ===

The '''Run Once''' window defines one-off boot options for a virtual machine. For persistent boot options, use the '''Boot Options''' tab in the '''New Virtual Machine''' window. The following table details the information required for the '''Run Once''' window.

'''Table 8.12. Virtual Machine: Run Once Settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''Boot Options'''
|Defines the virtual machine's boot sequence, running options, and source images for installing the operating system and required drivers.
* '''Attach Floppy''' - Attaches a diskette image to the virtual machine. Use this option to install Windows drivers. The diskette image must reside in the ISO domain.
* '''Attach CD''' - Attaches an ISO image to the virtual machine. Use this option to install the virtual machine's operating system and applications. The CD image must reside in the ISO domain.
* '''Boot Sequence''' - Determines the order in which the boot devices are used to boot the virtual machine. Select either '''Hard Disk''', '''CD-ROM''' or '''Network''', and use the arrow keys to move the option up or down.
* '''Run Stateless''' - Deletes all changes to the virtual machine upon shutdown. This option is only available if a virtual disk is attached to the virtual machine.
* '''Start in Pause Mode''' - Starts then pauses the virtual machine to enable connection to the console, suitable for virtual machines in remote locations.
|- style="vertical-align:top;"
|'''Linux Boot Options'''
|The following options boot a Linux kernel directly instead of through the BIOS bootloader.
* '''kernel path''' - A fully qualified path to a kernel image to boot the virtual machine. The kernel image must be stored on either the ISO domain (path name in the format of <code>iso://path-to-image</code>) or on the host's local storage domain (path name in the format of <code>/data/images</code>).
* '''initrd path''' - A fully qualified path to a ramdisk image to be used with the previously specified kernel. The ramdisk image must be stored on the ISO domain (path name in the format of <code>iso://path-to-image</code>) or on the host's local storage domain (path name in the format of <code>/data/images</code>).
* '''kernel params''' - Kernel command line parameter strings to be used with the defined kernel on boot.
|- style="vertical-align:top;"
|'''Initial Run'''
|Specifies whether Cloud-Init is used to initialize the virtual machine. If selected, the following settings become available to configure this feature:
* '''VM Hostname''' - Specify a host name for the virtual machine.
* '''Configure Time Zone''' - Apply a specific time zone for the virtual machine. Select this check box and select a time zone from the '''Time Zone''' drop-down menu to specify the time zone.

'''Authentication'''

* '''Use already configured password''' - Specifies that any passwords that have been configured for the virtual machine will be used.
* '''Root Password''' - Specify a root password for the virtual machine. Enter the password in this text field and the '''Verify Root Password''' text field to verify the password.
* '''SSH Authorized Keys''' - Specify SSH keys to be added to the authorized keys file of the virtual machine.
* '''Regenerate SSH Keys''' - Regenerates SSH keys for the virtual machine.

'''Networks'''

* '''DNS Servers''': Specify the DNS servers to be used by the virtual machine.
* '''DNS Search Domains''': Specify the DNS search domains to be used by the virtual machine.
* '''Network''': Configures network interfaces for the virtual machine. Select this check box and use the '''+''' and '''-''' buttons to add or remove network interfaces to or from the virtual machine. When you click the '''+''' button, a set of fields becomes visible that can specify whether to use DHCP, and configure an IP address, netmask, and gateway, and specify whether the network interface will start on boot.

'''Custom Script'''

* Enter custom scripts that will be run on the virtual machine when it starts. The scripts entered in this field are custom YAML sections that are added to those produced by oVirt. They automate tasks such as creating users and files, configuring '''yum''' repositories and running commands. For more information on the format of scripts that can be entered in this field, see the [http://www.ovirt.org/Features/vm-init-persistent#Custom_Script Custom Script] documentation.
|- style="vertical-align:top;"
|'''Host'''
|Defines the virtual machine's host.
* '''Any host in cluster:''' - Allocates the virtual machine to any available host.
* '''Specific''' - Specifies a user-defined host for the virtual machine.
|- style="vertical-align:top;"
|'''Display Protocol'''
|Defines the protocol to connect to virtual machines.
* '''VNC''' - Can be used for Linux virtual machines. Requires a VNC client to connect to a virtual machine using VNC. Optionally, specify '''VNC Keyboard Layout''' from the drop-down menu.
* '''SPICE''' - Recommended protocol for Linux and Windows virtual machines, excepting Windows 8 and Server 2012 virtual machines.
|- style="vertical-align:top;"
|'''Custom Properties'''
|Additional VDSM options for running virtual machines.
* '''sap_agent''' - Enables SAP monitoring on the virtual machine. Set to '''true''' or '''false'''.
* '''sndbuf''' - Enter the size of the buffer for sending the virtual machine's outgoing data over the socket.
* '''vhost''' - Enter the name of the virtual host on which this virtual machine should run. The name can contain any combination of letters and numbers.
* '''viodiskcache''' - Caching mode for the virtio disk. '''writethrough''' writes data to the cache and the disk in parallel, '''writeback''' does not copy modifications from the cache to the disk, and '''none''' disables caching.
|}

=== Configuring a Watchdog ===

==== Adding a Watchdog Card to a Virtual Machine ====

'''Summary'''

Add a watchdog card to a virtual machine.

⁠

'''Procedure 8.6. Adding a Watchdog Card to a Virtual Machine'''

# Click the '''Virtual Machines''' tab and select a virtual machine.
# Click '''Edit''' to open the '''Edit Virtual Machine''' window.
# Click '''Show Advanced Options''' to display all tabs and click the '''High Availability''' tab.
# Select the watchdog model to use from the '''Watchdog Model''' drop-down menu.
# Select an action from the '''Watchdog Action''' drop-down menu. This is the action that the virtual machine takes when the watchdog is triggered.
# Click '''OK'''.

'''Result'''

You have added a watchdog card to the virtual machine.

==== Installing a Watchdog ====

'''Summary'''

To activate a watchdog card attached to a virtual machine, you must install the watchdog package on that virtual machine and start the <code>watchdog</code> service.

⁠

'''Procedure 8.7. Installing a Watchdog'''

<ol>
<li>Log on to the virtual machine on which the watchdog card is attached.</li>
<li><p>Run the following command to install the watchdog package and dependencies:</p>
<pre class="screen"># yum install watchdog</pre></li>
<li><p>Edit the <code>/etc/watchdog.conf</code> file and uncomment the following line:</p>
<pre class="screen">watchdog-device = /dev/watchdog</pre></li>
<li>Save the changes.</li>
<li><p>Run the following commands to start the <code>watchdog</code> service and ensure this service starts on boot:</p>
<pre class="screen"># service watchdog start
# chkconfig watchdog on</pre></li></ol>

'''Result'''

You have installed and started the <code>watchdog</code> service on a virtual machine.

==== Confirming Watchdog Functionality ====

'''Summary'''

Confirm that a watchdog card has been attached to a virtual machine and that the <code>watchdog</code> service is active.

<div class="alert alert-info">'''Warning:''' This procedure is provided for testing the functionality of watchdogs only and must not be run on production machines.</div>

⁠

'''Procedure 8.8. Confirming Watchdog Functionality'''

<ol>
<li>Log on to the virtual machine on which the watchdog card is attached.</li>
<li><p>Run the following command to confirm that the watchdog card has been identified by the virtual machine:</p>
<pre class="screen"># lspci | grep watchdog -i</pre></li>
<li>Run one of the following commands to confirm that the watchdog is active:
<ul>
<li><p>Run the following command to trigger a kernel panic:</p>
<pre class="screen"># echo c &gt; /proc/sysrq-trigger</pre></li>
<li><p>Run the following command to terminate the <code>watchdog</code> service:</p>
<pre class="screen"># kill -9 `pgrep watchdog`</pre></li></ul>
</li></ol>

'''Result'''

The watchdog timer can no longer be reset, so the watchdog counter reaches zero after a short period of time. When the watchdog counter reaches zero, the action specified in the '''Watchdog Action''' drop-down menu for that virtual machine is performed.

==== Parameters for Watchdogs in watchdog.conf ====

The following is a list of options for configuring the <code>watchdog</code> service available in the <code>/etc/watchdog.conf</code> file. To configure an option, you must ensure that option is uncommented and restart the <code>watchdog</code> service after saving the changes.

<div class="alert alert-info">'''Note:''' For a more detailed explanation of options for configuring the <code>watchdog</code> service and using the <code>watchdog</code> command, see the <code>watchdog</code> man page.</div>

'''Table 8.13. watchdog.conf variables'''

{| class="wikitable"
!width="40%"|Variable name
!width="20%"|Default Value
!width="40%"|Remarks
|- style="vertical-align:top;"
|<code>ping</code>
|N/A
|An IP address that the watchdog attempts to ping to verify whether that address is reachable. You can specify multiple IP addresses by adding additional <code>ping</code> lines.
|- style="vertical-align:top;"
|<code>interface</code>
|N/A
|A network interface that the watchdog will monitor to verify the presence of network traffic. You can specify multiple network interfaces by adding additional <code>interface</code> lines.
|- style="vertical-align:top;"
|<code>file</code>
|<code>/var/log/messages</code>
|A file on the local system that the watchdog will monitor for changes. You can specify multiple files by adding additional <code>file</code> lines.
|- style="vertical-align:top;"
|<code>change</code>
|<code>1407</code>
|The number of watchdog intervals after which the watchdog checks for changes to files. A <code>change</code> line must be specified on the line directly after each <code>file</code> line, and applies to the <code>file</code> line directly above that <code>change</code> line.
|- style="vertical-align:top;"
|<code>max-load-1</code>
|<code>24</code>
|The maximum average load that the virtual machine can sustain over a one-minute period. If this average is exceeded, then the watchdog is triggered. A value of <code>0</code> disables this feature.
|- style="vertical-align:top;"
|<code>max-load-5</code>
|<code>18</code>
|The maximum average load that the virtual machine can sustain over a five-minute period. If this average is exceeded, then the watchdog is triggered. A value of <code>0</code> disables this feature. By default, the value of this variable is set to a value approximately three quarters that of <code>max-load-1</code>.
|- style="vertical-align:top;"
|<code>max-load-15</code>
|<code>12</code>
|The maximum average load that the virtual machine can sustain over a fifteen-minute period. If this average is exceeded, then the watchdog is triggered. A value of <code>0</code> disables this feature. By default, the value of this variable is set to a value approximately one half that of <code>max-load-1</code>.
|- style="vertical-align:top;"
|<code>min-memory</code>
|<code>1</code>
|The minimum amount of virtual memory that must remain free on the virtual machine. This value is measured in pages. A value of <code>0</code> disables this feature.
|- style="vertical-align:top;"
|<code>repair-binary</code>
|<code>/usr/sbin/repair</code>
|The path and file name of a binary file on the local system that will be run when the watchdog is triggered. If the specified file resolves the issues preventing the watchdog from resetting the watchdog counter, then the watchdog action is not triggered.
|- style="vertical-align:top;"
|<code>test-binary</code>
|N/A
|The path and file name of a binary file on the local system that the watchdog will attempt to run during each interval. A test binary allows you to specify a file for running user-defined tests.
|- style="vertical-align:top;"
|<code>test-timeout</code>
|N/A
|The time limit, in seconds, for which user-defined tests can run. A value of <code>0</code> allows user-defined tests to continue for an unlimited duration.
|- style="vertical-align:top;"
|<code>temperature-device</code>
|N/A
|The path to and name of a device for checking the temperature of the machine on which the <code>watchdog</code> service is running.
|- style="vertical-align:top;"
|<code>max-temperature</code>
|<code>120</code>
|The maximum allowed temperature for the machine on which the <code>watchdog</code> service is running. The machine will be halted if this temperature is reached. Unit conversion is not taken into account, so you must specify a value that matches the watchdog card being used.
|- style="vertical-align:top;"
|<code>admin</code>
|<code>root</code>
|The email address to which email notifications are sent.
|- style="vertical-align:top;"
|<code>interval</code>
|<code>10</code>
|The interval, in seconds, between updates to the watchdog device. The watchdog device expects an update at least once every minute, and if there are no updates over a one-minute period, then the watchdog is triggered. This one-minute period is hard-coded into the drivers for the watchdog device, and cannot be configured.
|- style="vertical-align:top;"
|<code>logtick</code>
|<code>1</code>
|When verbose logging is enabled for the <code>watchdog</code> service, the <code>watchdog</code> service periodically writes log messages to the local system. The <code>logtick</code> value represents the number of watchdog intervals after which a message is written.
|- style="vertical-align:top;"
|<code>realtime</code>
|<code>yes</code>
|Specifies whether the watchdog is locked in memory. A value of <code>yes</code> locks the watchdog in memory so that it is not swapped out of memory, while a value of <code>no</code> allows the watchdog to be swapped out of memory. If the watchdog is swapped out of memory and is not swapped back in before the watchdog counter reaches zero, then the watchdog is triggered.
|- style="vertical-align:top;"
|<code>priority</code>
|<code>1</code>
|The schedule priority when the value of <code>realtime</code> is set to <code>yes</code>.
|- style="vertical-align:top;"
|<code>pidfile</code>
|<code>/var/run/syslogd.pid</code>
|The path and file name of a PID file that the watchdog monitors to see if the corresponding process is still active. If the corresponding process is not active, then the watchdog is triggered.
|}

== Editing Virtual Machines ==

=== Editing Virtual Machine Properties ===

'''Summary'''

Changes to storage, operating system or networking parameters can adversely affect the virtual machine. Ensure that you have the correct details before attempting to make any changes. Virtual machines must be powered off before some changes can be made to them. This procedure explains how to edit a virtual machine. It is necessary to edit a virtual machines in order to change its settings.

The following fields can be edited while a virtual machine is running:

* '''Name'''
* '''Description'''
* '''Comment'''
* '''Delete Protection'''
* '''Network Interfaces'''
* '''Use Cloud-Init/Sysprep''' (and its properties)
* '''Use custom migration downtime'''
* '''Highly Available'''
* '''Priority for Run/Migration queue'''
* '''Watchdog Model'''
* '''Watchdog Action'''
* '''Physical Memory Guaranteed'''
* '''Memory Balloon Device Enabled'''
* '''VirtIO-SCSI Enabled'''
* '''First Device'''
* '''Second Device'''
* '''Attach CD'''
* '''kernel path'''
* '''initrd path'''
* '''kernel parameters'''

To change all other settings, the virtual machine must be powered off.

⁠

'''Procedure 8.9. Editing a virtual machine:'''

# Select the virtual machine to be edited.
# Click the '''Edit''' button to open the '''Edit Virtual Machine''' window.
# Change the '''General''', '''System''', '''Initial Run''', '''Console''', '''Host''', '''High Availability''', '''Resource Allocation''', '''Boot Options''', and '''Custom Options''' fields as required.
# Click '''OK''' to save your changes. Your changes will be applied once you restart your virtual machine.

'''Result'''

You have changed the settings of a virtual machine by editing it.

=== Network Interfaces ===

==== Adding and Editing Virtual Machine Network Interfaces ====

'''Summary'''

You can add network interfaces to virtual machines. Doing so allows you to put your virtual machine on multiple logical networks. You can also edit a virtual machine's network interface card to change the details of that network interface card. This procedure can be performed on virtual machines that are running, but some actions can be performed only on virtual machines that are not running.

'''Procedure 8.10. Adding Network Interfaces to Virtual Machines'''

<ol>
<li>Click the '''Virtual Machines''' tab and select a virtual machine.</li>
<li>Select the '''Network Interfaces''' tab in the details pane to display a list of network interfaces that are currently associated with the virtual machine.</li>
<li><p>Click '''New''' to open the '''New Network Interface''' window.</p>
<p>⁠</p>
<p>[[Image:New Network Interface.png|400px|New Network Interface window]]</p>
<p>'''Figure 8.5. New Network Interface window'''</p></li>
<li>Enter the '''Name''' of the network interface.</li>
<li><p>Use the drop-down menus to select the '''Profile''' and the '''Type''' of network interface for the new network interface.The '''Link State''' is set to '''Up''' by default when the network interface card is defined on the virtual machine and connected to the network.</p>
<div class="alert alert-info">'''Note:''' The '''Profile''' and '''Type''' fields are populated in accordance with the profiles and network types available to the cluster and the network interface cards available to the virtual machine.</div></li>
<li>Select the '''Custom MAC address''' check box and enter a MAC address for the network interface card as required.</li>
<li>Click '''OK''' to close the '''New Network Interface''' window.</li></ol>

'''Result'''

Your new network interface is listed in the '''Network Interfaces''' tab in the details pane of the virtual machine.

==== Editing a Network Interface ====

'''Summary'''

This procedure describes editing a network interface. In order to change any network settings, you must edit the network interface.

⁠

'''Procedure 8.11. Editing a Network Interface'''

# Click the '''Virtual Machines''' tab and select a virtual machine.
# Click the '''Network Interfaces''' tab of the details pane and select the network interface to edit.
# Click '''Edit''' to open the '''Edit Network Interface''' window. This dialog contains the same fields as the '''New Network Interface''' dialog.
# Click '''OK''' to save your changes once you are finished.

'''Result'''

You have now changed the network interface by editing it.

==== Removing a Network Interface ====

'''Summary'''

This procedure describes how to remove a network interface.

⁠

'''Procedure 8.12. Removing a Network Interface'''

# Click the '''Virtual Machines''' tab and select a virtual machine.
# Click the '''Network Interfaces''' tab of the details pane and select the network interface to remove.
# Click '''Remove''' and click '''OK''' when prompted.

'''Result'''

You have removed a network interface from a virtual machine.

==== Explanation of Settings in the Virtual Machine Network Interface Window ====

These settings apply when you are adding or editing a virtual machine network interface. If you have more than one network interface attached to a virtual machine, you can put the virtual machine on more than one logical network.

'''Table 8.14. Add a network interface to a virtual machine entries'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''Name'''
|The name of the network interface. This text field has a 21-character limit and must be a unique name with any combination of uppercase and lowercase letters, numbers, hyphens, and underscores.
|- style="vertical-align:top;"
|'''Network'''
|Logical network that the network interface is placed on. By default, all network interfaces are put on the '''rhevm''' management network.
|- style="vertical-align:top;"
|'''Link State'''
|Whether or not the network interface is connected to the logical network.
* '''Up''': The network interface is located on its slot.
** When the '''Card Status''' is '''Plugged''', it means the network interface is connected to a network cable, and is active.
** When the '''Card Status''' is '''Unplugged''', the network interface will be automatically connected to the network and become active.
* '''Down''': The network interface is located on its slot, but it is not connected to any network. Virtual machines will not be able to run in this state.
|- style="vertical-align:top;"
|'''Type'''
|The virtual interface the network interface presents to virtual machines. VirtIO is faster but requires VirtIO drivers. Red Hat Enterprise Linux 5 and higher includes VirtIO drivers. Windows does not include VirtIO drivers, but they can be installed from the guest tools ISO or virtual floppy disk. rtl8139 and e1000 device drivers are included in most operating systems.
|- style="vertical-align:top;"
|'''Specify custom MAC address'''
|Choose this option to set a custom MAC address. oVirt automatically generates a MAC address that is unique to the environment to identify the network interface. Having two devices with the same MAC address online in the same network causes networking conflicts.
|- style="vertical-align:top;"
|'''Port Mirroring'''
|A security feature that allows all network traffic going to or leaving from virtual machines on a given logical network and host to be copied (mirrored) to the network interface. If the host also uses the network, then traffic going to or leaving from the host is also copied.
Port mirroring only works on network interfaces with IPv4 IP addresses.
|- style="vertical-align:top;"
|'''Card Status'''
|Whether or not the network interface is defined on the virtual machine.
* <code>Plugged</code>: The network interface has been defined on the virtual machine.
** If its '''Link State''' is <code>Up</code>, it means the network interface is connected to a network cable, and is active.
** If its '''Link State''' is <code>Down</code>, the network interface is not connected to a network cable.
* <code>Unplugged</code>: The network interface is only defined on oVirt, and is not associated with a virtual machine.
** If its '''Link State''' is <code>Up</code>, when the network interface is plugged it will automatically be connected to a network and become active.
** If its '''Link State''' is <code>Down</code>, the network interface is not connected to any network until it is defined on a virtual machine.
|}

==== Hot Plugging Network Interfaces ====

'''Summary'''

You can hot plug network interfaces. Hot plugging means enabling and disabling network interfaces while a virtual machine is running.

⁠

'''Procedure 8.13. Hot plugging network interfaces'''

# Click the '''Virtual Machines''' tab and select a virtual machine.
# Select the '''Network Interfaces''' tab from the details pane of the virtual machine.
# Select the network interface you would like to hot plug and click '''Edit''' to open the '''Edit Network Interface''' window.
# Click the '''Advanced Parameters''' arrow to access the '''Card Status''' option. Set the '''Card Status''' to '''Plugged''' to enable the network interface, or set it to '''Unplugged''' to disable the network interface.

'''Result'''

You have enabled or disabled a virtual network interface.

==== Removing Network Interfaces From Virtual Machines ====

'''Summary'''

You can remove network interfaces from virtual machines.

⁠

'''Procedure 8.14. Removing Network Interfaces From Virtual Machines'''

# Click the '''Virtual Machines''' tab and select a virtual machine.
# Select the '''Network Interfaces''' tab in the virtual machine details pane.
# Select the network interface to remove.
# Click the '''Remove''' button and click '''OK''' when prompted.

'''Result'''

The network interface is no longer attached to the virtual machine.

=== Virtual Disks ===

==== Adding and Editing Virtual Machine Disks ====

'''Summary'''

It is possible to add disks to virtual machines. You can add new disks, or previously created floating disks to a virtual machine. This allows you to provide additional space to and share disks between virtual machines. You can also edit disks to change some of their details.

An '''Internal''' disk is the default type of disk. You can also add an '''External(Direct Lun)''' disk. Internal disk creation is managed entirely by oVirt; external disks require externally prepared targets that already exist. Existing disks are either floating disks or shareable disks attached to virtual machines.

⁠

'''Procedure 8.15. Adding Disks to Virtual Machines'''

<ol>
<li>Click the '''Virtual Machines''' tab and select a virtual machine.</li>
<li>Click the '''Disks''' tab in the details pane to display a list of virtual disks currently associated with the virtual machine.</li>
<li><p>Click '''Add''' to open the '''Add Virtual Disk''' window.</p>
<p>⁠</p>
<p>[[Image:Add_Virtual_Disk.png|400px|Add Virtual Disk Window]]</p>
<p>'''Figure 8.6. Add Virtual Disk Window'''</p></li>
<li>Use the appropriate radio buttons to switch between '''Internal''' and the '''External (Direct Lun)''' disks.</li>
<li>Select the '''Attach Disk''' check box to choose an existing disk from the list and select the '''Activate''' check box.
Alternatively, enter the '''Size''', '''Alias''', and '''Description''' of a new disk and use the drop-down menus and check boxes to configure the disk.</li>
<li>Click '''OK''' to add the disk and close the window.</li></ol>

'''Result'''

Your new disk is listed in the '''Virtual Disks''' tab in the details pane of the virtual machine.

==== Hot Plugging Virtual Machine Disks ====

'''Summary'''

You can hot plug virtual machine disks. Hot plugging means enabling or disabling devices while a virtual machine is running.

⁠

'''Procedure 8.16. Hot Plugging Virtual Machine Disks'''

# Click the '''Virtual Machines''' tab and select a virtual machine.
# Select the '''Disks''' tab from the details pane of the virtual machine.
# Select the virtual machine disk you would like to hot plug.
# Click the '''Activate''' button, or click the '''Deactivate''' button and click '''OK''' when prompted.

'''Result'''

You have enabled or disabled a virtual machine disk.

==== Removing Virtual Disks From Virtual Machines ====

'''Summary'''

You can remove virtual disks from virtual machines.

⁠

'''Procedure 8.17. Removing Virtual Disks From Virtual Machines'''

# Click the '''Virtual Machines''' tab and select a virtual machine.
# Select the '''Disks''' tab in the virtual machine details pane.
# Select the virtual disk to remove.
# Click the '''Deactivate''' button and click '''OK''' when prompted.
# Click the '''Remove''' button and click '''OK''' when prompted. Optionally, select the '''Remove Permanently''' option to completely remove the virtual disk from the environment. If you do not select this option - for example, because the disk is a shared disk - the virtual disk will remain in the '''Disks''' resource tab.

'''Result'''

The disk is no longer attached to the virtual machine.

=== Extending the Size of an Online Virtual Disk ===

'''Summary'''

This procedure explains how to extend the size of a virtual drive while the virtual drive is attached to a virtual machine.

⁠

'''Procedure 8.18. Extending the Size of an Online Virtual Disk'''

# Click the '''Virtual Machines''' tab and select a virtual machine.
# Select the '''Disks''' tab in the details pane.
# Select a target disk from the list in the details pane.
# Click '''Edit''' in the details pane.
# Enter a value in the <code>Extend size by(GB)</code> field.
# Click '''OK'''.

'''Result'''

The target disk's status becomes <code>locked</code> for a short time, during which the drive is resized. When the resizing of the drive is complete, the status of the drive becomes <code>OK</code>.

=== Floating Disks ===

Floating disks are disks that are not associated with any virtual machine.

Floating disks can minimize the amount of time required to set up virtual machines. Designating a floating disk as storage for a VM makes it unnecessary to wait for disk preallocation at the time of a VM's creation.

Floating disks can be attached to virtual machines or designated as shareable disks, which can be used with one or more VMs.

=== Associating a Virtual Disk with a Virtual Machine ===

'''Summary'''

This procedure explains how to associate a virtual disk with a virtual machine. Once the virtual disk is associated with the virtual machine, the VM is able to access it.

⁠

'''Procedure 8.19. Associating a Virtual Disk with a Virtual Machine'''

<ol>
<li>Click the '''Virtual Machines''' tab and select a virtual machine.</li>
<li>In the details pane, select the '''Disks''' tab.</li>
<li>Click '''Add''' in the menu at the top of the Details Pane.</li>
<li>Type the size in GB of the disk into the '''Size(GB)''' field.</li>
<li>Type the disk alias into the '''Alias''' field.</li>
<li>Click '''OK''' in the bottom right corner of the '''Add Virtual Disk''' window.
The disk you have associated with the virtual machine appears in the details pane after a short time.</li></ol>

'''Result'''

The virtual disk is associated with the virtual machine.

<div class="alert alert-info">'''Note:''' No Quota resources are consumed by attaching virtual disks to, or detaching virtual disks from, virtual machines.</div>

<div class="alert alert-info">'''Note:''' Using the above procedure, it is now possible to attach a virtual disk to more than one virtual machine.</div>

=== Changing the CD for a Virtual Machine ===

'''Summary'''

You can change the CD accessible to a virtual machine while that virtual machine is running.

<div class="alert alert-info">'''Note:''' You can only use ISO files that have been added to the ISO domain of the cluster in which the virtual machine is a member. Therefore, you must upload ISO files to that domain before you can make those ISO files accessible to virtual machines.</div>

⁠

'''Procedure 8.20. Changing the CD for a Virtual Machine'''

<ol>
<li>From the '''Virtual Machines''' tab, select a virtual machine that is currently running.</li>
<li><p>Click '''Change CD''' to open the '''Change CD''' window.</p>
<p>⁠</p>
<p>[[Image:Change_CD.png|300px|The Change CD Window]]</p>
<p>'''Figure 8.7. The Change CD Window'''</p></li>
<li>From the drop-down menu:
<ul>
<li>Select <code>[Eject]</code> to eject the CD currently accessible to the virtual machine.
Or,</li>
<li>Select an ISO file from the list to eject the CD currently accessible to the virtual machine and mount that ISO file as a CD.</li></ul>
</li>
<li>Click '''OK'''.</li></ol>

'''Result'''

You have ejected the CD previously accessible to the virtual machine, or ejected the CD previously accessible to the virtual machine and made a new CD accessible to that virtual machine

=== Smart Card Authentication ===

Smart cards are an external hardware security feature, most commonly seen in credit cards, but also used by many businesses as authentication tokens. Smart cards can be used to protect oVirt virtual machines.

=== Enabling and Disabling Smart cards ===

'''Summary'''

The following procedures explain how to enable and disable the Smart card feature for virtual machines.

⁠

'''Procedure 8.21. Enabling Smart cards'''

# Ensure that the Smart card hardware is plugged into the client machine and is installed according to manufacturer's directions.
# Select the desired virtual machine.
# Click the '''Edit''' button. The '''Edit Virtual Machine''' window appears.
# Select the '''Console''' tab, and select the check box labeled '''Smartcard enabled''', then click '''OK'''.
# Run the virtual machine by clicking the '''Console''' icon or through the User Portal. Smart card authentication is now passed from the client hardware to the virtual machine.

'''Result'''

You have enabled Smart card authentication for the virtual machine.

<div class="alert alert-info">'''Important:''' If the Smart card hardware is not correctly installed, enabling the Smart card feature will result in the virtual machine failing to load properly.</div>

⁠

'''Procedure 8.22. Disabling Smart cards'''

# Select the desired virtual machine.
# Click the '''Edit''' button. The '''Edit Virtual Machine''' window appears.
# Select the '''Console''' tab, and clear the check box labeled '''Smartcard enabled''', then click '''OK'''.

'''Result'''

You have disabled Smart card authentication for the virtual machine.

== Running Virtual Machines ==

=== Installing Console Components ===

==== Console Components ====

A console is a graphical window that allows you to view the start up screen, shut down screen and desktop of a virtual machine, and to interact with that virtual machine in a similar way to a physical machine. In oVirt, the default application for opening a console to a virtual machine is Remote Viewer, which must be installed on the client machine prior to use.

==== Installing Remote Viewer on Linux ====

Remote Viewer is an application for opening a graphical console to virtual machines. Remote Viewer is a SPICE client that is included the virt-viewer package provided by the <code>Red Hat Enterprise Linux Workstation (v. 6 for x86_64)</code> channel.

⁠

'''Procedure 8.23. Installing Remote Viewer on Linux'''

<ol>
<li><p>Run the following command to install the spice-xpi package and dependencies:</p>
<pre class="screen"># yum install spice-xpi</pre></li>
<li><p>Run the following command to check whether the '''virt-viewer''' package has already been installed on your system:</p>
<pre class="screen"># rpm -q virt-viewer
virt-viewer-0.5.2-18.el6_4.2.x86_64</pre>
<p>If the virt-viewer package has not been installed, run the following command to install the package and its dependencies:</p>
<pre class="screen"># yum install virt-viewer</pre></li>
<li>Restart Firefox for your changes to take effect.</li></ol>

The SPICE plug-in is now installed. You can now connect to your virtual machines using the SPICE protocol.

==== Installing Remote Viewer for Internet Explorer on Windows ====

'''Summary'''

The SPICE ActiveX component is required to run Remote Viewer, which opens a graphical console to virtual machines. Remote Viewer is a SPICE client installed together with the SPICE ActiveX component; both are provided in the <code>SpiceX.cab</code> file.

⁠

'''Procedure 8.24. Installing Remote Viewer for Internet Explorer on Windows'''

# Open Internet Explorer and log in to the User Portal.
# Start a virtual machine and attempt to connect to the virtual machine using the '''Browser plugin''' console option.
# Click the warning banner and click '''Install This Add-on''' when prompted.
# Click '''Install''' when prompted.
# Restart Internet Explorer for your changes to take effect.

'''Result'''

You have installed the SPICE plug-in and Remote Viewer, and can now connect to virtual machines using the SPICE protocol from within Internet Explorer.

==== Installing Remote Viewer on Windows ====

The '''Remote Viewer''' application provides users with a graphical console for connecting to virtual machines. Once installed, it is called automatically when attempting to open a SPICE session with a virtual machine. Alternatively, it can also be used as a standalone application.

⁠

'''Procedure 8.25. Installing Remote Viewer on Windows'''

<ol>
<li>Open a web browser and download one of the following installers according to the architecture of your system.
<ul>
<li><p>Virt Viewer for 32-bit Windows:</p>
<pre class="screen">https://[your manager's address]/ovirt-engine/services/files/spice/virt-viewer-x86.msi</pre></li>
<li><p>Virt Viewer for 64-bit Windows:</p>
<pre class="screen">https://[your manager's address]/ovirt-engine/services/files/spice/virt-viewer-x64.msi</pre></li></ul>
</li>
<li>Open the folder where the file was saved.</li>
<li>Double-click the file.</li>
<li>Click '''Run''' if prompted by a security warning.</li>
<li>Click '''Yes''' if prompted by User Account Control.</li></ol>

'''Result'''

'''Remote Viewer''' is installed and can be accessed via '''Remote Viewer''' in the '''VirtViewer''' folder of '''All Programs''' in the start menu.

=== Guest Drivers and Agents ===

==== Installing Guest Agents and Drivers ====

Installing oVirt guest agents and drivers on virtual machines provides optimized performance and extra features.

<dl>
<dt>Installing the agents and drivers on Red Hat Enterprise Linux guests
<dd>All of the drivers are included in the base channel for RHN-registered Red Hat Enterprise Linux virtual machines. They can be installed using the <code>yum install rhevm-guest-agent</code> command.
Your guest must be subscribed to the <code>Red Hat Enterprise Virt Agent</code> channel to install the agents.
In Red Hat Enterprise Linux 5, this channel is labeled <code>rhel-x86_64-rhev-agent-5-server</code>. In Red Hat Enterprise Linux 6, the channel is labeled <code>rhel-x86_64-rhev-agent-6-server</code>.
<dt>Installing the agents and drivers on Windows guests
<dd>The agents and drivers are installed on Windows virtual machines using the <code>rhev-tools-setup.iso</code> disk image. The guest tools ISO is distributed using the Red Hat Network as <code>rhev-guest-tools-iso.rpm</code>, an RPM file installed on oVirt.
After installing oVirt, the guest tools ISO can be found at <code>/usr/share/rhev-guest-tools-iso/rhev-tools-setup.iso</code>. When setting up oVirt, if you have created a local storage share for an ISO storage domain, the ISO file is automatically copied to the ISO storage domain. In this case the ISO image is automatically attached to Windows guests when they are created. Otherwise, the ISO must be manually attached to Windows guests for the tools and agents to be installed.
Updated versions of the ISO file must be manually attached to running Windows virtual machines to install updated versions of the tools and drivers. If the APT service is enabled on virtual machines, the updated ISO files will be automatically attached.</dl>

==== Automating Guest Additions on Windows Guests with oVirt Application Provisioning Tool(APT) ====

oVirt Application Provisioning Tool (APT) is a Windows service that can be installed in Windows virtual machines and templates. Attach the guest tools ISO file to your Windows virtual machine and '''ovirt-Application Provisioning.exe''' automatically runs to install the APT service.

When the APT service is installed on a virtual machine, attached ISO files are automatically scanned. When the service recognizes a valid oVirt guest tools ISO, and no other guest tools are installed, the APT service installs the guest tools. If guest tools are installed, and the ISO image contains newer versions of the tools, an upgrade is automatically performed.

When the APT service has successfully installed or upgraded guest tools on a virtual machine, the virtual machine is automatically rebooted.

==== oVirt Guest Drivers and Guest Agents ====

oVirt provides customized drivers and guest tools to use with Windows and Red Hat Enterprise Linux guests. The drivers allow guests to use enhanced virtual devices that perform better than emulated devices; the guest agents facilitate communication between the guest and oVirt.

⁠

'''Table 8.15. oVirt Guest Drivers'''

{| class="wikitable"
!width="33%"|Driver
!width="33%"|Description
!width="33%"|Works on
|- style="vertical-align:top;"
|<code>virtio-net</code>
|Paravirtualized network driver provides enhanced performance over emulated devices like rtl.
|Server and Desktop.
|- style="vertical-align:top;"
|<code>virtio-block</code>
|Paravirtualized HDD driver offers increased I/O performance over emulated devices like IDE by optimizing the coordination and communication between the guest and the hypervisor. The driver complements the software implementation of the virtio-device used by the host to play the role of a hardware device.
|Server and Desktop.
|- style="vertical-align:top;"
|<code>virtio-scsi</code>
|Paravirtualized iSCSI HDD driver offers similar functionality to the virtio-block device, with some additional enhancements. In particular, this driver supports adding hundreds of devices, and names devices using the standard SCSI device naming scheme.
|Server and Desktop.
|- style="vertical-align:top;"
|<code>virtio-serial</code>
|Virtio-serial provides support for multiple serial ports. The improved performance is used for fast communication between the guest and the host that avoids network complications. This fast communication is required for the guest agents and for other features such as clipboard copy-paste between the guest and the host and logging.
|Server and Desktop.
|- style="vertical-align:top;"
|<code>virtio-balloon</code>
|Virtio-balloon is used to control the amount of memory a guest actually accesses. It offers improved memory over-commitment. The balloon drivers are installed for future compatibility but not used by default in oVirt 3.1 or higher.
|Server and Desktop.
|- style="vertical-align:top;"
|<code>qxl</code>
|A paravirtualized display driver reduces CPU usage on the host and provides better performance through reduced network bandwidth on most workloads.
|Server and Desktop.
|}

⁠

'''Table 8.16. oVirt Guest Agents and Tools'''

{| class="wikitable"
!width="33%"|Guest agent/tool
!width="33%"|Description
!width="33%"|Works on
|- style="vertical-align:top;"
|<code>ovirt-guest-agent</code>
|Allows oVirt to receive guest internal events and information such as IP address and installed applications. Also allows oVirt to execute specific commands, such as shut down or reboot, on a guest.
On Red Hat Enterprise Linux 6 and higher guests, the ovirt-guest-agent installs '''tuned''' on your virtual machine and configures it to use an optimized, virtualized-guest profile.
|Server and Desktop.
|- style="vertical-align:top;"
|<code>spice-agent</code>
|The SPICE agent supports multiple monitors and is responsible for client-mouse-mode support to provide a better user experience and improved responsiveness than the QEMU emulation. Cursor capture is not needed in client-mouse-mode. The SPICE agent reduces bandwidth usage when used over a wide area network by reducing the display level, including color depth, disabling wallpaper, font smoothing, and animation. The SPICE agent enables clipboard support allowing cut and paste operations for both text and images between client and guest, and automatic guest display setting according to client-side settings. On Windows guests, the SPICE agent consists of vdservice and vdagent.
|Server and Desktop.
|- style="vertical-align:top;"
|<code>ovirt-sso</code>
|An agent that enables users to automatically log in to their virtual machines based on the credentials used to access oVirt.
|Desktop.
|- style="vertical-align:top;"
|<code>ovirt-usb</code>
|A component that contains drivers and services for Legacy USB support (version 3.0 and earlier) on guests. It is needed for accessing a USB device that is plugged into the client machine. <code>ovirt-USB Client</code> is needed on the client side.
|Desktop.
|}

=== Accessing Virtual machines ===

==== Starting a Virtual Machine ====

'''Summary'''

You can start a virtual machine from the Administration Portal.


'''Procedure 8.26. Starting a Virtual Machine'''

<ol>
<li>Click the '''Virtual Machines''' tab and select a virtual machine with a status of <code>Down</code>.</li>
<li>Click the run [[Image:up.png]] button.
Alternatively, right-click the virtual machine and select '''Run'''.</li></ol>

'''Result'''

The '''Status''' of the virtual machine changes to <code>Up</code>, and the console protocol of the selected virtual machine is displayed. If the guest agent is installed on the virtual machine, the IP address of that virtual machine is also displayed.

==== Opening a Console to a Virtual Machine ====

'''Summary'''

Open a console to a virtual machine.


'''Procedure 8.27. Logging in to a Virtual Machine'''

<ol>
<li>Click the '''Virtual Machines''' tab and select a virtual machine.</li>
<li><p>Click the console button or right-click the virtual machine and select '''Console'''.</p>
<p>⁠</p>
<p>[[Image:Console.png|400px|Connection Icon on the Virtual Machine Menu]]</p>
<p>'''Figure 8.8. Connection Icon on the Virtual Machine Menu'''</p></li>
<li><ul>
<li>If Remote Viewer is installed, a console window will automatically open for the virtual machine.</li></ul>
</li></ol>

'''Result'''

You have opened a console to a virtual machine from the Administration Portal.

<div class="alert alert-info">'''Note:''' If Remote Viewer is not installed, you will be prompted to download a file called <code>console.vv</code>. You can then install Remove Viewer and manually open this file, or you can use a text editor to open the file and retrieve the connection information that file contains. This information can then be used to open a console to the virtual machine using a VNC client.</div>

==== Shutting Down a Virtual Machine ====

'''Summary'''

If the guest agent is installed on a virtual machine or that virtual machine supports Advanced Configuration and Power Interface (ACPI), you can shut that virtual machine down from within the Administration Portal.

'''Procedure 8.28. Shutting Down a Virtual Machine'''

<ol>
<li>Click the '''Virtual Machines''' tab and select a running virtual machine.</li>
<li>Click the shut down ( [[Image:Down.png]] ) button.
Alternatively, right-click the virtual machine and select '''Shutdown'''.</li></ol>

'''Result'''

The virtual machine shuts down gracefully and the '''Status''' of the virtual machine changes to <code>Down</code>.

==== Pausing a Virtual Machine ====

'''Summary'''

If the guest agent is installed on a virtual machine or that virtual machine supports Advanced Configuration and Power Interface (ACPI), you can pause that virtual machine from within the Administration Portal. This is equal to placing that virtual machine into ''Hibernate'' mode.

⁠

'''Procedure 8.29. Pausing a Virtual Machine'''

<ol>
<li>Click the '''Virtual Machines''' tab and select a running virtual machine.</li>
<li>Click the Suspend ( [[Image:Suspend.png]] ) button.
Alternatively, right-click the virtual machine and select '''Suspend'''.</li></ol>

'''Result'''

The '''Status''' of the virtual machine changes to <code>Paused</code>.

==== Rebooting a Virtual Machine ====

'''Summary'''

If the guest agent is installed on a virtual machine, you can reboot that virtual machine from within the Administration Portal.

'''Procedure 8.30. Rebooting a Virtual Machine'''

<ol>
<li>Click the '''Virtual Machines''' tab and select a running virtual machine.</li>
<li>Click the Reboot ( [[Image:Reboot.png]] ) button.
Alternatively, right-click the virtual machine and select '''Reboot'''.</li>
<li>Click '''OK''' in the '''Reboot Virtual Machine(s)''' confirmation window.</li></ol>

'''Result'''

The '''Status''' of the virtual machine changes to <code>Reboot In Progress</code> before returning to <code>Up</code>.

=== Console Options ===

==== Introduction to Connection Protocols ====

Connection protocols are the underlying technology used to provide graphical consoles for virtual machines and allow users to work with virtual machines in a similar way as they would with physical machines. oVirt currently supports the following connection protocols:

SPICE

Simple Protocol for Independent Computing Environments (SPICE) is the recommended connection protocol for both Linux virtual machines and Windows virtual machines. SPICE is installed and executed on the client that connects to the virtual machine.

VNC

Virtual Network Computing (VNC) can be used to open consoles to both Linux virtual machines and Windows virtual machines. To open a console to a virtual machine using VNC, you must use Remote Viewer or a VNC client.

RDP

Remote Desktop Protocol (RDP) can only be used to open consoles to Windows virtual machines, and is only available when you access a virtual machines from a Windows machine on which Remote Desktop has been installed. Moreover, before you can connect to a Windows virtual machine using RDP, you must set up remote sharing on the virtual machine and configure the firewall to allow remote desktop connections.

<div class="alert alert-info">'''Note:''' SPICE is not currently supported on virtual machines running Windows 8. If a Windows 8 virtual machine is configured to use the SPICE protocol, it will detect the absence of the required SPICE drivers and automatically fall back to using RDP.</div>

==== Accessing Console Options ====

In the Administration Portal, you can configure several options for opening graphical consoles for virtual machines, such as the method of invocation and whether to enable or disable USB redirection.

⁠

'''Procedure 8.31. Accessing Console Options'''

# Select a running virtual machine.
# Right-click the virtual machine and click the '''Edit Console Options''' button to open the '''Console Options''' window.

<div class="alert alert-info">'''Note:''' Further options specific to each of the connection protocols, such as the keyboard layout when using the VNC connection protocol, can be configured in the '''Console''' tab of the '''Edit Virtual Machine''' window.</div>

==== SPICE Console Options ====

When the SPICE connection protocol is selected, the following options are available in the '''Console Options''' window.

[[Image:Console Options.png|300px|The Console Options window]]

'''Figure 8.9. The Console Options window'''

'''Console Invocation'''

* '''Auto''': oVirt automatically selects the method for invoking the console.
* '''Native client''': When you connect to the console of the virtual machine, a file download dialog provides you with a file that opens a console to the virtual machine via Remote Viewer.
* '''Browser plugin''': When you connect to the console of the virtual machine, you are connected directly via Remote Viewer.
* '''SPICE HTML5 browser client (Tech preview)''': When you connect to the console of the virtual machine, a browser tab is opened that acts as the console.

'''SPICE Options'''

* '''Map control-alt-delete shortcut to ctrl+alt+end''': Select this check box to map the '''Ctrl'''+'''Alt'''+'''Del''' key combination to '''Ctrl'''+'''Alt'''+'''End''' inside the virtual machine.
* '''Enable USB Auto-Share''': Select this check box to automatically redirect USB devices to the virtual machine. If this option is not selected, USB devices will connect to the client machine instead of the guest virtual machine. To use the USB device on the guest machine, manually enable it in the SPICE client menu.
* '''Open in Full Screen''': Select this check box for the virtual machine console to automatically open in full screen when you connect to the virtual machine. Press '''SHIFT'''+'''F11''' to toggle full screen mode on or off.
* '''Enable SPICE Proxy''': Select this check box to enable the SPICE proxy.
* '''Enable WAN options''': Select this check box to enable WAN color depth and effects for the virtual machine console. Select this check box for only Windows virtual machines. Selecting this check box sets the parameters ''WAN-DisableEffects'' and ''WAN-ColorDepth''. Selecting '''Enable WAN options''' sets ''Wan-DisableEffects'' to ''animation'' and sets the color depth to 16 bits.

<div class="alert alert-info">'''Important:''' The '''Browser plugin''' console option is only available when accessing the Administration and User Portals through Internet Explorer. This console options uses the version of Remote Viewer provided by the <code>SpiceX.cab</code> installation program. For all other browsers, the '''Native client''' console option is the default. This console option uses the version of Remote Viewer provided by the <code>virt-viewer-x86.msi</code> and <code>virt-viewer-x64.msi</code> installation files.</div>

==== VNC Console Options ====

When the VNC connection protocol is selected, the following options are available in the '''Console Options''' window.

'''Console Invocation'''

* '''Native Client''': When you connect to the console of the virtual machine, a file download dialog provides you with a file that opens a console to the virtual machine via Remote Viewer.
* '''NoVNC''': When you connect to the console of the virtual machine, a browser tab is opened that acts as the console.

'''VNC Options'''

* '''Map control-alt-delete shortcut to ctrl+alt+end''': Select this check box to map the '''Ctrl'''+'''Alt'''+'''Del''' key combination to '''Ctrl'''+'''Alt'''+'''End''' inside the virtual machine.

==== RDP Console Options ====

When the RDP connection protocol is selected, the following options are available in the '''Console Options''' window.

'''Console Invocation'''

* '''Auto''': oVirt automatically selects the method for invoking the console.
* '''Native client''': When you connect to the console of the virtual machine, a file download dialog provides you with a file that opens a console to the virtual machine via Remote Desktop.

'''RDP Options'''

* '''Use Local Drives''': Select this check box to make the drives on the client machine to be accessible on the guest virtual machine.

=== Remote Viewer Options ===

==== Remote Viewer Options ====

When you specify the '''Native client''' or '''Browser plugin''' console invocation options, you will connect to virtual machines using Remote Viewer. The Remote Viewer window provides a number of options for interacting with the virtual machine to which it is connected.⁠

'''Table 8.17. Remote Viewer Options'''

{| class="wikitable"
!width="50%"|Option
!width="50%"|Hotkey
|- style="vertical-align:top;"
|File
|* '''Screenshot''': Takes a screen capture of the active window and saves it in a location of your specification.
* '''USB device selection''': If USB redirection has been enabled on your virtual machine, the USB device plugged into your client machine can be accessed from this menu.
* '''Quit''': Closes the console. The hot key for this option is '''Shift'''+'''Ctrl'''+'''Q'''.
|- style="vertical-align:top;"
|View
|* '''Full screen''': Toggles full screen mode on or off. When enabled, full screen mode expands the virtual machine to fill the entire screen. When disabled, the virtual machine is displayed as a window. The hot key for enabling or disabling full screen is '''SHIFT'''+'''F11'''.
* '''Zoom''': Zooms in and out of the console window. '''Ctrl'''+'''+''' zooms in, '''Ctrl'''+'''-''' zooms out, and '''Ctrl'''+'''0''' returns the screen to its original size.
* '''Automatically resize''': Tick to enable the guest resolution to automatically scale according to the size of the console window.
* '''Displays''': Allows users to enable and disable displays for the guest virtual machine.
|- style="vertical-align:top;"
|Send key
|* '''Ctrl'''+'''Alt'''+'''Del''': On a Red Hat Enterprise Linux virtual machine, it displays a dialog with options to suspend, shut down or restart the virtual machine. On a Windows virtual machine, it displays the task manager or Windows Security dialog.
* '''Ctrl'''+'''Alt'''+'''Backspace''': On a Red Hat Enterprise Linux virtual machine, it restarts the X sever. On a Windows virtual machine, it does nothing.
* '''Ctrl'''+'''Alt'''+'''F1'''
* '''Ctrl'''+'''Alt'''+'''F2'''
* '''Ctrl'''+'''Alt'''+'''F3'''
* '''Ctrl'''+'''Alt'''+'''F4'''
* '''Ctrl'''+'''Alt'''+'''F5'''
* '''Ctrl'''+'''Alt'''+'''F6'''
* '''Ctrl'''+'''Alt'''+'''F7'''
* '''Ctrl'''+'''Alt'''+'''F8'''
* '''Ctrl'''+'''Alt'''+'''F9'''
* '''Ctrl'''+'''Alt'''+'''F10'''
* '''Ctrl'''+'''Alt'''+'''F11'''
* '''Ctrl'''+'''Alt'''+'''F12'''
* '''Printscreen''': Passes the '''Printscreen''' keyboard option to the virtual machine.
|- style="vertical-align:top;"
|Help
|The '''About''' entry displays the version details of Virtual Machine Viewer that you are using.
|- style="vertical-align:top;"
|Release Cursor from Virtual Machine
|'''SHIFT'''+'''F12'''
|}

==== Remote Viewer Hotkeys ====

You can access the hotkeys for a virtual machine in both full screen mode and windowed mode. If you are using full screen mode, you can display the menu containing the button for hotkeys by moving the mouse pointer to the middle of the top of the screen. If you are using windowed mode, you can access the hotkeys via the '''Send key''' menu on the virtual machine window title bar.

<div class="alert alert-info">'''Note:''' If '''vdagent''' is not running on the client machine, the mouse can become captured in a virtual machine window if it is used inside a virtual machine and the virtual machine is not in full screen. To unlock the mouse, press '''Shift'''+'''F12'''.</div>

== Removing Virtual Machines ==

=== Removing a Virtual Machine ===

'''Summary'''

Remove a virtual machine from the oVirt environment.

<div class="alert alert-info">'''Important:''' The '''Remove''' button is disabled while virtual machines are running; you must shut down a virtual machine before you can remove it.</div>

⁠

'''Procedure 8.32. Removing a Virtual Machine'''

# Click the '''Virtual Machines''' tab and select the virtual machine to remove.
# Click '''Remove''' to open the '''Remove Virtual Machine(s)''' window.
# Optionally, select the '''Remove Disk(s)''' check box to remove the virtual disks attached to the virtual machine together with the virtual machine. If the '''Remove Disk(s)''' check box is cleared, then the virtual disks remain in the environment as floating disks.
# Click '''OK'''.

'''Result'''

The virtual machine is removed from the environment and is no longer listed in the '''Virtual Machines''' resource tab. If you selected the '''Remove Disk(s)''' check box, then the virtual disks attached to the virtual machine are also removed.

== ⁠Snapshots ==

=== Creating a Snapshot of a Virtual Machine ===

'''Summary'''

A snapshot is a view of a virtual machine's operating system and applications on any or all available disks at a given point in time. Take a snapshot of a virtual machine before you make a change to it that may have unintended consequences. You can use a snapshot to return a virtual machine to a previous state.

<div class="alert alert-info">'''Note:''' Live snapshots can only be created for virtual machines running on 3.1-or-higher-compatible data centers. Virtual machines in 3.0-or-lower-compatible data centers must be shut down before a snapshot can be created.</div>

'''Procedure 8.33. Creating a Snapshot of a Virtual Machine'''

<ol>
<li>Click the '''Virtual Machines''' tab and select a virtual machine.</li>
<li><p>Click '''Create Snapshot''' to open the '''Create Snapshot''' window.</p>
<p>⁠</p>
<p>[[Image:Create Snapshot.png|300px|Create snapshot]]</p>
<p>'''Figure 8.10. Create snapshot'''</p></li>
<li>Enter a description for the snapshot.</li>
<li>Select '''Disks to include''' using the check boxes.</li>
<li>Use the '''Save Memory''' check box to denote whether you wish to include the virtual machine's memory in the snapshot.</li>
<li>Click '''OK''' to create the snapshot and close the window.</li></ol>

'''Result'''

The virtual machine's operating system and applications on the selected disk(s) are stored in a snapshot that can be previewed or restored. The snapshot is created with a status of <code>Locked</code>, which changes to <code>Ok</code>. When you click on the snapshot, its details are shown on the '''General''', '''Disks''', '''Network Interfaces''', and '''Installed Applications''' tabs in the right side-pane of the details pane.

=== Using a Snapshot to Restore a Virtual Machine ===

'''Summary'''

A snapshot can be used to restore a virtual machine to its previous state.

⁠

'''Procedure 8.34. Using a snapshot to restore a virtual machine'''

<ol>
<li>Click the '''Virtual Machines''' tab and select a virtual machine.</li>
<li>Click the '''Snapshots''' tab in the details pane to list the available snapshots.</li>
<li>Select a snapshot to restore in the left side-pane. The snapshot details display in the right side-pane.</li>
<li>Click the drop-down list beside '''Preview''' to open the '''Custom Preview Snapshot''' window.</li>
<li>Use the check boxes to select the '''VM Configuration''', '''Memory''', and disk(s) you want to restore, then click '''OK'''. This allows you to create and restore from a customized snapshot using the configuration and disk(s) from multiple snapshots. The status of the snapshot changes to <code>Preview Mode</code>. The status of the virtual machine briefly changes to <code>Image Locked</code> before returning to <code>Down</code>.</li>
<li>Start the virtual machine; it runs using the disk image of the snapshot.</li>
<li>Click '''Commit''' to permanently restore the virtual machine to the condition of the snapshot. Any subsequent snapshots are erased.
Alternatively, click the '''Undo''' button to deactivate the snapshot and return the virtual machine to its previous state.</li></ol>

'''Result'''

The virtual machine is restored to its state at the time of the snapshot, or returned to its state before the preview of the snapshot.

=== Creating a Virtual Machine from a Snapshot ===

'''Summary'''

You have created a snapshot from a virtual machine. Now you can use that snapshot to create another virtual machine.

⁠

'''Procedure 8.35. Creating a virtual machine from a snapshot'''

<ol>
<li>Click the '''Virtual Machines''' tab and select a virtual machine.</li>
<li>Click the '''Snapshots''' tab in the details pane to list the available snapshots for the virtual machines.</li>
<li>Select a snapshot in the list displayed and click '''Clone''' to open the '''Clone VM from Snapshot''' window.</li>
<li><p>Enter the '''Name''' and '''Description''' of the virtual machine to be created.</p>
<p>⁠</p>
<p>[[Image:Clone VM Snapshot.png|300px|Clone a Virtual Machine from a Snapshot]]</p>
<p>'''Figure 8.11. Clone a Virtual Machine from a Snapshot'''</p></li>
<li>Click '''OK''' to create the virtual machine and close the window.</li></ol>

'''Result'''

After a short time, the cloned virtual machine appears in the '''Virtual Machines''' tab in the navigation pane. It appears in the navigation pane with a status of <code>Image Locked</code>. The virtual machine will remain in this state until oVirt completes the creation of the virtual machine. A virtual machine with a preallocated 20GB hard drive takes about fifteen minutes to create. Sparsely-allocated virtual disks take less time to create than do preallocated virtual disks.

When the virtual machine is ready to use, its status changes from <code>Image Locked</code> to <code>Down</code> in the '''Virtual Machines''' tab in the navigation pane.

=== Deleting a Snapshot ===

'''Summary'''

Delete a snapshot and permanently remove it from the virtualized environment.

⁠

'''Procedure 8.36. Deleting a Snapshot'''

<ol>
<li>Click the '''Virtual Machines''' tab and select a virtual machine.</li>
<li><p>Click the '''Snapshots''' tab in the details pane to list available snapshots for the virtual machine.</p>
<p>⁠</p>
<p>[[Image:Snapshot List.png|600px|Snapshot List]]</p>
<p>'''Figure 8.12. Snapshot List'''</p></li>
<li>Select the snapshot to delete.</li>
<li>In the Navigation pane, shut down the running virtual machine associated with the snapshot to be deleted.</li>
<li>Click '''Delete''' to open the '''Delete Snapshot''' confirmation window.</li>
<li>Click '''OK''' to delete the snapshot and close the window.</li></ol>

'''Result'''

You have removed a virtual machine snapshot. Removing a snapshot does not affect the virtual machine.

== ⁠Affinity Groups ==

=== Introduction to Virtual Machine Affinity ===

Virtual machine affinity allows you to define sets of rules that specify whether certain virtual machines run together on the same host or run separately on different hosts. This allows you to create advanced workload scenarios for addressing challenges such as strict licensing requirements and workloads demanding high availability.

Virtual machine affinity is applied to virtual machines by adding virtual machines to one or more affinity groups. An affinity group is a group of two or more virtual machines for which a set of identical parameters and conditions apply. These parameters include positive (run together) affinity that ensures the virtual machines in an affinity group run on the same host, and negative (run independently) affinity that ensures the virtual machines in an affinity group run on different hosts.

A further set of conditions can then be applied to these parameters. For example, you can apply hard enforcement, which is a condition that ensures the virtual machines in the affinity group run on the same host or different hosts regardless of external conditions, or soft enforcement, which is a condition that indicates a preference for virtual machines in an affinity group to run on the same host or different hosts when possible.

The combination of an affinity group, its parameters and conditions are collectively known as an affinity policy.

<div class="alert alert-info">'''Note:''' Affinity groups are applied to virtual machines on the cluster level. When a virtual machine is moved from one cluster to another, that virtual machine is removed from all affinity groups in the source cluster.</div>

<div class="alert alert-info">'''Important:''' Affinity groups will only take effect when the <code>VmAffinityGroups</code> filter module or weights module is enabled in the cluster policy applied to clusters in which affinity groups are defined. The <code>VmAffinityGroups</code> filter module is used to implement hard enforcement, and the <code>VmAffinityGroups</code> weights module is used to implement soft enforcement.</div>

=== Creating an Affinity Group ===

'''Summary'''

You can create new affinity groups for applying affinity policies to virtual machines.

⁠

'''Procedure 8.37. Creating an Affinity Group'''

# Click the '''Virtual Machines''' tab and select a virtual machine.
# Click the '''Affinity Groups''' tab in the details pane.
# Click the '''New''' button to open the '''New Affinity Group''' window.
# Enter a name and description for the affinity group in the '''Name''' text field and '''Description''' text field.
# Select the '''Positive''' check box to apply positive affinity, or ensure this check box is cleared to apply negative affinity.
# Select the '''Enforcing''' check box to apply hard enforcement, or ensure this check box is cleared to apply soft enforcement.
# Use the drop-down menu to select the virtual machines to be added to the affinity group. Use the '''+''' and '''-''' buttons to add or remove additional virtual machines.
# Click '''OK'''.

'''Result'''

You have created a virtual machine affinity group and specified the parameters and conditions to be applied to the virtual machines that are members of that group.

=== Editing an Affinity Group ===

'''Summary'''

You can edit the settings of existing affinity groups.

⁠

'''Procedure 8.38. Editing an Affinity Group'''

# Click the '''Virtual Machines''' tab and select a virtual machine.
# Click the '''Affinity Groups''' tab in the details pane.
# Click the '''Edit''' button to open the '''Edit Affinity Group''' window.
# Change the '''Positive''' and '''Enforcing''' check boxes to the preferred values and use the '''+''' and '''-''' buttons to add or remove virtual machines to or from the affinity group.
# Click '''OK'''.

'''Result'''

You have edited an affinity group.

=== Removing an Affinity Group ===

'''Summary'''

You can remove an existing affinity group.

⁠

'''Procedure 8.39. Removing an Affinity Group'''

# Click the '''Virtual Machines''' tab and select a virtual machine.
# Click the '''Affinity Groups''' tab in the details pane.
# Click the '''Remove''' button and click '''OK''' when prompted to remove the affinity group.

'''Result'''

You have removed an affinity group, and the affinity policy that applied to the virtual machines that were members of that affinity group no longer applies.

== ⁠Importing and Exporting Virtual Machines ==

=== Exporting and Importing Virtual Machines and Templates ===

Virtual machines and templates can be exported from and imported to data centers in the same oVirt environment, or a different oVirt environment. oVirt allows you to import and export virtual machines (and templates) stored in Open Virtual Machine Format (OVF).

There are three stages to exporting and importing virtual machines and templates:

# Export the virtual machine or template to an export domain.
# Detach the export domain from one data center, and attach it to another. You can attach it to a different data center in the same oVirt environment, or attach it to a data center in a separate oVirt environment that is managed by another installation of oVirt.
# Import the virtual machine or template into the data center to which the export domain is attached.

A virtual machine must be stopped before it can be moved across data centers. If the virtual machine was created using a template, the template must exist in the destination data center for the virtual machine to work, or the virtual machine must be exported with the '''Collapse Snapshots''' option selected.

<div class="alert alert-info">'''Note:''' When you export or import a virtual machine or template, the properties of that virtual machine or template are preserved, including basic details such as the name and description, resource allocation, and high availability settings.</div>

=== Overview of the Export and Import Process ===

The export domain allows you to move virtual machines and templates between oVirt environments.

To export or import virtual machines and templates, an active export domain must be attached to the data center containing the virtual machine or template to be exported or imported. An export domain acts as a temporary storage area containing two directories for each exported virtual machine or template. One directory contains the OVF (Open Virtualization Format) files for the virtual machine or template. The other directory holds the disk image or images for the virtual machine or template.

You can also import virtual machines from other virtualization providers such as Xen, VMware or Windows virtual machines using the V2V feature. V2V converts virtual machines and places them in the export domain.

For more information on V2V, see the ''Red Hat Enterprise Linux V2V Guide''.

<div class="alert alert-info">'''Note:''' An export domain can only be active in one data center at a given time. This means that the export domain must be attached to either the source data center or the destination data center.</div>

Exporting virtual machines and templates from one data center to another requires some preparation. Ensure that:

* An export domain exists, and is attached to the source data center.
* The virtual machine is shut down.
* If the virtual machine was created based on a template, that template must reside on the destination data center or be exported with the virtual machine.

When the virtual machine or template has been exported to the export domain, you can import that virtual machine or template into the destination data center. If the destination data center is in the same oVirt environment as the source data center, delete the original virtual machine or template from the source data center after the export has completed.

=== Graphical Overview for Exporting and Importing Virtual Machines and Templates ===

'''Summary'''

This procedure provides a graphical overview of the steps required to export a virtual machine or template from one data center and import that virtual machine or template into another data center.

⁠

'''Procedure 8.40. Exporting and Importing Virtual Machines and Templates'''

<ol>
<li><p>Attach the export domain to the source data center.</p>
<p>⁠</p>
<p>[[Image:Export1.png|400px|Attach Export Domain]]</p>
<p>'''Figure 8.13. Attach Export Domain'''</p></li>
<li><p>Export the virtual machine or template to the export domain.</p>
<p>⁠</p>
<p>[[Image:Export2.png|400px|Export the Virtual Resource]]</p>
<p>'''Figure 8.14. Export the Virtual Resource'''</p></li>
<li><p>Detach the export domain from the source data center.</p>
<p>⁠</p>
<p>[[Image:Export3.png|400px|Detach Export Domain]]</p>
<p>'''Figure 8.15. Detach Export Domain'''</p></li>
<li><p>Attach the export domain to the destination data center.</p>
<p>⁠</p>
<p>[[Image:Export4.png|400px|Attach the Export Domain]]</p>
<p>'''Figure 8.16. Attach the Export Domain'''</p></li>
<li><p>Import the virtual machine or template into the destination data center.</p>
<p>⁠</p>
<p>[[Image:Export5.png|400px|Import the virtual resource]]</p>
<p>'''Figure 8.17. Import the virtual resource'''</p></li></ol>

'''Result'''

The virtual machine or template is imported to the destination data center.

=== Exporting a Virtual Machine to the Export Domain ===

'''Summary'''

Export a virtual machine to the export domain so that it can be imported into a different data center. Before you begin, the export domain must be attached to the data center that contains the virtual machine to be exported.

⁠

'''Procedure 8.41. Exporting a Virtual Machine to the Export Domain'''

<ol>
<li>Click the '''Virtual Machines''' tab and select a virtual machine.</li>
<li>Click '''Export''' to open the '''Export Virtual Machine''' window.</li>
<li>Select the '''Force Override''' check box to override existing images of the virtual machine on the export domain.
Select the '''Collapse Snapshots''' check box to create a single export volume per disk. Selecting this option will remove snapshot restore points and include the template in a template-based virtual machine. This removes any dependencies a virtual machine has on a template.</li>
<li>Click '''OK''' to export the virtual machine and close the window.</li></ol>

'''Result'''

The export of the virtual machine begins. The virtual machine displays in the Virtual Machines list with an <code>Image Locked</code> status as it is exported. Depending on the size of your virtual machine hard disk images, and your storage hardware, this can take up to an hour. Use the '''Events''' tab to view the progress.

When complete, the virtual machine has been exported to the export domain and displays on the '''VM Import''' tab of the export domain's details pane.

=== Importing a Virtual Machine into the Destination Data Center ===

'''Summary'''

You have a virtual machine on an export domain. Before the virtual machine can be imported to a new data center, the export domain must be attached to the destination data center.

⁠

'''Procedure 8.42. Importing a Virtual Machine into the Destination Data Center'''

<ol>
<li>Use the '''Storage''' resource tab, tree mode, or the search function to find and select the export domain in the results list. The export domain must have a status of <code>Active</code></li>
<li>Select the '''VM Import''' tab in the details pane to list the available virtual machines to import.</li>
<li>Select one or more virtual machines to import and click '''Import''' to open the '''Import Virtual Machine(s)''' window.</li>
<li>Use the drop-down menus to select the '''Default Storage Domain''' and '''Cluster'''.</li>
<li>Select the '''Collapse Snapshots''' check box to remove snapshot restore points and include templates in template-based virtual machines.</li>
<li>Click the virtual machine to be imported and click on the '''Disks''' sub-tab. From this tab, you can use the '''Allocation Policy''' and '''Storage Domain''' drop-down lists to select whether the disk used by the virtual machine will be thinly provisioned or preallocated, and can also select the storage domain on which the disk will be stored. An icon is also displayed to indicate which of the disks to be imported acts as the boot disk for that virtual machine.</li>
<li>Click '''OK''' to import the virtual machines The '''Import Conflict''' window opens if the virtual machine exists in the virtualized environment.</li>
<li>Choose one of the following radio buttons:
<ul>
<li>'''Don't import'''</li>
<li>'''Clone''' and enter a unique name for the virtual machine in the '''New Name''' field.</li></ul>

Or select the '''Apply to all''' check box to import all duplicated virtual machines with the same suffix.</li>
<li>Click '''OK''' to import the virtual machines and close the window.</li></ol>

<div class="alert alert-info">'''Important:''' During a single import operation, you can only import virtual machines that share the same architecture. If any of the virtual machines to be imported have a different architecture to that of the other virtual machines to be imported, a warning will display and you will be prompted to change your selection so that only virtual machines with the same architecture will be imported.</div>

'''Result'''

You have imported the virtual machine to the destination data center. This may take some time to complete.

== ⁠Migrating Virtual Machines Between Hosts ==

=== What is Live Migration? ===

Live migration provides the ability to move a running virtual machine between physical hosts with no interruption to service.

Live migration is transparent to the end user: the virtual machine remains powered on and user applications continue to run while the virtual machine is relocated to a new physical host.

=== Live Migration Prerequisites ===

Live migration is used to seamlessly move virtual machines to support a number of common maintenance tasks. Ensure that your oVirt environment is correctly configured to support live migration well in advance of using it.

At a minimum, for successful live migration of virtual machines to be possible:

* The source and destination host must both be members of the same cluster, ensuring CPU compatibility between them.
* The source and destination host must have a status of <code>Up</code>.
* The source and destination host must have access to the same virtual networks and VLANs.
* The source and destination host must have access to the data storage domain on which the virtual machine resides.
* There must be enough CPU capacity on the destination host to support the virtual machine's requirements.
* There must be enough RAM on the destination host that is not in use to support the virtual machine's requirements.
* The migrating virtual machine must not have the <code>cache!=none</code> custom property set.

In addition, for best performance, the storage and management networks should be split to avoid network saturation. Virtual machine migration involves transferring large amounts of data between hosts.

Live migration is performed using the management network. Each live migration event is limited to a maximum transfer speed of 30 MBps, and the number of concurrent migrations supported is also limited by default. Despite these measures, concurrent migrations have the potential to saturate the management network. It is recommended that separate logical networks are created for storage, display, and virtual machine data to minimize the risk of network saturation.

=== Automatic Virtual Machine Migration ===

oVirt automatically initiates live migration of all virtual machines running on a host when the host is moved into maintenance mode. The destination host for each virtual machine is assessed as the virtual machine is migrated, in order to spread the load across the cluster.

oVirt automatically initiates live migration of virtual machines in order to maintain load balancing or power saving levels in line with cluster policy. While no cluster policy is defined by default, it is recommended that you specify the cluster policy which best suits the needs of your environment. You can also disable automatic, or even manual, live migration of specific virtual machines where required.

=== Preventing Automatic Migration of a Virtual Machine ===

'''Summary'''

oVirt allows you to disable automatic migration of virtual machines. You can also disable manual migration of virtual machines by setting the virtual machine to run only on a specific host.

The ability to disable automatic migration and require a virtual machine to run on a particular host is useful when using application high availability products, such as Red Hat High Availability or Cluster Suite.

'''Procedure 8.43. Preventing automatic migration of a virtual machine'''

<ol>
<li>Click the '''Virtual Machines''' tab and select a virtual machine.</li>
<li>Click '''Edit''' to open the '''Edit Virtual Machine''' window.</li>
<li>Click the '''Hide Advanced Options''' button.<br>
[[Image:Edit Virtual Machine.png|400px|Edit Virtual Machine Window]]<br>
'''Figure 8.18. Edit Virtual Machine Window'''</li>
<li>Click the '''Host''' tab.</li>
<li>Use the '''Run On''' radio buttons to designate the virtual machine to run on '''Any Host in Cluster''' or a '''Specific''' host. If applicable, select a specific host from the drop-down menu.
<div class="alert alert-info">'''Warning:''' Explicitly assigning a virtual machine to a specific host and disabling migration is mutually exclusive with oVirt high availability. Virtual machines that are assigned to a specific host can only be made highly available using third party high availability products like Red Hat High Availability.</div></li>
<li>Use the drop-down menu to affect the '''Migration Options'''. Select '''Do not allow migration''' to enable the '''Use Host CPU''' check box.</li>
<li>If applicable, enter relevant '''CPU Pinning topology''' commands in the text field.</li>
<li>Click '''OK''' to save the changes and close the window.</li></ol>

'''Result'''

You have changed the migration settings for the virtual machine.

=== Manually Migrating Virtual Machines ===

'''Summary'''

A running virtual machine can be migrated to any host within its designated host cluster. This is especially useful if the load on a particular host is too high. When bringing a server down for maintenance, migration is triggered automatically, so manual migration is not required. Migration of virtual machines does not cause any service interruption.

The migrating virtual machine must not have the <code>cache!=none</code> custom property set.

'''Procedure 8.44. Manually Migrating Virtual Machines'''

<ol>
<li>Click the '''Virtual Machines''' tab and select a running virtual machine.</li>
<li>Click '''Migrate''' to open the '''Migrate Virtual Machine(s)''' window.</li>
<li>Use the radio buttons to select whether to '''Select Host Automatically''' or to '''Select Destination Host''', specifying the host using the drop-down menu.
<div class="alert alert-info">'''Note:''' Virtual Machines migrate within their designated host cluster. When the '''Select Host Automatically''' option is selected, the system determines the host to which the virtual is migrated according to the load balancing and power management rules set up in the cluster policy.</div></li>
<li>Click '''OK''' to commence migration and close the window.</li></ol>

'''Result'''

The virtual machine is migrated. Once migration is complete the '''Host''' column will update to display the host the virtual machine has been migrated to.

=== Setting Migration Priority ===

'''Summary'''

oVirt queues concurrent requests for migration of virtual machines off of a given host. Every minute the load balancing process runs. Hosts already involved in a migration event are not included in the migration cycle until their migration event has completed. When there is a migration request in the queue and available hosts in the cluster to action it, a migration event is triggered in line with the load balancing policy for the cluster.

It is possible to influence the ordering of the migration queue, for example setting mission critical virtual machines to migrate before others. oVirt allows you to set the priority of each virtual machine to facilitate this. Virtual machines migrations will be ordered by priority, those virtual machines with the highest priority will be migrated first.

⁠

'''Procedure 8.45. Setting Migration Priority'''

# Click the '''Virtual Machines''' tab and select a virtual machine.
# Click '''Edit''' to open the '''Edit Virtual Machine''' window.
# Select the '''High Availability''' tab.
# Use the radio buttons to set the '''Priority for Run/Migrate Queue''' of the virtual machine to one of '''Low''', '''Medium''', or '''High'''.
# Click '''OK''' to save changes and close the window.

'''Result'''

The virtual machine's migration priority has been modified.

=== Canceling Ongoing Virtual Machine Migrations ===

'''Summary'''

A virtual machine migration is taking longer than you expected. You'd like to be sure where all virtual machines are running before you make any changes to your environment.

⁠

'''Procedure 8.46. Canceling Ongoing Virtual Machine Migrations'''

# Select the migrating virtual machine. It is displayed in the '''Virtual Machines''' resource tab with a status of '''Migrating from'''.
# Click the '''Cancel Migration''' button at the top of the results list. Alternatively, right-click on the virtual machine and select '''Cancel Migration''' from the context menu.

'''Result'''

The virtual machine status returns from '''Migrating from''' status to '''Up''' status.

=== Event and Log Notification upon Automatic Migration of Highly Available Virtual Servers ===

When a virtual server is automatically migrated because of the high availability function, the details of an automatic migration are documented in the '''Events''' tab and in the engine log to aid in troubleshooting, as illustrated in the following examples:

⁠

'''Example 8.1. Notification in the Events Tab of the Web Admin Portal'''

Highly Available ''Virtual_Machine_Name'' failed. It will be restarted automatically.

''Virtual_Machine_Name'' was restarted on Host ''Host_Name''

⁠

'''Example 8.2. Notification in oVirt engine.log'''

This log can be found on oVirt at <code>/var/log/ovirt-engine/engine.log</code>:

Failed to start Highly Available VM. Attempting to restart. VM Name: ''Virtual_Machine_Name'', VM Id:''Virtual_Machine_ID_Number''

== ⁠Improving Uptime with Virtual Machine High Availability ==

=== Why Use High Availability? ===

High availability is recommended for virtual machines running critical workloads.

High availability can ensure that virtual machines are restarted in the following scenarios:

* When a host becomes non-operational due to hardware failure.
* When a host is put into maintenance mode for scheduled downtime.
* When a host becomes unavailable because it has lost communication with an external storage resource.

A high availability virtual machine is automatically restarted, either on its original host or another host in the cluster.

=== What is High Availability? ===

High availability means that a virtual machine will be automatically restarted if its process is interrupted. This happens if the virtual machine is terminated by methods other than powering off from within the guest or sending the shutdown command from oVirt. When these events occur, the highly available virtual machine is automatically restarted, either on its original host or another host in the cluster.

High availability is possible because oVirt constantly monitors the hosts and storage, and automatically detects hardware failure. If host failure is detected, any virtual machine configured to be highly available is automatically restarted on another host in the cluster.

With high availability, interruption to service is minimal because virtual machines are restarted within seconds with no user intervention required. High availability keeps your resources balanced by restarting guests on a host with low current resource utilization, or based on any workload balancing or power saving policies that you configure. This ensures that there is sufficient capacity to restart virtual machines at all times.

=== High Availability Considerations ===

A highly available host requires a power management device and its fencing parameters configured. In addition, for a virtual machine to be highly available when its host becomes non-operational, it needs to be started on another available host in the cluster. To enable the migration of highly available virtual machines:

* Power management must be configured for the hosts running the highly available virtual machines.
* The host running the highly available virtual machine must be part of a cluster which has other available hosts.
* The destination host must be running.
* The source and destination host must have access to the data domain on which the virtual machine resides.
* The source and destination host must have access to the same virtual networks and VLANs.
* There must be enough CPUs on the destination host that are not in use to support the virtual machine's requirements.
* There must be enough RAM on the destination host that is not in use to support the virtual machine's requirements.

=== Configuring a Highly Available Virtual Machine ===

'''Summary'''

High availability must be configured individually for each virtual machine.

'''Procedure 8.47. Configuring a Highly Available Virtual Machine'''

<ol>
<li>Click the '''Virtual Machines''' tab and select a virtual machine.</li>
<li>Click '''Edit''' to open the '''Edit Virtual Machine''' window.</li>
<li>Click the '''Show Advanced Options''' button.
<li>Click the '''High Availability''' tab.</li>
<li>Select the '''Highly Available''' check box to enable high availability for the virtual machine.</li>
<li>Use the radio buttons to set the '''Priority for Run/Migrate Queue''' of the virtual machine to one of '''Low''', '''Medium''', or '''High'''. When migration is triggered, a queue is created in which the high priority virtual machines are migrated first. If a cluster is running low on resources, only the high priority virtual machines are migrated.</li>
<li>Click '''OK'''.</li></ol>

'''Result'''

You have configured high availability for a virtual machine. You can check if a virtual machine is highly available by selecting the virtual machine and clicking on the '''General''' tab in the details pane.

== ⁠Other Virtual Machine Tasks ==

=== Enabling SAP monitoring for a virtual machine from the Administration Portal ===

'''Summary'''

Enable SAP monitoring on a virtual machine to be recognized by SAP monitoring systems.


'''Procedure 8.48. Enabling SAP monitoring for a Virtual Machine from the Administration Portal'''

<ol>
<li>Click the '''Virtual Machines''' tab and select a virtual machine.</li>
<li>Click '''Edit''' button to open the '''Edit Virtual Machine''' window.</li>
<li>Click the '''Show Advanced Properties''' button.
<li>Select the '''Custom Properties''' tab.<br>
[[Image:Edit Virtual Machine CustomProperties.png|350px|Custom Properties tab]]<br>
'''Figure 8.19. Enable SAP'''</li>
<li>Use the drop-down menu to select <code>sap_agent</code>. Ensure the secondary drop-down menu is set to '''True'''.
If previous properties have been set, select the plus sign to add a new property rule and select <code>sap_agent</code>.</li>
<li>Click '''OK''' to save changes and close the window.</li></ol>

'''Result'''

You have enabled SAP monitoring for your virtual machine.

=== Configuring Red Hat Enterprise Linux 5.4 or Higher Virtual Machines to use SPICE ===

==== Using SPICE on virtual machines running versions of Red Hat Enterprise Linux released prior to 5.4 ====

SPICE is a remote display protocol designed for virtual environments, which enables you to view a virtualized desktop or server. SPICE delivers a high quality user experience, keeps CPU consumption low, and supports high quality video streaming.

Using SPICE on a Linux machine significantly improves the movement of the mouse cursor on the console of the virtual machine. To use SPICE, the X-Windows system requires additional qxl drivers. The qxl drivers are provided with Red Hat Enterprise Linux 5.4 and newer. Older versions are not supported. Installing SPICE on a virtual machine running Red Hat Enterprise Linux significantly improves the performance of the graphical user interface.

<div class="alert alert-info">'''Note:''' Typically, this is most useful for virtual machines where the user requires the use of the graphical user interface. System administrators who are creating virtual servers may prefer not to configure SPICE if their use of the graphical user interface is minimal.</div>

==== Installing qxl drivers on virtual machines ====

'''Summary'''

This procedure installs qxl drivers on virtual machines running Red Hat Enterprise Linux 5.4 or higher.

'''Procedure 8.49. Installing qxl Drivers on a Virtual Machine'''

<ol>
<li>Log in to a Red Hat Enterprise Linux virtual machine.</li>
<li>Open a terminal.</li>
<li>Run the following command as root:<br>
<pre class="screen"># yum install xorg-x11-drv-qxl</pre></li></ol>

'''Result'''

The qxl drivers have been installed and must now be configured.

==== Configuring qxl drivers on virtual machines ====

'''Summary'''

You can configure qxl drivers using either a graphical interface or the command line. Perform only one of the following procedures.

'''Procedure 8.50. Configuring qxl drivers in GNOME'''

# Click '''System'''.
# Click '''Administration'''.
# Click '''Display'''.
# Click the '''Hardware''' tab.
# Click '''Video Cards Configure'''.
# Select '''qxl''' and click '''OK'''.
# Restart X Window by logging out of the virtual machine and logging back in.

'''Procedure 8.51. Configuring qxl drivers on the command line:'''

<ol>
<li>Back up <code>/etc/X11/xorg.conf</code>:<br>
<pre class="screen"># cp /etc/X11/xorg.conf /etc/X11/xorg.conf.$$.backup</pre></li>
<li>Make the following change to the Device section of <code>/etc/X11/xorg.conf</code>:<br>
<pre class="screen">Section     &quot;Device&quot;
Identifier  &quot;Videocard0&quot;
Driver      &quot;qxl&quot;
Endsection</pre></li></ol>

'''Result'''

You have configured qxl drivers to enable your virtual machine to use SPICE.

==== Configuring a Virtual Machine's Tablet and Mouse to use SPICE ====

'''Summary'''

Edit the <code>/etc/X11/xorg.conf</code> file to enable SPICE for your virtual machine's tablet devices.

'''Procedure 8.52. Configuring a virtual machine's tablet and mouse to use SPICE'''

<ol>
<li>Verify that the tablet device is available on your guest:<br>
<pre class="screen"># /sbin/lsusb -v | grep 'QEMU USB Tablet'</pre><br>
If there is no output from the command, do not continue configuring the tablet.</li>
<li>Back up <code>/etc/X11/xorg.conf</code> by running this command:<br>
<pre class="screen"># cp /etc/X11/xorg.conf /etc/X11/xorg.conf.$$.backup</pre></li>
<li>Make the following changes to /etc/X11/xorg.conf:<br>
<pre class="screen">Section &quot;ServerLayout&quot;
Identifier     &quot;single head configuration&quot;
Screen      0  &quot;Screen0&quot; 0 0
InputDevice    &quot;Keyboard0&quot; &quot;CoreKeyboard&quot;
InputDevice    &quot;Tablet&quot; &quot;SendCoreEvents&quot;
InputDevice    &quot;Mouse&quot; &quot;CorePointer&quot;
EndSection
                             
Section &quot;InputDevice&quot;
Identifier  &quot;Mouse&quot;
Driver      &quot;void&quot;
#Option      &quot;Device&quot; &quot;/dev/input/mice&quot;
#Option      &quot;Emulate3Buttons&quot; &quot;yes&quot;
EndSection
                             
Section &quot;InputDevice&quot;
Identifier  &quot;Tablet&quot;
Driver      &quot;evdev&quot;
Option      &quot;Device&quot; &quot;/dev/input/event2&quot;
Option &quot;CorePointer&quot; &quot;true&quot;
EndSection</pre></li>
<li>Log out and log back into the virtual machine to restart X-Windows.</li></ol>

'''Result'''

You have enabled a tablet and a mouse device on your virtual machine to use SPICE.

=== KVM Virtual Machine Timing Management ===

Virtualization poses various challenges for virtual machine time keeping. Virtual machines which use the Time Stamp Counter (TSC) as a clock source may suffer timing issues as some CPUs do not have a constant Time Stamp Counter. Virtual machines running without accurate timekeeping can have serious affects on some networked applications as your virtual machine will run faster or slower than the actual time.

KVM works around this issue by providing virtual machines with a paravirtualized clock. The KVM <code>pvclock</code> provides a stable source of timing for KVM guests that support it.

Presently, only Red Hat Enterprise Linux/CentOS 5.4 and higher virtual machines fully support the paravirtualized clock.

Virtual machines can have several problems caused by inaccurate clocks and counters:

* Clocks can fall out of synchronization with the actual time which invalidates sessions and affects networks.
* Virtual machines with slower clocks may have issues migrating.

These problems exist on other virtualization platforms and timing should always be tested.

<div class="alert alert-info">'''Important:''' The Network Time Protocol (NTP) daemon should be running on the host and the virtual machines. Enable the <code>ntpd</code> service:

<pre class="screen"># service ntpd start</pre>
Add the ntpd service to the default startup sequence:

<pre class="screen"># chkconfig ntpd on</pre>
Using the <code>ntpd</code> service should minimize the affects of clock skew in all cases.</div>

The NTP servers you are trying to use must be operational and accessible to your hosts and virtual machines.

Determining if your CPU has the constant Time Stamp Counter

Your CPU has a constant Time Stamp Counter if the <code>constant_tsc</code> flag is present. To determine if your CPU has the <code>constant_tsc</code> flag run the following command:

<pre class="screen">$ cat /proc/cpuinfo | grep constant_tsc</pre>
If any output is given your CPU has the <code>constant_tsc</code> bit. If no output is given follow the instructions below.

Configuring Hosts Without a Constant Time Stamp Counter

Systems without constant time stamp counters require additional configuration. Power management features interfere with accurate time keeping and must be disabled for virtual machines to accurately keep time with KVM.

<div class="alert alert-info">'''Important:''' These instructions are for AMD revision F CPUs only.</div>

If the CPU lacks the <code>constant_tsc</code> bit, disable all power management features ([https://bugzilla.redhat.com/show_bug.cgi?id=513138 BZ#513138]). Each system has several timers it uses to keep time. The TSC is not stable on the host, which is sometimes caused by <code>cpufreq</code> changes, deep C state, or migration to a host with a faster TSC. Deep C sleep states can stop the TSC. To prevent the kernel using deep C states append &quot;<code>processor.max_cstate=1</code>&quot; to the kernel boot options in the <code>grub.conf</code> file on the host:

<pre class="screen">term Red Hat Enterprise Linux Server (2.6.18-159.el5)
        root (hd0,0)
    kernel /vmlinuz-2.6.18-159.el5 ro root=/dev/VolGroup00/LogVol00 rhgb quiet processor.max_cstate=1</pre>
Disable <code>cpufreq</code> (only necessary on hosts without the <code>constant_tsc</code>) by editing the <code>/etc/sysconfig/cpuspeed</code> configuration file and change the <code>MIN_SPEED</code> and <code>MAX_SPEED</code> variables to the highest frequency available. Valid limits can be found in the <code>/sys/devices/system/cpu/cpu*/cpufreq/scaling_available_frequencies</code> files.

Using the <code>engine-config</code> tool to receive alerts when hosts drift out of sync.

You can use the <code>engine-config</code> tool to configure alerts when your hosts drift out of sync.

There are two relevant parameters for time drift on hosts: <code>EnableHostTimeDrift</code> and <code>HostTimeDriftInSec</code>. <code>EnableHostTimeDrift</code>, with a default value of false, can be enabled to receive alert notifications of host time drift. The <code>HostTimeDriftInSec</code> parameter is used to set the maximum allowable drift before alerts start being sent.

Alerts are sent once per hour per host.

Using the Paravirtualized Clock with Red Hat Enterprise Linux or CentOS virtual machines

For certain Red Hat Enterprise Linux or CentOS virtual machines, additional kernel parameters are required. These parameters can be set by appending them to the end of the /kernel line in the /boot/grub/grub.conf file of the virtual machine.

<div class="alert alert-info">'''Note:''' The process of configuring kernel parameters can be automated using the <code>ktune</code> package</div>

The <code>ktune</code> package provides an interactive Bourne shell script, <code>fix_clock_drift.sh</code>. When run as the superuser, this script inspects various system parameters to determine if the virtual machine on which it is run is susceptible to clock drift under load. If so, it then creates a new <code>grub.conf.kvm</code> file in the <code>/boot/grub/</code> directory. This file contains a kernel boot line with additional kernel parameters that allow the kernel to account for and prevent significant clock drift on the KVM virtual machine. After running <code>fix_clock_drift.sh</code> as the superuser, and once the script has created the <code>grub.conf.kvm</code> file, then the virtual machine's current <code>grub.conf</code> file should be backed up manually by the system administrator, the new <code>grub.conf.kvm</code> file should be manually inspected to ensure that it is identical to <code>grub.conf</code> with the exception of the additional boot line parameters, the <code>grub.conf.kvm</code> file should finally be renamed <code>grub.conf</code>, and the virtual machine should be rebooted.

The table below lists versions of Red Hat Enterprise Linux and the parameters required for virtual machines on systems without a constant Time Stamp Counter.

{| class="wikitable"
!width="50%"|'''Red Hat Enterprise Linux'''
!width="50%"|'''Additional virtual machine kernel parameters'''
|- style="vertical-align:top;"
|5.4 AMD64/Intel 64 with the paravirtualized clock
|Additional parameters are not required
|- style="vertical-align:top;"
|5.4 AMD64/Intel 64 without the paravirtualized clock
|notsc lpj=n
|- style="vertical-align:top;"
|5.4 x86 with the paravirtualized clock
|Additional parameters are not required
|- style="vertical-align:top;"
|5.4 x86 without the paravirtualized clock
|clocksource=acpi_pm lpj=n
|- style="vertical-align:top;"
|5.3 AMD64/Intel 64
|notsc
|- style="vertical-align:top;"
|5.3 x86
|clocksource=acpi_pm
|- style="vertical-align:top;"
|4.8 AMD64/Intel 64
|notsc
|- style="vertical-align:top;"
|4.8 x86
|clock=pmtmr
|- style="vertical-align:top;"
|3.9 AMD64/Intel 64
|Additional parameters are not required
|- style="vertical-align:top;"
|3.9 x86
|Additional parameters are not required
|}

Using the Real-Time Clock with Windows Virtual Machines

Windows uses the both the Real-Time Clock (RTC) and the Time Stamp Counter (TSC). For Windows virtual machines the Real-Time Clock can be used instead of the TSC for all time sources which resolves virtual machine timing issues.

To enable the Real-Time Clock for the PMTIMER clocksource (the PMTIMER usually uses the TSC) add the following line to the Windows boot settings. Windows boot settings are stored in the boot.ini file. Add the following line to the <code>boot.ini</code> file:

<pre class="screen">/use pmtimer</pre>
For more information on Windows boot settings and the pmtimer option, refer to [http://support.microsoft.com/kb/833721 Available switch options for the Windows XP and the Windows Server 2003 Boot.ini files].

=== Monitoring Virtual Machine Login Activity Using the Sessions Tab ===

Client virtual machines connecting to oVirt will require maintenance and/or updates on occasion. The information contained in the '''Sessions''' tab allows you to monitor virtual machine login activity to avoid performing maintenance tasks on machines in active use.

Use the '''Virtual Machines''' resource tab, tree mode, or the search function to find and select a virtual machine in the results list. Select the '''Sessions''' tab in the details pane to display '''Logged-in User''', '''Console User''', and '''Console Client IP'''.

= ⁠Templates =

== Introduction to Templates ==

A template is a copy of a preconfigured virtual machine, used to simplify the subsequent, repeated creation of similar virtual machines. Templates capture installed software and software configurations, as well as the hardware configuration, of the original virtual machine.

When you create a template from a virtual machine, a read-only copy of the virtual machine's disk is taken. The read-only disk becomes the base disk image of the new template, and of any virtual machines created from the template. As such, the template cannot be deleted whilst virtual machines created from the template exist in the environment.

Virtual machines created from a template use the same NIC type and driver as the original virtual machine, but utilize separate and unique MAC addresses.

<div class="alert alert-info">'''Note:''' A virtual machine may require to be sealed before being used to create a template.</div>

== Template Tasks ==

=== Creating a Template ===

'''Summary'''

Create a template from an existing virtual machine to use as a blueprint for creating additional virtual machines.

'''Procedure 9.1. Creating a Template from an Existing Virtual Machine'''

<ol>
<li>Click the '''Virtual Machines''' tab and select a virtual machine.</li>
<li>Ensure the virtual machine is powered down and has a status of <code>Down</code>.</li>
<li>Click '''Make Template''' to open the '''New Template''' window.<br>
[[Image:New Template.png|300px|The New Template window]]<br>
'''Figure 9.1. The New Template window'''</li>
<li>Enter a '''Name''', '''Description''', and '''Comment''' for the template.</li>
<li>From the '''Cluster''' drop-down menu, select the cluster with which the template will be associated. By default, this will be the same as that of the source virtual machine.</li>
<li>Optionally, select the '''Create as a Sub Template version''' check box, select a '''Root Template''' and enter a '''Sub Version Name''' to create the new template as a sub template of an existing template.</li>
<li>In the '''Disks Allocation''' section, enter an alias for the disk in the '''Alias''' text field and select the storage domain on which the disk will be stored from the '''Target''' drop-down list. By default, these will be the same as those of the source virtual machine.</li>
<li>The '''Allow all users to access this Template''' check box is selected by default. This makes the template public.</li>
<li>The '''Copy VM permissions''' check box is not selected by default. Select this check box to copy the permissions of the source virtual machine to the template.</li>
<li>Click '''OK'''.</li></ol>

'''Result'''

The virtual machine displays a status of <code>Image Locked</code> while the template is being created. The process of creating a template may take up to an hour depending on the size of the virtual machine disk and your storage hardware. When complete, the template is added to the '''Templates''' tab. You can now create new virtual machines based on the template.

<div class="alert alert-info">'''Note:''' When a template is made, the virtual machine is copied so that both the existing virtual machine and its template are usable after template creation.</div>

=== Explanation of Settings and Controls in the New Template Window ===

The following table details the settings for the '''New Template''' window.⁠

'''Table 9.1. New Template and Edit Template Settings'''

{| class="wikitable"
!width="50%"|Field
!width="50%"|Description/Action
|-
|'''Name'''
|The name of the template. This is the name by which the template is listed in the '''Templates''' tab in the Administration Portal and is accessed via the REST API. This text field has a 40-character limit and must be a unique name with any combination of uppercase and lowercase letters, numbers, hyphens, and underscores.
|- style="vertical-align:top;"
|'''Description'''
|A description of the template. This field is recommended but not mandatory.
|- style="vertical-align:top;"
|'''Comment'''
|A field for adding plain text, human-readable comments regarding the template.
|- style="vertical-align:top;"
|'''Cluster'''
|The cluster with which the template will be associated. This is the same as the original virtual machines by default. You can select any cluster in the data center.
|- style="vertical-align:top;"
|'''Create as a Sub Template version'''
|Allows you to specify whether the template will be created as a new version of an existing template. Select this check box to access the settings for configuring this option.
* '''Root Template''': The template under which the sub template will be added.
* '''Sub Version Name''': The name of the template. This is the name by which the template is accessed when creating a new virtual machine based on the template.
|- style="vertical-align:top;"
|'''Disks Allocation'''
|'''Alias''' - An alias for the virtual machine disk used by the template. By default, the alias is set to the same value as that of the source virtual machine.
'''Virtual Size''' - The current actual size of the virtual disk used by the template. This value cannot be edited, and is provided for reference only.
'''Target''' - The storage domain on which the virtual disk used by the template will be stored. By default, the storage domain is set to the same value as that of the source virtual machine. You can select any storage domain in the cluster.
|- style="vertical-align:top;"
|'''Allow all users to access this Template'''
|Allows you to specify whether a template is public or private. A public template can be accessed by all users, whereas a private template can only be accessed by users with the '''TemplateAdmin''' or '''SuperUser''' roles.
|- style="vertical-align:top;"
|'''Copy VM permissions'''
|Allows you to copy explicit permissions that have been set on the source virtual machine to the template.
|}

=== Editing a Template ===

'''Summary'''

Once a template has been created, its properties can be edited. Because a template is a copy of a virtual machine, the options available when editing a template are identical to those in the '''Edit Virtual Machine''' window.

⁠

'''Procedure 9.2. Editing a Template'''

# Use the '''Templates''' resource tab, tree mode, or the search function to find and select the template in the results list.
# Click '''Edit''' to open the '''Edit Template''' window.
# Change the necessary properties and click '''OK'''.

'''Result'''

The properties of the template are updated. The '''Edit Template''' window will not close if a property field is invalid.

=== Deleting a Template ===

'''Summary'''

Delete a template from your oVirt environment.

<div class="alert alert-info">'''Warning:''' If you have used a template to create a virtual machine, make sure that you do not delete the template as the virtual machine needs it to continue running.</div>

⁠

'''Procedure 9.3. Deleting a Template'''

# Use the resource tabs, tree mode, or the search function to find and select the template in the results list.
# Click '''Remove''' to open the '''Remove Template(s)''' window.
# Click '''OK''' to remove the template.

'''Result'''

You have removed the template.

=== Exporting Templates ===

==== Migrating Templates to the Export Domain ====

'''Summary'''

Export templates into the export domain to move them to another data domain, either in the same oVirt environment, or another one.

⁠

'''Procedure 9.4. Exporting Individual Templates to the Export Domain'''

<ol>
<li>Use the '''Templates''' resource tab, tree mode, or the search function to find and select the template in the results list.</li>
<li>Click '''Export''' to open the '''Export Template''' window.<br>
<div class="alert alert-info">'''Note:''' Select the '''Force Override''' check box to replace any earlier version of the template on the export domain.</div></li>
<li>Click '''OK''' to begin exporting the template; this may take up to an hour, depending on the virtual machine disk image size and your storage hardware.</li>
<li>Repeat these steps until the export domain contains all the templates to migrate before you start the import process.
Use the '''Storage''' resource tab, tree mode, or the search function to find and select the export domain in the results list and click the '''Template Import''' tab in the details pane to view all exported templates in the export domain.</li></ol>

'''Result'''

The templates have been exported to the export domain.

==== Copying a Template's Virtual Hard Disk ====

'''Summary'''

If you are moving a virtual machine that was created from a template with the thin provisioning storage allocation option selected, the template's disks must be copied to the same storage domain as that of the virtual machine disk.

⁠

'''Procedure 9.5. Copying a Virtual Hard Disk'''

# Select the '''Disks''' tab.
# Select the template disk or disks to copy.
# Click the '''Copy''' button to display the '''Copy Disk''' window.
# Use the drop-down menu or menus to select the '''Target''' data domain.

'''Result'''

A copy of the template's virtual hard disk has been created, either on the same, or a different, storage domain. If you were copying a template disk in preparation for moving a virtual hard disk, you can now move the virtual hard disk.

=== Importing Templates ===

==== Importing a Template into a Data Center ====

'''Summary'''

Import templates from a newly attached export domain.

⁠

'''Procedure 9.6. Importing a Template into a Data Center'''

<ol>
<li>Use the resource tabs, tree mode, or the search function to find and select the newly attached export domain in the results list.</li>
<li>Select the '''Template Import''' tab of the details pane to display the templates that migrated across with the export domain.</li>
<li>Select a template and click '''Import''' to open the '''Import Template(s)''' window.</li>
<li>Select the templates to import.</li>
<li>Use the drop-down menus to select the '''Destination Cluster''' and '''Storage''' domain. Alter the '''Suffix''' if applicable.
Alternatively, clear the '''Clone All Templates''' check box.</li>
<li>Click '''OK''' to import templates and open a notification window. Click '''Close''' to close the notification window.</li></ol>

'''Result'''

The template is imported into the destination data center. This can take up to an hour, depending on your storage hardware. You can view the import progress in the '''Events''' tab.

Once the importing process is complete, the templates will be visible in the '''Templates''' resource tab. The templates can create new virtual machines, or run existing imported virtual machines based on that template.

==== Importing a Virtual Disk Image from an OpenStack Image Service as a Template ====

'''Summary'''

Virtual disk images managed by an OpenStack Image Service can be imported into oVirt if that OpenStack Image Service has been added to oVirt as an external provider.

<ol>
<li>Click the '''Storage''' resource tab and select the OpenStack Image Service domain from the results list.</li>
<li>Select the image to import in the '''Images''' tab of the details pane.</li>
<li><p>Click '''Import''' to open the '''Import Image(s)''' window.</p>
<p>⁠</p>
<p>[[Image:images/5008.png|The Import Image(s) Window]]</p>
<p>'''Figure 9.2. The Import Image(s) Window'''</p></li>
<li>From the '''Data Center''' drop-down menu, select the data center into which the virtual disk image will be imported.</li>
<li>From the '''Domain Name''' drop-down menu, select the storage domain in which the virtual disk image will be stored.</li>
<li>Optionally, select a quota from the '''Quota''' drop-down menu to apply a quota to the virtual disk image.</li>
<li>Select the '''Import as Template''' check box.</li>
<li>From the '''Cluster''' drop-down menu, select the cluster in which the virtual disk image will be made available as a template.</li>
<li>Click '''OK''' to import the virtual disk image.</li></ol>

'''Result'''

The image is imported as a template and is displayed in the results list of the '''Templates''' resource tab. You can now create virtual machines based on the template.

== Sealing Virtual Machines in Preparation for Deployment as Templates ==

=== Sealing a Linux Virtual Machine for Deployment as a Template ===

==== Sealing a Linux Virtual Machine for Deployment as a Template ====

There are two main methods for sealing a Linux virtual machine in preparation for using that virtual machine to create a template: manually, or using the <code>sys-unconfig</code> command. Sealing a Linux virtual machine manually requires you to create a file on the virtual machine that acts as a flag for initiating various configuration tasks the next time you start that virtual machine. The <code>sys-unconfig</code> command allows you to automate this process. However, both of these methods also require you to manually delete files on the virtual machine that are specific to that virtual machine or might cause conflicts amongst virtual machines created based on the template you will create based on that virtual machine. As such, both are valid methods for sealing a Linux virtual machine and will achieve the same result.

==== Sealing a Linux Virtual Machine Manually for Deployment as a Template ====

'''Summary'''

You must generalize (seal) a Linux virtual machine before creating a template based on that virtual machine.

⁠'''Procedure 9.7. Sealing a Linux Virtual Machine'''

<ol>
<li>Log in to the virtual machine.</li>
<li>Flag the system for re-configuration by running the following command as root:<br>
<pre class="screen"># touch /.unconfigured</pre></li>
<li>Run the following command to remove ssh host keys:<br>
<pre class="screen"># rm -rf /etc/ssh/ssh_host_*</pre></li>
<li>Set <code>HOSTNAME=localhost.localdomain</code> in <code>/etc/sysconfig/network</code></li>
<li>Run the following command to remove <code>/etc/udev/rules.d/70-*</code>:<br>
<pre class="screen"># rm -rf /etc/udev/rules.d/70-*</pre></li>
<li>Remove the <code>HWADDR</code> line and <code>UUID</code> line from <code>/etc/sysconfig/network-scripts/ifcfg-eth*</code>.</li>
<li>Optionally, delete all the logs from <code>/var/log</code> and build logs from <code>/root</code>.</li>
<li>Run the following command to shut down the virtual machine:<br>
<pre class="screen"># poweroff</pre></li></ol>

'''Result'''

The virtual machine is sealed and can be made into a template. You can deploy Linux virtual machines from this template without experiencing configuration file conflicts.

==== Sealing a Linux Virtual Machine for Deployment as a Template using sys-unconfig ====

'''Summary'''

You must generalize (seal) a Linux virtual machine before creating a template based on that virtual machine.

'''Procedure 9.8. Sealing a Linux Virtual Machine using sys-unconfig'''

<ol>
<li>Log in to the virtual machine.</li>
<li>Run the following command to remove ssh host keys:<br>
<pre class="screen"># rm -rf /etc/ssh/ssh_host_*</pre></li>
<li>Set <code>HOSTNAME=localhost.localdomain</code> in <code>/etc/sysconfig/network</code>.</li>
<li>Remove the <code>HWADDR</code> line and <code>UUID</code> line from <code>/etc/sysconfig/network-scripts/ifcfg-eth*</code>.</li>
<li>Optionally, delete all the logs from <code>/var/log</code> and build logs from <code>/root</code>.</li>
<li>Run the following command:<br>
<pre class="screen"># sys-unconfig</pre></li></ol>

'''Result'''

The virtual machine shuts down; it is now sealed and can be made into a template. You can deploy Linux virtual machines from this template without experiencing configuration file conflicts.

=== Sealing a Windows Virtual Machine for Deployment as a Template ===

==== Considerations when Sealing a Windows Template with Sysprep ====

A template created for Windows virtual machines must be generalized (sealed) before being used to deploy virtual machines. This ensures that machine-specific settings are not reproduced in the template.

The '''Sysprep''' tool is used to seal Windows templates before use.

<div class="alert alert-info">'''Important:''' Do not reboot the virtual machine during this process.</div>

Before starting the <code>Sysprep</code> process, verify the following settings are configured:

<ul>
<li>The Windows '''Sysprep''' parameters have been correctly defined.
If not, click '''Edit''' and enter the required information in the '''Operating System''' and '''Domain''' fields.</li>
<li>The correct product key has been entered in the <code>engine-config</code> configuration tool. If not, run the configuration tool on oVirt as the root user, and enter the required information. The configuration keys that you need to set are <code>ProductKey</code> and <code>SysPrepPath</code>. For example, the Windows 7 configuration value is <code>ProductKeyWindow7</code> and <code>SysPrepWindows7Path</code>. Set these values with this command:<br>
<pre class="screen"># engine-config --set ProductKeyWindow7=&lt;validproductkey&gt; --cver=general</pre></li></ul>

==== Sealing a Windows XP Template ====

'''Summary'''

Seal a Windows XP template using the '''Sysprep''' tool before using the template to deploy virtual machines.

<div class="alert alert-info">'''Note:''' You can also use the procedure above to seal a Windows 2003 template. The Windows 2003 '''Sysprep''' tool is available at [http://www.microsoft.com/download/en/details.aspx?id=14830 http://www.microsoft.com/download/en/details.aspx?id=14830].</div>

⁠

'''Procedure 9.9. Sealing a Windows XP Template'''

<ol>
<li>Download <code>sysprep</code> to the virtual machine to be used as a template.
The Windows XP '''Sysprep''' tool is available at [http://www.microsoft.com/download/en/details.aspx?id=11282 http://www.microsoft.com/download/en/details.aspx?id=11282]</li>
<li>Create a new directory: <code>c:\sysprep</code>.</li>
<li>Open the <code>deploy.cab</code> file and add its contents to <code>c:\sysprep</code>.</li>
<li>Execute <code>sysprep.exe</code> from within the folder and click '''OK''' on the welcome message to display the Sysprep tool.</li>
<li>Select the following check boxes:
<ul>
<li>'''Don't reset grace period for activation'''</li>
<li>'''Use Mini-Setup'''</li></ul>
</li>
<li>Ensure that the shutdown mode is set to <code>Shut down</code> and click '''Reseal'''.</li>
<li>Acknowledge the pop-up window to complete the sealing process; the virtual machine shuts down automatically upon completion.</li></ol>

'''Result'''

The Windows XP template is sealed and ready for deploying virtual machines.

==== Sealing a Windows 7 or Windows 2008 Template ====

'''Summary'''

Seal a Windows 7 or Windows 2008 template before using the template to deploy virtual machines.

⁠

'''Procedure 9.10. Sealing a Windows 7 or Windows 2008 Template'''

<ol>
<li>In the virtual machine to be used as a template, open a command line terminal and type <code>regedit</code>.</li>
<li>The '''Registry Editor''' window opens. On the left pane, expand '''HKEY_LOCAL_MACHINE''' → '''SYSTEM''' → '''SETUP'''.</li>
<li>On the main window, right-click to add a new string value using '''New''' → '''String Value'''.</li>
<li>Right-click on the file and select '''Modify''' to open the '''Edit String''' window.</li>
<li>Enter the following information in the provided fields:
<ul>
<li>Value name: <code>UnattendFile</code></li>
<li>Value data: <code>a:\sysprep.inf</code></li></ul>
</li>
<li>Launch '''Sysprep''' from <code>C:\Windows\System32\sysprep\sysprep.exe</code>.</li>
<li>Enter the following information into the '''Sysprep''' tool:
<ul>
<li>Under '''System Cleanup Action''', select '''Enter System Out-of-Box-Experience (OOBE)'''.</li>
<li>Select the '''Generalize''' check box if you need to change the computer's system identification number (SID).</li>
<li>Under '''Shutdown Options''', select '''Shutdown'''.</li></ul>

Click '''OK''' to complete the sealing process; the virtual machine shuts down automatically upon completion.</li></ol>

'''Result'''

The Windows 7 or Windows 2008 template is sealed and ready for deploying virtual machines.

=== Using Cloud-Init to Automate the Configuration of Virtual Machines ===

==== Cloud-Init Overview ====

Cloud-Init is a tool for automating the initial setup of virtual machines such as configuring the host name, network interfaces, and authorized keys. It can be used when provisioning virtual machines that have been deployed based on a template to avoid conflicts on the network.

To use this tool, the cloud-init package must first be installed on the virtual machine. Once installed, the Cloud-Init service starts during the boot process to search for instructions on what to configure. You can then use options in the '''Run Once''' window to provide these instructions one time only, or options in the '''New Virtual Machine''', '''Edit Virtual Machine''' and '''Edit Template''' windows to provide these instructions every time the virtual machine starts.

==== Cloud-Init Use Case Scenarios ====

Cloud-Init can be used to automate the configuration of virtual machines in a variety of scenarios. Several common scenarios are as follows:

; Virtual Machines Created Based on Templates
: You can use the Cloud-Init options in the '''Initial Run''' section of the '''Run Once''' window to initialize a virtual machine that was created based on a template. This allows you to customize the virtual machine the first time that virtual machine is started.
; Virtual Machine Templates
: You can use the '''Use Cloud-Init/Sysprep''' options in the '''Initial Run''' tab of the '''New Template''' and '''Edit Template''' windows to specify options for customizing virtual machines created based on that template.
; Virtual Machine Pools
: You can use the '''Use Cloud-Init/Sysprep''' options in the '''Initial Run''' tab of the '''New Pool''' window to specify options for customizing virtual machines taken from that virtual machine pool. This allows you to specify a set of standard settings that will be applied every time a virtual machine is taken from that virtual machine pool. You can inherit or override the options specified for the template on which the virtual machine is based, or specify options for the virtual machine pool itself.

==== Installing Cloud-Init ====

'''Summary'''

Install Cloud-Init on a Red Hat or CentOS virtual machine.

'''Procedure 9.11. Installing Cloud-Init'''

<ol>
<li>Log on to the virtual machine.</li>
<li>Install the cloud-init package and dependencies:<br>
<pre class="screen"># yum install cloud-init</pre></li></ol>

'''Result'''

You have installed the cloud-init package and dependencies.

==== Using Cloud-Init to Initialize a Virtual Machine ====

'''Summary'''

Use Cloud-Init to automate the initial configuration of a Linux virtual machine that has been provisioned based on a template.

⁠

'''Procedure 9.12. Using Cloud-Init to Initialize a Virtual Machine'''

# Click the '''Virtual Machines''' tab and select a virtual machine.
# Click '''Run Once''' to open the '''Run Virtual Machine(s)''' window.
# Expand the '''Initial Run''' section and select the '''Cloud-Init''' check box.
# Enter a host name in the '''VM Hostname''' text field.
# Select the '''Configure Time Zone''' check box and select a time zone from the '''Time Zone''' drop-down menu.
# Select the '''Use already configured password''' check box to use the existing credentials, or clear that check box and enter a root password in the '''Root Password''' and '''Verify Root Password''' text fields to specify a new root password.
# Enter any SSH keys to be added to the authorized hosts file on the virtual machine in the '''SSH Authorized Keys''' text area.
# Select the '''Regenerate SSH Keys''' check box to regenerate SSH keys for the virtual machine.
# Enter any DNS servers in the '''DNS Servers''' text field.
# Enter any DNS search domains in the '''DNS Search Domains''' text field.
# Select the '''Network''' check box and use the '''+''' and '''-''' buttons to add or remove network interfaces to or from the virtual machine.
# Enter any custom scripts in the '''Custom Script''' text area.
# Click '''OK'''.

<div class="alert alert-info">'''Important:''' Cloud-Init is only supported on cluster compatibility version 3.3 and higher.</div>

'''Result'''

The virtual machine boots and the specified settings are applied.

==== Using Cloud-Init to Prepare a Template ====

'''Summary'''

Use Cloud-Init to specify a set of standard settings to be included in a template.

<div class="alert alert-info">'''Note:''' While the following procedure outlines how to use Cloud-Init when preparing a template, the same settings are also available in the '''New Virtual Machine''' and '''Edit Template''' windows.</div>

⁠

'''Procedure 9.13. Using Cloud-Init to Prepare a Template'''

# Click the '''Virtual Machines''' tab and select a virtual machine.
# Click '''Edit''' to open the '''Edit Virtual Machine''' window.
# Click the '''Initial Run''' tab and select the '''Use Cloud-Init/Sysprep''' check box.
# Enter a host name in the '''VM Hostname''' text field.
# Select the '''Configure Time Zone''' check box and select a time zone from the '''Time Zone''' drop-down menu.
# Expand the '''Authentication''' section and select the '''Use already configured password''' check box to user the existing credentials, or clear that check box and enter a root password in the '''Root Password''' and '''Verify Root Password''' text fields to specify a new root password.
# Enter any SSH keys to be added to the authorized hosts file on the virtual machine in the '''SSH Authorized Keys''' text area.
# Select the '''Regenerate SSH Keys''' check box to regenerate SSH keys for the virtual machine.
# Expand the '''Networks''' section and enter any DNS servers in the '''DNS Servers''' text field.
# Enter any DNS search domains in the '''DNS Search Domains''' text field.
# Select the '''Network''' check box and use the '''+''' and '''-''' buttons to add or remove network interfaces to or from the virtual machine.
# Expand the '''Custom Script''' section and enter any custom scripts in the '''Custom Script''' text area.
# Click '''Ok'''.

<div class="alert alert-info">'''Important:''' Cloud-Init is only supported on cluster compatibility version 3.3 and higher.</div>

'''Result'''

The virtual machine boots and the specified settings are applied.

= ⁠Pools =

== Introduction to Virtual Machine Pools ==

A virtual machine pool is a group of virtual machines that are all clones of the same template and that can be used on demand by any user in a given group. Virtual machine pools allow administrators to rapidly configure a set of generalized virtual machines for users.

Users access a virtual machine pool by taking a virtual machine from the pool. When a user takes a virtual machine from a pool, they are provided with any one of the virtual machines in the pool if any are available. That virtual machine will have the same operating system and configuration as that of the template on which the pool was based, but users may not receive the same member of the pool each time they take a virtual machine. Users can also take multiple virtual machines from the same virtual machine pool depending on the configuration of that pool.

Virtual machines in a virtual machine pool are stateless, meaning that data is not persistent across reboots. However, if a user configures console options for a virtual machine taken from a virtual machine pool, those options will be set as the default for that user for that virtual machine pool.

In principle, virtual machines in a pool are started when taken by a user, and shut down when the user is finished. However, virtual machine pools can also contain pre-started virtual machines. Pre-started virtual machines are kept in an up state, and remain idle until they are taken by a user. This allows users to start using such virtual machines immediately, but these virtual machines will consume system resources even while not in use due to being idle.

<div class="alert alert-info">'''Note:''' Virtual machines taken from a pool are not stateless when accessed from the Administration Portal. This is because administrators need to be able to write changes to the disk if necessary.</div>

== Virtual Machine Pool Tasks ==

=== Creating a Virtual Machine Pool ===

'''Summary'''

You can create a virtual machine pool that contains multiple virtual machines that have been created based on a common template.

'''Procedure 10.1. Creating a Virtual Machine Pool'''

# Click the '''Pools''' tab.
# Click the '''New''' button to open the '''New Pool''' window.
#* Use the drop down-list to select the '''Cluster''' or use the selected default.
#* Use the '''Based on Template''' drop-down menu to select a template or use the selected default. If you have selected a template, optionally use the '''Template Sub Version''' drop-down menu to select a version of that template. A template provides standard settings for all the virtual machines in the pool.
#* Use the '''Operating System''' drop-down list to select an '''Operating System''' or use the default provided by the template.
#* Use the '''Optimized for''' drop-down list to optimize virtual machines for either '''Desktop''' use or '''Server''' use.
# Enter a '''Name''' and '''Description''', any '''Comments''' and the '''Number of VMs''' for the pool.
# Select the '''Maximum number of VMs per user''' that a single user is allowed to run in a session. The minimum is one.
# Optionally, click the '''Show Advanced Options''' button and perform the following steps:
## Select the '''Console''' tab. At the bottom of the tab window, select the '''Override SPICE Proxy''' check box to enable the '''Overridden SPICE proxy address''' text field and specify the address of a SPICE proxy to override the global SPICE proxy, if any.
## Click the '''Pool''' tab and select a '''Pool Type''':
##* '''Manual''' - The administrator is responsible for explicitly returning the virtual machine to the pool. The virtual machine reverts to the original base image after the administrator returns it to the pool.
##* '''Automatic''' - When the virtual machine is shut down, it automatically reverts to its base image and is returned to the virtual machine pool.
# Click '''OK'''.

'''Result'''

You have created and configured a virtual machine pool with the specified number of identical virtual machines. You can view these virtual machines in the '''Virtual Machines''' resource tab, or in the details pane of the '''Pools''' resource tab; a virtual machine in a pool is distinguished from independent virtual machines by its icon.

=== Explanation of Settings and Controls in the New Pool Window ===

==== New Pool General Settings Explained ====

The following table details the information required on the '''General''' tab of the '''New Pool''' window that is specific to virtual machine pools. All other settings are identical to those in the '''New Virtual Machine''' window.

'''Table 10.1. General settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''Number of VMs'''
|Allows you to specify the number of virtual machines in the virtual machine pool that will be created and made available to the virtual machine pool when that virtual machine pools is created. By default, the maximum number of virtual machines you can create in a pool is 1000. This value can be configured using the <code>MaxVmsInPool</code> key of the <code>engine-config</code> command.
|- style="vertical-align:top;"
|'''Maximum number of VMs per user'''
|Allows you to specify the maximum number of virtual machines a single user can take from the virtual machine pool at any one time. The value of this field must be between <code>1</code> and <code>32,767</code>.
|}

==== New Pool Pool Settings Explained ====

The following table details the information required on the '''Pool''' tab of the '''New Pool''' window.

⁠'''Table 10.2. Console settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''Pool Type'''
|This drop-down menu allows you to specify the type of the virtual machine pool. The following options are available:
* '''Automatic''': After a user finishes using a virtual machine taken from a virtual machine pool, that virtual machine is automatically returned to the virtual machine pool.
* '''Manual''': After a user finishes using a virtual machine taken from a virtual machine pool, that virtual machine is only returned to the virtual machine pool when an administrator manually returns the virtual machine.
|}

==== New Pool and Edit Pool Console Settings Explained ====

The following table details the information required on the '''Console''' tab of the '''New Pool''' or '''Edit Pool''' window that is specific to virtual machine pools. All other settings are identical to those in the '''New Virtual Machine''' and '''Edit Virtual Machine''' windows.


'''Table 10.3. Console settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''Override SPICE proxy'''
|Select this check box to enable overriding the SPICE proxy defined in global configuration. This feature is useful in a case where the user (who is, for example, connecting via the User Portal) is outside of the network where the hypervisors reside.
|- style="vertical-align:top;"
|'''Overridden SPICE proxy address'''
|The proxy by which the SPICE client will connect to virtual machines. This proxy overrides both the global SPICE proxy defined for the oVirt environment and the SPICE proxy defined for the cluster to which the virtual machine pool belongs, if any. The address must be in the following format:
<pre class="screen">protocol://[host]:[port]</pre>
|}

=== Editing a Virtual Machine Pool ===

'''Summary'''

After a virtual machine pool has been created, its properties can be edited. The properties available when editing a virtual machine pool are identical to those available when creating a new virtual machine pool except that the '''Number of VMs''' property is replaced by '''Increase number of VMs in pool by'''.

⁠

'''Procedure 10.2. Editing a Virtual Machine Pool'''

# Use the '''Pools''' resource tab, tree mode, or the search function to find and select the virtual machine pool in the results list.
# Click '''Edit''' to open the '''Edit Pool''' window.
# Edit the properties of the virtual machine pool.
# Click '''Ok'''.

'''Result'''

The properties of an existing virtual machine pool have been edited.

=== Explanation of Settings and Controls in the Edit Pool Window ===

==== Edit Pool General Settings Explained ====

The following table details the information required on the '''General''' tab of the '''Edit Pool''' window that is specific to virtual machine pools. All other settings are identical to those in the '''Edit Virtual Machine''' window.

'''Table 10.4. General settings'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''Prestarted VMs'''
|Allows you to specify the number of virtual machines in the virtual machine pool that will be started before they are taken and kept in that state to be taken by users. The value of this field must be between <code>0</code> and the total number of virtual machines in the virtual machine pool.
|- style="vertical-align:top;"
|'''Increase number of VMs in pool by'''
|Allows you to increase the number of virtual machines in the virtual machine pool by the specified number.
|- style="vertical-align:top;"
|'''Maximum number of VMs per user'''
|Allows you to specify the maximum number of virtual machines a single user can take from the virtual machine at any one time. The value of this field must be between <code>1</code> and <code>32,767</code>.
|}

=== Prestarting Virtual Machines in a Pool ===

The virtual machines in a virtual machine pool are powered down by default. When a user requests a virtual machine from a pool, a machine is powered up and assigned to the user. In contrast, a prestarted virtual machine is already running and waiting to be assigned to a user, decreasing the amount of time a user has to wait before being able to access a machine. When a prestarted virtual machine is shut down it is returned to the pool and restored to its original state. The maximum number of prestarted virtual machines is the number of virtual machines in the pool.

'''Summary'''

Prestarted virtual machines are suitable for environments in which users require immediate access to virtual machines which are not specifically assigned to them. Only automatic pools can have prestarted virtual machines.

⁠

'''Procedure 10.3. Prestarting Virtual Machines in a Pool'''

# Use the '''Pools''' resource tab, tree mode, or the search function to find and select the virtual machine pool in the results list.
# Click '''Edit''' to open the '''Edit Pool''' window.
# Enter the number of virtual machines to be prestarted in the '''Prestarted VMs''' field.
# Select the '''Pool''' tab. Ensure '''Pool Type''' is set to '''Automatic'''.
# Click '''OK'''.

'''Result'''

You have set a number of prestarted virtual machines in a pool. The prestarted machines are running and available for use.

=== Adding Virtual Machines to a Virtual Machine Pool ===

'''Summary'''

If you require more virtual machines than originally provisioned in a virtual machine pool, add more machines to the pool.

⁠

'''Procedure 10.4. Adding Virtual Machines to a Virtual Machine Pool'''

# Use the '''Pools''' resource tab, tree mode, or the search function to find and select the virtual machine pool in the results list.
# Click '''Edit''' to open the '''Edit Pool''' window.
# Enter the number of additional virtual machines to add in the '''Increase number of VMs in pool by''' field.
# Click '''OK'''.

'''Result'''

You have added more virtual machines to the virtual machine pool.

=== Detaching Virtual Machines from a Virtual Machine Pool ===

'''Summary'''

You can detach virtual machines from a virtual machine pool. Detaching a virtual machine removes it from the pool to become an independent virtual machine.

⁠

'''Procedure 10.5. Detaching Virtual Machines from a Virtual Machine Pool'''

<ol>
<li>Use the '''Pools''' resource tab, tree mode, or the search function to find and select the virtual machine pool in the results list.</li>
<li>Ensure the virtual machine has a status of <code>Down</code> because you cannot detach a running virtual machine.
Click the '''Virtual Machines''' tab in the details pane to list the virtual machines in the pool.</li>
<li>Select one or more virtual machines and click '''Detach''' to open the '''Detach Virtual Machine(s)''' confirmation window.</li>
<li>Click '''OK''' to detach the virtual machine from the pool.</li></ol>

<div class="alert alert-info">'''Note:''' The virtual machine still exists in the environment and can be viewed and accessed from the '''Virtual Machines''' resource tab. Note that the icon changes to denote that the detached virtual machine is an independent virtual machine.</div>

'''Result'''

You have detached a virtual machine from the virtual machine pool.

=== Removing a Virtual Machine Pool ===

'''Summary'''

You can remove a virtual machine pool from a data center. You must first either delete or detach all of the virtual machines in the pool. Detaching virtual machines from the pool will preserve them as independent virtual machines.

⁠

'''Procedure 10.6. Removing a Virtual Machine Pool'''

# Use the '''Pools''' resource tab, tree mode, or the search function to find and select the virtual machine pool in the results list.
# Click '''Remove''' to open the '''Remove Pool(s)''' confirmation window.
# Click '''OK''' to remove the pool.

'''Result'''

You have removed the pool from the data center.

== Trusted Compute Pools ==

=== Creating a Trusted Cluster ===

<div class="alert alert-info">'''Note:''' If no OpenAttestation server is properly configured, this procedure will fail.</div>

'''Summary'''

This procedure explains how to set up a trusted computing pool. Trusted computing pools permit the deployment of virtual machines on trusted hosts. With the addition of attestation, administrators can ensure that verified measurement of software is running in the hosts. This provides the foundation of the secure enterprise stack.

⁠

'''Procedure 10.7. Creating a Trusted Cluster'''

# In the navigation pane, select the '''Clusters''' tab.
# Click the '''New''' button.
# In the '''General''' tab, set the cluster name.
# In the '''General''' tab, select the '''Enable Virt Service''' radio button.
# In the '''Cluster Policy''' tab, select '''Enable Trusted Service''' check box.
# Click '''OK'''.

'''Result'''

You have built a trusted computing pool.

=== Adding a Trusted Host ===

'''Summary'''

This procedure explains how to add a trusted host to your oVirt environment.

⁠

'''Procedure 10.8. '''

<ol>
<li>Select the '''Hosts''' tab.</li>
<li>Click the '''New''' button.</li>
<li>In the '''General''' tab, set the host's name.</li>
<li><p>In the '''General''' tab, set the host's address.</p>
<p>'''Note'''</p>
<p>The host designated here must be trusted by the attestation server.</p></li>
<li>In the '''General''' tab, in the '''Host Cluster''' drop-down menu, select a trusted cluster.</li>
<li>Click '''OK'''.</li></ol>

'''Result'''

You have added a trusted host to your oVirt environment.

= ⁠Virtual Machine Disks =

== Understanding Virtual Machine Storage ==

oVirt supports three storage types: NFS, iSCSI and FCP.

In each type, a host known as the Storage Pool Manager (SPM) manages access between hosts and storage. The SPM host is the only node that has full access within the storage pool; the SPM can modify the storage domain metadata, and the pool's metadata. All other hosts can only access virtual machine hard disk image data.

By default in an NFS, local, or POSIX compliant data center, the SPM creates the virtual disk using a thin provisioned format as a file in a file system.

In iSCSI and other block-based data centers, the SPM creates a volume group on top of the Logical Unit Numbers (LUNs) provided, and makes logical volumes to use as virtual machine disks. Virtual machine disks on block-based storage are preallocated by default.

If the virtual disk is preallocated, a logical volume of the specified size in GB is created. The virtual machine can be mounted on a Red Hat Enterprise Linux server using <code>kpartx</code>, <code>vgscan</code>, <code>vgchange</code> and <code>mount</code> to investigate the virtual machine's processes or problems.

If the virtual disk is a thin provisioned, a 1 GB logical volume is created. The logical volume is continuously monitored by the host on which the virtual machine is running. As soon as the usage nears a threshold the host notifies the SPM, and the SPM extends the logical volume by 1 GB. The host is responsible for resuming the virtual machine after the logical volume has been extended. If the virtual machine goes into a paused state it means that the SPM could not extend the disk in time. This occurs if the SPM is too busy or if there is not enough storage space.

A virtual disk with a preallocated (RAW) format has significantly faster write speeds than a virtual disk with a thin provisioning (Qcow2) format. Thin provisioning takes significantly less time to create a virtual disk. The thin provision format is suitable for non-IO intensive virtual machines.

oVirt 3.3 and above introduced online virtual drive resizing.

== Understanding Virtual Disks ==

Virtual disks are of two types, '''Thin Provisioned''' or '''Preallocated'''. Preallocated disks are RAW formatted. Thin provisioned disks are QCOW2 formatted.

<ul>
<li>Preallocated
A preallocated virtual disk has reserved storage of the same size as the virtual disk itself. The backing storage device (file/block device) is presented as is to the virtual machine with no additional layering in between. This results in better performance because no storage allocation is required during runtime.
On SAN (iSCSI, FCP) this is achieved by creating a block device with the same size as the virtual disk. On NFS this is achieved by filling the backing hard disk image file with zeros. Preallocating storage on an NFS storage domain presumes that the backing storage is not QCOW2 formatted and zeros will not be deduplicated in the hard disk image file. (If these assumptions are incorrect, do not select Preallocated for NFS virtual disks).</li>
<li>Thin Provisioned
For sparse virtual disks backing storage is not reserved and is allocated as needed during runtime. This allows for storage overcommitment under the assumption that most disks are not fully utilized and that storage capacity can be utilized better. This requires the backing storage to monitor write requests and can cause some performance issues. On NFS backing storage is achieved by using files. On SAN this is achieved by creating a block device smaller than the virtual disk's defined size and communicating with the hypervisor to monitor necessary allocations. This does not require support from the underlying storage devices.</li></ul>

The possible combinations of storage types and formats are described in the following table.

'''Table 11.1. Permitted Storage Combinations'''

{| class="wikitable"
!width="25%"|Storage
!width="25%"|Format
!width="25%"|Type
!width="25%"|Note
|- style="vertical-align:top;"
!NFS or iSCSI/FCP
!RAW or Qcow2
!Sparse or Preallocated
!
|- style="vertical-align:top;"
|NFS
|RAW
|Preallocated
|A file with an initial size which equals the amount of storage defined for the virtual disk, and has no formatting.
|- style="vertical-align:top;"
|NFS
|RAW
|Sparse
|A file with an initial size which is close to zero, and has no formatting.
|- style="vertical-align:top;"
|NFS
|Qcow2
|Sparse
|A file with an initial size which is close to zero, and has RAW formatting. Subsequent layers will be Qcow2 formatted.
|- style="vertical-align:top;"
|SAN
|RAW
|Preallocated
|A block device with an initial size which equals the amount of storage defined for the virtual disk, and has no formatting.
|- style="vertical-align:top;"
|SAN
|Qcow2
|Preallocated
|A block device with an initial size which equals the amount of storage defined for the virtual disk, and has Qcow2 formatting.
|- style="vertical-align:top;"
|SAN
|Qcow2
|Sparse
|A block device with an initial size which is much smaller than the size defined for the VDisk (currently 1GB), and has Qcow2 formatting for which space is allocated as needed (currently in 1GB increments).
|}

== Shareable Disks in oVirt ==

Some applications require storage to be shared between servers. oVirt allows you to mark virtual machine hard disks as '''shareable''' and attach those disks to virtual machines. That way a single virtual disk can be used by multiple cluster-aware guests.

Shared disks are not to be used in every situation. For applications like clustered database servers, and other highly available services, shared disks are appropriate. Attaching a shared disk to multiple guests that are not cluster-aware is likely to cause data corruption because their reads and writes to the disk are not coordinated.

You cannot take a snapshot of a shared disk. Virtual disks that have snapshots taken of them cannot later be marked shareable.

You can mark a disk shareable either when you create it, or by editing the disk later.

== Read Only Disks in oVirt ==

Some applications require administrators to share data with read-only rights. oVirt allows you to mark virtual machine hard disks as '''Read Only''' and attach those disks to virtual machines. If a disk is marked '''shareable''', you can add it to some virtual machines as read-only and to others as rewritable. That way, a single disk can be read by multiple cluster-aware guests, while an administrator maintains writing privileges.

Floating disks are always rewritable and cannot be marked read-only.

A disk cannot be switched from or to read-only while active.

You can mark a disk read-only either when you create it, or by editing the disk later.

== Virtual Disk Tasks ==

=== Creating Floating Virtual Disks ===

'''Summary'''

You can create a virtual disk that does not belong to any virtual machines. You can then attach this disk to a single virtual machine, or to multiple virtual machines if the disk is shareable.

'''Procedure 11.1. Creating Floating Virtual Disks'''

<ol>
<li>Select the '''Disks''' resource tab.</li>
<li>Click '''Add''' to open the '''Add Virtual Disk''' window.<br>
[[Image:Add_Virtual_Disk.png|350px|Add Virtual Disk Window]]<br>
'''Figure 11.1. Add Virtual Disk Window'''</li>
<li>Use the radio buttons to specify whether the virtual disk will be an '''Internal''' or '''External (Direct Lun)''' disk.</li>
<li>Enter the '''Size(GB)''', '''Alias''', and '''Description''' of the virtual disk.</li>
<li>Use the drop-down menus to select the '''Interface''', '''Allocation Policy''', '''Data Center''', and '''Storage Domain''' of the virtual disk.</li>
<li>Select the '''Wipe After Delete''', '''Is Bootable''' and '''Is Shareable''' check boxes to enable each of these options.</li>
<li>Click '''OK'''.</li></ol>

'''Result'''

You have created a virtual disk that can be attached to one or more virtual machines depending on its settings.

=== Explanation of Settings in the New Virtual Disk Window ===

'''Table 11.2. Add Virtual Disk Settings: Internal'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''Size(GB)'''
|The size of the new virtual disk in GB.
|- style="vertical-align:top;"
|'''Alias'''
|The name of the virtual disk, limited to 40 characters.
|- style="vertical-align:top;"
|'''Description'''
|A description of the virtual disk. This field is recommended but not mandatory.
|- style="vertical-align:top;"
|'''Interface'''
|The virtual interface the disk presents to virtual machines. '''VirtIO''' is faster, but requires drivers. Red Hat Enterprise Linux 5 and higher include these drivers. Windows does not include these drivers, but they can be installed from the guest tools ISO or virtual floppy disk. IDE devices do not require special drivers.
|- style="vertical-align:top;"
|'''Allocation Policy'''
|The provisioning policy for the new virtual disk. '''Preallocated''' allocates the entire size of the disk on the storage domain at the time the virtual disk is created. '''Thin Provision''' allocates 1 GB at the time the virtual disk is created and sets a maximum limit on the size to which the disk can grow. Preallocated virtual disks take more time to create than thinly provisioned virtual disks, but have better read and write performance. Preallocated virtual disks are recommended for servers. Thinly provisioned disks are faster to create than preallocated disks and allow for storage over-commitment. Thinly provisioned virtual disks are recommended for desktops.
|- style="vertical-align:top;"
|'''Data Center'''
|The data center in which the virtual disk will be available.
|- style="vertical-align:top;"
|'''Storage Domain'''
|The storage domain in which the virtual disk will be stored. The drop-down list shows all storage domains available in the given cluster, and also shows the total space and currently available space in the storage domain.
|- style="vertical-align:top;"
|'''Wipe after delete'''
|Allows you to enable enhanced security for deletion of sensitive material when the virtual disk is deleted.
|- style="vertical-align:top;"
|'''Is bootable'''
|Allows you to enable the bootable flag on the virtual disk.
|- style="vertical-align:top;"
|'''Is Shareable'''
|Allows you to attach the virtual disk to more than one virtual machine at a time.
|- style="vertical-align:top;"
|'''Read Only'''
|Allows you to set the disk as read-only. The same disk can be attached as read-only to one virtual machine, and as rewritable to another.
|}

The '''External (Direct Lun)''' settings can be displayed in either '''Targets &gt; LUNs''' or '''LUNs &gt; Targets'''. '''Targets &gt; LUNs''' sorts available LUNs according to the host on which they are discovered, whereas '''LUNs &gt; Targets''' displays a single list of LUNs.

'''Table 11.3. Add Virtual Disk Settings: External (Direct Lun)'''

{| class="wikitable"
!width="50%"|Field Name
!width="50%"|Description
|- style="vertical-align:top;"
|'''Alias'''
|The name of the virtual disk, limited to 40 characters.
|- style="vertical-align:top;"
|'''Description'''
|A description of the virtual disk. This field is recommended but not mandatory.
|- style="vertical-align:top;"
|'''Interface'''
|The virtual interface the disk presents to virtual machines. '''VirtIO''' is faster, but requires drivers. Red Hat Enterprise Linux 5 and higher include these drivers. Windows does not include these drivers, but they can be installed from the guest tools ISO or virtual floppy disk. IDE devices do not require special drivers.
|- style="vertical-align:top;"
|'''Data Center'''
|The data center in which the virtual disk will be available.
|- style="vertical-align:top;"
|'''Use Host'''
|The host on which the LUN will be mounted. You can select any host in the data center.
|- style="vertical-align:top;"
|'''Storage Type'''
|The type of external LUN to add. You can select from either '''iSCSI''' or '''Fibre Channel'''.
|- style="vertical-align:top;"
|'''Discover Targets'''
|This section can be expanded when you are using iSCSI external LUNs and '''Targets &gt; LUNs''' is selected.
'''Address''' - The host name or IP address of the target server.
'''Port''' - The port by which to attempt a connection to the target server. The default port is 3260.
'''User Authentication''' - The iSCSI server requires User Authentication. The '''User Authentication''' field is visible when you are using iSCSI external LUNs.
'''CHAP user name''' - The user name of a user with permission to log in to LUNs. This field is accessible when the '''User Authentication''' check box is selected.
'''CHAP password''' - The password of a user with permission to log in to LUNs. This field is accessible when the '''User Authentication''' check box is selected.
|- style="vertical-align:top;"
|'''Is bootable'''
|Allows you to enable the bootable flag on the virtual disk.
|- style="vertical-align:top;"
|'''Is Shareable'''
|Allows you to attach the virtual disk to more than one virtual machine at a time.
|- style="vertical-align:top;"
|'''Read Only'''
|Allows you to set the disk as read-only. The same disk can be attached as read-only to one virtual machine, and as rewritable to another.
|}

Fill in the fields in the '''Discover Targets''' section and click the '''Discover''' button to discover the target server. You can then click the '''Login All''' button to list the available LUNs on the target server and, using the radio buttons next to each LUN, select the LUN to add.

Using LUNs directly as virtual machine hard disk images removes a layer of abstraction between your virtual machines and their data.

The following considerations must be made when using a direct LUN as a virtual machine hard disk image:

* Live storage migration of direct LUN hard disk images is not supported.
* Direct LUN disks are not included in virtual machine exports.
* Direct LUN disks are not included in virtual machine snapshots.

=== Moving a Virtual Disk ===

'''Summary'''

You can move a virtual disk that is attached to a virtual machine or acts as a floating virtual disk from one storage domain to another

<div class="alert alert-info">'''Note:''' If the virtual disk is attached to a virtual machine that was created based on a template and used the thin provisioning storage allocation option, the disks for the template on which the virtual machine was based must be copied to the same storage domain as the virtual disk.</div>

⁠

'''Procedure 11.2. Moving a Virtual Disk'''

# Select the '''Disks''' tab.
# Select the virtual disks to move.
# Click the '''Move''' button to open the '''Move Disk(s)''' window.
# Use the '''Target''' drop-down menus to select the storage domain to which the virtual disk will be moved.
# Click '''OK'''.

'''Result'''

The virtual disks are moved to the target storage domain, and have a status of <code>Locked</code> while being moved.

=== Copying a Virtual Disk ===

'''Summary'''

You can copy a virtual disk attached to a template from one storage domain to another.

⁠

'''Procedure 11.3. Copying a Virtual Disk'''

# Select the '''Disks''' tab.
# Select the virtual disks to copy.
# Click the '''Copy''' button to open the '''Copy Disk(s)''' window.
# Use the '''Target''' drop-down menus to select the storage domain to which the virtual disk will be copied.
# Click '''OK'''.

'''Result'''

The virtual disks are copied to the target storage domain, and have a status of <code>Locked</code> while being copied.


= ⁠Backups =

== Backing Up and Restoring oVirt ==

=== Backing up oVirt - Overview ===

While taking complete backups of the machine on which oVirt is installed is recommended whenever changing the configuration of that machine, a utility is provided for backing up only the key files related to oVirt. This utility - the <code>engine-backup</code> command - can be used to rapidly back up the engine database and configuration files into a single file that can be easily stored.

=== Syntax for the engine-backup Command ===

The <code>engine-backup</code> command works in one of two basic modes:

<pre class="screen"># engine-backup --mode=backup</pre>
<pre class="screen"># engine-backup --mode=restore</pre>
These two modes are further extended by a set of parameters that allow you to specify the scope of the backup and different credentials for the engine database. A full list of parameters and their function is as follows:

'''Basic Options'''

; ''<code>--mode</code>''
: Specifies whether the command will perform a backup operation or a restore operation. Two options are available - <code>backup</code>, and <code>restore</code>. This is a required parameter.
; ''<code>--file</code>''
: Specifies the path and name of a file into which backups are to be taken in backup mode, and the path and name of a file from which to read backup data in restore mode. This is a required parameter in both backup mode and restore mode.
; ''<code>--log</code>''
: Specifies the path and name of a file into which logs of the backup or restore operation are to be written. This parameter is required in both backup mode and restore mode.
; ''<code>--scope</code>''
: Specifies the scope of the backup or restore operation. There are two options - <code>all</code>, which backs up both the engine database and configuration data, and <code>db</code>, which backs up only the engine database.

'''Database Options'''

The following options are only available when using the <code>engine-backup</code> command in <code>restore</code> mode.

; ''<code>--change-db-credentials</code>''
: Allows you to specify alternate credentials for restoring the engine database using credentials other than those stored in the backup itself. Specifying this parameter allows you to add the following parameters.
; ''<code>--db-host</code>''
: Specifies the IP address or fully qualified domain name of the host on which the database resides. This is a required parameter.
; ''<code>--db-port</code>''
: Specifies the port by which a connection to the database will be made.
; ''<code>--db-user</code>''
: Specifies the name of the user by which a connection to the database will be made. This is a required parameter.
; ''<code>--db-passfile</code>''
: Specifies a file containing the password by which a connection to the database will be made. Either this parameter or the ''<code>--db-password</code>'' parameter must be specified.
; ''<code>--db-password</code>''
: Specifies the plain text password by which a connection to the database will be made. Either this parameter or the ''<code>--db-passfile</code>'' parameter must be specified.
; ''<code>--db-name</code>''
: Specifies the name of the database to which the database will be restored. This is a required parameter.
; ''<code>--db-secured</code>''
: Specifies that the connection with the database is to be secured.
; ''<code>--db-secured-validation</code>''
: Specifies that the connection with the host is to be validated.

'''Help'''

; ''<code>--help</code>''
: Provides an overview of the available modes, parameters, sample usage, how to create a new database and configure the firewall in conjunction with backing up and restoring oVirt.

=== Creating a Backup with the engine-backup Command ===

'''Summary'''

The process for creating a backup of the engine database and the configuration data for oVirt using the <code>engine-backup</code> command is straightforward and can be performed while oVirt is active.

'''Procedure 12.1. Backing up oVirt'''

<ol>
<li>Log on to the machine running oVirt.</li>
<li>Run the following command to create a full backup:<br>
'''Example 12.1. Creating a Full Backup'''<br>
<pre class="screen"># engine-backup --scope=all --mode=backup --log=[file name] --file=[file name]</pre><br>
Alternatively, run the following command to back up only the engine database:<br>
'''Example 12.2. Creating an engine database Backup'''<br>
<pre class="screen"># engine-backup --scope=db --mode=backup --log=[file name] --file=[file name]</pre></li></ol>

'''Result'''

A <code>tar</code> file containing a backup of the engine database, or the engine database and the configuration data for oVirt, is created using the path and file name provided.

=== Restoring a Backup with the engine-backup Command ===

While the process for restoring a backup using the <code>engine-backup</code> command is straightforward, it involves several additional steps in comparison to that for creating a backup depending on the destination to which the backup is to be restored. For example, the <code>engine-backup</code> command can be used to restore backups to fresh installations of oVirt, on top of existing installations of oVirt, and using local or remote databases.

<div class="alert alert-info">'''Important:''' Backups can only be restored to environments of the same major release as that of the backup. For example, a backup of an oVirt version 3.3 environment can only be restored to another oVirt version 3.3 environment. To view the version of oVirt contained in a backup file, unpack the backup file and read the value in the <code>version</code> file located in the root directory of the unpacked files.</div>

=== Restoring a Backup to a Fresh Installation ===

'''Summary'''

The <code>engine-backup</code> command can be used to restore a backup to a fresh installation of oVirt. The following procedure must be performed on a machine on which the base operating system has been installed and the required packages for oVirt have been installed, but the <code>engine-setup</code> command has not yet been run. This procedure assumes that the backup file can be accessed from the machine on which the backup is to be restored.

<div class="alert alert-info">'''Note:''' The <code>engine-backup</code> command does not handle the actual creation of the engine database or the initial configuration of the <code>postgresql</code> service. Therefore, these tasks must be performed manually as outlined below when restoring a backup to a fresh installation.</div>

'''Procedure 12.2. Restoring a Backup to a Fresh Installation'''

<ol>
<li>Log on to the machine on which oVirt is installed.</li>
<li>Manually create an empty database to which the database in the backup can be restored and configure the <code>postgresql</code> service:
<ol>
<li>Run the following commands to initialize the <code>postgresql</code> database, start the <code>postgresql</code> service and ensure this service starts on boot:<br>
<pre class="screen"># service postgresql initdb
# service postgresql start
# chkconfig postgresql on</pre></li>
<li>Run the following commands to enter the postgresql command line:<br>
<pre class="screen"># su postgres
$ psql</pre></li>
<li>Run the following command to create a new user:<br>
<pre class="screen">postgres=# create role [user name] with login encrypted password '[password]';</pre></li>
<li>Run the following command to create the new database:<br>
<pre class="screen">postgres=# create database [database name] owner [user name] template template0 encoding 'UTF8' lc_collate 'en_US.UTF-8' lc_ctype 'en_US.UTF-8';</pre></li>
<li>Edit the <code>/var/lib/pgsql/data/pg_hba.conf</code> file as follows:
<ul>
<li>For local databases, replace the existing directives in the section starting with <code>Local</code> at the bottom of the file with the following directives:<br>
<pre class="screen">host    [database name]    [user name]    0.0.0.0/0  md5
host    [database name]    [user name]    ::0/0      md5</pre></li>
<li>For remote databases, add the following line immediately underneath the line starting with <code>Local</code> at the bottom of the file, replacing ''X.X.X.X'' with the IP address of oVirt:<br>
<pre class="screen">host    [database name]    [user name]    X.X.X.X/32   md5</pre></li></ul>
</li>
<li>Run the following command to restart the <code>postgresql</code> service:<br>
<pre class="screen"># service postgresql restart</pre></li></ol>
</li>
<li>Restore the backup using the <code>engine-backup</code> command with the ''<code>--change-db-credentials</code>'' parameter to pass the credentials of the new database:<br>
<pre class="screen"># engine-backup --mode=restore --file=[file name] --log=[file name] --change-db-credentials --db-host=[database location] --db-name=[database name] --db-user=[user name] --db-password=[password]</pre><br>
If successful, the following output displays:<br>
<pre class="screen">You should now run engine-setup.
Done.</pre></li>
<li>Run the following command and follow the prompts to configure oVirt:<br>
<pre class="screen"># engine-setup</pre></li></ol>

'''Result'''

The engine database and configuration files for oVirt have been restored to the version in the backup.

=== Restoring a Backup to Overwrite an Existing Installation ===

'''Summary'''

The <code>engine-backup</code> command can restore a backup to a machine on which oVirt has already been installed and set up. This is useful when you have taken a backup up of an installation, performed changes on that installation and then want to restore the installation from the backup.

<div class="alert alert-info">'''Note:''' When restoring a backup to overwrite an existing installation, you must run the <code>engine-cleanup</code> command to clean up the existing installation before using the <code>engine-backup</code> command. Because the <code>engine-backup</code> command only cleans the engine database, and does not drop the database or delete the user that owns that database, you do not need to create a new database or specify the database credentials because the user and database already exist.</div>


'''Procedure 12.3. Restoring a Backup to Overwrite an Existing Installation'''

<ol>
<li>Log on to the machine on which oVirt is installed.</li>
<li>Run the following command and follow the prompts to remove the configuration files for and clean the database associated with oVirt:<br>
<pre class="screen"># engine-cleanup</pre></li>
<li>Restore the backup using the <code>engine-backup</code> command:<br>
<pre class="screen"># engine-backup --mode=restore --file=[file name] --log=[file name]</pre><br>
If successful, the following output displays:<br>
<pre class="screen">You should now run engine-setup.
Done.</pre></li>
<li>Run the following command and follow the prompts to re-configure the firewall and ensure the <code>ovirt-engine</code> service is correctly configured:<br>
<pre class="screen"># engine-setup</pre></li></ol>

'''Result'''

The engine database and configuration files for oVirt have been restored to the version in the backup.

=== Restoring a Backup with Different Credentials ===

'''Summary'''

The <code>engine-backup</code> command can restore a backup to a machine on which oVirt has already been installed and set up, but the credentials of the database in the backup are different to those of the database on the machine on which the backup is to be restored. This is useful when you have taken a backup of an installation and want to restore the installation from the backup to a different system.

<div class="alert alert-info">'''Important:''' When restoring a backup to overwrite an existing installation, you must run the <code>engine-cleanup</code> command to clean up the existing installation before using the <code>engine-backup</code> command. Because the <code>engine-backup</code> command only cleans the engine database, and does not drop the database or delete the user that owns that database, you do not need to create a new database or specify the database credentials because the user and database already exist. However, if the credentials for the owner of the engine database are not known, you must change them before you can restore the backup.</div>

'''Procedure 12.4. Restoring a Backup with Different Credentials'''

<ol>
<li>Log on to the machine on which oVirt is installed.</li>
<li>Run the following command and follow the prompts to remove the configuration files for and clean the database associated with oVirt:<br>
<pre class="screen"># engine-cleanup</pre></li>
<li>Change the password for the owner of the engine database if the credentials of that user are not known:
<ol>
<li>Run the following commands to enter the postgresql command line:<br>
<pre class="screen"># su postgres
$ psql</pre></li>
<li>Run the following command to change the password of the user that owns the engine database:<br>
<pre class="screen">postgres=# alter role [user name] encrypted password '[new password]';</pre></li></ol>
</li>
<li>Restore the backup using the <code>engine-backup</code> command with the ''<code>--change-db-credentials</code>'' parameter:<br>
<pre class="screen"># engine-backup --mode=restore --file=[file name] --log=[file name] --change-db-credentials --db-host=[database location] --db-name=[database name] --db-user=[user name] --db-password=[password]</pre><br>
If successful, the following output displays:<br>
<pre class="screen">You should now run engine-setup.
Done.</pre></li>
<li>Run the following command and follow the prompts to re-configure the firewall and ensure the <code>ovirt-engine</code> service is correctly configured:<br>
<pre class="screen"># engine-setup</pre></li></ol>

'''Result'''

The engine database and configuration files for oVirt have been restored to the version in the backup using the supplied credentials, and oVirt has been configured to use the new database.

== Manually Backing Up and Restoring oVirt ==

=== Backing Up the Engine Database Using the backup.sh Script ===

'''Summary'''

oVirt includes a script to automate database backups. Using this script on your Manager server, you can protect yourself against potential data loss.

'''Procedure 12.5. Backing up the engine database using the backup.sh script'''

<ol>
<li>Change into the <code>/usr/share/ovirt-engine/dbscripts/</code> directory.</li>
<li>Invoke <code>backup.sh</code> with the ''<code>-h</code>'' parameter to see the available options.<br>
<pre class="screen">Usage: backup.sh [-h] [-s SERVERNAME] [-p PORT] [-d DATABASE] [-l DIR] -u USERNAME [-v] 

    -s SERVERNAME - The database servername for the database (def. localhost)
    -p PORT       - The database port for the database       (def. 5432)
    -d DATABASE   - The database name                        (def. engine)
    -u USERNAME   - The username for the database.
    -v            - Turn on verbosity (WARNING: lots of output)
    -l DIR        - Backup file directory. 
    -h            - This help text.

for more options please run pg_dump --help</pre></li>
<li>Invoke the <code>backup.sh</code> command again with parameters appropriate for your environment. If you are backing up the local <code>engine</code> database, the ''<code>-s, -p,</code>'' and ''<code>-d</code>'' parameters are not necessary. Use the ''<code>-l</code>'' to specify the backup directory. This will cause a <code>.sql</code> file to be created in the directory you give.</li>
<li>Copy the <code>.sql</code> you just created from the directory you specified to a safe remote location.</li></ol>

'''Result'''

You have used the backup.sh script to backup your <code>engine</code> database.

=== Backing Up Manager Configuration Files ===

oVirt stores customized configurations as configuration files. These configuration files contain specific configuration details regarding a given environment, and must be backed up.

'''Table 12.1. Files and directories that must be backed up'''

{| class="wikitable"
!width="67%"|Location
!width="33%"|Overview
|- style="vertical-align:top;"
|/etc/ovirt-engine/
|A directory containing oVirt configuration files such as <code>engine-config.conf</code>.
|- style="vertical-align:top;"
|/etc/yum/pluginconf.d/versionlock.list
|A file containing version information about currently installed oVirt components.
|- style="vertical-align:top;"
|/etc/pki/ovirt-engine/
|Security certificates provided by oVirt to clients.
|- style="vertical-align:top;"
|/usr/share/jasperreports-server-pro/buildomatic/
|A directory containing files required to build the oVirt reports server.
|- style="vertical-align:top;"
|/var/lib/ovirt-engine/backups/
|A directory containing backup files.
|- style="vertical-align:top;"
|/var/tmp/ovirt-engine/deployments/
|A directory containing information on deployments.
|- style="vertical-align:top;"
|/usr/share/ovirt-engine-reports/
|A directory containing configuration files related to reports. In particular, this directory contains sub-directories in which the credentials of the reports user are stored in a plain text, human-readable format.
|- style="vertical-align:top;"
|/root/.rnd
|A random seed file used to generate secure certificates.
|- style="vertical-align:top;"
|/var/log/ovirt-engine/setup/
|A directory containing logs that contain the answers you gave to the setup configuration questions. You must use these files when restoring oVirt because they supply the same information that was used to initially configure oVirt.
|}

When you have backed up all the above files and directories, you can recover oVirt to a working state after an unforeseen event.

=== Restoring the Engine Database Using the restore.sh Script ===

'''Summary'''

oVirt includes a script to automate database restoration. Using this script on your Manager server, you can recover from database corruption.

'''Procedure 12.6. Restoring the Engine Database Using the restore.sh Script'''

<ol>
<li>Change into the <code>/usr/share/ovirt-engine/dbscripts/</code> directory.</li>
<li>Invoke <code>restore.sh</code> with the ''<code>-h</code>'' parameter to see the available options.<br>
<pre class="screen">Usage: restore.sh [-h] [-s SERVERNAME] [-p PORT] -u USERNAME -d DATABASE -f FILE [-r] 

    -s SERVERNAME - The database servername for the database (def. localhost)
    -p PORT       - The database port for the database       (def. 5432)
    -u USERNAME   - The username for the database.
    -d DATABASE   - The database name
    -f File       - Backup file name to restore from. 
    -r            - Remove existing database with same name
    -h            - This help text.

for more options please run pg_restore --help</pre></li>
<li>Invoke the <code>restore.sh</code> command again with parameters appropriate for your environment. If you are restoring the local <code>engine</code> database, the ''<code>-s</code>'' and ''<code>-p</code>'' parameters are not necessary. Use the ''<code>-d</code>'' to specify name of the database you are creating. oVirt expects a primary database named <code>engine</code>. Use the ''<code>-f</code>'' to specify the <code>.sql</code> file you are restoring from.</li></ol>

'''Result'''

You have used the restore.sh script to restore your <code>engine</code> database.

=== Restoring oVirt Configuration Files ===

'''Summary'''

Restore a backed up copy of configuration files to oVirt.

'''Procedure 12.7. Restoring oVirt Configuration Files'''

<ol>
<li><p>Stop the engine service:</p>
<pre class="screen"># service ovirt-engine stop</pre></li>
<li>Completely remove all previous installations of oVirt:<br>
<pre class="screen"># yum remove ovirt-engine</pre></li>
<li>Remove <code>/etc/pki/ovirt-engine</code>:<br>
<pre class="screen"># rm -rf /etc/pki/ovirt-engine</pre></li>
<li>Remove the main <code>ovirt-engine</code> directory:<br>
<pre class="screen"># rm -rf /etc/ovirt-engine</pre></li>
<li>Install oVirt:<br>
<pre class="screen"># yum install -y ovirt-engine</pre></li>
<li>Run <code>engine-setup</code>, giving the same answers as when you originally installed <code>ovirt-engine</code>:<br>
<pre class="screen"># engine-setup</pre><br>
Your answers can be found in <code>/var/log/engine-setup-SETUP-DATE.log</code>, which you backed up.</li>
<li>Stop the engine service, which was restarted as a part of the previous command:<br>
<pre class="screen"># service ovirt-engine stop</pre></li>
<li>Restore the backed up configuration files to their original locations.</li>
<li>Make sure the ownership of the <code>.truststore</code> file is correct:<br>
<pre class="screen"># chown ovirt:ovirt /etc/pki/ovirt-engine/.truststore</pre></li>
<li>Make sure the permissions of the <code>ovirt-engine-notifier.conf</code> file is correct:<br>
<pre class="screen"># chmod 640 /usr/share/ovirt-engine/services/ovirt-engine-notifier/ovirt-engine-notifier.conf</pre></li>
<li>Start the engine service:<br>
<pre class="screen"># service ovirt-engine start</pre></li></ol>

'''Result'''

You have restored a backed up copy of configuration files to oVirt.

= ⁠Users and Roles =

== Introduction to Users ==

oVirt uses external directory services for user authentication and information. All user accounts must be created in external directory servers; these users are called ''directory users''. The exception is the <code>admin</code> user which resides in the <code>internal</code> domain created during installation.

After a directory server is attached to oVirt, the users in the directory can be added to the Administration Portal, making them ''oVirt users''. oVirt users can be assigned different roles and permissions according to the tasks they have to perform.

There are two types of oVirt users - end users who use and manage virtual resources from the User Portal, and administrators who maintain the system infrastructure using the Administration Portal. <code>User</code> roles and <code>admin</code> roles can be assigned to oVirt users for individual resources like virtual machines and hosts, or on a hierarchy of objects like clusters and data centers.

== Directory Users ==

=== Directory Services Support in oVirt ===

During installation oVirt creates its own internal administration user, <code>admin</code>. This account is intended for use when initially configuring the environment, and for troubleshooting. To add other users to oVirt you must attach a directory server to oVirt using the Domain Management Tool, <code>engine-manage-domains</code>.

Once at least one directory server has been attached to oVirt, you can add users that exist in the directory server and assign roles to them using the Administration Portal. Users can be identified by their User Principal Name (UPN) of the form <code>user@domain</code>. Attachment of more than one directory server to oVirt is also supported.

The directory servers supported for use with oVirt 3.4 are:

* Active Directory
* Identity Management (IdM)
* Red Hat Directory Server 9 (RHDS 9)
* OpenLDAP

You must ensure that the correct DNS records exist for your directory server. In particular you must ensure that the DNS records for the directory server include:

* A valid pointer record (PTR) for the directory server's reverse look-up address.
* A valid service record (SRV) for LDAP over TCP port <code>389</code>.
* A valid service record (SRV) for Kerberos over TCP port <code>88</code>.
* A valid service record (SRV) for Kerberos over UDP port <code>88</code>.

If these records do not exist in DNS then you cannot add the domain to oVirt configuration using <code>engine-manage-domains</code>.

For more detailed information on installing and configuring a supported directory server, see the vendor's documentation:

* Active Directory - [http://technet.microsoft.com/en-us/windowsserver/dd448614 http://technet.microsoft.com/en-us/windowsserver/dd448614].
* Identity Management (IdM) - [http://docs.redhat.com/docs/en-US/Red_Hat_Enterprise_Linux/6/html/Identity_Management_Guide/index.html http://docs.redhat.com/docs/en-US/Red_Hat_Enterprise_Linux/6/html/Identity_Management_Guide/index.html]
* Red Hat Directory Server (RHDS) - [http://docs.redhat.com/docs/en-US/Red_Hat_Directory_Server/index.html http://docs.redhat.com/docs/en-US/Red_Hat_Directory_Server/index.html]
* OpenLDAP - [http://www.openldap.org/doc/ http://www.openldap.org/doc/]

<div class="alert alert-info">'''Important:''' A user must be created in the directory server specifically for use as the oVirt administrative user. Do ''not'' use the administrative user for the directory server as the oVirt administrative user.</div>

<div class="alert alert-info">'''Important:''' It is not possible to install oVirt (rhevm) and IdM (ipa-server) on the same system. IdM is incompatible with the mod_ssl package, which is required by oVirt.</div>

<div class="alert alert-info">'''Important:''' If you are using Active Directory as your directory server, and you want to use <code>sysprep</code> in the creation of Templates and Virtual Machines, then the oVirt administrative user must be delegated control over the Domain to:

* '''Join a computer to the domain'''
* '''Modify the membership of a group'''

For information on creation of user accounts in Active Directory, see [http://technet.microsoft.com/en-us/library/cc732336.aspx http://technet.microsoft.com/en-us/library/cc732336.aspx].

For information on delegation of control in Active Directory, see [http://technet.microsoft.com/en-us/library/cc732524.aspx http://technet.microsoft.com/en-us/library/cc732524.aspx].</div>

<div class="alert alert-info">'''Note:''' oVirt uses Kerberos to authenticate with directory servers. RHDS does not provide native support for Kerberos. If you are using RHDS as your directory server then you must ensure that the directory server is made a service within a valid Kerberos domain. To do this you must perform these steps while referring to the relevant directory server documentation:

<ul>
<li>Configure the <code>memberOf</code> plug-in for RHDS to allow group membership. In particular ensure that the value of the ''<code>memberofgroupattr</code>'' attribute of the <code>memberOf</code> plug-in is set to <code>uniqueMember</code>. In '''OpenLDAP''', the <code>memberOf</code> functionality is not called a &quot;plugin&quot;. It is called an &quot;overlay&quot; and requires no configuration after installation.
Consult the Red Hat Directory Server 9.0 ''Plug-in Guide'' for more information on configuring the <code>memberOf</code> plug-in.</li>
<li>Define the directory server as a service of the form <code>ldap/hostname@REALMNAME</code> in the Kerberos realm. Replace ''hostname'' with the fully qualified domain name associated with the directory server and ''REALMNAME'' with the fully qualified Kerberos realm name. The Kerberos realm name must be specified in capital letters.</li>
<li>Generate a <code>keytab</code> file for the directory server in the Kerberos realm. The <code>keytab</code> file contains pairs of Kerberos principals and their associated encrypted keys. These keys allow the directory server to authenticate itself with the Kerberos realm.
Consult the documentation for your Kerberos principle for more information on generating a <code>keytab</code> file.</li>
<li>Install the <code>keytab</code> file on the directory server. Then configure RHDS to recognize the <code>keytab</code> file and accept Kerberos authentication using GSSAPI.
Consult the Red Hat Directory Server 9.0 ''Administration Guide'' for more information on configuring RHDS to use an external <code>keytab</code> file.</li>
<li>Test the configuration on the directory server by using the <code>kinit</code> command to authenticate as a user defined in the Kerberos realm. Once authenticated run the <code>ldapsearch</code> command against the directory server. Use the ''<code>-Y GSSAPI</code>'' parameters to ensure the use of Kerberos for authentication.</li></ul></div>

== User Authorization ==

=== User Authorization Model ===

oVirt applies authorization controls based on the combination of the three components:

* The user performing the action
* The type of action being performed
* The object on which the action is being performed

=== User Actions ===

For an action to be successfully performed, the <code>user</code> must have the appropriate <code>permission</code> for the <code>object</code> being acted upon. Each type of action corresponds to a <code>permission</code>. There are many different permissions in the system, so for simplicity:

[[Image:Actions.png|400px|Actions]]

'''Figure 13.1. Actions'''

<div class="alert alert-info">'''Important:''' Some actions are performed on more than one object. For example, copying a template to another storage domain will impact both the template and the destination storage domain. The user performing an action must have appropriate permissions for all objects the action impacts.</div>

=== User Permissions ===

Permissions enable users to perform actions on objects, where objects are either individual objects or container objects.

[[Image:Permissions roles.png|400px|Permissions &amp; Roles]]

'''Figure 13.2. Permissions &amp; Roles'''

Any permissions that apply to a container object also apply to all members of that container. The following diagram depicts the hierarchy of objects in the system.

[[Image:Object heirarchy.png|400px|oVirt Object Hierarchy]]

'''Figure 13.3. oVirt Object Hierarchy'''

== oVirt User Properties and Roles ==

=== User Properties ===

Roles and permissions are the properties of the user. Roles are predefined sets of privileges that permit access to different levels of physical and virtual resources. Multilevel administration provides a finely grained hierarchy of permissions. For example, a data center administrator has permissions to manage all objects in the data center, while a host administrator has system administrator permissions to a single physical host. A user can have permissions to use a single virtual machine but not make any changes to the virtual machine configurations, while another user can be assigned system permissions to a virtual machine.

=== User and Administrator Roles ===

oVirt provides a range of pre-configured roles, from an administrator with system-wide permissions to an end user with access to a single virtual machine. While you cannot change or remove the default roles, you can clone and customize them, or create new roles according to your requirements. There are two types of roles:

* Administrator Role: Allows access to the ''Administration Portal'' for managing physical and virtual resources. An administrator role does not confer any permissions for the User Portal.
* User Role: Allows access to the ''User Portal'' for managing and accessing virtual machines and templates. A user role does not confer any permissions for the Administration Portal.

For example, if you have an <code>administrator</code> role on a cluster, you can manage all virtual machines in the cluster using the ''Administration Portal''. However, you cannot access any of these virtual machines in the ''User Portal''; this requires a <code>user</code> role.

=== User Roles Explained ===

The table below describes basic user roles which confer permissions to access and configure virtual machines in the User Portal.

⁠

'''Table 13.1. oVirt User Roles - Basic'''

{| class="wikitable"
!width="33%"|Role
!width="33%"|Privileges
!width="33%"|Notes
|- style="vertical-align:top;"
|UserRole
|Can access and use virtual machines and pools.
|Can log in to the User Portal, use assigned virtual machines and pools, view virtual machine state and details.
|- style="vertical-align:top;"
|PowerUserRole
|Can create and manage virtual machines and templates.
|Apply this role to a user for the whole environment with the '''Configure''' window, or for specific data centers or clusters. For example, if a PowerUserRole is applied on a data center level, the PowerUser can create virtual machines and templates in the data center.
|- style="vertical-align:top;"
|UserVmManager
|System administrator of a virtual machine.
|Can manage virtual machines, create and use snapshots, and migrate virtual machines. A user who creates a virtual machine in the User Portal is automatically assigned the UserVmManager role on the machine.
|}

<div class="alert alert-info">'''Note:''' In oVirt 3.0, the '''PowerUserRole''' only granted permissions for virtual machines which are directly assigned to the PowerUser, or virtual machines created by the PowerUser. Now, the '''VmCreator''' role provides privileges previously conferred by the '''PowerUserRole'''. The '''PowerUserRole''' can now be applied on a system-wide level, or on specific data centers or clusters, and grants permissions to all virtual machines and templates within the system or specific resource. Having a '''PowerUserRole''' is equivalent to having the '''VmCreator''', '''DiskCreator''', and '''TemplateCreator''' roles.</div>

The table below describes advanced user roles which allow you to do more fine tuning of permissions for resources in the User Portal.

'''Table 13.2. oVirt User Roles - Advanced'''

{| class="wikitable"
!width="33%"|Role
!width="33%"|Privileges
!width="33%"|Notes
|- style="vertical-align:top;"
|UserTemplateBasedVm
|Limited privileges to only use Templates.
|Can use templates to create virtual machines.
|- style="vertical-align:top;"
|DiskOperator
|Virtual disk user.
|Can use, view and edit virtual disks. Inherits permissions to use the virtual machine to which the virtual disk is attached.
|- style="vertical-align:top;"
|VmCreator
|Can create virtual machines in the User Portal.
|This role is not applied to a specific virtual machine; apply this role to a user for the whole environment with the '''Configure''' window. Alternatively apply this role for specific data centers or clusters. When applying this role to a cluster, you must also apply the DiskCreator role on an entire data center, or on specific storage domains.
|- style="vertical-align:top;"
|TemplateCreator
|Can create, edit, manage and remove virtual machine templates within assigned resources.
|This role is not applied to a specific template; apply this role to a user for the whole environment with the '''Configure''' window. Alternatively apply this role for specific data centers, clusters, or storage domains.
|- style="vertical-align:top;"
|DiskCreator
|Can create, edit, manage and remove virtual machine disks within assigned clusters or data centers.
|This role is not applied to a specific virtual disk; apply this role to a user for the whole environment with the '''Configure''' window. Alternatively apply this role for specific data centers or storage domains.
|- style="vertical-align:top;"
|TemplateOwner
|Can edit and delete the template, assign and manage user permissions for the template.
|This role is automatically assigned to the user who creates a template. Other users who do not have '''TemplateOwner''' permissions on a template cannot view or use the template.
|- style="vertical-align:top;"
|NetworkUser
|Logical network and network interface user for virtual machine and template.
|Can attach or detach network interfaces from specific logical networks.
|}

=== Administrator Roles Explained ===

The table below describes basic administrator roles which confer permissions to access and configure resources in the Administration Portal.

'''Table 13.3. oVirt System Administrator Roles - Basic'''

{| class="wikitable"
!width="33%"|Role
!width="33%"|Privileges
!width="33%"|Notes
|- style="vertical-align:top;"
|SuperUser
|System Administrator of the oVirt environment.
|Has full permissions across all objects and levels, can manage all objects across all data centers.
|- style="vertical-align:top;"
|ClusterAdmin
|Cluster Administrator.
|Possesses administrative permissions for all objects underneath a specific cluster.
|- style="vertical-align:top;"
|DataCenterAdmin
|Data Center Administrator.
|Possesses administrative permissions for all objects underneath a specific data center except for storage.
|}

<div class="alert alert-info">'''Important:''' Do not use the administrative user for the directory server as the oVirt administrative user. Create a user in the directory server specifically for use as the oVirt administrative user.</div>

The table below describes advanced administrator roles which allow you to do more fine tuning of permissions for resources in the Administration Portal.

'''Table 13.4. oVirt System Administrator Roles - Advanced'''

{| class="wikitable"
!width="33%"|Role
!width="33%"|Privileges
!width="33%"|Notes
|- style="vertical-align:top;"
|TemplateAdmin
|Administrator of a virtual machine template.
|Can create, delete, and configure the storage domains and network details of templates, and move templates between domains.
|- style="vertical-align:top;"
|StorageAdmin
|Storage Administrator.
|Can create, delete, configure, and manage an assigned storage domain.
|- style="vertical-align:top;"
|HostAdmin
|Host Administrator.
|Can attach, remove, configure, and manage a specific host.
|- style="vertical-align:top;"
|NetworkAdmin
|Network Administrator.
|Can configure and manage the network of a particular data center or cluster. A network administrator of a data center or cluster inherits network permissions for virtual pools within the cluster.
|- style="vertical-align:top;"
|VmPoolAdmin
|System Administrator of a virtual pool.
|Can create, delete, and configure a virtual pool; assign and remove virtual pool users; and perform basic operations on a virtual machine in the pool.
|- style="vertical-align:top;"
|GlusterAdmin
|Gluster Storage Administrator.
|Can create, delete, configure, and manage Gluster storage volumes.
|}

== oVirt User Tasks ==

=== Adding Users ===

'''Summary'''

Users in oVirt must be added from an external directory service before they can be assigned roles and permissions.

'''Procedure 13.1. Adding Users to oVirt'''

<ol>
<li>Click the '''Users''' tab to display the list of authorized users.</li>
<li>Click '''Add'''. The '''Add Users and Groups''' window opens.<br>
[[Image:Add Users.png|400px|Add Users and Groups Window]]<br>
'''Figure 13.4. Add Users and Groups Window'''</li>
<li>In the '''Search''' drop down menu, select the appropriate domain. Enter a name or part of a name in the search text field, and click '''GO'''. Alternatively, click '''GO''' to view a list of all users and groups.</li>
<li>Select the check boxes for the appropriate users or groups.</li>
<li>Click '''OK'''.</li></ol>

'''Result'''

The added user displays on the '''Users''' tab.

=== Viewing User Information ===

'''Summary'''

You can view detailed information on each user in the '''Users''' tab.

'''Procedure 13.2. Viewing User Information'''

<ol>
<li>Click the '''Users''' tab to display the list of authorized users.</li>
<li>Select the user, or perform a search if the user is not visible on the results list.</li>
<li>The details pane displays for the selected user, usually with the '''General''' tab displaying general information, such as the domain name, email and status of the user.</li>
<li>The other tabs allow you to view groups, permissions, quotas, and events for the user.
For example, to view the groups to which the user belongs, click the '''Directory Groups''' tab.</li></ol>

'''Result'''

You have viewed domain, permissions, quota, group and event information for a user.

=== Viewing User Permissions on Resources ===

'''Summary'''

Users can be assigned permissions on specific resources or a hierarchy of resources. You can view the assigned users and their permissions on each resource.

'''Procedure 13.3. Viewing User Permissions on Resources'''

# Use the resource tabs, tree mode, or the search function to find and select the resource in the results list.
# Click the '''Permissions''' tab of the details pane to list the assigned users, the user's role, and the inherited permissions for the selected resource.

'''Result'''

You have viewed the assigned users and their roles for a selected resource.

=== Removing Users ===

'''Summary'''

When a user account is no longer required, remove it from oVirt.

'''Procedure 13.4. Removing Users'''

# Click the '''Users''' tab to display the list of authorized users.
# Select the user to be removed. Ensure the user is not running any virtual machines.
# Click the '''Remove''' button. A message displays prompting you to confirm the removal. Click '''OK'''.

'''Result'''

The user is removed from oVirt, but not from the external directory.

=== Configuring Roles ===

Roles are predefined sets of privileges that can be configured from oVirt. Roles provide access and management permissions to different levels of resources in the data center, and to specific physical and virtual resources.

With multilevel administration, any permissions which apply to a container object also apply to all individual objects within that container. For example, when a host administrator role is assigned to a user on a specific host, the user gains permissions to perform any of the available host operations, but only on the assigned host. However, if the host administrator role is assigned to a user on a data center, the user gains permissions to perform host operations on all hosts within the cluster of the data center.

=== Creating a New Role ===

'''Summary'''

If the role you require is not on oVirt's default list of roles, you can create a new role and customize it to suit your purposes.

'''Procedure 13.5. Creating a New Role'''

<ol>
<li>On the header bar, click the '''Configure''' button to open the '''Configure''' window. The window shows a list of default User and Administrator roles, and any custom roles.</li>
<li>Click '''New'''. The '''New Role''' dialog box displays.<br>
[[Image:New Role.png|400px|The New Role Dialog]]<br>
'''Figure 13.5. The New Role Dialog'''</li>
<li>Enter the '''Name''' and '''Description''' of the new role.</li>
<li>Select either '''Admin''' or '''User''' as the '''Account Type'''.</li>
<li>Use the '''Expand All''' or '''Collapse All''' buttons to view more or fewer of the permissions for the listed objects in the '''Check Boxes to Allow Action''' list. You can also expand or collapse the options for each object.</li>
<li>For each of the objects, select or clear the actions you wish to permit or deny for the role you are setting up.</li>
<li>Click '''OK''' to apply the changes you have made. The new role displays on the list of roles.</li></ol>

'''Result'''

You have created a new role with permissions to specific resources. You can assign the new role to users.

=== Editing or Copying a Role ===

'''Summary'''

You can change the settings for roles you have created, but you cannot change default roles. To change default roles, clone and modify them to suit your requirements.

'''Procedure 13.6. Editing or Copying a Role'''

# On the header bar, click the '''Configure''' button to open the '''Configure''' window. The window shows a list of default User and Administrator roles, and any custom roles.
# Select the role you wish to change. Click '''Edit''' to open the '''Edit Role''' window, or click '''Copy''' to open the '''Copy Role''' window.
# If necessary, edit the '''Name''' and '''Description''' of the role.
# Use the '''Expand All''' or '''Collapse All''' buttons to view more or fewer of the permissions for the listed objects. You can also expand or collapse the options for each object.
# For each of the objects, select or clear the actions you wish to permit or deny for the role you are editing.
# Click '''OK''' to apply the changes you have made.

'''Result'''

You have edited the properties of a role, or cloned a role.

== Assigning an Administrator or User Role to a Resource ==

'''Summary'''

Assign administrator or user roles to resources to allow users to access or manage that resource.

'''Procedure 13.7. Assigning a Role to a Resource'''

# Use the resource tabs, tree mode, or the search function to find and select the resource in the results list.
# Click the '''Permissions''' tab of the details pane to list the assigned users, the user's role, and the inherited permissions for the selected resource.
# Click '''Add''' to open the '''Add Permission to User''' window.
# Enter the name or user name of an existing user into the '''Search''' text box and click '''Go'''. Select a user from the resulting list of possible matches.
# Select a role from the '''Role to Assign:''' drop-down menu.
# Click '''OK''' to assign the role and close the window.

'''Result'''

You have assigned a role to a user; the user now has the inherited permissions of that role enabled for that resource.

== Removing an Administrator or User Role from a Resource ==

'''Summary'''

Remove an administrator or user role from a resource; the user loses the inherited permissions associated with the role for that resource.

'''Procedure 13.8. Removing a Role from a Resource'''

# Use the resource tabs, tree mode, or the search function to find and select the resource in the results list.
# Click the '''Permissions''' tab of the details pane to list the assigned users, the user's role, and the inherited permissions for the selected resource.
# Select the user to remove from the resource.
# Click '''Remove'''. The '''Remove Permission''' window opens to confirm permissions removal.
# Click '''OK''' to remove the user role.

'''Result'''

You have removed the user's role, and the associated permissions, from the resource.

== User Role and Authorization Examples ==

The following examples illustrate how to apply authorization controls for various scenarios, using the different features of the authorization system described in this chapter.

'''Example 13.1. Cluster Permissions'''

Sarah is the system administrator for the accounts department of a company. All the virtual resources for her department are organized under an oVirt <code>cluster</code> called <code>Accounts</code>. She is assigned the <code>ClusterAdmin</code> role on the accounts cluster. This enables her to manage all virtual machines in the cluster, since the virtual machines are child objects of the cluster. Managing the virtual machines includes editing, adding, or removing virtual resources such as disks, and taking snapshots. It does not allow her to manage any resources outside this cluster. Because <code>ClusterAdmin</code> is an administrator role, it allows her to use the Administration Portal to manage these resources, but does not give her any access via the User Portal.

'''Example 13.2. VM PowerUser Permissions'''

John is a software developer in the accounts department. He uses virtual machines to build and test his software. Sarah has created a virtual desktop called <code>johndesktop</code> for him. John is assigned the <code>UserVmManager</code> role on the <code>johndesktop</code> virtual machine. This allows him to access this single virtual machine using the User Portal. Because he has <code>UserVmManager</code> permissions, he can modify the virtual machine and add resources to it, such as new virtual disks. Because <code>UserVmManager</code> is a user role, it does not allow him to use the Administration Portal.

⁠'''Example 13.3. Data Center Power User Role Permissions'''

Penelope is an office manager. In addition to her own responsibilities, she occasionally helps the HR manager with recruitment tasks, such as scheduling interviews and following up on reference checks. As per corporate policy, Penelope needs to use a particular application for recruitment tasks.

While Penelope has her own machine for office management tasks, she wants to create a separate virtual machine to run the recruitment application. She is assigned <code>PowerUserRole</code> permissions for the data center in which her new virtual machine will reside. This is because to create a new virtual machine, she needs to make changes to several components within the data center, including creating the virtual machine disk image in the storage domain.

Note that this is not the same as assigning <code>DataCenterAdmin</code> privileges to Penelope. As a PowerUser for a data center, Penelope can log in to the User Portal and perform virtual machine-specific actions on virtual machines within the data center. She cannot perform data center-level operations such as attaching hosts or storage to a data center.

'''Example 13.4. Network Administrator Permissions'''

Chris works as the network administrator in the IT department. Her day-to-day responsibilities include creating, manipulating, and removing networks in the department's oVirt environment. For her role, she requires administrative privileges on the resources and on the networks of each resource. For example, if Chris has <code>NetworkAdmin</code> privileges on the IT department's data center, she can add and remove networks in the data center, and attach and detach networks for all virtual machines belonging to the data center.

In addition to managing the networks of the company's virtualized infrastructure, Chris also has a junior network administrator reporting to her. The junior network administrator, Pat, is managing a smaller virtualized environment for the company's internal training department. Chris has assigned Pat <code>NetworkUser</code> permissions and <code>UserVmManager</code> permissions for the virtual machines used by the internal training department. With these permissions, Pat can perform simple administrative tasks such as adding network interfaces onto virtual machines in the Power User Portal. However, he does not have permissions to alter the networks for the hosts on which the virtual machines run, or the networks on the data center to which the virtual machines belong.

'''Example 13.5. Custom Role Permissions'''

Rachel works in the IT department, and is responsible for managing user accounts in oVirt. She needs permission to add user accounts and assign them the appropriate roles and permissions. She does not use any virtual machines herself, and should not have access to administration of hosts, virtual machines, clusters or data centers. There is no built-in role which provides her with this specific set of permissions. A custom role must be created to define the set of permissions appropriate to Rachel's positi

[[Image:UserManager.png|300px|UserManager Custom Role]]

'''Figure 13.6. UserManager Custom Role'''

The '''UserManager''' custom role shown above allows manipulation of users, permissions and roles. These actions are organized under <code>System</code> - the top level object of the hierarchy shown in Figure 13.6. This means they apply to all other objects in the system. The role is set to have an '''Account Type''' of '''Admin'''. This means that when she is assigned this role, Rachel can only use the Administration Portal, not the User Portal.

= ⁠Quotas and Service Level Agreement Policy =

== Introduction to Quota ==

Quota is a resource limitation tool provided with oVirt. Quota may be thought of as a layer of limitations on top of the layer of limitations set by User Permissions.

Quota is a data center object.

Quota allows administrators of oVirt environments to limit user access to memory, CPU, and storage. Quota defines the memory resources and storage resources an administrator can assign users. As a result users may draw on only the resources assigned to them. When the quota resources are exhausted, oVirt does not permit further user actions.

There are two different kinds of Quota:

'''Table 14.1. The Two Different Kinds of Quota'''

{| class="wikitable"
!width="50%"|Quota type
!width="50%"|Definition
|- style="vertical-align:top;"
|Run-time Quota
|This quota limits the consumption of runtime resources, like CPU and memory.
|- style="vertical-align:top;"
|Storage Quota
|This quota limits the amount of storage available.
|}

Quota, like SELinux, has three modes:

'''Table 14.2. Quota Modes'''

{| class="wikitable"
!width="50%"|Quota Mode
!width="50%"|Function
|- style="vertical-align:top;"
|Enforced
|This mode puts into effect the Quota that you have set in audit mode, limiting resources to the group or user affected by the quota.
|- style="vertical-align:top;"
|Audit
|This mode allows you to change Quota settings. Choose this mode to increase or decrease the amount of runtime quota and the amount of storage quota available to users affected by it.
|- style="vertical-align:top;"
|Disabled
|This mode turns off the runtime and storage limitations defined by the quota.
|}

When a user attempts to run a virtual machine, the specifications of the virtual machine are compared to the storage allowance and the runtime allowance set in the applicable quota.

If starting a virtual machine causes the aggregated resources of all running virtual machines covered by a quota to exceed the allowance defined in the quota, then oVirt refuses to run the virtual machine.

When a user creates a new disk, the requested disk size is added to the aggregated disk usage of all the other disks covered by the applicable quota. If the new disk takes the total aggregated disk usage above the amount allowed by the quota, disk creation fails.

Quota allows for resource sharing of the same hardware. It supports hard and soft thresholds. Administrators can use a quota to set thresholds on resources. These thresholds appear, from the user's point of view, as 100% usage of that resource. To prevent failures when the customer unexpectedly exceeds this threshold, the interface supports a &quot;grace&quot; amount by which the threshold can be briefly exceeded. Exceeding the threshold results in a warning sent to the customer.

<div class="alert alert-info">'''Important:''' Quota imposes limitations upon the running of virtual machines. Ignoring these limitations is likely to result in a situation in which you cannot use your virtual machines and virtual disks.</div>

When quota is running in enforced mode, virtual machines and disks that do not have quotas assigned cannot be used.

To power on a virtual machine, a quota must be assigned to that virtual machine.

To create a snapshot of a virtual machine, the disk associated with the virtual machine must have a quota assigned.

When creating a template from a virtual machine, you are prompted to select the quota that you want the template to consume. This allows you to set the template (and all future machines created from the template) to consume a different quota than the virtual machine and disk from which the template is generated.

== Shared Quota and Individually Defined Quota ==

Users with SuperUser permissions can create quotas for individual users or quotas for groups.

Group quotas can be set for Active Directory users. If a group of ten users are given a quota of 1TB of storage and one of the ten users fills the entire terabyte, then the entire group will be in excess of the quota and none of the ten users will be able to use any of the storage associated with their group.

An individual user's quota is set for only the individual. Once the individual user has used up all of his or her storage or runtime quota, the user will be in excess of the quota and the user will no longer be able to use the storage associated with his or her quota.

== Quota Accounting ==

When a quota is assigned to a consumer or a resource, each action by that consumer or on the resource involving storage, vCPU, or memory results in quota consumption or quota release.

Since the quota acts as an upper bound that limits the user's access to resources, the quota calculations may differ from the actual current use of the user. The quota is calculated for the max growth potential and not the current usage.

'''Example 14.1. Accounting example'''

A user runs a virtual machine with 1 vCPU and 1024 MB memory. The action consumes 1 vCPU and 1024 MB of the quota assigned to that user. When the virtual machine is stopped 1 vCPU and 1024 MB of RAM are released back to the quota assigned to that user. Run-time quota consumption is accounted for only during the actual run-time of the consumer.

A user creates a virtual thin provision disk of 10GB. The actual disk usage may indicate only 3GB of that disk are actually in use. The quota consumption, however, would be 10GB, the max growth potential of that disk.

== Enabling and Changing a Quota Mode in a Data Center ==

'''Summary'''

This procedure enables or changes the quota mode in a data center. You must select a quota mode before you can define quotas. You must be logged in to the Web Administration Portal to follow the steps of this procedure.

Use '''Audit''' mode to test your quota to make sure it works as you expect it to. You do not need to have your quota in '''Audit''' mode to create or change a quota.

'''Procedure 14.1. Enabling and Changing Quota in a Data Center'''

<ol>
<li>Click the '''Data Centers''' tab in the Navigation Pane.</li>
<li>From the list of data centers displayed in the Navigation Pane, choose the data center whose quota policy you plan to edit.</li>
<li>Click '''Edit''' in the top left of the Navigation Pane.
An '''Edit Data Center''' window opens.</li>
<li>In the '''Quota Mode''' drop-down, change the quota mode to '''Enforced'''.</li>
<li>Click '''OK'''.</li></ol>

'''Result'''

You have now enabled a quota mode at the Data Center level. If you set the quota mode to '''Audit''' during testing, then you must change it to '''Enforced''' in order for the quota settings to take effect.

== Creating a New Quota Policy ==

'''Summary'''

You have enabled quota mode, either in Audit or Enforcing mode. You want to define a quota policy to manage resource usage in your data center

'''Procedure 14.2. Creating a New Quota Policy'''

<ol>
<li>In tree mode, select the data center. The '''Quota''' tab appears in the Navigation Pane.</li>
<li>Click the '''Quota''' tab in the Navigation Pane.</li>
<li>Click '''Add''' in the Navigation Pane. The '''New Quota''' window opens.</li>
<li>Fill in the '''Name''' field with a meaningful name.
Fill in the '''Description''' field with a meaningful name.</li>
<li>In the '''Memory &amp; CPU''' section of the '''New Quota''' window, use the green slider to set '''Cluster Threshold'''.</li>
<li>In the '''Memory &amp; CPU''' section of the '''New Quota''' window, use the blue slider to set '''Cluster Grace'''.</li>
<li>Click '''Edit''' on the bottom-right of the '''Memory &amp; CPU''' field. An '''Edit Quota''' window opens.</li>
<li>Under the '''Memory''' field, select either the '''Unlimited''' radio button (to allow limitless use of Memory resources in the cluster), or select the '''limit to''' radio button to set the amount of memory set by this quota. If you select the '''limit to''' radio button, input a memory quota in megabytes (MB) in the '''MB''' field.</li>
<li>Under the '''CPU''' field, select either the '''Unlimited''' radio button or the '''limit to''' radio button to set the amount of CPU set by this quota. If you select the '''limit to''' radio button, input a number of vCPUs in the '''vCpus''' field.</li>
<li>Click '''OK''' in the '''Edit Quota''' window.</li>
<li>In the '''Storage''' section of the '''New Quota''' window, use the green slider to set '''Storage Threshold'''.</li>
<li>In the '''Storage''' section of the '''New Quota''' window, use the blue slider to set '''Storage Grace'''.</li>
<li>Click '''Edit''' in the '''Storage''' field. The '''Edit Quota''' window opens.</li>
<li>Under the '''Storage Quota''' field, select either the '''Unlimited''' radio button (to allow limitless use of Storage) or the '''limit to''' radio button to set the amount of storage to which quota will limit users. If you select the '''limit to''' radio button, input a storage quota size in gigabytes (GB) in the '''GB''' field.</li>
<li>Click '''OK''' in the '''Edit Quota''' window. You are returned to the '''New Quota''' window.</li>
<li>Click '''OK''' in the '''New Quota''' window.</li></ol>

'''Result'''

You have created a new quota policy.

== Explanation of Quota Threshold Settings ==

'''Table 14.3. Quota thresholds and grace'''

{| class="wikitable"
!width="50%"|Setting
!width="50%"|Definition
|- style="vertical-align:top;"
|Cluster Threshold
|The amount of cluster resources available per data center.
|- style="vertical-align:top;"
|Cluster Grace
|The amount of the cluster available for the data center after exhausting the data center's Cluster Threshold.
|- style="vertical-align:top;"
|Storage Threshold
|The amount of storage resources available per data center.
|- style="vertical-align:top;"
|Storage Grace
|The amount of storage available for the data center after exhausting the data center's Storage Threshold.
|}

If a quota is set to 100GB with 20% Grace, then consumers are blocked from using storage after they use 120GB of storage. If the same quota has a Threshold set at 70%, then consumers receive a warning when they exceed 70GB of storage consumption (but they remain able to consume storage until they reach 120GB of storage consumption.) Both &quot;Threshold&quot; and &quot;Grace&quot; are set relative to the quota. &quot;Threshold&quot; may be thought of as the &quot;soft limit&quot;, and exceeding it generates a warning. &quot;Grace&quot; may be thought of as the &quot;hard limit&quot;, and exceeding it makes it impossible to consume any more storage resources.

== Assigning a Quota to an Object ==

'''Summary'''

This procedure explains how to associate a virtual machine with a quota.

'''Procedure 14.3. Assigning a Quota to a Virtual Machine'''

# In the navigation pane, select the Virtual Machine to which you plan to add a quota.
# Click '''Edit'''. The '''Edit Virtual Machine''' window appears.
# Select the quota you want the virtual machine to consume. Use the '''Quota''' drop-down to do this.
# Click '''OK'''.

'''Result'''

You have designated a quota for the virtual machine you selected.

'''Summary'''

This procedure explains how to associate a virtual machine disk with a quota.

'''Procedure 14.4. Assigning a Quota to a Virtual Disk'''

# In the navigation pane, select the Virtual Machine whose disk(s) you plan to add a quota.
# In the details pane, select the disk you plan to associate with a quota.
# Click '''Edit'''. The '''Edit Virtual Disk''' window appears.
# Select the quota you want the virtual disk to consume.
# Click '''OK'''.

'''Result'''

You have designated a quota for the virtual disk you selected.

<div class="alert alert-info">'''Important:''' Quota must be selected for all objects associated with a virtual machine, in order for that virtual machine to work. If you fail to select a quota for the objects associated with a virtual machine, the virtual machine will not work. The error that oVirt throws in this situation is generic, which makes it difficult to know if the error was thrown because you did not associate a quota with all of the objects associated with the virtual machine. It is not possible to take snapshots of virtual machines that do not have an assigned quota. It is not possible to create templates of virtual machines whose virtual disks do not have assigned quotas.</div>

== Using Quota to Limit Resources by User ==

'''Summary'''

This procedure describes how to use quotas to limit the resources a user has access to.

'''Procedure 14.5. Assigning a User to a Quota'''

# In the tree, click the Data Center with the quota you want to associate with a User.
# Click the '''Quota''' tab in the navigation pane.
# Select the target quota in the list in the navigation pane.
# Click the '''Consumers''' tab in the details pane.
# Click '''Add''' at the top of the details pane.
# In the '''Search''' field, type the name of the user you want to associate with the quota.
# Click '''GO'''.
# Select the check box at the left side of the row containing the name of the target user.
# Click '''OK''' in the bottom right of the '''Assign Users and Groups to Quota''' window.

'''Result'''

After a short time, the user will appear in the '''Consumers''' tab of the details pane.

== Editing Quotas ==

'''Summary'''

This procedure describes how to change existing quotas.

'''Procedure 14.6. Editing Quotas'''

# On the tree pane, click on the data center whose quota you want to edit.
# Click on the '''Quota''' tab in the Navigation Pane.
# Click the name of the quota you want to edit.
# Click '''Edit''' in the Navigation pane.
# An '''Edit Quota''' window opens. If required, enter a meaningful name in the '''Name''' field.
# If required, you can enter a meaningful description in the '''Description''' field.
# Select either the '''All Clusters''' radio button or the '''Specific Clusters''' radio button. Move the '''Cluster Threshold''' and '''Cluster Grace''' sliders to the desired positions on the '''Memory &amp; CPU''' slider.
# Select either the '''All Storage Domains''' radio button or the '''Specific Storage Domains''' radio button. Move the '''Storage Threshold''' and '''Storage Grace''' sliders to the desired positions on the '''Storage''' slider.
# Click '''OK''' in the '''Edit Quota''' window to confirm the new quota settings.

'''Result'''

You have changed an existing quota.

== ⁠Removing Quotas ==

'''Summary'''

This procedure describes how to remove quotas.

'''Procedure 14.7. Removing Quotas'''

# On the tree pane, click on the data center whose quota you want to edit.
# Click on the '''Quota''' tab in the Navigation Pane.
# Click the name of the quota you want to remove.
# Click '''Remove''' at the top of the Navigation pane, under the row of tabs.
# Click '''OK''' in the '''Remove Quota(s)''' window to confirm the removal of this quota.

'''Result'''

You have removed a quota.

== ⁠Service-level Agreement Policy Enforcement ==

oVirt 3.3 supports service-level agreement CPU features. These features can be accessed through the Administrator Portal.

'''Summary'''

This procedure describes how to set service-level agreement CPU features.

# Select '''New VM''' in the Navigation Pane.
# Select '''Show Advanced Options'''.
# Select the '''Resource Allocation''' tab.
# Specify '''CPU Shares'''. Possible options are '''Low''', '''Medium''', '''High''', '''Custom''', and '''Disabled'''. Virtual machines set to '''High''' receive twice as many shares as '''Medium''', and virtual machines set to '''Medium''' receive twice as many shares as virtual machines set to '''Low'''. '''Disabled''' instructs VDSM to use an older algorithm for determining share dispensation; usually the number of shares dispensed under these conditions is 1020.

'''Result'''

You have set a service-level agreement CPU policy. Users' CPU consumption is now governed by the policy you have set.

[[Image:SLA.png|400px|Description]]

'''Figure 14.1. Service-level Agreement Policy Enforcement - CPU Allocation Menu'''

= ⁠Event Notifications =

== Configuring Event Notifications ==

'''Summary'''

oVirt can notify designated users when specific events occur in the environment that oVirt manages. To use this functionality, you must set up a mail transfer agent to deliver messages.

'''Procedure 15.1. Configuring Event Notifications'''

<ol>
<li>Ensure you have set up the mail transfer agent with the appropriate variables.</li>
<li>Use the '''Users''' resource tab, tree mode, or the search function to find and select the user to which event notifications will be sent.</li>
<li>Click the '''Event Notifier''' tab in the details pane to list the events for which the user will be notified. This list will be blank if you have not configured any event notifications for that user.</li>
<li>Click '''Manage Events''' to open the '''Add Event Notification''' window.<br>
[[Image:Add Event Notification.png|400px|The Add Events Notification Window]]<br>
'''Figure 15.1. The Add Events Notification Window'''</li>
<li>Use the '''Expand All''' button or the subject-specific expansion buttons to view the events.</li>
<li>Select the appropriate check boxes.</li>
<li>Enter an email address in the '''Mail Recipient''' field.</li>
<li>Click '''OK''' to save changes and close the window.</li>
<li><p>Add and start the '''ovirt-engine-notifier''' service on oVirt. This activates the changes you have made:</p>
<pre class="screen"># chkconfig --add ovirt-engine-notifier
# chkconfig ovirt-engine-notifier on
# service ovirt-engine-notifier restart</pre></li></ol>

'''Result'''

The specified user now receives emails based on events in the oVirt environment. The selected events display on the '''Event Notifier''' tab for that user.

== Parameters for Event Notifications in ovirt-engine-notifier.conf ==

The event notifier configuration file can be found in <code>/usr/share/ovirt-engine/services/ovirt-engine-notifier/ovirt-engine-notifier.conf</code>

'''Table 15.1. ovirt-engine-notifier.conf variables'''

{| class="wikitable"
!width="40%"|Variable Name
!width="20%"|Default
!width="40%"|Remarks
|- style="vertical-align:top;"
|SENSITIVE_KEYS
|none
|A comma-separated list of keys that will not be logged.
|- style="vertical-align:top;"
|JBOSS_HOME
|/usr/share/jbossas
|The location of the JBoss application server used by oVirt.
|- style="vertical-align:top;"
|ENGINE_ETC
|/etc/ovirt-engine
|The location of the <code>etc</code> directory used by oVirt.
|- style="vertical-align:top;"
|ENGINE_LOG
|/var/log/ovirt-engine
|The location of the <code>logs</code> directory used by oVirt.
|- style="vertical-align:top;"
|ENGINE_USR
|/usr/share/ovirt-engine
|The location of the <code>usr</code> directory used by oVirt.
|- style="vertical-align:top;"
|ENGINE_JAVA_MODULEPATH
|${ENGINE_USR}/modules
|The file path to which the JBoss modules are appended.
|- style="vertical-align:top;"
|NOTIFIER_DEBUG_ADDRESS
|none
|The address of a machine that can be used to perform remote debugging of the Java virtual machine that the notifier uses.
|- style="vertical-align:top;"
|NOTIFIER_STOP_TIME
|
|The time, in seconds, after which the service will time out.
|- style="vertical-align:top;"
|NOTIFIER_STOP_INTERVAL
|
|The time, in seconds, by which the timeout counter will be incremented.
|- style="vertical-align:top;"
|INTERVAL_IN_SECONDS
|
|The interval in seconds between instances of dispatching messages to subscribers.
|- style="vertical-align:top;"
|IDLE_INTERVAL
|
|The interval, in seconds, between which low-priority tasks will be performed.
|- style="vertical-align:top;"
|DAYS_TO_KEEP_HISTORY
|
|This variable sets the number of days dispatched events will be preserved in the history table. If this variable is not set, events remain on the history table indefinitely.
|- style="vertical-align:top;"
|FAILED_QUERIES_NOTIFICATION_THRESHOLD
|
|The number of failed queries after which a notification email is sent. A notification email is sent after the first failure to fetch notifications, and then once every time the number of failures specified by this variable is reached. If you specify a value of <code>0</code> or <code>1</code>, an email will be sent with each failure.
|- style="vertical-align:top;"
|FAILED_QUERIES_NOTIFICATION_RECIPIENTS
|none
|The email addresses of the recipients to which notification emails will be sent. Email addresses must be separated by a comma. This entry has been deprecated by the <code>FILTER</code> variable.
|- style="vertical-align:top;"
|DAYS_TO_SEND_ON_STARTUP
|
|The number of days of old events that will be processed and sent when the notifier starts.
|- style="vertical-align:top;"
|FILTER
|exclude:*
|The algorithm used to determine the triggers for and recipients of email notifications. The value for this variable comprises a combination of <code>include</code> or <code>exclude</code>, the event, and the recipient. For example, <code>include:VDC_START(smtp:mail@example.com) ${FILTER}</code>
|- style="vertical-align:top;"
|MAIL_SERVER
|none
|The SMTP mail server address. Required.
|- style="vertical-align:top;"
|MAIL_PORT
|
|The port used for communication. Possible values include <code>25</code> for plain SMTP, <code>465</code> for SMTP with SSL, and <code>587</code> for SMTP with TLS.
|- style="vertical-align:top;"
|MAIL_USER
|none
|If SSL is enabled to authenticate the user, then this variable must be set. This variable is also used to specify the &quot;from&quot; user address when the MAIL_FROM variable is not set. Some mail servers do not support this functionality. The address is in RFC822 format.
|- style="vertical-align:top;"
|SENSITIVE_KEYS
|${SENSITIVE_KEYS},MAIL_PASSWORD
|Required to authenticate the user if the mail server requires authentication or if SSL or TLS is enabled.
|- style="vertical-align:top;"
|MAIL_PASSWORD
|none
|Required to authenticate the user if the mail server requires authentication or if SSL or TLS is enabled.
|- style="vertical-align:top;"
|MAIL_SMTP_ENCRYPTION
|none
|The type of encryption to be used in communication. Possible values are <code>none</code>, <code>ssl</code>, <code>tls</code>.
|- style="vertical-align:top;"
|HTML_MESSAGE_FORMAT
|false
|The mail server sends messages in HTML format if this variable is set to <code>true</code>.
|- style="vertical-align:top;"
|MAIL_FROM
|none
|This variable specifies a sender address in RFC822 format, if supported by the mail server.
|- style="vertical-align:top;"
|MAIL_REPLY_TO
|none
|This variable specifies reply-to addresses in RFC822 format on sent mail, if supported by the mail server.
|- style="vertical-align:top;"
|MAIL_SEND_INTERVAL
|
|The number of SMTP messages to be sent for each IDLE_INTERVAL
|- style="vertical-align:top;"
|MAIL_RETRIES
|
|The number of times to attempt to send an email before failing.
|- style="vertical-align:top;"
|SNMP_MANAGER
|none
|The IP addresses or fully qualified domain names of machines that will act as the SNMP managers. Entries must be separated by a space and can contain a port number. For example, <code>manager1.example.com manager2.example.com:164</code>
|- style="vertical-align:top;"
|SNMP_COMMUNITY
|public
|The default SNMP community.
|- style="vertical-align:top;"
|SNMP_OID
|
|The default TRAP object identifiers for alerts.
|- style="vertical-align:top;"
|ENGINE_INTERVAL_IN_SECONDS
|
|The interval, in seconds, between monitoring the machine on which oVirt is installed. The interval is measured from the time the monitoring is complete.
|- style="vertical-align:top;"
|ENGINE_MONITOR_RETRIES
|
|The number of times the notifier attempts to monitor the status of the machine on which oVirt is installed in a given interval after a failure.
|- style="vertical-align:top;"
|ENGINE_TIMEOUT_IN_SECONDS
|
|The time, in seconds, to wait before the notifier attempts to monitor the status of the machine on which oVirt is installed in a given interval after a failure.
|- style="vertical-align:top;"
|IS_HTTPS_PROTOCOL
|false
|This entry must be set to <code>true</code> if JBoss is being run in secured mode.
|- style="vertical-align:top;"
|SSL_PROTOCOL
|TLS
|The protocol used by JBoss configuration connector when SSL is enabled.
|- style="vertical-align:top;"
|SSL_IGNORE_CERTIFICATE_ERRORS
|false
|This value must be set to <code>true</code> if JBoss is running in secure mode and SSL errors is to be ignored.
|- style="vertical-align:top;"
|SSL_IGNORE_HOST_VERIFICATION
|false
|This value must be set to <code>true</code> if JBoss is running in secure mode and host name verification is to be ignored.
|- style="vertical-align:top;"
|REPEAT_NON_RESPONSIVE_NOTIFICATION
|false
|This variable specifies whether repeated failure messages will be sent to subscribers if the machine on which oVirt is installed is non-responsive.
|- style="vertical-align:top;"
|ENGINE_PID
|/var/lib/ovirt-engine/ovirt-engine.pid
|The path and file name of the PID of oVirt.
|}

== Canceling Event Notifications ==

'''Summary'''

A user has configured some unnecessary event notifications and wants them canceled.

'''Procedure 15.2. Canceling Event Notifications'''

# In the '''Users''' tab, select the user or the user group.
# Select the '''Event Notifier''' tab in the details pane to list events for which the user receives notifications.
# Click '''Manage Events''' to open the '''Add Event Notification''' window.
# Use the '''Expand All''' button, or the subject-specific expansion buttons, to view the events.
# Clear the appropriate check boxes to remove notification for that event.
# Click '''OK''' to save changes and close the window.

'''Result'''

You have canceled unnecessary event notifications for the user.

= ⁠Utilities =

== The Ovirt Engine Rename Tool ==

=== The Ovirt Engine Rename Tool ===

When the <code>engine-setup</code> command is run in a clean environment, the command generates a number of certificates and keys that use the fully qualified domain name of oVirt supplied during the setup process. If the fully qualified domain name of oVirt must be changed later on (for example, due to migration of the machine hosting oVirt to a different domain), the records of the fully qualified domain name must be updated to reflect the new name. The <code>ovirt-engine-rename</code> command automates this task.

The <code>ovirt-engine-rename</code> command updates records of the fully qualified domain name of oVirt in the following locations:

* /etc/ovirt-engine/engine.conf.d/10-setup-protocols.conf
* /etc/ovirt-engine/imageuploader.conf.d/10-engine-setup.conf
* /etc/ovirt-engine/isouploader.conf.d/10-engine-setup.conf
* /etc/ovirt-engine/logcollector.conf.d/10-engine-setup.conf
* /etc/pki/ovirt-engine/cert.conf
* /etc/pki/ovirt-engine/cert.template
* /etc/pki/ovirt-engine/certs/apache.cer
* /etc/pki/ovirt-engine/keys/apache.key.nopass
* /etc/pki/ovirt-engine/keys/apache.p12

<div class="alert alert-info">'''Warning:''' While the <code>ovirt-engine-rename</code> command creates a new certificate for the web server on which oVirt runs, it does not affect the certificate for the engine or the certificate authority. Due to this, there is some risk involved in using the <code>ovirt-engine-rename</code> command, particularly in environments that have been upgraded from oVirt version 3.2 and earlier. Therefore, changing the fully qualified domain name of oVirt by running <code>engine-cleanup</code> and <code>engine-setup</code> is recommended where possible.</div>

=== Syntax for the Ovirt Engine Rename Command ===

The basic syntax for the <code>ovirt-engine-rename</code> command is:

<pre class="screen"># /usr/share/ovirt-engine/setup/bin/ovirt-engine-rename</pre>
The command also accepts the following options:

; ''<code>--newname=[new name]</code>''
: Allows you to specify the new fully qualified domain name for oVirt without user interaction.
; ''<code>--log=[file]</code>''
: Allows you to specify the path and name of a file into which logs of the rename operation are to be written.
; ''<code>--config=[file]</code>''
: Allows you to specify the path and file name of a configuration file to load into the rename operation.
; ''<code>--config-append=[file]</code>''
: Allows you to specify the path and file name of a configuration file to append to the rename operation. This option can be used to specify the path and file name of an answer file.
; ''<code>--generate-answer=[file]</code>''
: Allows you to specify the path and file name of a file into which your answers to and the values changed by the <code>ovirt-engine-rename</code> command are recorded.

=== Using the Ovirt Engine Rename Tool ===

'''Summary'''

You can use the <code>ovirt-engine-rename</code> command to update records of the fully qualified domain name of oVirt.

'''Procedure 16.1. Renaming oVirt'''

<ol>
<li>Prepare all DNS and other relevant records for the new fully qualified domain name.</li>
<li>Update the DHCP server configuration if DHCP is used.</li>
<li>Update the host name on oVirt.</li>
<li>Run the following command:<br>
<pre class="screen"># /usr/share/ovirt-engine/setup/bin/ovirt-engine-rename</pre></li>
<li>When prompted, press '''Enter''' to stop the engine service:<br>
<pre class="screen">During execution engine service will be stopped (OK, Cancel) [OK]:</pre></li>
<li>When prompted, enter the new fully qualified domain name for oVirt:<br>
<pre class="screen">New fully qualified server name:[new name]</pre></li></ol>

'''Result'''

The <code>ovirt-engine-rename</code> command updates records of the fully qualified domain name of oVirt.

== The Domain Management Tool ==

=== The Domain Management Tool ===

oVirt authenticates users using directory services. To add users to oVirt you must first use the internal <code>admin</code> user to add the directory service that the users must be authenticated against. You add and remove directory services domains using the included domain management tool, <code>engine-manage-domains</code>.

The <code>engine-manage-domains</code> command is only accessible on the machine on which oVirt is installed. The <code>engine-manage-domains</code> command must be run as the <code>root</code> user.

=== Syntax for the Domain Management Tool ===

The usage syntax is:

<pre class="screen">engine-manage-domains -action=ACTION [options]</pre>
Available actions are:

; ''<code>add</code>''
: Add a domain to oVirt's directory services configuration.
; ''<code>edit</code>''
: Edit a domain in oVirt's directory services configuration.
; ''<code>delete</code>''
: Delete a domain from oVirt's directory services configuration.
; ''<code>validate</code>''
: Validate oVirt's directory services configuration. This command attempts to authenticate each domain in the configuration using the configured user name and password.
; ''<code>list</code>''
: List oVirt's current directory services configuration.

These options can be combined with the actions on the command line:

; ''<code>--add-permissions</code>''
: Specifies that the domain user will be given the '''SuperUser''' role in oVirt. By default, if the ''<code>--add-permissions</code>'' parameter is not specified, the '''SuperUser''' role is not assigned to the domain user. The ''<code>--add-permissions</code>'' option is optional. It is only valid when used in combination with the ''<code>add</code>'' and ''<code>edit</code>'' actions.
; ''<code>--change-password-msg=[MSG]</code>''
: Specifies the message that is returned to the user at login when their password has expired. This allows you to direct users to a specific URL (must begin with http or https) where their password can be changed. The ''<code>--change-password-msg</code>'' option is optional, and is only valid when used in combination with the ''<code>add</code>'' and ''<code>edit</code>'' actions.
; ''<code>--config-file=[FILE]</code>''
: Specifies an alternate configuration file that the command must use. The ''<code>--config-file</code>'' parameter is always optional.
; ''<code>--domain=[DOMAIN]</code>''
: The domain on which the action will be performed. The ''<code>--domain</code>'' parameter is mandatory for the ''<code>add</code>'', ''<code>edit</code>'', and ''<code>delete</code>'' actions.
; ''<code>--force</code>''
: Forces the command to skip confirmation of delete operations.
; ''<code>--ldap-servers=[servers]</code>''
: A comma delimited list of LDAP servers to be set to the domain.
; ''<code>--provider=</code>''[PROVIDER]
: The LDAP provider type of the directory server for the domain. Valid values are:
<ul>
<li>''<code>ad</code>'' - Microsoft Active Directory.</li>
<li>''<code>ipa</code>'' - Identity Management (IdM).</li>
<li>''<code>rhds</code>'' - Red Hat Directory Server. Red Hat Directory Server does not come with Kerberos. oVirt requires Kerberos authentication. Red Hat Directory Server must be running as a service inside a Kerberos domain to provide directory services to oVirt.<br>
<div class="alert alert-info">'''Note:''' To use Red Hat Directory Server as your directory server, you must have the <code>memberof</code> plug-in installed in Red Hat Directory Server. To use the <code>memberof</code> plug-in, your users must be <code>inetuser</code>.</div></li>
<li><code>itds</code> - IBM Tivoli Directory Server.</li>
<li><code>oldap</code> - OpenLDAP.</li></ul>
; ''<code>--report</code>''
: When used in conjunction with the ''<code>validate</code>'' action, this command outputs a report of all validation errors encountered.
; ''<code>--user=[USER]</code>''
: Specifies the domain user to use. The ''<code>--user</code>'' parameter is mandatory for ''<code>add</code>'', and optional for ''<code>edit</code>''.
; ''<code>--password-file=[FILE]</code>''
: Specifies that the domain user's password is on the first line of the provided file. This option, or the ''<code>--interactive</code>'' option, must be used to provide the password for use with the ''<code>add</code>'' action.

For further details on usage, see the <code>engine-manage-domains</code> command's help output:

<pre class="screen"># engine-manage-domains --help</pre>

== The Configuration Tool ==

=== The Configuration Tool ===

Installing oVirt modifies only a subset of configuration settings from their defaults. Further modifications are made using the configuration tool: <code>engine-config</code>.

The configuration tool does not require Red Hat JBoss Enterprise Application Platform or oVirt to be running to update the configuration. Configuration key values are stored in the database; configuration changes will not be saved unless the database is operational. Changes are applied when Red Hat JBoss Enterprise Application Platform is restarted.

oVirt stores configuration settings as a series of key-to-value pair mappings. The configuration tool allows you to:

* List all available configuration keys.
* List all available configuration values.
* Retrieve the value of a specific configuration key.
* Set the value of a specific configuration key.

You are also able to maintain multiple versions of oVirt's configuration with the configuration tool. Use the ''<code>--cver</code>'' parameter to specify the configuration version to be used when retrieving or setting a value for a configuration key. The default configuration version is <code>general</code>.

=== Syntax for engine-config Command ===

The configuration tool is accessible on the client machine on which oVirt is installed. For full usage information consult the help output of the <code>engine-config</code> command:

<pre class="screen"># engine-config --help</pre>

'''Common tasks'''

; List available configuration keys
: Use the ''<code>--list</code>'' parameter to list available configuration keys.<br>
<pre class="screen"># engine-config --list</pre><br>
Each available configuration key is listed by name and description.
; List available configuration values
: Use the ''<code>--all</code>'' parameter to list available configuration values.<br>
<pre class="screen"># engine-config --all</pre><br>
Each available configuration key is listed by name, current value of the key, and the configuration version.
; Retrieve value of configuration key
: Use the ''<code>--get</code>'' parameter to retrieve the value of a specific key.<br>
<pre class="screen"># engine-config --get KEY_NAME</pre><br>
Replace ''KEY_NAME'' with the name of the specific key to retrieve the key name, value, and the configuration version. Use the ''<code>--cver</code>'' parameter to specify the configuration version of the value to be retrieved.
; Set value of configuration key
: Use the ''<code>--set</code>'' parameter to set the value of a specific key. You must also set the configuration version to which the change is to apply using the ''<code>--cver</code>'' parameter.<br>
<pre class="screen"># engine-config --set KEY_NAME=KEY_VALUE --cver=VERSION</pre><br>
Replace ''KEY_NAME'' with the name of the specific key to set; replace ''KEY_VALUE'' with the value to be set. Environments with more than one configuration version require the ''VERSION'' to be specified.

=== The admin@internal User ===

The <code>admin@internal</code> user account is automatically created upon installation of oVirt. This account is stored locally in oVirt's PostgreSQL database, separate from external directory services such as IdM or Active Directory. Unlike external directory domains, users cannot be added or deleted from the <code>internal</code> domain. The <code>admin@internal</code> user is the SuperUser of oVirt and has administrative privileges over the environment via the Administration Portal.

The password for the <code>admin@internal</code> user is set during the installation of oVirt. Use the '''engine-config''' utility if you need to reset the password.

=== Changing the Password for admin@internal ===

<ol>
<li>Log in to oVirt server as the <code>root</code> user.</li>
<li>Use the <code>engine-config</code> utility to set a new password for the <code>admin@internal</code> user.<br>
<pre class="screen"># engine-config -s AdminPassword=interactive</pre><br>
Use escape characters if your password includes any special characters.</li>
<li>Restart the ovirt-engine service for the changes to take effect.<br>
<pre class="screen"># service ovirt-engine restart</pre></li></ol>

=== oVirt Configuration Options ===

'''Table 16.1. oVirt Configuration Options'''

{| class="wikitable"
!width="20%"|Name
!width="20%"|Description
!width="20%"|Type
!width="20%"|Default Value
!width="20%"|Comments
|- style="vertical-align:top;"
|AbortMigrationOnError
|Abort ongoing migration on error
|Boolean
|v3.0: false
v3.1: false
v3.2: false
v3.3: false
|Specify whether it is possible to optionally abort ongoing migration when an error occurs.
|- style="vertical-align:top;"
|AsyncTaskPollingRate
|Async Task Polling Rate (in seconds)
|Integer
|
|How often (in seconds) oVirt queries the status of an asynchronous task in progress.
|- style="vertical-align:top;"
|AsyncTaskZombieTaskLifeInMinutes
|Zombie tasks lifetime in minutes
|Integer
|
|How long (in minutes) a task is allowed to run before assuming it has become a zombie and should be killed. The value affects large storage manipulations especially. When using slow storage and large virtual images, or when a task is known to take longer than 3000 minutes (50 hours), the value should be increased.
|- style="vertical-align:top;"
|AttestationPort
|Definition of service port for attestation service
|Integer
|
|Which port is your attestation server listening for connections on?
|- style="vertical-align:top;"
|AttestationServer
|Definition of FQDN of attestation server
|String
|
|Fully qualified domain name or IP address of your attestation server.
|- style="vertical-align:top;"
|AttestationTruststore
|Trust store used for securing communication with attestation service
|String
|TrustStore.jks
|Copy the TrustStore.jks keystore file from <code>/var/lib/oat-appraiser/Certificate/</code> on your attestation server to <code>/usr/share</code> on your engine server.
|- style="vertical-align:top;"
|AttestationTruststorePass
|The password used to access trust store
|String
|password
|The default password is password.
|- style="vertical-align:top;"
|AttestationFirstStageSize
|Attestation size for first stage
|Integer
|
|Used for quick initialization. Do not change unless you know why.
|- style="vertical-align:top;"
|AuditLogAgingThreshold
|Audit Log Aging Threshold (in days)
|Integer
|
|How long an audit log is kept before being rotated.
|- style="vertical-align:top;"
|AuditLogCleanupTime
|Time to check for Audit Log cleanup
|Time
|At what time the Audit Log is checked for Aging and cleaned up.
|- style="vertical-align:top;"
|AuthenticationMethod
|The authentication method used by oVirt
|String
|LDAP
|The API used for querying users. Currently LDAP is the only supported value.
|- style="vertical-align:top;"
|BlockMigrationOnSwapUsagePercentage
|Host swap percentage threshold (for scheduling)
|Integer
|
|The maximum percentage of swap space on the host that a VM run or migration is allowed to consume on the host. If the host is swapping beyond this percentage, a VM will not migrate over and will not be started.
|- style="vertical-align:top;"
|BootstrapMinimalVdsmVersion
|Minimum VDSM version
|String
|
|The minimum version of VDSM that is acceptable when adding hosts to the Engine. Newer versions have more features.
|- style="vertical-align:top;"
|CABaseDirectory
|CA Base Directory
|String
|/etc/pki/ovirt-engine
|Where oVirt Certificate Authority is located on oVirt host.
|- style="vertical-align:top;"
|CertificateFileName
|Certificate File Name
|String
|/etc/pki/ovirt-engine/certs/engine.cer
|Points to the certificate file used by oVirt for SSL/TLS communication with VDSM.
|- style="vertical-align:top;"
|ClientModeSpiceDefault
|The default SPICE console protocol mode
|String
|Auto
|The default mode to use when connecting to a virtual machine using the SPICE console protocol.
|- style="vertical-align:top;"
|ClientModeVncDefault
|The default VNC console protocol mode
|String
|Native
|The default mode to use when connecting to a virtual machine using the VNC console protocol.
|- style="vertical-align:top;"
|ClientModeRdpDefault
|The default RDP console protocol mode
|String
|Auto
|The default mode to use when connecting to a virtual machine using the RDP console protocol.
|- style="vertical-align:top;"
|ClusterEmulatedMachines
|Supported machine types
|String
|v3.0: rhel6.2.0
v3.1: rhel6.3.0
v3.2: rhel6.4.0
v3.3: rhel6.5.0
v3.4: rhel6.5.0
|The machine types supported by clusters.
|- style="vertical-align:top;"
|CpuOverCommitDurationMinutes
|The duration in minutes of CPU consumption to activate selection algorithm
|Integer
|
|When the cluster policy is set to Even Distribution, wait for this amount of minutes after detecting CPU overcommit before triggering virtual machine migrations to rebalance the host load. This configuration value applies only for the default.
|- style="vertical-align:top;"
|CustomDeviceProperties
|Custom device properties
|DeviceCustomProperties
|v3.4 only: {type=interface;prop={SecurityGroups=^(?:(?:[0-9a-fA-F]{8}-(?:[0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12}, *)*[0-9a-fA-F]{8}-(?:[0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12}|)$}}
|Definition of custom properties for each device type.
|- style="vertical-align:top;"
|DefaultWindowsTimeZone
|The default time zone for Windows virtual machines
|WindowsTimeZone
|GMT Standard Time
|The default time zone used when creating new Windows virtual machines.
|- style="vertical-align:top;"
|DefaultGeneralTimeZone
|The default time zone for virtual machines other than Windows virtual machines
|GeneralTimeZone
|Etc/GMT
|The default time zone used when creating virtual machines other than Windows virtual machines.
|- style="vertical-align:top;"
|DelayResetForSpmInSeconds
|Delay before Storage Pool Manager reset
|Double
|
|The additional delay, in seconds, before reset due to a communication issue when the host is the Storage Pool Manager.
|- style="vertical-align:top;"
|DelayResetPerVmInSeconds
|Delay before virtual machine reset
|Double
|
|The additional delay, in seconds, before reset due to a communication issue for each virtual machine running on a host.
|- style="vertical-align:top;"
|DisableFenceAtStartupInSec
|Disable Fence Operations at oVirt Startup in seconds
|Integer
|
|Allow this amount of seconds after oVirt starts to detect hosts, before assuming the hosts are unresponsive and proceed to fence hosts. This value should be increased when oVirt is on a machine that has slow network startup (a VMware guest, for example).
|- style="vertical-align:top;"
|DwhHeartBeatInterval
|The interval, in seconds at which the data warehouse is informed that the engine is running
|Integer
|
|
|- style="vertical-align:top;"
|WANDisableEffects
|Disabled WAN Effects value to send to the SPICE console
|StringMultiple
|animation
|The list of effects which will be disabled for SPICE. Possible values: <code>animation</code>, <code>wallpaper</code>, <code>font-smooth</code>, and <code>all</code>.
|- style="vertical-align:top;"
|WANColorDepth
|WAN Color Depth value to send to the SPICE console
|Integer
|The color depth used by the SPICE. Possible values are <code>16</code> and <code>32</code>.
|- style="vertical-align:top;"
|EnableMACAntiSpoofingFilterRules
|Enable anti-spoofing filter rules for MAC addresses
|String
|true
|Specifies whether network filtering is enabled.
|- style="vertical-align:top;"
|EnableSpiceRootCertificateValidation
|Enable Spice Root Certification Validation
|String
|true
|If <code>true</code>, the certificate of the host on which the virtual machine is running and oVirt setup CA certificate are sent to the SPICE client when attempting to connect to the virtual machine with SPICE, as an extra security mechanism.
|- style="vertical-align:top;"
|EnableUSBAsDefault
|Enable USB devices attachment to the virtual machine by default
|String
|true
|
|- style="vertical-align:top;"
|EnableVdsLoadBalancing
|Enables Host Load Balancing system
|String
|true
|This config value allows the user to turn on or off (true and false, respectively) the virtual machine load balancing according to the policy configured for the cluster.
|- style="vertical-align:top;"
|EncryptHostCommunication
|Encryption of host communication
|Boolean
|true
|Specify whether communication between hosts and oVirt will be encrypted.
|- style="vertical-align:top;"
|ExternalSchedulerServiceURL
|The location of an external scheduler
|String
|http://localhost:18781
|The location of an external scheduler.
|- style="vertical-align:top;"
|ExternalSchedulerConnectionTimeout
|The time for which a connection to an external scheduler will be attempted before timing out
|Integer
|
|This value can be set to <code>0</code> to disable this feature.
|- style="vertical-align:top;"
|ExternalSchedulerEnabled
|Specifies whether the virtual machine scheduler will consider the external filters and load balancers
|Boolean
|false
|
|- style="vertical-align:top;"
|ExternalSchedulerResponseTimeout
|The time for which a response from an external scheduler will be waited on before timing out
|Integer
|
|
|- style="vertical-align:top;"
|FreeSpaceCriticalLowInGB
|Critical low disk space alert threshold (in GB)
|Integer
|
|Produces an alert when a Storage Domain has this amount of space left. This setting is also used in various preliminary tests for action sanity when users try to use storage domains, to prevent reaching this critical amount. Adding and importing disks will fail if the amount of space is less than the value specified here.
|- style="vertical-align:top;"
|FreeSpaceLow
|Limit of percentage of free disk space below which it is considered low
|Integer
|
|When a storage domain has this percentage of space left, it is considered low on disk space.
|- style="vertical-align:top;"
|GlusterRefreshRateHooks
|The refresh rate for Gluster hooks
|Integer
|
|The refresh rate, in seconds, for Gluster hooks from Gluster servers.
|- style="vertical-align:top;"
|HighUtilizationForEvenlyDistribute
|High Utilization Limit For Evenly Distribute selection algorithm
|Integer
|
|Maximum number of virtual machines per host in the Evenly Distribute algorithm.
|- style="vertical-align:top;"
|HighUtilizationForPowerSave
|High Utilization Limit For Power Save selection algorithm
|Integer
|
|A default for newly created clusters, in use with PowerSave load balancing algorithm, marks the higher limit of host utilization for populating hosts.
|- style="vertical-align:top;"
|HostPreparingForMaintenanceIdleTime
|The time to wait, in seconds, to determine if a host is idling in status <code>PreparingForMaintenance</code>
|Integer
|
|When the interval is met, another attempt is made to move the host into maintenance.
|- style="vertical-align:top;"
|KeystoneAuthUrl
|The location of a Keystone server
|String
|
|The location of an OpenStack Keystone server for authenticating OpenStack providers.
|- style="vertical-align:top;"
|LDAPQueryTimeout
|Read Timeout in seconds for LDAP queries
|Integer
|
|The amount of time an LDAP query will read before the query is stopped.
|- style="vertical-align:top;"
|LDAPOperationTimeout
|Search timeout at LDAP server side
|Integer
|
|The amount of time an LDAP search will operate before it is stopped.
|- style="vertical-align:top;"
|LDAPConnectTimeout
|Connect timeout in seconds for LDAP queries
|Integer
|
|The amount of time an LDAP query will connect before it is stopped.
|- style="vertical-align:top;"
|LocalAdminPassword
|Local Administrator Password
|Password
|Populated during initial setup
|The password for <code>admin@local</code> default user.
|- style="vertical-align:top;"
|LogMaxPhysicalMemoryUsedThresholdInPercentage
|Memory usage threshold for triggering a log event
|Integer
|
|The maximum threshold of physical memory usage on a host, in percentage, that will trigger an audit log event.
|- style="vertical-align:top;"
|LogMaxCpuUsedThresholdInPercentage
|CPU usage threshold for triggering a log event
|Integer
|
|The maximum threshold of CPU usage on a host, in percentage, that will trigger an audit log event.
|- style="vertical-align:top;"
|LogMaxNetworkUsedThresholdInPercentage
|Network usage threshold for triggering a log event
|Integer
|
|The maximum threshold of network usage on a host, in percentage, that will trigger an audit log event.
|- style="vertical-align:top;"
|LogMinFreeSwapThresholdInMB
|Free swap threshold for triggering a log event
|Integer
|
|The minimum threshold of free swap memory on a host, in MB, that will trigger an audit log event.
|- style="vertical-align:top;"
|LogMaxSwapUsedThresholdInPercentage
|Swap usage threshold for triggering a log event
|Integer
|
|The maximum threshold for swap memory usage on a host, in percentage, that will trigger an audit log event.
|- style="vertical-align:top;"
|LogPhysicalMemoryThresholdInMB
|Threshold for logging low host memory in MB
|Integer
|
|The minimum amount of RAM left before a host is considered low on memory. If a host's RAM is lower than this setting, it is recorded on the audit log and no action is taken.
|- style="vertical-align:top;"
|LowUtilizationForEvenlyDistribute
|Low Utilization Limit for Evenly Distribute selection algorithm
|Integer
|
|Minimum number of virtual machines per host in the Evenly Distribute algorithm.
|- style="vertical-align:top;"
|LowUtilizationForPowerSave
|Low Utilization Limit for Power Save selection algorithm
|Integer
|
|A default for newly created clusters, in use with PowerSave load balancing algorithm, marks the lower limit of host utilization for populating hosts.
|- style="vertical-align:top;"
|MacPoolRanges
|MAC Addresses Pool Ranges
|String
|
|The MAC address pool range to be automatically assigned to virtual machines.
|- style="vertical-align:top;"
|MaxAverageNetworkQoSValue
|Maximum value for Average Networks Quality of Service (Mbps)
|Integer
|
|
|- style="vertical-align:top;"
|MaxPeakNetworkQoSValue
|Maximum value for Peak Networks Quality of Service (Mbps)
|Integer
|
|
|- style="vertical-align:top;"
|MaxBurstNetworkQoSValue
|Maximum value for Burst Networks Quality of Service (Mb)
|Integer
|
|
|- style="vertical-align:top;"
|MaxMacsCountInPool
|Maximum MAC Addresses count in Pool
|Integer
|
|Maximum number of MAC addresses allowed in the MAC pool.
|- style="vertical-align:top;"
|MaxNumberOfHostsInStoragePool
|Maximum number of hosts in Storage Pool
|Integer
|
|Limits the maximum number of hosts assigned to the clusters of a single Data Center. This can be increased after testing more hosts, if necessary.
|- style="vertical-align:top;"
|MaxNumOfCpuPerSocket
|Maximum Number of CPU per socket
|Integer
|
|The maximum number of virtual CPU cores that can be assigned to a single virtual CPU socket.
|- style="vertical-align:top;"
|MaxNumOfVmCpus
|Total Numbers of Virtual Machine CPUs
|Integer
|
3.1: 160
3.2: 160
3.3: 160
3.4: 160
|The maximum total amount of CPU cores assigned to a virtual machine (determined by number of cores multiplied by number of sockets).
|- style="vertical-align:top;"
|MaxNumofVmSockets
|Maximum number of sockets per virtual machine
|Integer
|
|The maximum number of virtual CPU sockets assigned to a virtual machine.
|- style="vertical-align:top;"
|MaxRerunVmOnVdsCount
|Maximum virtual machine rerun attempts on a host
|Integer
|
|Maximum number of attempts to start a virtual machine on a host before an error (&quot;unable to start VM&quot;) is reported.
|- style="vertical-align:top;"
|MaxSchedulerWeight
|Maximum schedule weighting
|Integer
|
|The maximum weight score for a single scheduler weight module.
|- style="vertical-align:top;"
|MaxStorageVdsDelayCheckSec
|Max delay for check of domain in seconds
|Integer
|
|Maximum amount of seconds to wait for storage domain status to be returned before reporting an error.
|- style="vertical-align:top;"
|MaxStorageVdsTimeoutCheckSec
|Maximum timeout for last check of domain in seconds
|Integer
|
|When monitoring storage, vdsmd on the hosts reports a &quot;lastCheck&quot; value for each domain. This setting is used to decide whether the last check happened too long ago and domain is considered in error.
|- style="vertical-align:top;"
|MaxVdsMemOverCommit
|Max Host Memory Over-Commit (%) for virtual desktops load
|Integer
|
|The percentage of memory overcommit permitted to occur when using virtual desktop loads.
|- style="vertical-align:top;"
|MaxVdsMemOverCommitForServers
|Maximum Host Memory Over-Commit (%) for Virtual Servers load
|Integer
|
|The percentage of memory overcommit permitted to occur when using virtual server loads.
|- style="vertical-align:top;"
|MaxVdsNameLength
|Max VDS name length
|Integer
|
|Maximum name length for a Hypervisor host.
|- style="vertical-align:top;"
|MaxVmNameLengthNonWindows
|Maximum virtual machine name length for non-Windows operating system
|Integer
|
|Maximum name length for a non-Windows virtual machine.
|- style="vertical-align:top;"
|MaxVmNameLengthWindows
|Maximum name length in Windows
|Integer
|
|Maximum name length for Windows virtual machine (limitation imposed by Windows hostnames).
|- style="vertical-align:top;"
|MaxVmsInPool
|Max virtual machines in pool
|Integer
|
|Maximum number of virtual machines in a single data center.
|- style="vertical-align:top;"
|VmPoolMaxSubsequentFailures
|Maximum number of subsequent VM creation failures before giving up
|Integer
|
|The maximum number of subsequent failed virtual machine creations that can occur in a virtual machine pool before the operation is stopped.
|- style="vertical-align:top;"
|NumberofFailedRunsOnVds
|Number of Failed Runs on Host
|Integer
|
|Number of attempts to run virtual machines on hosts before setting host status to &quot;Error&quot;.
|- style="vertical-align:top;"
|NumberOfVmsForTopSizeVms
|Number of virtual machines with highest disk size to display
|Integer
|
|Number of virtual machines to display in the storage domain's virtual machine tab. Will display this amount of virtual machines, sorted by the most storage space per used virtual machine.
|- style="vertical-align:top;"
|NumberVmRefreshesBeforeSave
|Number of Virtual Machine Data Refreshes Before Saving to Database
|Integer
|
|The number of host monitor iterations between refreshing virtual machines from VDSM (determines if virtual machines should be refreshed one upon each iteration)
|- style="vertical-align:top;"
|OnlyRequiredNetworksMandatoryForVdsSelection
|Specifies whether only required networks will be considered for determining if a virtual machine can be run on a host
|String
|true
|If set to <code>true</code>, only networks marked as <code>Required</code> will be considered when determining if a virtual machine can be run on a given host. Otherwise, all networks that the virtual machine uses must be set up on a host for that host to be able to run the virtual machine.
|- style="vertical-align:top;"
|OverUtilizationForHaReservation
|A percentage representing the threshold for over-utilization compared to the optimal use case
|Integer
|
|Example - if the optimal number of highly available virtual machines for a given host is two, and this key is set to <code>200</code>, a highly available virtual machine will not be migrated using the balance method until there are at least five highly available virtual machines on that the given host.
|- style="vertical-align:top;"
|ScaleDownForHaReservation
|A number by which the high-availability reservation weight score is divided to produce the final weight score
|Integer
|
|Example - if the weight score for a host is 90 and this key is set to <code>2</code>, the final score for that host is 45. This allows you to reduce the effect of the high-availability reservation weight function has on the total scoring for a host.
|- style="vertical-align:top;"
|oVirtISOsRepositoryPath
|The oVirt Node installation files path
|String
|/usr/share/ovirt-hypervisor
|The location of oVirt Node ISO images used for upgrading Hypervisor hosts.
|- style="vertical-align:top;"
|EnableVdsHaReservation
|Specifies whether high-availability virtual machine reservation is enabled for a cluster
|Boolean
|true
|
|- style="vertical-align:top;"
|VdsHaReservationIntervalInMinutes
|The period of time, in minutes, after which a cluster will be checked for high-availability reservation
|Integer
|
|
|- style="vertical-align:top;"
|DefaultMaximumMigrationDowntime
|The maximum time a virtual machine can be down during live migration
|Integer
|
|If this key is set to <code>0</code>, the default value for VDSM will be used.
|- style="vertical-align:top;"
|PollUri
|The URI used for accessing the attestation service
|String
|AttestationService/resources/PollHosts
|
|- style="vertical-align:top;"
|ProductKey2003
|Product Key (for Windows 2003)
|String
|
|Windows serial key to be used with sysprepped virtual machines created from a template.
|- style="vertical-align:top;"
|ProductKey2003x64
|Product Key (for Windows 2003 x64)
|String
|
|Windows serial key to be used with sysprepped virtual machines created from a template.
|- style="vertical-align:top;"
|ProductKey2008
|Product Key (for Windows 2008)
|String
|
|Windows serial key to be used with sysprepped virtual machines created from a template.
|- style="vertical-align:top;"
|ProductKey2008R2
|Product Key (for Windows 2008 R2)
|String
|
|Windows serial key to be used with sysprepped virtual machines created from a template.
|- style="vertical-align:top;"
|ProductKey2008x64
|Product Key (for Windows 2008 x64)
|String
|
|Windows serial key to be used with sysprepped virtual machines created from a template.
|- style="vertical-align:top;"
|ProductKey
|Product Key (for Windows XP)
|String
|
|Windows serial key to be used with sysprepped virtual machines created from a template.
|- style="vertical-align:top;"
|ProductKeyWindow7
|Product Key (for Windows 7)
|String
|
|Windows serial key to be used with sysprepped virtual machines created from a template.
|- style="vertical-align:top;"
|ProductKeyWindow7x64
|Product Key (for Windows 7 x64)
|String
|
|Windows serial key to be used with sysprepped virtual machines created from a template.
|- style="vertical-align:top;"
|ProductRPMVersion
|oVirt RPM Version
|String
|Automatically populated
|The RPM version of the currently used rhevm package.
|- style="vertical-align:top;"
|SANWipeAfterDelete
|Initializing disk image is more secure but it can be time consuming and I/O intensive depending on the size of the image
|String
|false
|Determines the default value (checked/unchecked) of the '''Wipe After Delete''' check box in the '''New Virtual Disk''' window. This is relevant for disks being created on SAN-based storage domains (FC/iSCSI).
|- style="vertical-align:top;"
|SASL_QOP
|SASL quality of protection
|String
|auth-conf
|Determines the quality of protection in authentication and LDAP queries (auth, auth-int, auth-conf).
|- style="vertical-align:top;"
|SearchResultsLimit
|Max Quantity of Search Results
|Integer
|
|The number of results to return for search queries if no specific figure is given in the web administration portal or REST.
|- style="vertical-align:top;"
|SecureConnectionWithOATServers
|Determine whether use secure communication or not to access attestation service
|Boolean
|true
|
|- style="vertical-align:top;"
|ServerRebootTimeout
|Host Reboot Timeout (in seconds)
|Integer
|
|Wait this amount of seconds when a host is rebooted or fenced, before determining that the host is <code>Non Responsive</code>. Can be increased for hosts that take longer to reboot.
|- style="vertical-align:top;"
|SpiceProxyDefault
|The address of the SPICE Proxy.
|String
|none
|When this key is set to a value, the SPICE proxy is activated (turned on). When this key is not set to a value, the SPICE proxy is not activated (turned off).
|- style="vertical-align:top;"
|SpiceReleaseCursorKeys
|Keyboard keys combination that causes the mouse cursor to be released from its grab on SPICE
|String
|Shift+F12
|
|- style="vertical-align:top;"
|SpiceSecureChannels
|SPICE Secure Channels
|String
|smain, sinputs, scursor, splayback, srecord, sdisplay, susbredir, ssmartcard
|Which SPICE channels should be secured with SSL.
|- style="vertical-align:top;"
|SpiceToggleFullScreenKeys
|Keyboard keys combination that toggles the full-screen state of SPICE client window
|String
|Shift+F11
|
|- style="vertical-align:top;"
|SpiceUsbAutoShare
|Enable USB devices sharing by default in SPICE
|String
|true
|Represents the default value (checked/unchecked) of the '''Enable USB Auto-Share''' check box in the '''Console Options''' dialog in the User Portal.
|- style="vertical-align:top;"
|SpmCommandFailOverRetries
|Number of retries to failover the Storage Pool Manager on failed commands
|Integer
|
|Number of SPM selection failover retries. In case an SPM command fails, back end performs a failover - it selects a new SPM and re-runs the command.
|- style="vertical-align:top;"
|SPMFailOverAttempts
|Number of attempts to connect to the Storage Pool Manager before Failover
|Integer
|
|When monitoring a Storage Pool, if the current SPM fails, failover does not happen immediately (see description of SpmCommandFailOverRetries). This setting defines the number of retries before deciding that the current SPM is down and a failover is required.
|- style="vertical-align:top;"
|SpmVCpuConsumption
|The CPU consumption of SPM embodied as number of VCPUs on the Host
|Integer
|
|When a host is the SPM, it is considered to be using this amount of extra virtual CPUs, to make up for the overhead that SPM operations generate.
|- style="vertical-align:top;"
|SSHInactivityTimoutSeconds
|SSH Inactivity Timeout (in seconds)
|Integer
|
|The maximum amount of time back end allows for an SSH session to remote hosts. After this timeout the session is killed.
|- style="vertical-align:top;"
|SSHInactivityHardTimoutSeconds
|SSH Inactivity Hard Timeout (in seconds)
|Integer
|
|
|- style="vertical-align:top;"
|NumberOfUSBSlots
|Number of USB slots in virtual machines with native USB support
|Integer
|
|
|- style="vertical-align:top;"
|SchedulerAllowOverBooking
|Specify whether scheduler resource synchronization will be skipped
|Boolean
|false
|If scheduler resource synchronization is skipped, it may lead to more requests being scheduled than can be fulfilled.
|- style="vertical-align:top;"
|SchedulerOverBookingThreshold
|Determines the threshold for pending Scheduling requests before Scheduling resource synchronization is skipped
|Integer
|
|This option is used when <code>SchedulerAllowOverBooking</code> is set to <code>true</code>.
|- style="vertical-align:top;"
|SSLEnabled
|SPICE SSL Enabled
|String
|true
|Whether SPICE Secure channels should be encrypted using SSL.
|- style="vertical-align:top;"
|StorageDomainFailureTimeoutInMinutes
|Storage Domain failure timeout
|Integer
|
|Defines the amount of time taken before deciding domain is problematic, starting at the first failure reported by VDSM (in minutes).
|- style="vertical-align:top;"
|StoragePoolRefreshTimeInSeconds
|Storage Pool Manager Polling Rate (in seconds)
|Integer
|
|Storage Pool monitoring frequency.
|- style="vertical-align:top;"
|SysPrep2K3Path
|Path to a Windows 2003 machine sysprep file
|String
|
|Path to the operating system specific sysprep file template.
|- style="vertical-align:top;"
|SysPrep2K8Path
|Path to a Windows 2008 machine sysprep file
|String
|
|Path to the operating system specific sysprep file template.
|- style="vertical-align:top;"
|SysPrep2K8R2Path
|Path to a Windows 2008 R2 machine sysprep file
|String
|
|Path to the operating system specific sysprep file template.
|- style="vertical-align:top;"
|SysPrep2K8x64Path
|Path to a Windows 2008 machine sysprep file
|String
|
|Path to the operating system specific sysprep file template.
|- style="vertical-align:top;"
|SysPrepWindows7Path
|Path to a Windows 7 machine sysprep file
|String
|
|Path to the operating system specific sysprep file template.
|- style="vertical-align:top;"
|SysPrepWindows7x64Path
|Path to a Windows 7 x64 machine sysprep file
|String
|
|Path to the operating system specific sysprep file template.
|- style="vertical-align:top;"
|SysPrepWindows8Path
|Path to a Windows 8 machine Sys-Prep file
|String
|
|Path to the operating system specific sysprep file template.
|- style="vertical-align:top;"
|SysPrepWindows8x64Path
|Path to a Windows 8 x64 machine Sys-Prep file
|String
|
|Path to the operating system specific sysprep file template.
|- style="vertical-align:top;"
|SysPrepWindows2012x64Path
|Path to a Windows 2012 x64 machine Sys-Prep file
|String
|
|Path to the operating system specific sysprep file template.
|- style="vertical-align:top;"
|SysPrepXPPath
|Path to a Windows XP machine sysprep file
|String
|
|Path to the operating system specific sysprep file template.
|- style="vertical-align:top;"
|TimeoutToResetVdsInSeconds
|Communication timeout in seconds before attempting reset
|Integer
|
|The amount of time a host is unresponsive before a fence command is issued. This is used in conjunction with ''<code>VDSAttemptsToResetCount</code>''.
|- style="vertical-align:top;"
|TimeToReduceFailedRunOnVdsInMinutes
|Time to Reduce Failed Run on Host (in minutes)
|Integer
|
|The amount of time that the host will be in Error status after failing to run virtual machines.
|- style="vertical-align:top;"
|UserDefinedVMProperties
|User-defined virtual machine properties
|String
|
|Mostly used with VDSM hooks.
|- style="vertical-align:top;"
|UseFqdnForRdpIfAvailable
|Specify whether the fully qualified domain name will be used in connections using the RDP console protocol
|Boolean
|true
|If this option is enabled, the RDP console will use the fully qualified domain name of the virtual machine, if available, as reported by the guest agent. This fully qualified domain name is then used to establish the connection.
|- style="vertical-align:top;"
|UserRefreshRate
|Refresh Rate of Users' Data from Active Directory (in seconds)
|Integer
|
|How often the directory server is polled for user account updates.
|- style="vertical-align:top;"
|UtilizationThresholdInPercent
|The Utilization Threshold (in percent)
|Integer
|
|In load balancing, this is a default value used to calculate the maximum CPU limit to determine if the host is over-utilized. This is the percent of the value that the user set in high-utilization in the cluster.
|- style="vertical-align:top;"
|ValidNumOfMonitors
|Valid Numbers of Monitors
|Integer
|
|Number of monitors available for SPICE-enabled virtual machines.
|- style="vertical-align:top;"
|VdcVersion
|oVirt Version
|String
|
|Automatically set to the current version of oVirt
|- style="vertical-align:top;"
|- style="vertical-align:top;"
|VDSAttemptsToResetCount
|Number of attempts to communicate with Host before trying to reset
|Integer
|
|The amount of times to retry communications with a host before a fence command is issued. Used in conjunction with ''<code>TimeoutToResetVdsInSeconds</code>''.
|- style="vertical-align:top;"
|VdsLoadBalancingeIntervalInMinutes
|Host Load Balancing Interval (in minutes)
|Integer
|
|The interval between running the virtual machines' load balancer in minutes (also defines the first invocation of the load balancer).
|- style="vertical-align:top;"
|VdsRecoveryTimeoutInMintues
|Host Timeout when Recovering (in minutes)
|Integer
|
|When VDSM fails/restarts, it can sometimes be in recovering mode (VDSM reports &quot;initializing&quot; or &quot;recovering from reports&quot;).
|- style="vertical-align:top;"
|VdsRefreshRate
|Time interval in seconds to poll a Host's status
|Integer
|
|How often a Hypervisor host's status is checked.
|- style="vertical-align:top;"
|vdsTimeout
|Host Control Communication Timeout (in seconds)
|Integer
|
|Timeout for a VDSM call - the time engine will wait for sync call to VDSM.
|- style="vertical-align:top;"
|vdsConnectionTimeout
|VDS connection timeout value
|Integer
|
|The time to wait, in seconds, for establishment of a connection with a host.
|- style="vertical-align:top;"
|vdsRetries
|Number of times to retry VDS-related host operations
|Integer
|
|The number of times to retry host operations in the event of communication errors.
|- style="vertical-align:top;"
|VM32BitMaxMemorySizeInMB
|Maximum memory for 32-bit virtual machines
|Integer
|
|The maximum memory size, in MB, for 32-bit virtual machines.
|- style="vertical-align:top;"
|VM64BitMaxMemorySizeInMB
|Maximum memory for 64-bit virtual machines
|Integer
|v3.0: 524288
v3.1: 2097152
v3.2: 2097152
v3.3: 2097152
v3.4: 2097152
| 
|- style="vertical-align:top;"
|VmGracefulShutdownMessage
|Message displayed in Virtual Machine when Virtual Machine is being shut down from oVirt
|String
|
|System Administrator has initiated shutdown of this Virtual Machine. Virtual Machine is shutting down.
|- style="vertical-align:top;"
|- style="vertical-align:top;"
|VMMinMemorySizeInMB
|Minimal memory size of virtual machine in MB
|Integer
|
|
|- style="vertical-align:top;"
|VncKeyboardLayout
|Keyboard Layout configuration for VNC
|String
|en-us
|Possible values: ar, da, de-ch, en-us, et, fo, fr-be, fr-ch, hu, it, li, mk, nl, no, pt, ru, sv, tr, de en-gb, es, fi, fr, fr-ca, hr, is, ja, lv, nl-be, pl, pt-br, sl, th.
|- style="vertical-align:top;"
|WaitForVdsInitInSec
|Wait for a host to complete init in SPM selection
|Integer
|
|This is a timeout for initializing host as in ''<code>VdsRecoveryTimeoutInMinutes</code>'', but this timeout is shorter and is used during the SPM selection algorithm. If the selected host is initialized, wait for it to recover.
|- style="vertical-align:top;"
|FenceQuietTimeBetweenOperationsInSec
|Quiet time between Power Management operations in seconds
|Integer
|
|The minimum time in seconds between two power management operations activated manually by a user.
|- style="vertical-align:top;"
|FenceProxyDefaultPreferences
|The default preferences for fencing proxies
|String
|cluster,dc
|The default fencing proxy preferences used to define how to search for a proxy host in fencing operations.
|- style="vertical-align:top;"
|MaxAuditLogMessageLength
|Maximum length of an Audit Log message
|Integer
|
|
|- style="vertical-align:top;"
|SysPrepDefaultUser
|Default sysprep user name
|String
|
|This user is used if the domain for sysprep is unknown or no domain is specified.
|- style="vertical-align:top;"
|SysPrepDefaultPassword
|Default SysPrep user password
|Password
|Empty
|This password is used if the domain for sysprep is unknown or no domain is specified.
|- style="vertical-align:top;"
|QoSInboundAverageDefaultValue
|The average quality of service for inbound network traffic
|Integer
|
|The average quality of service for inbound network traffic, in Mbps.
|- style="vertical-align:top;"
|QoSInboundPeakDefaultValue
|The quality of service for inbound network traffic during peak times
|Integer
|
|The quality of service for inbound network traffic during peak times, in Mbps.
|- style="vertical-align:top;"
|QoSInboundBurstDefaultValue
|The quality of service for inbound network traffic during bursts
|Integer
|
|The quality of service for inbound network traffic during bursts, in Mbps.
|- style="vertical-align:top;"
|QoSOutboundAverageDefaultValue
|The average quality of service for outbound network traffic
|Integer
|
|The average quality of service for outbound network traffic, in Mbps.
|- style="vertical-align:top;"
|QoSOutboundPeakDefaultValue
|The quality of service for outbound network traffic during peak times
|Integer
|
|The quality of service for outbound network traffic during peak times, in Mbps.
|- style="vertical-align:top;"
|QoSOutboundBurstDefaultValue
|The quality of service for outbound network traffic during bursts
|Integer
|
|The quality of service for outbound network traffic during bursts, in Mbps.
|- style="vertical-align:top;"
|UserSessionTimeOutInterval
|Session timeout interval in minutes
|Integer
|
|User session timeout. Global for all types of access - User Portal/Admin Portal/Web Admin/API.
|- style="vertical-align:top;"
|AdminPassword
|admin user password
|Password
|
|Password of admin user (used if no directory service is used for authentication).
|- style="vertical-align:top;"
|IPTablesConfig
|Iptables configuration used to auto-configure oVirt
|String
|
|The complete set of iptables rules that are used when automatic firewall configuration is selected when running the <code>engine-setup</code> command
|- style="vertical-align:top;"
|OvirtIsoPrefix
|oVirt ISOs files prefix
|String
|ovirt-node-iso, rhevh
|
|- style="vertical-align:top;"
|OvirtInitialSupportedIsoVersion
|oVirt node initial Supported ISO Version
|String
|
|
|- style="vertical-align:top;"
|VdsLocalDisksLowFreeSpace
|Amount of free disk space on a host local storage domain that should be considered low, in MB
|Integer
|
|Setting this value lower than the default of 1000 MB reduces the time available to add additional space to your data domains before virtual machine performance is affected. If you have many virtual machines, generating or receiving data, it may make sense to set this value higher.
|- style="vertical-align:top;"
|VdsLocalDisksCriticallyLowFreeSpace
|Amount of free disk space on a host local storage domain that should be considered critically low, in MB
|Integer
|
|Setting this value lower than the default of 500 MB reduces the time between when critical disk shortage messages begin being displayed and when virtual machine performance is affected. If you have many virtual machines, generating or receiving data quickly, you might find that the default value is too low, and does not provide enough time to add more storage.
|- style="vertical-align:top;"
|AllowDuplicateMacAddresses
|Enable duplicate MAC address for VM network interface
|String
|false
|If enabled, allows that the same MAC address be set explicitly on several virtual NICs. Otherwise, setting a MAC address that is already in use on another virtual NIC is prohibited.
|- style="vertical-align:top;"
|JobCleanupRateInMinutes
|Frequency of jobs cleanup process
|Integer
|
|
|- style="vertical-align:top;"
|SucceededJobCleanupTimeInMinutes
|Time to keep successfully ended jobs
|Integer
|
|
|- style="vertical-align:top;"
|FailedJobCleanupTimeInMinutes
|Time to keep failed jobs
|Integer
|
|
|- style="vertical-align:top;"
|VmPoolMonitorIntervalInMinutes
|Interval in minutes for monitoring number of prestarted virtual machines in virtual machine pools
|Integer
|
|
|- style="vertical-align:top;"
|UserMessageOfTheDay
|A message to be displayed in the User Portal login page
|String
| 
| 
|- style="vertical-align:top;"
|VmPoolMonitorBatchSize
|Maximum number of virtual machines that the virtual machine pool monitor will attempt to prestart in a single cycle
|Integer
|
|
|- style="vertical-align:top;"
|NetworkConnectivityCheckTimeoutInSeconds
|The time to wait before rolling back network changes in case the engine losses connectivity with the host in seconds
|Integer
|
|
|- style="vertical-align:top;"
|AllowClusterWithVirtGlusterEnabled
|Allows to create a Cluster with both Virt and Gluster services enabled
|String
|false
|If enabled, the user can create a cluster with both Virt and Gluster support or one of them, otherwise the user cannot create a cluster that supports both.
|- style="vertical-align:top;"
|EnableMACAntiSpoofingFilterRules
|Indicates if Network Filtering should be enabled or not
|String
|v3.0: false v3.1: false v3.2: true
|If enabled, MAC anti-spoofing rules are set on each virtual network interface card, ensuring that the Ethernet frames this network interface card sends have the source MAC that is assigned to it in the engine.
|- style="vertical-align:top;"
|EnableHostTimeDrift
|Indicates if host time-drift validation is enabled
|String
|false
|If time drift validation is enabled, oVirt will require that host system time be within a given variation of oVirt system time. The allowed difference is set by HostTimeDriftInSec
|- style="vertical-align:top;"
|EngineMode
|Engine working mode
|String
|Active
|
|- style="vertical-align:top;"
|HostTimeDriftInSec
|Allowed time drift between any Host and Engine
|Integer
|
|
|- style="vertical-align:top;"
|WebSocketProxy
|The location of a websocket proxy
|String
|
|The location of a websocket proxy. Possible values include <code>Off</code>, <code>Host:[port]</code>, <code>Engine:[port]</code>, ''[host name]'', or ''[ip address]'':''[port]''
|- style="vertical-align:top;"
|WebSocketProxyTicketValiditySeconds
|The time for which websocket proxy tickets are valid
|Integer
|
|The time, in seconds, for validity of tickets issued for a websocket proxy.
|}

== The Image Uploader Tool ==

=== The Image Uploader Tool ===

The <code>engine-image-uploader</code> command allows you to list export storage domains and upload virtual machine images in OVF format to an export storage domain and have them automatically recognized in oVirt.

<div class="alert alert-info">'''Note:''' The image uploader only supports gzip-compressed OVF files created by oVirt.</div>

The archive contains images and master directories in the following format:

<pre class="screen">|-- images
|   |-- [Image Group UUID]
|        |--- [Image UUID (this is the disk image)]
|        |--- [Image UUID (this is the disk image)].meta
|-- master
|   |---vms
|       |--- [UUID]
|             |--- [UUID].ovf</pre>

=== Syntax for the engine-image-uploader Command ===

The basic syntax for the image uploader command is:

<pre class="screen">engine-image-uploader [options] list
engine-image-uploader [options] upload [file].[file]...[file]</pre>
The image uploader command supports two actions - ''<code>list</code>'', and ''<code>upload</code>''.

* The ''<code>list</code>'' action lists the export storage domains to which images can be uploaded.
* The ''<code>upload</code>'' action uploads images to the specified export storage domain.

You must specify one of the above actions when you use the image uploader command. Moreover, you must specify at least one local file to use the ''<code>upload</code>'' action.

There are several parameters to further refine the <code>engine-image-uploader</code> command. You can set defaults for any of these parameters in the <code>/etc/ovirt-engine/imageuploader.conf</code> file.

'''General Options'''

; ''<code>-h</code>'', ''<code>--help</code>''
: Displays information on how to use the image uploader command.
; ''<code>--conf-file=[PATH]</code>''
: Sets ''[PATH]'' as the configuration file the command will to use. The default is <code>etc/ovirt-engine/imageuploader.conf</code>.
; ''<code>--log-file=[PATH]</code>''
: Sets ''[PATH]'' as the specific file name the command will use to write log output. The default is <code>/var/log/ovirt-engine/ovirt-image-uploader/ovirt-image-uploader-[date].log</code>.
; ''<code>--cert-file=[PATH]</code>''
: Sets ''[PATH]'' as the certificate for validating the engine. The default is <code>/etc/pki/ovirt-engine/ca.pem</code>.
; ''<code>--insecure</code>''
: Specifies that no attempt will be made to verify the engine.
; ''<code>--quiet</code>''
: Sets quiet mode, reducing console output to a minimum.
; ''<code>-v</code>'', ''<code>--verbose</code>''
: Sets verbose mode, providing more console output.
; ''<code>-f</code>'', ''<code>--force</code>''
: Force mode is necessary when the source file being uploaded has the same file name as an existing file in the destination export domain. This option forces the existing file to be overwritten.

'''oVirt Options'''

; ''<code>-u [USER]</code>'', ''<code>--user=[USER]</code>''
: Specifies the user whose credentials will be used to execute the command. The ''[USER]'' is specified in the format ''[username]''@''[domain]''. The user must exist in the specified domain and be known to oVirt.
; ''<code>-r [FQDN]</code>'', ''<code>--engine=[FQDN]</code>''
: Specifies the IP address or fully qualified domain name of oVirt from which the images will be uploaded. It is assumed that the image uploader is being run from the same machine on which oVirt is installed. The default value is <code>localhost:443</code>.

'''Export Storage Domain Options'''

The following options specify the export domain to which the images will be uploaded. These options cannot be used together; you must used either the ''<code>-e</code>'' option or the ''<code>-n</code>'' option.

; ''<code>-e</code>'' ''[EXPORT_DOMAIN]'', ''<code>--export-domain=[EXPORT_DOMAIN]</code>''
: Sets the storage domain ''EXPORT_DOMAIN'' as the destination for uploads.
; ''<code>-n</code>'' ''[NFSSERVER]'', ''<code>--nfs-server=[NFSSERVER]</code>''
: Sets the NFS path ''[NFSSERVER]'' as the destination for uploads.

'''Import Options'''

The following options allow you to customize which attributes of the images being uploaded are included when the image is uploaded to the export domain.

; ''<code>-i</code>'', ''<code>--ovf-id</code>''
: Specifies that the UUID of the image will not be updated. By default, the command generates a new UUID for images that are uploaded. This ensures there is no conflict between the id of the image being uploaded and the images already in the environment.
; ''<code>-d</code>'', ''<code>--disk-instance-id</code>''
: Specifies that the instance ID for each disk in the image will not be renamed. By default, the command generates new UUIDs for disks in images that are uploaded. This ensures there are no conflicts between the disks on the image being uploaded and the disks already in the environment.
; ''<code>-m</code>'', ''<code>--mac-address</code>''
: Specifies that network components in the image will not be removed from the image. By default, the command removes network interface cards from image being uploaded to prevent conflicts with network cards on other virtual machines already in the environment. If you do not use this option, you can use the Administration Portal to add network interface cards to newly imported images and oVirt will ensure there are no MAC address conflicts.
; ''<code>-N [NEW_IMAGE_NAME]</code>'', ''<code>--name=[NEW_IMAGE_NAME]</code>''
: Specifies a new name for the image being uploaded.

=== Creating an OVF Archive That is Compatible With the Image Uploader ===

'''Summary'''

You can create files that can be uploaded using the <code>engine-image-uploader</code> tool.

'''Procedure 16.2. Creating an OVF Archive That is Compatible With the Image Uploader'''

# Use oVirt to create an empty export domain. An empty export domain makes it easy to see which directory contains your virtual machine.
# Export your virtual machine to the empty export domain you just created.
# Log in to the storage server that serves as the export domain, find the root of the NFS share and change to the subdirectory under that mount point. You started with a new export domain, there is only one directory under the exported directory. It contains the <code>images/</code> and <code>master/</code> directories.
# Run the <code>tar -zcvf my.ovf images/ master/</code> command to create the tar/gzip ovf archive.
# Anyone you give the resulting ovf file to (in this example, called <code>my.ovf</code>) can import it to oVirt using the <code>engine-image-uploader</code> command.

'''Result'''

You have created a compressed OVF image file that can be distributed. Anyone you give it to can use the <code>engine-image-uploader</code> command to upload your image into their oVirt environment.

=== Basic engine-image-uploader Usage Examples ===

The following is an example of how to use the engine uploader command to list export storage domains:

'''Example 16.1. Listing export storage domains using the image uploader'''

<pre class="screen"># engine-image-uploader list
Please provide the REST API password for the admin@internal oVirt Engine user (CTRL+D to abort):
Export Storage Domain Name | Datacenter  | Export Domain Status
myexportdom               | Myowndc 　  | active</pre>

The following is an example of how to upload an Open Virtualization Format (ovf) file:

'''Example 16.2. Uploading a file using the image uploader'''

<pre class="screen"># engine-image-uploader -e myexportdom upload myrhel6.ovf
Please provide the REST API password for the admin@internal oVirt Engine user (CTRL+D to abort):</pre>

== The Log Collector Tool ==

=== Log Collector ===

A log collection tool is included in oVirt. This allows you to easily collect relevant logs from across the oVirt environment when requesting support.

The log collection command is <code>engine-log-collector</code>. You are required to log in as the <code>root</code> user and provide the administration credentials for the oVirt environment. The <code>engine-log-collector -h</code> command displays usage information, including a list of all valid options for the <code>engine-log-collector</code> command.

=== Syntax for engine-log-collector Command ===

The basic syntax for the log collector command is:

<pre class="screen">engine-log-collector [options] list [all, clusters, datacenters]
engine-log-collector [options] collect</pre>
The two supported modes of operation are ''<code>list</code>'' and ''<code>collect</code>''.

* The ''<code>list</code>'' parameter lists either the hosts, clusters, or data centers attached to oVirt. You are able to filter the log collection based on the listed objects.
* The ''<code>collect</code>'' parameter performs log collection from oVirt. The collected logs are placed in an archive file under the <code>/tmp/logcollector</code> directory. The <code>engine-log-collector</code> command assigns each log a specific file name.

Unless another parameter is specified, the default action is to list the available hosts together with the data center and cluster to which they belong. You will be prompted to enter user names and passwords to retrieve certain logs.

There are numerous parameters to further refine the <code>engine-log-collector</code> command.

'''General options'''

; ''<code>--version</code>''
: Displays the version number of the command in use and returns to prompt.
; ''<code>-h</code>'', ''<code>--help</code>''
: Displays command usage information and returns to prompt.
; ''<code>--conf-file=PATH</code>''
: Sets ''PATH'' as the configuration file the tool is to use.
; ''<code>--local-tmp=PATH</code>''
: Sets ''PATH'' as the directory in which logs are saved. The default directory is <code>/tmp/logcollector</code>.
; ''<code>--ticket-number=TICKET</code>''
: Sets ''TICKET'' as the ticket, or case number, to associate with the SOS report.
; ''<code>--upload=FTP_SERVER</code>''
: Sets ''FTP_SERVER'' as the destination for retrieved logs to be sent using FTP. Do not use this option unless advised to by a Red Hat support representative.
; ''<code>--log-file=PATH</code>''
: Sets ''PATH'' as the specific file name the command should use for the log output.
; ''<code>--quiet</code>''
: Sets quiet mode, reducing console output to a minimum. Quiet mode is off by default.
; ''<code>-v</code>'', ''<code>--verbose</code>''
: Sets verbose mode, providing more console output. Verbose mode is off by default.

'''oVirt Options'''

These options filter the log collection and specify authentication details for oVirt.

These parameters can be combined for specific commands. For example, <code>engine-log-collector --user=admin@internal --cluster ClusterA,ClusterB --hosts &quot;SalesHost&quot;*</code> specifies the user as <code>admin@internal</code> and limits the log collection to only <code>SalesHost</code> hosts in clusters <code>A</code> and <code>B</code>.

; ''<code>--no-hypervisors</code>''
: Omits virtualization hosts from the log collection.
; ''<code>-u USER</code>'', ''<code>--user=USER</code>''
: Sets the user name for login. The ''USER'' is specified in the format ''user''@''domain'', where ''user'' is the user name and ''domain'' is the directory services domain in use. The user must exist in directory services and be known to oVirt.
; ''<code>-r FQDN</code>'', ''<code>--rhevm=FQDN</code>''
: Sets the fully qualified domain name of oVirt server from which to collect logs, where ''FQDN'' is replaced by the fully qualified domain name of oVirt. It is assumed that the log collector is being run on the same local host as oVirt; the default value is <code>localhost</code>.
; ''<code>-c CLUSTER</code>'', ''<code>--cluster=CLUSTER</code>''
: Collects logs from the virtualization hosts in the nominated ''CLUSTER'' in addition to logs from oVirt. The cluster(s) for inclusion must be specified in a comma-separated list of cluster names or match patterns.
; ''<code>-d DATACENTER</code>'', ''<code>--data-center=DATACENTER</code>''
: Collects logs from the virtualization hosts in the nominated ''DATACENTER'' in addition to logs from oVirt. The data center(s) for inclusion must be specified in a comma-separated list of data center names or match patterns.
; ''<code>-H HOSTS_LIST</code>'', ''<code>--hosts=HOSTS_LIST</code>''
: Collects logs from the virtualization hosts in the nominated ''HOSTS_LIST'' in addition to logs from oVirt. The hosts for inclusion must be specified in a comma-separated list of host names, fully qualified domain names, or IP addresses. Match patterns are also valid.

'''SOS Report Options'''

The log collector uses the JBoss SOS plugin. Use the following options to activate data collection from the JMX console.

; ''<code>--jboss-home=JBOSS_HOME</code>''
: JBoss installation directory path. The default is <code>/var/lib/jbossas</code>.
; ''<code>--java-home=JAVA_HOME</code>''
: Java installation directory path. The default is <code>/usr/lib/jvm/java</code>.
; ''<code>--jboss-profile=JBOSS_PROFILE</code>''
: Displays a quoted and space-separated list of server profiles; limits log collection to specified profiles. The default is ''<code>'rhevm-slimmed'</code>''.
; ''<code>--enable-jmx</code>''
: Enables the collection of run-time metrics from oVirt's JBoss JMX interface.
; ''<code>--jboss-user=JBOSS_USER</code>''
: User with permissions to invoke JBoss JMX. The default is ''<code>admin</code>''.
; ''<code>--jboss-logsize=LOG_SIZE</code>''
: Maximum size in MB for the retrieved log files.
; ''<code>--jboss-stdjar=STATE</code>''
: Sets collection of JAR statistics for JBoss standard JARs. Replace ''STATE'' with <code>on</code> or <code>off</code>. The default is <code>on</code>.
; ''<code>--jboss-servjar=STATE</code>''
: Sets collection of JAR statistics from any server configuration directories. Replace ''STATE'' with <code>on</code> or <code>off</code>. The default is <code>on</code>.
; ''<code>--jboss-twiddle=STATE</code>''
: Sets collection of twiddle data on or off. Twiddle is the JBoss tool used to collect data from the JMX invoker. Replace ''STATE'' with <code>on</code> or <code>off</code>. The default is <code>on</code>.
; ''<code>--jboss-appxml=XML_LIST</code>''
: Displays a quoted and space-separated list of applications with XML descriptions to be retrieved. Default is <code>all</code>.

'''SSH Configuration'''

; ''<code>--ssh-port=PORT</code>''
: Sets ''PORT'' as the port to use for SSH connections with virtualization hosts.
; ''<code>-k KEYFILE</code>'', ''<code>--key-file=KEYFILE</code>''
: Sets ''KEYFILE'' as the public SSH key to be used for accessing the virtualization hosts.
; ''<code>--max-connections=MAX_CONNECTIONS</code>''
: Sets ''MAX_CONNECTIONS'' as the maximum concurrent SSH connections for logs from virtualization hosts. The default is <code>10</code>.

'''PostgreSQL Database Options'''

The database user name and database name must be specified, using the ''<code>pg-user</code>'' and ''<code>dbname</code>'' parameters, if they have been changed from the default values.

Use the ''<code>pg-dbhost</code>'' parameter if the database is not on the local host. Use the optional ''<code>pg-host-key</code>'' parameter to collect remote logs. The PostgreSQL SOS plugin must be installed on the database server for remote log collection to be successful.

; ''<code>--no-postgresql</code>''
: Disables collection of database. The log collector will connect to oVirt PostgreSQL database and include the data in the log report unless the ''<code>--no-postgresql</code>'' parameter is specified.
; ''<code>--pg-user=USER</code>''
: Sets ''USER'' as the user name to use for connections with the database server. The default is <code>postgres</code>.
; ''<code>--pg-dbname=DBNAME</code>''
: Sets ''DBNAME'' as the database name to use for connections with the database server. The default is <code>rhevm</code>.
; ''<code>--pg-dbhost=DBHOST</code>''
: Sets ''DBHOST'' as the host name for the database server. The default is <code>localhost</code>.
; ''<code>--pg-host-key=KEYFILE</code>''
: Sets ''KEYFILE'' as the public identity file (private key) for the database server. This value is not set by default; it is required only where the database does not exist on the local host.

=== Basic Log Collector Usage ===

When the <code>engine-log-collector</code> command is run without specifying any additional parameters, its default behavior is to collect all logs from oVirt and its attached hosts. It will also collect database logs unless the ''<code>--no-postgresql</code>'' parameter is added. In the following example, log collector is run to collect all logs from oVirt and three attached hosts.

'''Example 16.3. Log Collector Usage'''

<pre class="screen"># engine-log-collector
INFO: Gathering oVirt Engine information...
INFO: Gathering PostgreSQL the oVirt Engine database and log files from localhost...
Please provide REST API password for the admin@internal oVirt Engine user (CTRL+D to abort):
About to collect information from 3 hypervisors. Continue? (Y/n):
INFO: Gathering information from selected hypervisors...
INFO: collecting information from 192.168.122.250
INFO: collecting information from 192.168.122.251
INFO: collecting information from 192.168.122.252
INFO: finished collecting information from 192.168.122.250
INFO: finished collecting information from 192.168.122.251
INFO: finished collecting information from 192.168.122.252
Creating compressed archive...
INFO Log files have been collected and placed in /tmp/logcollector/sosreport-rhn-account-20110804121320-ce2a.tar.xz.
The MD5 for this file is 6d741b78925998caff29020df2b2ce2a and its size is 26.7M</pre>

== The ISO Uploader Tool ==

=== The ISO Uploader Tool ===

The ISO uploader is a tool for uploading ISO images to the ISO storage domain. It is installed as part of oVirt.

The ISO uploader command is <code>engine-iso-uploader</code>. You must log in as the <code>root</code> user and provide the administration credentials for the oVirt environment to use this command. The <code>engine-iso-uploader -h</code> command displays usage information, including a list of all valid options for the <code>engine-iso-uploader</code> command.

=== Syntax for the engine-iso-uploader Command ===

The basic syntax for the ISO uploader command is:

<pre class="screen">engine-iso-uploader [options] list
engine-iso-uploader [options] upload [file].[file]...[file]</pre>
The ISO uploader command supports two actions - ''<code>list</code>'', and ''<code>upload</code>''.

* The ''<code>list</code>'' action lists the ISO storage domains to which ISO files can be uploaded. oVirt creates this list on the machine on which oVirt is installed during the installation process.
* The ''<code>upload</code>'' action uploads a single ISO file or multiple ISO files separated by spaces to the specified ISO storage domain. NFS is used by default, but SSH is also available.

You must specify one of the above actions when you use the ISO uploader command. Moreover, you must specify at least one local file to use the ''<code>upload</code>'' action.

There are several parameters to further refine the <code>engine-iso-uploader</code> command.

'''General Options'''

; ''<code>--version</code>''
: Displays the version of the ISO uploader command.
; ''<code>-h</code>'', ''<code>--help</code>''
: Displays information on how to use the ISO uploader command.
; ''<code>--conf-file=[PATH]</code>''
: Sets ''[PATH]'' as the configuration file the command will to use. The default is <code>/etc/ovirt-engine/isouploader.conf</code>.
; ''<code>--log-file=[PATH]</code>''
: Sets ''[PATH]'' as the specific file name the command will use to write log output. The default is <code>/var/log/ovirt-engine/ovirt-iso-uploader/ovirt-iso-uploader[date].log</code>.
; ''<code>--cert-file=[PATH]</code>''
: Sets ''[PATH]'' as the certificate for validating the engine. The default is <code>/etc/pki/ovirt-engine/ca.pem</code>.
; ''<code>--insecure</code>''
: Specifies that no attempt will be made to verify the engine.
; ''<code>--nossl</code>''
: Specifies that SSL will not be used to connect to the engine.
; ''<code>--quiet</code>''
: Sets quiet mode, reducing console output to a minimum.
; ''<code>-v</code>'', ''<code>--verbose</code>''
: Sets verbose mode, providing more console output.
; ''<code>-f</code>'', ''<code>--force</code>''
: Force mode is necessary when the source file being uploaded has the same file name as an existing file in the destination ISO domain. This option forces the existing file to be overwritten.

'''oVirt Options'''

; ''<code>-u [USER]</code>'', ''<code>--user=[USER]</code>''
: Specifies the user whose credentials will be used to execute the command. The ''[USER]'' is specified in the format ''[username]''@''[domain]''. The user must exist in the specified domain and be known to oVirt.
; ''<code>-r [FQDN]</code>'', ''<code>--engine=[FQDN]</code>''
: Specifies the IP address or fully qualified domain name of oVirt from which the images will be uploaded. It is assumed that the image uploader is being run from the same machine on which oVirt is installed. The default value is <code>localhost:443</code>.

'''ISO Storage Domain Options'''

The following options specify the ISO domain to which the images will be uploaded. These options cannot be used together; you must used either the ''<code>-i</code>'' option or the ''<code>-n</code>'' option.

; ''<code>-i</code>'', ''<code>--iso-domain=[ISODOMAIN]</code>''
: Sets the storage domain ''[ISODOMAIN]'' as the destination for uploads.
; ''<code>-n</code>'', ''<code>--nfs-server=[NFSSERVER]</code>''
: Sets the NFS path ''[NFSSERVER]'' as the destination for uploads.

'''Connection Options'''

The ISO uploader uses NFS as default to upload files. These options specify SSH file transfer instead.

; ''<code>--ssh-user=[USER]</code>''
: Sets ''[USER]'' as the SSH user name to use for the upload. The default is <code>root</code>.
; ''<code>--ssh-port=[PORT]</code>''
: Sets ''[PORT]'' as the port to use when connecting to SSH.
; ''<code>-k [KEYFILE]</code>'', ''<code>--key-file=[KEYFILE]</code>''
: Sets ''[KEYFILE]'' as the public key to use for SSH authentication. You will be prompted to enter the password of the user specified with ''<code>--ssh-user=[USER]</code>'' if no key is set.

= Log Files =

== oVirt Installation Log Files ==

⁠

'''Table 17.1. Installation'''

{| class="wikitable"
!width="50%"|Log File
!width="50%"|Description
|- style="vertical-align:top;"
|<code>/var/log/ovirt-engine/engine-cleanup_yyyy_mm_dd_hh_mm_ss.log</code>
|Log from the <code>engine-cleanup</code> command. This is the command used to reset an oVirt installation. A log is generated each time the command is run. The date and time of the run is used in the filename to allow multiple logs to exist.
|- style="vertical-align:top;"
|<code>/var/log/ovirt-engine/engine-db-install-yyyy_mm_dd_hh_mm_ss.log</code>
|Log from the <code>engine-setup</code> command detailing the creation and configuration of the <code>rhevm</code> database.
|- style="vertical-align:top;"
|<code>/var/log/ovirt-engine/rhevm-dwh-setup-yyyy_mm_dd_hh_mm_ss.log</code>
|Log from the <code>rhevm-dwh-setup</code> command. This is the command used to create the <code>ovirt_engine_history</code> database for reporting. A log is generated each time the command is run. The date and time of the run is used in the filename to allow multiple logs to exist concurrently.
|- style="vertical-align:top;"
|<code>/var/log/ovirt-engine/ovirt-engine-reports-setup-yyyy_mm_dd_hh_mm_ss.log</code>
|Log from the <code>rhevm-reports-setup</code> command. This is the command used to install oVirt Reports modules. A log is generated each time the command is run. The date and time of the run is used in the filename to allow multiple logs to exist concurrently.
|- style="vertical-align:top;"
|<code>/var/log/ovirt-engine/setup/ovirt-engine-setup-yyyymmddhhmmss.log</code>
|Log from the <code>engine-setup</code> command. A log is generated each time the command is run. The date and time of the run is used in the filename to allow multiple logs to exist concurrently.
|}

== oVirt Log Files ==

'''Table 17.2. Service Activity'''

{| class="wikitable"
!width="50%"|Log File
!width="50%"|Description
|- style="vertical-align:top;"
|<code>/var/log/ovirt-engine/engine.log</code>
|Reflects all oVirt GUI crashes, Active Directory look-ups, Database issues, and other events.
|- style="vertical-align:top;"
|<code>/var/log/ovirt-engine/host-deploy</code>
|Log files from hosts deployed from oVirt.
|- style="vertical-align:top;"
|<code>/var/lib/ovirt-engine/setup-history.txt</code>
|Tracks the installation and upgrade of packages associated with oVirt.
|}

== oVirt Host Log Files ==

'''Table 17.3.  Host Log Files'''

{| class="wikitable"
!width="50%"|Log File
!width="50%"|Description
|- style="vertical-align:top;"
|<code>/var/log/vdsm/libvirt.log</code>
|Log file for <code>libvirt</code>.
|- style="vertical-align:top;"
|<code>/var/log/vdsm/spm-lock.log</code>
|Log file detailing the host's ability to obtain a lease on the Storage Pool Manager role. The log details when the host has acquired, released, renewed, or failed to renew the lease.
|- style="vertical-align:top;"
|<code>/var/log/vdsm/vdsm.log</code>
|Log file for VDSM, oVirt's agent on the virtualization host(s).
|- style="vertical-align:top;"
|<code>/tmp/ovirt-host-deploy-@DATE@.log</code>
|Host deployment log, copied to engine as /var/log/ovirt-engine/host-deploy/ovirt-''@DATE@-@HOST@-@CORRELATION_ID@''.log after the host has been successfully deployed.
|}

== Remotely Logging Host Activities ==

=== Setting Up a Virtualization Host Logging Server ===

'''Summary'''

oVirt hosts generate and update log files, recording their actions and problems. Collecting these log files centrally simplifies debugging.

This procedure should be used on your centralized log server. You could use a separate logging server, or use this procedure to enable host logging on oVirt.

'''Procedure 17.1. Setting up a Virtualization Host Logging Server'''

<ol>
<li>Configure SELinux to allow '''rsyslog''' traffic.<br>
<pre class="screen"># semanage port -a -t syslogd_port_t -p udp 514</pre></li>
<li>Edit <code>/etc/rsyslog.conf</code> and add below lines:<br>
<pre class="screen">$template TmplAuth, &quot;/var/log/%fromhost%/secure&quot; 
$template TmplMsg, &quot;/var/log/%fromhost%/messages&quot; 

$RuleSet remote
authpriv.*   ?TmplAuth
*.info,mail.none;authpriv.none,cron.none   ?TmplMsg
$RuleSet RSYSLOG_DefaultRuleset
$InputUDPServerBindRuleset remote</pre><br>
Uncomment the following:<br>
<pre class="screen">#$ModLoad imudp
#$UDPServerRun 514</pre></li>
<li>Restart the rsyslog service:<br>
<pre class="screen"># service rsyslog restart</pre></li></ol>

'''Result'''

Your centralized log server is now configured to receive and store the <code>messages</code> and <code>secure</code> logs from your virtualization hosts.

=== Configuring oVirt Node Hosts to Use a Logging Server ===

'''Summary'''

oVirt hosts generate and update log files, recording their actions and problems. Collecting these log files centrally simplifies debugging.

Use this procedure on an oVirt Node host to begin sending log files to your centralized log server.

⁠

'''Procedure 17.2. Configuring oVirt Node Hosts to Use a Logging Server'''

# Log in to your oVirt Node host as <code>admin</code> to access the Hypervisors text user interface (TUI) setup screen.
# Select '''Logging''' from the list of options on the left of the screen.
# Press the '''Tab''' key to reach the text entry fields. Enter the IP address or FQDN of your centralized log server and the port it uses.
# Press the '''Tab''' key to reach the '''Apply''', and press the '''Enter''' Key.

'''Result'''

Your oVirt Node host has been configured to send messages to a centralized log server.

= ⁠Proxies =

== SPICE Proxy ==

=== SPICE Proxy Overview ===

The SPICE Proxy is a tool used to connect SPICE Clients to guests when the SPICE Clients are outside the network that connects the hypervisors.

Setting up a SPICE Proxy consists of installing '''Squid''' on a machine and configuring '''iptables''' to allow proxy traffic through the firewall.

Turning a SPICE Proxy on consists of using '''engine-config''' on oVirt to set the key <code>SpiceProxyDefault</code> to a value consisting of the name and port of the proxy.

Turning a SPICE Proxy off consists of using '''engine-config''' on oVirt to remove the value that the key <code>SpiceProxyDefault</code> has been set to.

=== SPICE Proxy Machine Setup ===

'''Summary'''

This procedure explains how to set up a machine as a SPICE Proxy. A SPICE Proxy makes it possible to connect to the oVirt network from outside the network. We use '''Squid''' in this procedure to provide proxy services.

'''Procedure 18.1. Installing Squid on a RHEL Machine'''

<ol>
<li>Install '''Squid''' on the Proxy machine:<br>
<pre class="screen"># yum install squid</pre></li>
<li>Open <code>/etc/squid/squid.conf</code>. Change<br>
<pre class="screen">http_access deny CONNECT !SSL_ports</pre><br>
to<br>
<pre class="screen">http_access deny CONNECT !Safe_ports</pre></li>
<li>Restart the proxy:<br>
<pre class="screen"># service squid restart</pre></li>
<li>Open the default squid port:<br>
<pre class="screen"># iptables -A INPUT -p tcp --dport 3128 -j ACCEPT</pre></li>
<li>Make this iptables rule persistent:<br>
<pre class="screen"># iptables-save</pre></li></ol>

'''Result'''

You have now set up a machine as a SPICE proxy. Before connecting to the oVirt network from outside the network, activate the SPICE proxy.

=== Turning on SPICE Proxy ===

'''Summary'''

This procedure explains how to activate (or turn on) the SPICE proxy.

'''Procedure 18.2. Activating SPICE Proxy'''

<ol>
<li>On oVirt, use the engine-config tool to set a proxy:<br>
<pre class="screen"># engine-config -s SpiceProxyDefault=someProxy</pre></li>
<li>Restart the '''ovirt-engine''' service:<br>
<pre class="screen"># service ovirt-engine restart</pre><br>
The proxy must have this form:<br>
<pre class="screen">protocol://[host]:[port]</pre>
<div class="alert alert-info">'''Note:''' Only the http protocol is supported by SPICE clients. If https is specified, the client will ignore the proxy setting and attempt a direct connection to the hypervisor</div></li></ol>

'''Result'''

SPICE Proxy is now activated (turned on). It is now possible to connect to the oVirt network through the SPICE proxy.

=== Turning Off a SPICE Proxy ===

'''Summary'''

This procedure explains how to turn off (deactivate) a SPICE proxy.

'''Procedure 18.3. Turning Off a SPICE Proxy'''

<ol>
<li>Log in to oVirt:<br>
<pre class="screen">$ ssh root@[IP of Manager]</pre></li>
<li>Run the following command to clear the SPICE proxy:<br>
<pre class="screen"># engine-config -s SpiceProxyDefault=&quot;&quot;</pre></li>
<li>Restart oVirt:<br>
<pre class="screen"># service ovirt-engine restart</pre></li></ol>

'''Result'''

SPICE proxy is now deactivated (turned off). It is no longer possible to connect to the oVirt network through the SPICE proxy.

== Squid Proxy ==

=== Installing and Configuring a Squid Proxy ===

'''Summary'''

This section explains how to install and configure a Squid Proxy to the User Portal.

'''Procedure 18.4. Configuring a Squid Proxy'''

<ol>
<li>'''Obtaining a Keypair'''<br>
Obtain a keypair and certificate for the HTTPS port of the Squid proxy server.<br>
You can obtain this keypair the same way that you would obtain a keypair for another SSL/TLS service. The keypair is in the form of two PEM files which contain the private key and the signed certificate. In this document we assume that they are named <code>proxy.key</code> and <code>proxy.cer</code>.<br>
The keypair and certificate can also be generated using the certificate authority of the oVirt engine. If you already have the private key and certificate for the proxy and do not want to generate it with the oVirt engine certificate authority, skip to the next step.</li>
<li>'''Generating a Keypair'''<br>
Decide on a host name for the proxy. In this procedure, the proxy is called <code>proxy.example.com</code>.<br>
Decide on the rest of the distinguished name of the certificate for the proxy. The important part here is the &quot;common name&quot;, which contains the host name of the proxy. Users' browsers use the common name to validate the connection. It is good practice to use the same country and same organization name used by the oVirt engine itself. Find this information by logging in to the oVirt engine machine and running the following command:<br>
<pre class="screen">[root@engine ~]# openssl x509 -in /etc/pki/ovirt-engine/ca.pem -noout -subject</pre><br>
This command will output something like this:<br>
<pre class="screen">subject= /C=US/O=Example Inc./CN=engine.example.com.81108</pre><br>
The relevant part here is <code>/C=us/O=Example Inc.</code>. Use this to build the complete distinguished name for the certificate for the proxy:<br>
<pre class="screen">/C=US/O=Example Inc./CN=proxy.example.com</pre><br>
Log in to the proxy machine and generate a certificate signing request:<br>
<pre class="screen">[root@proxy ~]# openssl req -newkey rsa:2048 -subj '/C=US/O=Example Inc./CN=proxy.example.com' -nodes -keyout proxy.key -out proxy.req</pre><br>
<div class="alert alert-info">'''Note:'''  The quotes around the distinguished name for the certificate are very important. Do not leave them out.</div><br>
The command will generate the key pair. It is very important that the private key is not encrypted (that is the effect of the -nodes option) because otherwise you would need to type the password to start the proxy server.<br>
The output of the command looks like this:<br>
<pre class="screen">Generating a 2048 bit RSA private key
......................................................+++
.................................................................................+++
writing new private key to 'proxy.key'
-----</pre><br>
The command will generate two files: <code>proxy.key</code> and <code>proxy.req</code>. <code>proxy.key</code> is the private key. Keep this file safe. <code>proxy.req</code> is the certificate signing request. <code>proxy.req</code> does not require any special protection.<br>
To generate the signed certificate, copy the <code>private.csr</code> file to the oVirt engine machine, using the '''scp''' command:<br>
<pre class="screen">[root@proxy ~]# scp proxy.req engine.example.com:/etc/pki/ovirt-engine/requests/.</pre><br>
Log in to the oVirt engine machine and run the following command to sign the certificate:<br>
<pre class="screen">[root@engine ~]# /usr/share/ovirt-engine/bin/pki-enroll-request.sh --name=proxy --days=3650 --subject='/C=US/O=Example Inc./CN=proxy.example.com'</pre><br>
This will sign the certificate and make it valid for 10 years (3650 days). Set the certificate to expire earlier, if you prefer.<br>
The output of the command looks like this:<br>
<pre class="screen">Using configuration from openssl.conf
Check that the request matches the signature
Signature ok
The Subject's Distinguished Name is as follows
countryName           :PRINTABLE:'US'
organizationName      :PRINTABLE:'Example Inc.'
commonName            :PRINTABLE:'proxy.example.com'
Certificate is to be certified until Jul 10 10:05:24 2023 GMT (3650
days)

Write out database with 1 new entries
Data Base Updated</pre><br>
The generated certificate file is available in the directory <code>/etc/pki/ovirt-engine/certs</code> and should be named <code>proxy.cer</code>. Copy this file to the proxy machine:<br>
<pre class="screen">[root@proxy ~]# scp engine.example.com:/etc/pki/ovirt-engine/certs/proxy.cer .</pre><br>
Make sure that both the <code>proxy.key</code> and <code>proxy.cer</code> files are present on the proxy machine:<br>
<pre class="screen">[root@proxy ~]# ls -l proxy.key proxy.cer</pre><br>
The output of this command will look like this:<br>
<pre class="screen">-rw-r--r--. 1 root root 4902 Jul 12 12:11 proxy.cer
-rw-r--r--. 1 root root 1834 Jul 12 11:58 proxy.key</pre><br>
You are now ready to install and configure the proxy server.</li>
<li>'''Install the Squid proxy server package'''<br>
Install this system as follows:<br>
<pre class="screen">[root@proxy ~]# yum -y install squid</pre></li>
<li>'''Configure the Squid proxy server'''<br>
Move the private key and signed certificate to a place where the proxy can access them, for example to the <code>/etc/squid</code> directory:<br>
<pre class="screen">[root@proxy ~]# cp proxy.key proxy.cer /etc/squid/.</pre><br>
Set permissions so that the &quot;squid&quot; user can read these files:<br>
<pre class="screen">[root@proxy ~]# chgrp squid /etc/squid/proxy.*
[root@proxy ~]# chmod 640 /etc/squid/proxy.*</pre><br>
The Squid proxy will connect to the oVirt engine web server using the SSL protocol, and must verify the certificate used by the engine. Copy the certificate of the CA that signed the certificate of the oVirt engine web server to a place where the proxy can access it, for example <code>/etc/squid</code>. The default CA certificate is located in the <code>/etc/pki/ovirt-engine/ca.pem</code> file in the oVirt engine machine. Copy it with the following command:<br>
<pre class="screen">[root@proxy ~]# scp engine.example.com:/etc/pki/ovirt-engine/ca.pem /etc/squid/.</pre><br>
Ensure the <code>squid</code> user can read that file:<br>
<pre class="screen">[root@proxy ~]# chgrp squid /etc/squid/ca.pem
[root@proxy ~]# chmod 640 /etc/squid/ca.pem</pre><br>
If SELinux is in enforcing mode, change the context of port 443 using the '''semanage''' tool. This permits Squid to use port 443.<br>
<pre class="screen">[root@proxy ~]# yum install -y policycoreutils-python
[root@proxy ~]# semanage port -m -p tcp -t http_cache_port_t 443</pre><br>
Replace the existing squid configuration file with the following:<br>
<pre class="screen">https_port 443 key=/etc/squid/proxy.key cert=/etc/squid/proxy.cer ssl-bump defaultsite=engine.example.com
cache_peer engine.example.com parent 443 0 no-query originserver ssl sslcafile=/etc/squid/ca.pem name=engine
cache_peer_access engine allow all
ssl_bump allow all
http_access allow all</pre></li>
<li>'''Restart the Squid Proxy Server'''<br>
Run the following command in the proxy machine:<br>
<pre class="screen">[root@proxy ~]# service squid restart</pre></li>
<li>'''Configure the websockets proxy'''<br>
<div class="alert alert-info">'''Note:''' This step is optional. Do this step only to use the noVNC console or the SPICE HTML 5 console.</div><br>
To use the noVNC or SPICE HTML 5 consoles to connect to the console of virtual machines, the websocket proxy server must be configured on the machine on which the engine is installed. If you selected to configure the websocket proxy server when prompted during installing or upgrading the engine with the <code>engine-setup</code> command, the websocket proxy server will already be configured. If you did not select to configure the websocket proxy server at this time, you can configure it later by running the <code>engine-setup</code> command with the following option:<br>
<pre class="screen">engine-setup --otopi-environment=&quot;OVESETUP_CONFIG/websocketProxyConfig=bool:True&quot;</pre><br>
You must also ensure the '''ovirt-websocket-proxy''' service is started and will start automatically on boot:<br>
<pre class="screen">[root@engine ~]# service ovirt-websocket-proxy status
[root@engine ~]# chkconfig ovirt-websocket-proxy on</pre><br>
Both the noVNC and the SPICE HTML 5 consoles use the websocket protocol to connect to the virtual machines, but squid proxy server does not support the websockets protocol, so this communication cannot be proxied with Squid. Tell the system to connect directly to the websockets proxy running in the machine where the engine is running. To do this, update the <code>WebSocketProxy</code> configuration parameter using the &quot;engine-config&quot; tool:<br>
<pre class="screen">[root@engine ~]# engine-config \
-s WebSocketProxy=engine.example.com:6100
[root@engine ~]# service ovirt-engine restart</pre><br>
<div class="alert alert-info">'''Important:''' If you skip this step the clients will assume that the websockets proxy is running in the proxy machine, and thus will fail to connect.</div></li>
<li>'''Connect to the User Portal using the complete URL'''<br>
Connect to the User Portal using the complete URL, for instance:<br>
<pre class="screen">https://proxy.example.com/UserPortal/org.ovirt.engine.ui.userportal.UserPortal/UserPortal.html</pre><br>
<div class="alert alert-info">'''Note:''' Shorter URLs, for example <code>https://proxy.example.com/UserPortal</code>, will not work. These shorter URLs are redirected to the long URL by the application server, using the 302 response code and the Location header. The version of '''Squid''' in Red Hat Enterprise Linux and Fedora ('''Squid''' version 3.1) does not support rewriting these headers.</div></li></ol>
'''Summary'''

You have installed and configured a Squid proxy to the User Portal.

= Firewalls =

== ⁠oVirt Firewall Requirements ==

oVirt requires that a number of ports be opened to allow network traffic through the system's firewall. The <code>engine-setup</code> script is able to configure the firewall automatically, but this overwrites any pre-existing firewall configuration.

Where an existing firewall configuration exists, you must manually insert the firewall rules required by oVirt instead. The <code>engine-setup</code> command saves a list of the <code>iptables</code> rules required in the <code>/usr/share/ovirt-engine/conf/iptables.example</code> file.

The firewall configuration documented here assumes a default configuration. Where non-default HTTP and HTTPS ports are chosen during installation adjust the firewall rules to allow network traffic on the ports that were selected - not the default ports (<code>80</code> and <code>443</code>) listed here.

'''Table A.1. oVirt Firewall Requirements'''

{| class="wikitable"
!width="20%"|Port(s)
!width="20%"|Protocol
!width="20%"|Source
!width="20%"|Destination
!width="20%"|Purpose
|-
| -
|ICMP
|* oVirt Node(s)<br>
* Red Hat Enterprise Linux host(s)
|* oVirt
|When registering to oVirt, virtualization hosts send an ICMP ping request to oVirt to confirm that it is online.
|-
|22
|TCP
|* System(s) used for maintenance of oVirt including backend configuration, and software upgrades.
|* oVirt
|SSH (optional)
|-
|80, 443
|TCP
|* Administration Portal clients<br>
* User Portal clients<br>
* oVirt Node(s)<br>
* Red Hat Enterprise Linux host(s)<br>
* REST API clients<br>
|* oVirt
|Provides HTTP and HTTPS access to oVirt.
|}

<div class="alert alert-info">'''Important:''' In environments where oVirt is also required to export NFS storage, such as an ISO Storage Domain, additional ports must be allowed through the firewall. Grant firewall exceptions for the ports applicable to the version of NFS in use:

; '''NFSv4'''
: TCP port <code>2049</code> for NFS.
; '''NFSv3'''
: TCP and UDP port <code>2049</code> for NFS.
: TCP and UDP port <code>111</code> (<code>rpcbind</code>/<code>sunrpc</code>).
: TCP and UDP port specified with <code>MOUNTD_PORT=&quot;port&quot;</code>
: TCP and UDP port specified with <code>STATD_PORT=&quot;port&quot;</code>
: TCP port specified with <code>LOCKD_TCPPORT=&quot;port&quot;</code>
: UDP port specified with <code>LOCKD_UDPPORT=&quot;port&quot;</code></div>

The <code>MOUNTD_PORT</code>, <code>STATD_PORT</code>, <code>LOCKD_TCPPORT</code>, and <code>LOCKD_UDPPORT</code> ports are configured in the <code>/etc/sysconfig/nfs</code> file.

== ⁠Virtualization Host Firewall Requirements ==

Red Hat Enterprise Linux hosts and oVirt Nodes require a number of ports to be opened to allow network traffic through the system's firewall. In the case of the oVirt Node these firewall rules are configured automatically. For Red Hat Enterprise Linux hosts however it is necessary to manually configure the firewa

'''Table A.2. Virtualization Host Firewall Requirements'''

{| class="wikitable"
!width="20%"|Port(s)
!width="20%"|Protocol
!width="20%"|Source
!width="20%"|Destination
!width="20%"|Purpose
|-
|22
|TCP
|* oVirt
|* oVirt Nodes
* Red Hat Enterprise Linux hosts
|Secure Shell (SSH) access.
|-
|161
|UDP
|* Red Hat Enterprise Linux Hypervisors
* Red Hat Enterprise Linux hosts
|* oVirt
|Simple network management protocol (SNMP).
|-
|5900-6923
|TCP
|* Administration Portal clients
* User Portal clients
|* oVirt Nodes
* Red Hat Enterprise Linux hosts
|Remote guest console access via VNC and SPICE. These ports must be open to facilitate client access to virtual machines.
|-
|5989
|TCP, UDP
|* Common Information Model Object Manager (CIMOM)
|* oVirt Nodes
* Red Hat Enterprise Linux hosts
|Used by Common Information Model Object Managers (CIMOM) to monitor virtual machines running on the virtualization host. To use a CIMOM to monitor the virtual machines in your virtualization environment then you must ensure that this port is open.
|-
|16514
|TCP
|* oVirt Nodes
* Red Hat Enterprise Linux hosts
|* oVirt Nodes
* Red Hat Enterprise Linux hosts
|Virtual machine migration using <code>libvirt</code>.
|-
|49152-49216
|TCP
|* Red Hat Enterprise Linux Hypervisors
* Red Hat Enterprise Linux hosts
|* Red Hat Enterprise Linux Hypervisors
* Red Hat Enterprise Linux hosts
|Virtual machine migration and fencing using VDSM. These ports must be open facilitate both automated and manually initiated migration of virtual machines.
|-
|54321
|TCP
|* oVirt
* oVirt Nodes
* Red Hat Enterprise Linux hosts
|* oVirt Nodes
* Red Hat Enterprise Linux hosts
|VDSM communications with oVirt and other virtualization hosts.
|}

'''Example A.1. Option Name: IPTablesConfig'''

Recommended (default) values: Automatically generated by vdsm bootstrap script

<pre class="programlisting">*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
# vdsm
-A INPUT -p tcp --dport 54321 -j ACCEPT
# libvirt tls
-A INPUT -p tcp --dport 16514 -j ACCEPT
# SSH
-A INPUT -p tcp --dport 22 -j ACCEPT
# guest consoles
-A INPUT -p tcp -m multiport --dports 5900:6923 -j ACCEPT
# migration
-A INPUT -p tcp -m multiport --dports 49152:49216 -j ACCEPT
# snmp
-A INPUT -p udp --dport 161 -j ACCEPT
# Reject any other input traffic
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -m physdev ! --physdev-is-bridged -j REJECT --reject-with icmp-host-prohibited
COMMIT</pre>

== ⁠Directory Server Firewall Requirements ==

oVirt requires a directory server to support user authentication. A number of ports must be opened in the directory server's firewall to support GSS-API authentication as used by oVirt.

'''Table A.3. Host Firewall Requirements'''

{| class="wikitable"
!width="20%"|Port(s)
!width="20%"|Protocol
!width="20%"|Source
!width="20%"|Destination
!width="20%"|Purpose
|- style="vertical-align:top;"
|88, 464
|TCP, UDP
|* oVirt
|* Directory server
|Kerberos authentication.
|- style="vertical-align:top;"
|389, 636
|TCP
|* oVirt
|* Directory server
|Lightweight Directory Access Protocol (LDAP) and LDAP over SSL.
|}

== ⁠Database Server Firewall Requirements ==

oVirt supports the use of a remote database server. If you plan to use a remote database server with oVirt then you must ensure that the remote database server allows connections from oVirt.

'''Table A.4. Host Firewall Requirements'''

{| class="wikitable"
!width="20%"|Port(s)
!width="20%"|Protocol
!width="20%"|Source
!width="20%"|Destination
!width="20%"|Purpose
|- style="vertical-align:top;"
|5432
|TCP, UDP
|* oVirt
|* PostgreSQL database server
|Default port for PostgreSQL database connections.
|}

If you plan to use a local database server on oVirt itself, which is the default option provided during installation, then no additional firewall rules are required.

= oVirt and SSL =

== ⁠Replacing oVirt SSL Certificate ==

'''Summary'''

You want to use your organization's commercially signed certificate to identify your oVirt to users connecting over https.

<div class="alert alert-info">'''Note:''' Using a commercially issued certificate for https connections does not affect the certificate used for authentication between your oVirt and hosts, they will continue to use the self-signed certificate generated by oVirt.</div>

Prerequisites

This procedure requires a ''PEM'' formatted certificate from your commercial certificate issuing authority, a ''.nokey'' file, and a ''.cer'' file. The ''.nokey'' and ''.cer'' files are sometimes distributed as a certificate-key bundle in the ''P12'' format.

This procedure assumes that you have a certificate-key bundle in the ''P12'' format.

'''Procedure B.1. Replacing oVirt Apache SSL Certificate'''

<ol>
<li>oVirt has been configured to use <code>/etc/pki/ovirt-engine/apache-ca.pem</code>, which is symbolically linked to <code>/etc/pki/ovirt-engine/ca.pem</code>. Remove the symbolic link.<br>
<pre class="screen"># rm /etc/pki/ovirt-engine/apache-ca.pem</pre></li>
<li>Save your commercially issued certificate as <code>/etc/pki/ovirt-engine/apache-ca.pem</code>.<br>
<pre class="screen">mv YOUR-3RD-PARTY-CERT.pem /etc/pki/ovirt-engine/apache-ca.pem</pre></li>
<li>Move your ''P12'' bundle to <code>/etc/pki/ovirt-engine/keys/apache.p12</code>.</li>
<li>Extract the key from the bundle.<br>
<pre class="screen"># openssl pkcs12 -in  /etc/pki/ovirt-engine/keys/apache.p12 -nocerts -nodes &gt; /etc/pki/ovirt-engine/keys/apache.key.nopass</pre></li>
<li>Extract the certificate from the bundle.<br>
<pre class="screen"># openssl pkcs12 -in /etc/pki/ovirt-engine/keys/apache.p12 -nokeys &gt; /etc/pki/ovirt-engine/certs/apache.cer</pre></li>
<li>Restart the Apache server.<br>
<pre class="screen"># service httpd restart</pre></li></ol>

'''Result'''

Your users can now connect to the portals without being warned about the authenticity of the certificate used to encrypt https traffic.

= Authors and Revision History =

'''Jodi Biddle'''

Red Hat Engineering Content Services

<code>jbiddle@redhat.com</code>

'''Andrew Burden'''

Red Hat Engineering Content Services

<code>aburden@redhat.com</code>

'''Lucy Bopf'''

Red Hat Engineering Content Services

<code>lbopf@redhat.com</code>

'''Andrew Dahms'''

Red Hat Engineering Content Services

<code>adahms@redhat.com</code>

'''Zac Dover'''

Red Hat Engineering Content Services

<code>zdover@redhat.com</code>

Revision 1.0-1

Wed 25 Jun 2014

'''Lucy Bopf'''

{|
|Initial creation for oVirt Engine test build for Brian Proffitt.
|}

= Legal Notice =

Copyright © 2014 Red Hat, Inc.

This document is licensed by Red Hat under the [http://creativecommons.org/licenses/by-sa/3.0/ Creative Commons Attribution-ShareAlike 3.0 Unported License]. If you distribute this document, or a modified version of it, you must provide attribution to Red Hat, Inc. and provide a link to the original. If the document is modified, all Red Hat trademarks must be removed.

Red Hat, as the licensor of this document, waives the right to enforce, and agrees not to assert, Section 4d of CC-BY-SA to the fullest extent permitted by applicable law.

Red Hat, Red Hat Enterprise Linux, the Shadowman logo, JBoss, MetaMatrix, Fedora, the Infinity Logo, and RHCE are trademarks of Red Hat, Inc., registered in the United States and other countries.

Linux® is the registered trademark of Linus Torvalds in the United States and other countries.

Java® is a registered trademark of Oracle and/or its affiliates.

XFS® is a trademark of Silicon Graphics International Corp. or its subsidiaries in the United States and/or other countries.

MySQL® is a registered trademark of MySQL AB in the United States, the European Union and other countries.

Node.js® is an official trademark of Joyent. Red Hat Software Collections is not formally related to or endorsed by the official Joyent Node.js open source or commercial project.

The OpenStack® Word Mark and OpenStack Logo are either registered trademarks/service marks or trademarks/service marks of the OpenStack Foundation, in the United States and other countries and are used with the OpenStack Foundation's permission. We are not affiliated with, endorsed or sponsored by the OpenStack Foundation, or the OpenStack community.

All other trademarks are the property of their respective owners.
