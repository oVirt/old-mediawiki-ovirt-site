''It's only proposal, not yet finalized''

=About kdump=

The kdump crash recovery mechanism provides way how to save kernel core dump to local or remote storage and reboot host afterwards so host will became operational asap. This is done by booting kdump kernel with specially configured initramfs from the context of regular kernel. 

The kdump service support is contained in '''kexec-tools''' package:
# Configuration of kdump behavior is defined in ''/etc/kdump.conf''
# The initramfs file can be created from ''/etc/kdump.conf'' file executing ''systemctl restart kdump'' (Fedora) or ''service kdump restart'' (RHEL)

'''Attention:''' To enable kdump these two things are needed:
# Main kernel has to be booted with ''crashkernel'' parameter
# kdump service has to be enabled and started

'''Attention:''' On RHEL6 you can specify ''crashkernel=auto'' (kernel calculates needed memory size based on RAM size), but this doesn't work on Fedora (you have to manually set memory size).

Following options can be specified in in ''/etc/kdump.conf'' file:
# Place where to store kernel core dump, currently it can be local, NFS, SSH or iSCSI (by default core dumps are saved to ''/var/crash'')
# Action that will be executed if core dump collection failed, currently it can be '''reboot'''(default), '''halt''', '''poweroff''', '''shell''' or '''dump_to_rootfs'''
# Scripts/commands to be executed before/after core dump collection started/finished
# Extra binaries to include into initramfs
# And other not so important for oVirt options

=About Fence kdump=
Fence kdump is a method how to prevent fencing a host during its kdump process. The tool is packaged in '''fence-agents-kdump''' package and it contains two commands:
* ''fence_kdump_send''
** It is executed in kdump kernel and it sends message using UDP protocol to specified host each time interval to notify that host is still in kdump process
* ''fence_kdump''
** It is executed on a host that tries to detect if some other host is in kdump process by receiving messages from specified host

The tool has following limitations that should be considered when using it in oVirt:
# ''fence_kdump_send'' can send packet only to IPs specified as its command line argument (it cannot send packets to level2 broadcast address)
# ''fence_kdump'' return success exit code only for one host at the time, messages from other hosts are ignored
# Package '''fence-agents-kdump''' doesn't contain any scripts to integrate them into kdump kernel

=Host configuration to enable fence_kdump=
There's fence_kdump support in package kexec-tools 2.0.4.18 (Fedora 20) and 2.0.0-273 (RHEL 6.5), but unfortunately this support is tightly bound to Pacemaker software. 

Patches were sent to support fence_kdump configuration directly in ''/etc/kdump.conf'' using these new options:
*'''fence_kdump_args'''
**Command line arguments for ''fence_kdump_send'' (it can contain all valid arguments except hosts to send notification to)
*'''fence_kdump_nodes'''
** List of cluster node(s) separated by space to send fence_kdump  notification to (this option is mandatory to enable fence_kdump)

If option '''fence_kdump_nodes''' will contain at least one host to send notification to, for example:
 fence_kdump_nodes 192.168.1.10 10.34.63.155
fence_kdump will be configured.

If required, other ''fence_kdump_send'' arguments can be set using '''fence_kdump_args''' option, for example:
 fence_kdump_args -p 7410 -f auto -i 5"

Patches are managed using those RFEs:
* Fedora 20: [https://bugzilla.redhat.com/1078134 BZ1078134]
* RHEL 6.6: [https://bugzilla.redhat.com/1083938 BZ1083938]
* RHEL 7.1: [https://bugzilla.redhat.com/1086988 BZ1086988]

=Receiving fence_kdump notifications=
There are currently several possible methods how to receive fence_kdump notification and detect that host is in kdump flow:
# '''Using fencing proxy same way as for hard fencing flow'''
#* On the fencing proxy host (selected host from same cluster/DC as Non Responsive host) we can execute fence_kdump using same API as other fencing agents and by analyzing exit code we will know if Non Responsive host is in kdump flow (exit code ''0'') or not
#* '''Problems'''
#** Since ''fence_kdump_send'' can send notification only to predefined list of hosts, on each add/remove host from cluster we will need to update fence_kdump_nodes on each host in cluster and recreate initial ramding for kdump by restarting kdump service.
#** Sending to notifications to huge list of hosts can be inefficient
# '''Host, that engine is running on, will be used as fencing proxy'''
#* We can execute ''fence_kdump'' using same API as other fencing agents on the same host as engine is running on and by analyzing exit code we will know if Non Responsive host is in kdump flow (exit code ''0'') or not
#* '''Problems'''
#** API to execute fencing agents on the same host as engine is running is not currently implemented, but it's requested as RFE [https://bugzilla.redhat.com/show_bug.cgi?id=891085 BZ891085]
#** UDP connection to port 7410 from all hosts to the host that engine is running on should be allowed
#** ''fence_kdump'' can detect only one host in kdump flow at the same time, notifications received from other hosts then requested are ignored. ''fence_kdump'' is executed with host name or IP and timeout to wait for notification from the host. So on large clusters when fence_kdump detection will be required for multiple hosts at once and those hosts won't be non responsive due to kdump flow, the timeout before hard fencing is executed will depend on number of hosts to detect kdump on.
# '''New fence_kdump notification listener executed inside engine will be implemented'''
#* We can easily implement new listener that will be part of engine and which will receive all fence_kdump notification and will store them in some kind of the map, where key can be IP address of host and value the timestamp when last notification was received. Using this listener we can easily detect kdump flow on multiple hosts at the same time
#* '''Problems'''
#** UDP connection to port 7410 from all hosts to the host that engine is running on should be allowed
#** May introduce security threat to engine since fence_kdump notification are sent using UDP protocol
# '''New standalone fence_kdump notification listener will be implemented'''
#* We can easily implement new standalone listener which will receive all fence_kdump notification and will store them in some kind of the map, where key can be IP address of host and value the timestamp when last notification was received. Using this listener we can easily detect kdump flow on multiple hosts at the same time
#* '''Problems'''
#** UDP connection to port 7410 from all hosts to the host that listener is running on should be allowed
#** We will need to implement API for communication between engine and standalone listener

We decided to implement new standalone listener running on the same host as engine (option 4).

=New standalone fence_kdump listener=
The new standalong listener will be implemented with these features:
*The first listener thread will:
*# Receive a message and check if it's valid fence_kdump message (compares magic number and message version (currently only ''1'') in the same way as in ''fence_kdump'' command).
*# If message is valid, send IP address, timestamp and empty status (fence_kdump protocol version 1 doesn't provide status of host kdump flow) to queue.
*In another thread queue will be processed:
*# Get message from queue
*# If the status is empty
*## Get most recent record from '''fence_kdump_messages''' table in engine database with proper IP
*## If no record is returned or ''record timestamp + NextKdumpTimeout < message timestamp'', set status to '''STARTED''', otherwise set status to '''DUMPING'''
*# Write IP, message timestamp and status to '''fence_kdump_messages''' table
*Another thread (it will be scheduled to execute every 30 seconds) will take care of finishing fence_kdump process status:
*# Select the most recent records from '''fence_kdump_messages''' table for all IP
*# For each IP if record status is not '''FINISHED''' and ''record_timestamp + KdumpFinishedTimeout < current timestamp'', write new record to '''fence_kdump_messages''' table with status '''FINISHED'''
*Last thread will be scheduler to execute every 5 seconds and it will be used as a heartbeat status for engine, that fence_kdump listener is alive:
*# It will store current timestamp into '''fence_kdump_messages''' table for IP value ''fence_kdump_listener''
The listener will use two config values:
*'''NextKdumpTimeout'''
**Defines minimum timeout allowed between one kdump flow finished and new one started for one host
** Default 60 seconds
*'''KdumpFinishedTimeout'''
**Defines maximum timeout after last received message from kdumping hosts after which the host kdump flow is marked as FINISHED
** Default 30 seconds
It's supposed that fence_kdump_send will send messages every 5 seconds.


For oVirt 3.5 we will rely on current fence_kdump capabilities, but for next oVirt version (3.6/4.0) we plan to send more patches to '''fence-agents-kdump''' and '''kexec-tools''' which will extend fence_kdump behaviour to be able:
* To send message sequence number
* To include unique host identification (host UUID) so we will not have to rely on DNS to pair incoming message with existing hosts
* To include HMAC signature to message
* To receive kdump status notification (STARTED, DUMPING, FINISHED, ERROR, ...) and send the status
* To use TCP protocol

=Fencing flow with fence_kdump=
Host kdump flow detection will be inserted into automatic fencing flow just before execution of hard fencing:
# On first network failure, host status will change to '''Connecting'''
# If the host doesn't respond during time interval, execute SSH Soft Fencing. If command execution wasn't successful, proceed to hard fencing enabled check immediately (step 4).
# If the host doesn't recover during time interval, proceed hard fencing enabled check  (step 4).
# If hard fencing is not enabled for host, set host status to '''Non Responsive''' and exit fencing flow
# If fence kdump is not enabled for the host, execute hard fencing immediately (step 8)
# If standalone fence_kdump listener is not alive, execute hard fencing immediately (step 8)
# Execute fence_kdump detection
## Store current timestamp into ''kdump_timestamp'' variable
## Resolve host IP
## Repeat following:
### Get most recent record from '''fence_kdump_messages''' table for resolved IP
### If ''record timestamp >= kdump_timestamp'' and record status is '''FINISHED''', set host status to '''Reboot''' and exit fencing flow
### If ''record timestamp >= kdump_timestamp'' and record status is '''STARTED''' or '''DUMPING''', wait '''FenceKdumpMessageInterval''' and continue the loop
### if ''record timestamp < kdump_timestamp'' and ''current timestamp >= kdump_timestamp + KdumpStartedTimeout'', continue with hard fencing  (step 8)
### if no record returned, wait '''FenceKdumpMessageInterval''' and continue the loop
# Execute hard fencing for host

Following config values are used:
* '''FenceKdumpMessageInterval'''
** Defines the interval between messages sent by ''fence_kdump_send''
** Default 5 seconds
* '''KdumpStartedTimeout'''
** Defines maximum timeout to wait until 1st message from kdumping host is received (host kdump flow started)
** Default 30 seconds

=Open questions/issues=
# '''Does kdump support all network configuration we need (bridge, VLAN, ...)?'''
#* Bridges are supported, I successfully tested fence_kdump with ''ovirtmgmt'' bridge
#* According to [https://bugzilla.redhat.com/show_bug.cgi?id=752458 BZ752458] VLANs are supported
# '''Fence_kdump uses port 7410 by default (can be changed using command line argument) which is reserved for Ionix Network Monitor. Should we used by default another port?'''
# '''Fence_kdump configuration will be updated only on host redeploy. Is it enough?'''
# '''Kdump configuration will need to be refreshed after network configuration is updated because network configuration to reach host for fence_kdump is stored inside kdump initial ramdisk'''
#* Can be achieved by restarting kdump service, but this call should be added to VDSM module which is responsible for network configuration.
# '''We plan to update only fence_kdump options in kdump configuration, host admin will be responsible to configure other options and restart kdump service manually when done. In order to successfully report kdump status to engine this operation should be done only when host is in Maintenance.'''
# '''Host from which fence_kdump message came is identified by IP address, but inside engine FQDN or IP of host is saved. Is it OK to resolve FQDN during kdump detection or do we need to save IP address of host in engine?'''
# '''We are able only to allow access to fence_kdump port, but we cannot easily identify which IPs can access this port. This is task for administrator to modify firewall rules for enhanced security'''

=Implementation status=
{| class="wikitable"
! style="text-align: left; width: 20%" | Area
! style="text-align: left; width: 50%" | Task
! style="text-align: left; width: 30%" | Status
|-
| rowspan="4" | kexec-tools
|-
|Patches for Fedora
| style="background-color: lightgreen" | Done, included in kexec-tools >= 2.0.4-27
|-
|Patches for RHEL 6.6
| Accepted, waiting to be merged
|-
|Patches for RHEL 7.1
| Accepted, waiting to be merged
|-
| colspan="3" | &nbsp;
|-
| rowspan="4" | vdsm
|-
|Detect status of kdump support for host
| Patch on review
|-
|Add dependency to kexec-tools package
| style="background-color: red" | Waiting for RHEL package
|-
|Configure fence_kdump during host deploy
| style="background-color: red" | 
|-
| colspan="3" | &nbsp;
|-
| rowspan="7" | engine
|-
|Display status of kdump configuration for host
| style="background-color: lightgreen" | Done
|-
|Enable/disable kdump detection in Host Power Management configuration
| style="background-color: lightgreen" | Done
|-
|Add  fence_kdump_send configuration to vdc_options
| Coding
|-
|Display warning when host kdump detection is enabled, but kdump not configured for host
| style="background-color: red" | 
|-
|Implement standalone fence_kdump listener
| Coding
|-
|Add fence_kdump handling to fencing flow
| Coding
|-
| colspan="3" | &nbsp;
|-
| rowspan="3" | engine-setup
|-
| Configure fence_kdump listener port during setup
| style="background-color: red" | 
|-
| Add firewall rule for fence_kdump listener
| style="background-color: red" | 
|-
| colspan="3" | &nbsp;
|-
| rowspan="3" | ovirt-node
|-
| Enable kdump support in kernel
| style="background-color: red" | 
|-
| Included kexec-tools package with fence_kdump configuration support
| style="background-color: red" | 
|}
