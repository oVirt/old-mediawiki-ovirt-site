= Guest Reboot (preview) =

== Summary ==

Support reboot in both engine and vdsm. Enable users to restart VM with single command.

== Detailed description ==

=== Current Condition ===

The current behavior in the engine requires the user who wishes to reboot VM to wait until the VM is <tt>Down</tt>, then press run and wait until it is <tt>Up</tt> again. 
Adding a new button/REST action (with configurable behavior, see [[#Backend|later]]) would solve this issue.
Also, if the guest OS refuses the "soft" version of shutdown, after some period it goes back to state <tt>Up</tt> and this delay period is not configurable.

=== Proposed changes ===

==== Frontend ====
* Add new button [[File:reboot.png|alt=Reboot icon]] in the main VM toolbar between the current stop and console buttons.
* Add 'Reboot' option to the VM context menu.
* Add context menu option for forced reboot - equivalent of 'Power Off' for reboot.
* Add power-down policy selection checkbox (see later) and textbox for specifying delay for graceful period shutdown/reboot to EditVM dialog.

==== REST API ====

* Add VM action for reboot (subject to power-down policy)
* Add VM action for forced-reboot (precise name open to discussion)
* Add VM attribute for power-down policy
* Add VM attribute for graceful power-down delay

==== Backend ====

At the engine level we can differentiate between VMs that the user considers "important" and should not be forcibly terminated if the guest OS doesn't gracefully power down after given timeout and VMs which the users expects to be rebooted by any means necessary. This power-down policy should be specified as <tt>vm_static</tt> attribute and would by applied on both the shutown and the reboot action. If the user would wish for the "harder" behavior he can edit the policy for given VM or just pick the appropriate action from the context menu. We should also provide the user with the ability to specify the graceful-delay as another <tt>vm_static</tt> attribute. This delay will be used by VDSM/guest-agent and specifies how long to wait for the guest-agent/acpi until we return failure or resort to the forced destroy/reset.

==== VDSM ====
Alter the API of <tt>shutdown</tt>. Add two optional boolean parameters: <tt>force</tt> and <tt>reboot</tt> where  <tt>reboot</tt> differentiates between shutdown/reboot and <tt>force</tt> allows us to specify whether to forcibly destroy/reset VM after all the graceful methods of shutdown/reboot have failed (guest-agent, acpi). 

==== Guest Agent ====
Support additional boolean parameter in the desktopShutdown call determining wether we want normal shutdown (<tt>reboot=False</tt>) or reboot. 
This is the simplest change as it boils down to passing -h or -r flag to the underlying script performing the shutdown.

== Possible Issues ==

* Run Once behavior 
:Do we want to preserve the run-once configuration after reboot (effectively becoming "run-twice") or do we treat it as equivalent to stop(); start()? 
:Do we provide option to the user to select the desired behavior?

* Stateless VM
:Do we want to clear the state of VM or preserve the running state for the user?

* Pool VMs
:Same state consideration for the state as in Stateless VM + need to make sure we do the stop();start(); atomically so we do not enable the possibility for another user to "steal" this VM

=== Current goals for oVirt 3.3 ===

Since most issues reside in the engine-level handling stop(); start() sequence for various special VM types the focus is now on implementing  the soft version of reboot, that is implementable with minimal changes to both vdsm and guest-agent and on the engine side essentialy consists of adding a button and new command, and provides a feature to the users that covers a very common case when the configuration has not changed and the guest is willing to gracefully reboot. In the next release we would also focus on implementing the rest of the full reboot capabilities, with power-down policy and configurable delay for graceful shutdown.

== Owner == 
* Name: [[User:Mbetak|Martin Betak]]
* Email: <mbetak@redhat.com>
